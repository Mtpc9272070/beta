<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADUWEB - Plataforma de Simulación</title>
    
    <!-- Configuración PWA y de App -->
    <link rel="manifest" href="./manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#10b981">
    <link rel="apple-touch-icon" href="./logo.png">
    
    <!-- Carga de Tailwind CSS CDN y SweetAlert2 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <!-- Configuración de Tailwind y Estilos -->
    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in { animation: fadeIn 0.5s ease-out; }
        
        /* Estilo para un desplazamiento suave y ocultar scrollbar */
        .scroll-container {
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none; /* Firefox */
        }
        .scroll-container::-webkit-scrollbar {
            display: none; /* WebKit */
        }

        /* Estilo para resaltar la navegación activa */
        .nav-active {
            color: #10b981; /* primary-teal */
            transform: scale(1.05);
            font-weight: bold;
        }
        /* --- NUEVO: Estilos para el menú de perfil --- */
        #profile-menu {
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        #profile-menu.hidden {
            opacity: 0;
            transform: translateY(-10px) scale(0.95);
        }
        /* NUEVO: Animación para la campana de notificación */
        @keyframes ring-bell {
            0%, 100% { transform: rotate(0); }
            10%, 30%, 50%, 70% { transform: rotate(-10deg); }
            20%, 40%, 60%, 80% { transform: rotate(10deg); }
        }
    </style>
</head>
<body class="font-sans bg-gray-50">

    <!-- Contenedor Principal de la Aplicación -->
    <div id="app-container" class="min-h-screen flex flex-col max-w-lg mx-auto shadow-xl bg-white">
        
        <!-- Pantalla de Carga/Autenticación -->
        <div id="loading-screen" class="absolute inset-0 bg-white/70 backdrop-blur-sm flex flex-col items-center justify-center z-50 transition-opacity duration-500">
            <div class="text-green-700 text-3xl font-bold mb-4 animate-pulse">ADUWEB</div>
            <div class="border-t-4 border-green-600 border-solid rounded-full h-12 w-12 animate-spin"></div>
            <p class="mt-4 text-gray-600" id="loading-text">Iniciando...</p>
        </div>
        
        <!-- Contenido de la Aplicación (Oculto al inicio) -->
        <div id="main-content" class="flex flex-col flex-grow hidden">

            <!-- 1. Header Fijo (Puntuación y Perfil) -->
            <header id="main-header" class="p-4 bg-white shadow-md flex justify-between items-center z-10 sticky top-0">
                <div class="flex items-center space-x-2 text-lg font-bold text-yellow-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-yellow-500" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2l3.09 6.31 6.91.99-5 4.88 1.18 6.88L12 18.25l-6.18 3.24 1.18-6.88-5-4.88 6.91-.99L12 2z"/></svg>
                    <span id="user-score">0 Puntos</span>
                </div>
                <div class="flex items-center space-x-3 relative">
                    <!-- NUEVO: Icono y contador de tiquete -->
                    <div id="ticket-timer-icon" class="hidden flex items-center space-x-1 text-sm font-bold text-amber-600">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-amber-500" viewBox="0 0 20 20" fill="currentColor"><path d="M2 6a2 2 0 012-2h12a2 2 0 012 2v2a2 2 0 100 4v2a2 2 0 01-2 2H4a2 2 0 01-2-2v-2a2 2 0 100-4V6z" /></svg>
                        <span id="ticket-time-left"></span>
                    </div>
                    <!-- MODIFICADO: Añadido onclick y IDs -->
                    <div id="notification-bell" class="relative cursor-pointer" onclick="toggleNotifications()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-600 hover:text-blue-600"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>
                        <span id="notification-badge" class="absolute -top-1 -right-1 h-3 w-3 rounded-full bg-red-500 border-2 border-white hidden"></span>
                    </div>
                    <!-- Contenedor del Menú de Perfil -->
                    <!-- MODIFICADO: Añadido onclick -->
                    <div class="relative">
                        <button onclick="toggleProfileMenu()" id="profile-button" class="w-10 h-10 bg-green-600/20 rounded-full flex items-center justify-center text-green-700 font-semibold shadow-inner transition hover:bg-green-600/30">
                            ...
                        </button>
                        <!-- Menú Desplegable de Perfil -->
                        <div id="profile-menu" class="hidden absolute top-full right-0 mt-2 w-48 bg-white rounded-lg shadow-xl border z-30 origin-top-right">
                            <a href="#" data-view="role" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Ver Perfil / Rol</a>
                            <a href="#" id="install-pwa-btn" class="hidden block px-4 py-2 text-sm text-blue-600 hover:bg-blue-50 font-semibold">📥 Instalar App</a>
                            <a href="#" id="logout-btn" class="block px-4 py-2 text-sm text-red-600 hover:bg-red-50 border-t">Cerrar Sesión</a>
                        </div>
                    </div>
                    <!-- NUEVO: Panel de notificaciones -->
                    <div id="notification-panel" class="hidden absolute top-full right-0 mt-2 w-80 bg-white rounded-lg shadow-xl border z-30 origin-top-right">
                        <div class="p-3 font-bold text-gray-800 border-b">Notificaciones</div>
                        <div id="notification-list" class="max-h-96 overflow-y-auto"></div>
                    </div>
                </div>
            </header>

            <!-- 2. Contenedor de Vistas -->
            <div id="view-container" class="flex-grow scroll-container overflow-y-auto">
                
                <!-- A. Vista: Login -->
                <div id="login-view" class="p-8 hidden">
                    <div class="text-center">
                        <h1 class="text-4xl font-extrabold text-green-700">ADUWEB</h1>
                        <p class="mt-2 text-gray-600">Simulador de Agente Aduanero</p>
                    </div>
                    <div class="space-y-4 mt-8">
                        <input type="text" id="userName" placeholder="Ingresa tu primer nombre" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-lg text-center">
                        <button id="login-btn" class="w-full p-3 bg-gray-400 text-white font-bold rounded-lg transition cursor-not-allowed" disabled>Conectando...</button>
                    </div>
                </div>

                <!-- B. Vista: Selección de Rol -->
                <div id="role-view" class="p-4 pb-20 hidden animate-fade-in">
                    <div class="text-center mb-8">
                        <div id="profile-avatar-initials" class="w-28 h-28 mx-auto mb-4 bg-green-600 text-white flex items-center justify-center rounded-full text-5xl font-bold shadow-lg border-4 border-white">
                            <!-- Las iniciales se insertarán aquí -->
                        </div>
                        <h1 id="profile-name" class="text-3xl font-extrabold text-gray-800">Cargando...</h1>
                        <p class="text-gray-600 mt-1">Estudiante de primer semestre</p>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h2 class="text-xl font-bold text-gray-700 mb-4">Tu Progreso</h2>
                        <div class="space-y-4">
                            <div class="flex justify-between items-center"><span class="text-gray-600">Puntaje Total (EXP):</span><span id="profile-score" class="font-bold text-lg text-purple-600">0</span></div>
                            <div class="flex justify-between items-center"><span class="text-gray-600">Simulaciones Completadas:</span><span id="profile-missions" class="font-bold text-lg text-green-600">0</span></div>
                            <div class="flex justify-between items-center"><span class="text-gray-600">Ruta de Aprendizaje:</span>
                                <div class="w-1/2 bg-gray-200 rounded-full h-5"><div id="profile-training-bar" class="bg-purple-600 h-5 rounded-full text-white text-xs flex items-center justify-center" style="width: 0%;">0%</div></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- C. Vista: Dashboard Principal -->
                <main id="dashboard-view" class="p-4 pb-20 hidden">
                    <!-- Contenido del Dashboard Restaurado -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <!-- Columna Izquierda: Perfil y Progreso -->
                        <div class="lg:col-span-1 space-y-6">
                            <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-blue-500">
                                <h2 class="text-2xl font-bold text-gray-800 mb-4">Perfil de Asesor</h2>
                                <p class="text-3xl font-extrabold text-blue-600 mb-1" id="playerName">Jugador</p>
                                <p class="text-lg text-gray-600" id="currentRoleDisplay">Sin Rol</p>
                            </div>
                            <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-purple-500">
                                <h3 class="text-xl font-bold text-gray-800 mb-3">Progreso Global</h3>
                                <div class="space-y-3">
                                    <div class="flex justify-between items-center"><span class="text-gray-600">Puntaje Total (EXP):</span><span class="text-2xl font-extrabold text-purple-600" id="playerScore">0</span></div>
                                    <div class="flex justify-between items-center"><span class="text-gray-600">Puntaje Promedio:</span><span class="text-xl font-bold text-blue-600" id="playerAvgScore">0</span></div>
                                    <div class="flex justify-between items-center"><span class="text-gray-600">Simulaciones:</span><span class="text-xl font-bold text-green-600" id="playerProgress">0</span></div>
                                    <div class="flex justify-between items-center"><span class="text-gray-600">Ruta Aprendizaje:</span>
                                        <div class="w-1/2 bg-gray-200 rounded-full h-4"><div id="training-progress-bar" class="bg-purple-600 h-4 rounded-full" style="width: 0%;"></div></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Columna Derecha: Acciones y Actividad -->
                        <div class="lg:col-span-2 space-y-6">
                            <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-green-500">
                                <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9V3m-3.404 16.252a9 9 0 01-12.848-12.848" /></svg>Plan de Formación</h2>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div id="online-match-container" class="relative md:col-span-2">
                                        <div id="online-match-card" onclick="openGame('sala_espera.html')" class="p-6 bg-green-600 text-white rounded-xl shadow-lg cursor-pointer transition transform hover:scale-[1.02]">
                                            <h3 class="text-xl font-bold flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" /></svg>Simulación "La Merca"</h3>
                                            <p class="text-sm opacity-90 mt-1">Accede al simulador multijugador para aplicar tu rol.</p>
                                        </div>
                                        <div id="online-match-lock-overlay" class="hidden absolute inset-0 bg-gray-800 bg-opacity-80 rounded-xl flex flex-col items-center justify-center text-center p-4 cursor-not-allowed">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" /></svg>
                                            <p class="text-white font-bold mt-2">Modo Multijugador Bloqueado</p>
                                            <p class="text-xs text-gray-300 mt-1">Completa el 100% de la Ruta de Aprendizaje o compra un tiquete.</p>
                                        </div>
                                    </div>
                                    <div id="practice-games-container" class="relative">
                                        <div id="practice-games-card" onclick="openGame('adugame_templates.html')" class="bg-white p-5 rounded-xl shadow-md border-l-4 border-purple-500 cursor-pointer transition hover:shadow-lg">
                                            <h3 class="text-lg font-bold text-gray-800 flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-purple-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M11 4a2 2 0 114 0v1a1 1 0 001 1h3a1 1 0 011 1v3a1 1 0 01-1 1h-1a2 2 0 100 4h1a1 1 0 011 1v3a1 1 0 01-1 1h-3a1 1 0 01-1-1v-1a2 2 0 10-4 0v1a1 1 0 01-1 1H7a1 1 0 01-1-1v-3a1 1 0 00-1-1H4a2 2 0 110-4h1a1 1 0 001-1V7a1 1 0 011-1h3a1 1 0 001-1V4z" /></svg>Centro de Juegos</h3>
                                            <p class="text-sm text-gray-600">Practica con minijuegos individuales para ganar EXP.</p>
                                        </div>
                                        <div id="practice-games-lock-overlay" class="hidden absolute inset-0 bg-gray-800 bg-opacity-80 rounded-xl flex flex-col items-center justify-center text-center p-4 cursor-not-allowed">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" /></svg>
                                            <p class="text-white font-bold mt-2">Juegos Bloqueados</p>
                                            <p class="text-xs text-gray-300 mt-1">Completa el 50% de la Ruta de Aprendizaje o compra un tiquete.</p>
                                        </div>
                                    </div>
                                    <div onclick="openGame('icogame.html')" class="bg-white p-5 rounded-xl shadow-md border-l-4 border-blue-500 cursor-pointer transition hover:shadow-lg">
                                        <h3 class="text-lg font-bold text-gray-800 flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M12 14l9-5-9-5-9 5 9 5z" /><path d="M12 14l6.16-3.422a12.083 12.083 0 01.665 6.479A11.952 11.952 0 0012 20.055a11.952 11.952 0 00-6.824-5.998 12.078 12.078 0 01.665-6.479L12 14z" /><path d="M12 14l9-5-9-5-9 5 9 5zm0 0l6.16-3.422a12.083 12.083 0 01.665 6.479A11.952 11.952 0 0012 20.055a11.952 11.952 0 00-6.824-5.998 12.078 12.078 0 01.665-6.479L12 14zm-4 6v-7.5l4-2.222" /></svg>Ruta de Aprendizaje</h3>
                                        <p class="text-sm text-gray-600">Completa módulos teóricos.</p>
                                    </div>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div onclick="openGame('tienda.html')" class="bg-white p-5 rounded-xl shadow-md border-l-4 border-orange-500 cursor-pointer transition hover:shadow-lg">
                                    <h3 class="text-lg font-bold text-gray-800 flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-orange-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" /></svg>Tienda</h3>
                                    <p class="text-sm text-gray-600">Usa tus EXP.</p>
                                </div>
                                <div onclick="openGame('panel_estadistico.html')" class="bg-white p-5 rounded-xl shadow-md border-l-4 border-indigo-500 cursor-pointer transition hover:shadow-lg">
                                    <h3 class="text-lg font-bold text-gray-800 flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z" /><path stroke-linecap="round" stroke-linejoin="round" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z" /></svg>Análisis</h3>
                                    <p class="text-sm text-gray-600">Revisa partidas.</p>
                                </div>
                                <div onclick="openGame('biblioteca.html')" class="bg-white p-5 rounded-xl shadow-md border-l-4 border-cyan-500 cursor-pointer transition hover:shadow-lg">
                                    <h3 class="text-lg font-bold text-gray-800 flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-cyan-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" /></svg>Biblioteca</h3>
                                    <p class="text-sm text-gray-600">Material de apoyo.</p>
                                </div>
                            </div>
                            <!-- MODIFICADO: La sección de Análisis ahora es Juegos del Profesor -->
                            <div onclick="openGame('teacher_games_list.html')" class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-rose-500 cursor-pointer transition hover:shadow-xl">
                                <h3 class="text-xl font-bold text-gray-800 mb-3 flex items-center gap-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-rose-600"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                                    Juegos del Profesor
                                </h3>
                                <p class="text-sm text-gray-600">Accede a las actividades personalizadas creadas por tu instructor.</p>
                            </div>
                            <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-yellow-500">
                                <h3 class="text-xl font-bold text-gray-800 mb-3">Última Actividad</h3>
                                <div id="lastActivityContainer"><p class="text-gray-500">Aún no has completado ninguna simulación.</p></div>
                            </div>
                        </div>
                    </div>
                </main>
                
                <!-- D. Vista: Ranking -->
                <div id="ranking-view" class="p-4 pb-20 hidden">
                    <h2 class="text-3xl font-extrabold text-gray-800 mb-6">Ranking Global</h2>
                    <div id="full-ranking-list" class="bg-white p-4 rounded-xl shadow-lg space-y-2"></div>
                </div>

            </div>
        </div>

        <!-- 3. Barra de Navegación Inferior -->
        <nav id="bottom-nav" class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 shadow-2xl z-20 max-w-lg mx-auto">
            <div class="flex justify-around items-center h-16 text-gray-500">
                <button id="nav-dashboard" data-view="dashboard" class="flex flex-col items-center justify-center w-1/5 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" /></svg>
                    <span class="text-xs mt-0.5">Inicio</span>
                </button>
                <button data-game="adugame_templates.html" class="flex flex-col items-center justify-center w-1/5 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M11.3 1.046A1 1 0 0112 2v5.268l4.263 2.404a1 1 0 01.537.881v5.404a1 1 0 01-1.537.881L12 14.268V19a1 1 0 01-1.732.686L2.268 12.5A1 1 0 012 11.768V7.232a1 1 0 01.881-.537L7 4.268V2a1 1 0 011.732-.686L11.3 1.046zM12 4.268L7 7.232v4.536l5 2.818V4.268z" clip-rule="evenodd" /></svg>
                    <span class="text-xs mt-0.5">Juegos</span>
                </button>
                <!-- MODIFICADO: El botón central ahora dirige a AduPost -->
                <button data-game="adupost.html" class="flex flex-col items-center justify-center w-1/5 transition text-green-600 -mt-6 bg-white p-3 rounded-full shadow-lg border">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 8h2a2 2 0 012 2v6a2 2 0 01-2 2h-2v4l-4-4H9a1.994 1.994 0 01-1.414-.586m0 0L11 14h4a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2v4l.586-.586z" /></svg>
                </button>
                <button id="nav-ranking" data-view="ranking" class="flex flex-col items-center justify-center w-1/4 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path d="M2 10a8 8 0 018-8v8h8a8 8 0 11-16 0z" /><path d="M12 2.252A8.014 8.014 0 0117.748 8H12V2.252z" /></svg>
                    <span class="text-xs mt-0.5">Ranking</span>
                </button>
                <button id="nav-role" data-view="role" class="flex flex-col items-center justify-center w-1/5 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" /></svg>
                    <span class="text-xs mt-0.5">Rol</span>
                </button>
            </div>
        </nav>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-app.js"; // Firebase App (core)
        import { getDatabase, ref, get, update, onValue, off, set } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-database.js"; // Firebase Realtime Database
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-auth.js"; // Firebase Auth
        import { playSound } from "./utils.js";
        import { firebaseConfig, CAREER_ROLES } from "./config.js"; // Importar configuración y roles

        // --- CONSTANTES Y VARIABLES GLOBALES ---
        const SESSION_KEY = 'aduweb_player_name';
        const SESSION_KEY_ID = 'aduweb_player_key';
        const SESSION_KEY_CAREER = 'aduweb_career';
        const SESSION_KEY_CAREER_NAME = 'aduweb_career_name';
        const TOTAL_MODULES_REQUIRED = 5; // Para la barra de progreso

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let currentUserKey = null;
        let playerNameGlobal = "";
        let currentCareerId = null;
        let currentCareerName = null;
        let notificationsListener = null;
        let userProfileListener = null;
        let processedNotifications = new Set();
        let deferredPrompt; // Variable para guardar el evento de instalación

        const views = {
            login: document.getElementById('login-view'),
            role: document.getElementById('role-view'),
            dashboard: document.getElementById('dashboard-view'),
            ranking: document.getElementById('ranking-view'),
        };
        const navButtons = {
            dashboard: document.getElementById('nav-dashboard'),
            role: document.getElementById('nav-role'),
            ranking: document.getElementById('nav-ranking')
        };
        
        // --- NUEVO: Lógica de Bloqueo de Secciones ---
        function checkSectionLocks(trainingProgress, tickets) {
            const progress = trainingProgress || 0;
            const userTickets = tickets || {};

            // 1. Bloqueo para "Centro de Juegos"
            const practiceTicket = userTickets.practice_games_ticket;
            const hasActivePracticeTicket = practiceTicket && practiceTicket.expiresAt > Date.now();
            const practiceUnlocked = hasActivePracticeTicket; // MODIFICADO: Solo se desbloquea con tiquete
            
            document.getElementById('practice-games-card').style.pointerEvents = practiceUnlocked ? 'auto' : 'none';
            document.getElementById('practice-games-lock-overlay').classList.toggle('hidden', practiceUnlocked);
            document.querySelector('#practice-games-lock-overlay p.text-xs').textContent = 'Compra un tiquete de acceso en la tienda.'; // MODIFICADO: Mensaje actualizado

            // 2. Bloqueo para "La Merca" (Partidas en Línea)
            const onlineTicket = userTickets.online_match_ticket;
            const hasActiveOnlineTicket = onlineTicket && onlineTicket.expiresAt > Date.now();
            const onlineUnlocked = hasActiveOnlineTicket; // MODIFICADO: Solo se desbloquea con tiquete

            document.getElementById('online-match-card').style.pointerEvents = onlineUnlocked ? 'auto' : 'none';
            document.getElementById('online-match-lock-overlay').classList.toggle('hidden', onlineUnlocked);
            document.querySelector('#online-match-lock-overlay p.text-xs').textContent = 'Compra un tiquete de acceso en la tienda.'; // MODIFICADO: Mensaje actualizado

            // 3. Mostrar contador de tiquete si hay alguno activo
            updateTicketTimer(hasActivePracticeTicket ? practiceTicket : (hasActiveOnlineTicket ? onlineTicket : null));
        }

        let ticketTimerInterval = null;
        function updateTicketTimer(activeTicket) {
            const timerIcon = document.getElementById('ticket-timer-icon');
            const timeLeftSpan = document.getElementById('ticket-time-left');

            if (ticketTimerInterval) clearInterval(ticketTimerInterval);

            if (activeTicket) {
                timerIcon.classList.remove('hidden');
                
                const update = () => {
                    const now = Date.now();
                    const remainingMs = activeTicket.expiresAt - now;

                    if (remainingMs <= 0) {
                        timerIcon.classList.add('hidden');
                        clearInterval(ticketTimerInterval);
                        return;
                    }

                    const hours = Math.floor(remainingMs / (1000 * 60 * 60));
                    const minutes = Math.floor((remainingMs % (1000 * 60 * 60)) / (1000 * 60));
                    timeLeftSpan.textContent = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}h`;
                };
                update();
                ticketTimerInterval = setInterval(update, 60000); // Actualizar cada minuto
            } else {
                timerIcon.classList.add('hidden');
            }
        }

        // ----------------------------------------------------------------------
        // 🚀 INICIO DE SESIÓN Y RUTAS
        // ----------------------------------------------------------------------

        // Función central para cargar datos y decidir la ruta (Login/Selección/Dashboard)
        function loadUserDataAndRoute(data) {
            playerNameGlobal = data.nombre;
            currentUserKey = data.key;
            
            // NUEVO: Priorizar la carga de la carrera desde el último estado conocido en Firebase
            const lastState = data.lastKnownState;
            
            currentCareerId = lastState?.careerId || localStorage.getItem(SESSION_KEY_CAREER);
            currentCareerName = lastState?.careerName || localStorage.getItem(SESSION_KEY_CAREER_NAME) || 'Estudiante';
            
            localStorage.setItem(SESSION_KEY_CAREER, currentCareerId);
            localStorage.setItem(SESSION_KEY_CAREER_NAME, currentCareerName);

            // --- LÓGICA DE CÁLCULO DE PROGRESO (Restaurada de logo.html) ---
            const totalScore = data.puntaje || 0; // Se actualiza en el listener
            const missionsCompleted = data.misiones_completadas || 0;
            const gameHistory = data.gameHistory ? Object.values(data.gameHistory) : [];
            
            document.getElementById("playerScore").textContent = totalScore;
            document.getElementById("playerProgress").textContent = `${missionsCompleted}`;
            document.getElementById("user-score").textContent = `${totalScore} Puntos`; // Header

            const avgScore = missionsCompleted > 0 ? Math.round(totalScore / missionsCompleted) : 0;
            document.getElementById("playerAvgScore").textContent = avgScore;

            const trainingProgress = data.progreso_entrenamiento || 0;
            const trainingProgressBar = document.getElementById("training-progress-bar");
            // Actualizar también la barra de perfil
            const profileTrainingBar = document.getElementById("profile-training-bar");
            if(profileTrainingBar) { profileTrainingBar.style.width = `${trainingProgress}%`; profileTrainingBar.textContent = `${Math.round(trainingProgress)}%`; }

            if(trainingProgressBar) trainingProgressBar.style.width = `${trainingProgress}%`;

            // --- ¡NUEVO! Lógica de desbloqueo de secciones ---
            checkSectionLocks(data.progreso_entrenamiento, data.tickets);


            const lastActivityContainer = document.getElementById("lastActivityContainer");
            if (lastActivityContainer && gameHistory.length > 0) {
                const lastGame = gameHistory.sort((a, b) => b.date - a.date)[0];
                const gameDate = new Date(lastGame.date).toLocaleDateString();
                const resultClass = lastGame.result === 'success' ? 'text-green-600' : 'text-red-600';
                lastActivityContainer.innerHTML = `
                    <p class="text-lg text-gray-700">Simulación en sala <strong class="font-mono">${lastGame.roomId}</strong>.</p>
                    <p class="text-sm mt-1">Finalizada el ${gameDate} con un puntaje de <strong class="text-blue-700">${lastGame.score}</strong> pts.</p>
                    <p class="text-sm font-semibold ${resultClass} mt-2">Resultado: ${lastGame.result.toUpperCase()}</p>
                `;
            }

            // --- FIN DE LÓGICA DE PROGRESO ---

            // El avatar se actualiza en el listener de perfil

            // Decide la ruta
            // Ya no se necesita la selección de rol, siempre va al dashboard
            showMainDashboard();

            document.getElementById('main-content').classList.remove('hidden');
            // Iniciar la escucha de notificaciones y perfil (función unificada)
            startListeningForProfileAndNotifications(currentUserKey);
        }


        // 📥 LOGIN (Actualizado con SweetAlert2)
        async function login() {
            const userName = document.getElementById("userName").value.trim().toLowerCase();
            if (!userName) {
                Swal.fire({
                    title: '¡Espera!',
                    text: 'Ingresa tu primer nombre para continuar.',
                    icon: 'warning',
                    confirmButtonColor: '#f59e0b'
                });
                return;
            }

            // ¡CORRECCIÓN! Reproducir un sonido aquí, después de la interacción del usuario.
            playSound("soundLogin");

            const loginBtn = document.querySelector('#login-view button'); // Asegurarse de que el selector es correcto
            loginBtn.textContent = 'Buscando...';

            // 1. Verificar si es un usuario especial (profesor)
            const specialUserRef = ref(db, "userEspecial");
            const specialSnapshot = await get(specialUserRef);
            if (specialSnapshot.exists()) {
                let specialUserFound = null;
                specialSnapshot.forEach(child => {
                    const data = child.val();
                    if ((data.nombre || "").toLowerCase() === userName) {
                        specialUserFound = data;
                    }
                });
                if (specialUserFound) {
                    localStorage.setItem('aduweb_special_user_name', specialUserFound.nombre);
                    window.location.href = 'panel_control.html'; // Redirección limpia
                    return;
                }
            }

            try {
                const snapshot = await get(ref(db, "usuarios"));
                if (snapshot.exists()) {
                    let encontrado = null;
                    snapshot.forEach((child) => {
                        const data = child.val();
                        const nombreBD = (data.nombre || "").toLowerCase();
                        if (nombreBD.includes(userName)) {
                            encontrado = { key: child.key, ...data };
                        }
                    });

                    if (encontrado) {
                        localStorage.setItem(SESSION_KEY, encontrado.nombre);
                        localStorage.setItem(SESSION_KEY_ID, encontrado.key);

                        // NUEVO: Inicializar AduCoins si no existen
                        if (typeof encontrado.aducoins === 'undefined') {
                            encontrado.aducoins = 100; // Valor inicial
                            await set(ref(db, `usuarios/${encontrado.key}/aducoins`), 100);
                        }

                        loadUserDataAndRoute(encontrado);
                        playSound("soundLogin");
                        
                        // Nueva Alerta Animada (¡Éxito!)
                        Swal.fire({
                            title: `¡Bienvenido, ${encontrado.nombre.split(' ')[0]}!`,
                            text: `Tu rol de simulación actual es: ${localStorage.getItem(SESSION_KEY_CAREER_NAME) || 'Sin asignar (Elige tu rol)'}.`,
                            icon: 'success', 
                            confirmButtonText: 'Continuar',
                            confirmButtonColor: '#10b981', // green-600
                        });


                    } else {
                        // Nueva Alerta Animada (¡Error!)
                        Swal.fire({
                            title: 'Error de Acceso',
                            text: 'Usuario no encontrado en la base de datos.',
                            icon: 'error',
                            confirmButtonText: 'Entendido',
                            confirmButtonColor: '#ef4444' // red-500
                        });
                    }
                } else {
                    Swal.fire({
                        title: 'Error de BD',
                        text: 'No se encontraron usuarios en la base de datos.',
                        icon: 'error',
                        confirmButtonColor: '#ef4444'
                    });
                }
            } catch(e) {
                console.error(e);
                Swal.fire({
                    title: 'Error de Conexión',
                    text: 'Hubo un problema al conectar con Firebase.',
                    icon: 'error',
                    confirmButtonColor: '#ef4444'
                });
            } finally {
                loginBtn.disabled = false;
                loginBtn.textContent = 'Entrar';
            }
        }
        
        // Función para obtener datos de Firebase por una clave específica
        async function getPlayerByKey(key) {
             try {
                const snapshot = await get(ref(db, `usuarios/${key}`));
                if (snapshot.exists()) {
                    return { key: snapshot.key, ...snapshot.val() };
                }
                return null;
            } catch (error) {
                console.error("Error al obtener jugador por clave:", error);
                return null;
            }
        }

        // 🔍 CHECK SESSION (FUNCIÓN OPTIMIZADA Y CORREGIDA)
        async function checkSession() {
            const savedKey = localStorage.getItem(SESSION_KEY_ID);

            // 1. Si no hay clave en localStorage, es un usuario nuevo. Mostramos el login.
            if (!savedKey) {
                const loadingScreen = document.getElementById('loading-screen');
                loadingScreen.classList.add('opacity-0');
                setTimeout(() => {
                    loadingScreen.classList.add('hidden');
                    document.getElementById('main-content').classList.remove('hidden');
                    navigate("login");
                }, 500);
                return;
            }

            // 2. Si hay clave, intentamos recuperar el perfil desde Firebase.
            document.getElementById('loading-text').textContent = 'Recuperando sesión...';
            const playerStatus = await getPlayerByKey(savedKey);
            
            if (playerStatus) {
                document.getElementById('main-content').classList.remove('hidden');
                currentUserKey = savedKey; // Establecer la clave global del usuario
                
                // --- LÓGICA DE RECONEXIÓN MEJORADA ---
                // OPTIMIZADO: Leemos directamente del perfil del usuario si está en una partida.
                const activeMatchId = playerStatus.activeMatch;

                if (activeMatchId) {
                    const reconectResult = await Swal.fire({
                        title: '¡Partida en Curso Detectada!',
                        text: `Parece que tienes una partida activa en la sala "${activeMatchId}". ¿Deseas reconectarte?`,
                        icon: 'info',
                        showCancelButton: true,
                        confirmButtonColor: '#10b981',
                        cancelButtonColor: '#ef4444',
                        confirmButtonText: 'Sí, ¡Reconectar!',
                        cancelButtonText: 'No, abandonar partida'
                    });

                    if (reconectResult.isConfirmed) {
                        // Redirigimos a la sala de espera, que ya sabe cómo manejar la reconexión.
                        window.location.href = `sala_espera.html`;
                        return;
                    } else {
                        // El usuario no quiere reconectar, limpiamos su estado de partida activa.
                        const userRef = ref(db, `usuarios/${savedKey}/activeMatch`);
                        await set(userRef, null);
                    }
                }

                // --- FLUJO NORMAL (SI NO HAY PARTIDA ACTIVA O SE ABANDONÓ) ---
                    document.getElementById('main-content').classList.remove('hidden');
                loadUserDataAndRoute(playerStatus);

            } else {
                document.getElementById('main-content').classList.remove('hidden');
                // El usuario existía antes, pero su clave ya no es válida o hay un error de conexión
                localStorage.removeItem(SESSION_KEY);
                localStorage.removeItem(SESSION_KEY_ID);
                // El usuario es inválido, lo mandamos a login.
                navigate("login");
                
                Swal.fire('Error de Conexión', 'No se pudo cargar tu perfil. Por favor, inicia sesión de nuevo.', 'error');
            }

            document.getElementById('loading-screen').classList.add('opacity-0');
            setTimeout(() => {
                document.getElementById('loading-screen').classList.add('hidden');
            }, 500);
        }

        // ----------------------------------------------------------------------
        // 🔄 FUNCIONES DE VISTAS (SCREEN SWITCHING)
        // ----------------------------------------------------------------------
        
        function navigate(targetViewId) {
            Object.values(views).forEach(view => view.classList.add('hidden'));
            if (navButtons[targetViewId]) Object.values(navButtons).forEach(btn => btn.classList.remove('nav-active'));

            if (views[targetViewId]) {
                views[targetViewId].classList.remove('hidden');
                views[targetViewId].classList.add('animate-fade-in');
                if (navButtons[targetViewId]) {
                    navButtons[targetViewId].classList.add('nav-active');
                }
            }
        }

        function showMainDashboard() {
            document.getElementById("playerName").textContent = playerNameGlobal;
            document.getElementById("currentRoleDisplay").textContent = currentCareerName || "Estudiante de primer semestre";
            navigate('dashboard');
        }

        function selectCareer(careerId, careerName) {
            localStorage.setItem(SESSION_KEY_CAREER, careerId);
            localStorage.setItem(SESSION_KEY_CAREER_NAME, careerName);
            currentCareerId = careerId;
            currentCareerName = careerName;
            showMainDashboard();
        }

        async function viewRanking() {
            playSound('soundClick');
            const snapshot = await get(ref(db, "usuarios"));
            const fullListContainer = document.getElementById('full-ranking-list');
            fullListContainer.innerHTML = '';

            if (snapshot.exists()) {
                let ranking = [];
                snapshot.forEach((child) => {
                    const data = child.val();
                    if (data.nombre) {
                        ranking.push({ uid: child.key, nombre: data.nombre, puntaje: data.puntaje || 0 });
                    }
                });

                ranking.sort((a, b) => b.puntaje - a.puntaje);

                ranking.forEach((player, i) => {
                    const isCurrentUser = player.uid === currentUserKey;
                    const baseClasses = "flex justify-between items-center py-3 border-b border-gray-100 rounded-lg px-2";
                    const userClasses = isCurrentUser ? " bg-green-100 font-bold" : "";
                    const userNickname = isCurrentUser ? `Tú (${player.nombre})` : player.nombre;
                    const scoreColor = isCurrentUser ? 'text-yellow-700' : 'text-yellow-600';
                    const rankColor = i === 0 ? 'text-blue-500' : i === 1 ? 'text-green-500' : i === 2 ? 'text-red-500' : 'text-gray-500';

                    const html = `
                        <div class="${baseClasses + userClasses}">
                            <div class="flex items-center">
                                <span class="text-2xl font-extrabold ${rankColor} mr-4 w-6 text-center">#${i + 1}</span>
                                <div class="w-8 h-8 ${isCurrentUser ? 'bg-green-600' : 'bg-gray-200'} rounded-full mr-2"></div>
                                <span class="font-medium ${isCurrentUser ? 'text-gray-900' : 'text-gray-700'}">${userNickname}</span>
                            </div>
                            <span class="text-lg font-bold ${scoreColor}">${player.puntaje} pts</span>
                        </div>
                    `;
                    fullListContainer.insertAdjacentHTML('beforeend', html);
                });
            }
            navigate('ranking');
        }

        async function logout() {
            playSound('soundClick');
            if (userProfileListener) userProfileListener();
            if (notificationsListener) notificationsListener();
            localStorage.removeItem(SESSION_KEY_ID);
            localStorage.removeItem(SESSION_KEY);
            localStorage.removeItem(SESSION_KEY_CAREER);
            localStorage.removeItem(SESSION_KEY_CAREER_NAME);
            Swal.fire({ title: 'Sesión Cerrada', icon: 'info', timer: 1500, showConfirmButton: false });
            setTimeout(() => navigate('login'), 1500);
        }
        
        // ----------------------------------------------------------------------
        // 🔔 NUEVO: LÓGICA DE NOTIFICACIONES
        // ----------------------------------------------------------------------
        
        // NUEVO: Función para generar iniciales a partir de un nombre
        function getInitials(name) {
            if (!name) return '??';
            const nameParts = name.trim().split(' ');
            if (nameParts.length > 1) {
                return (nameParts[0][0] + nameParts[1][0]).toUpperCase();
            }
            return name.substring(0, 2).toUpperCase();
        }

        function startListeningForProfileAndNotifications(playerKey) {
            // --- Listener de Notificaciones ---
            if (notificationsListener) {
                notificationsListener(); // Llama a la función de desuscripción.
                notificationsListener = null;
            }
            processedNotifications.clear();
            let isFirstLoad = true;

            const notificationsRef = ref(db, `usuarios/${playerKey}/notificaciones`);
            notificationsListener = onValue(notificationsRef, (snapshot) => {
                const notifications = snapshot.val();
                renderNotifications(notifications);

                if (notifications) {
                    Object.keys(notifications).forEach(key => {
                        if (!processedNotifications.has(key)) {
                            // Es una notificación nueva
                            processedNotifications.add(key);
                            if (!isFirstLoad) {
                                // Mostrar alerta solo si no es la carga inicial
                                const notif = notifications[key];
                                if (notif.tipo === 'INVITACION_SALA' && !notif.leido) {
                                    Swal.fire({
                                        toast: true,
                                        position: 'top-end',
                                        icon: 'info',
                                        title: `¡Nueva invitación de ${notif.remitente_nombre}!`,
                                        html: `Te ha invitado a la sala <strong>${notif.id_sala}</strong>.`,
                                        showConfirmButton: true,
                                        confirmButtonText: 'Unirse',
                                        timer: 4000, // 4 segundos
                                        timerProgressBar: true,
                                    }).then((result) => { if (result.isConfirmed) { acceptInvitation(key, notif.id_sala); } });
                                } else if (notif.tipo === 'NUEVO_ADUPOST' && !notif.leido) {
                                    Swal.fire({
                                        toast: true,
                                        position: 'top-end',
                                        icon: 'info',
                                        title: `¡Nuevo post de ${notif.remitente_nombre}!`,
                                        html: `<em>"${notif.post_content}"</em>`,
                                        showConfirmButton: false,
                                        timerProgressBar: true,
                                    }).then((result) => { if (result.isConfirmed) { acceptInvitation(key, notif.id_sala); } });
                                    // NUEVO: Animar la campana
                                    const bell = document.getElementById('notification-bell');
                                    if (bell) {
                                        bell.style.animation = 'ring-bell 0.8s ease-in-out';
                                        setTimeout(() => bell.style.animation = '', 800);
                                    }
                                }
                            }
                        }
                    });
                }
                isFirstLoad = false; // Después de la primera ejecución, ya no es la carga inicial
            });

            // --- Listener de Perfil (Avatar y datos) ---
            if (userProfileListener) userProfileListener();
            const profileRef = ref(db, `usuarios/${playerKey}`);

            userProfileListener = onValue(profileRef, (snapshot) => {
                if (snapshot.exists()) {
                    const userData = snapshot.val();
                    // MODIFICADO: Actualizar avatar en el header con iniciales
                    const profileButton = document.getElementById('profile-button');
                    profileButton.innerHTML = getInitials(userData.nombre);
                    
                    // Actualizar datos en la vista de perfil
                    updateProfileView(userData);
                }
            });
        }

        // NUEVO: Función para marcar notificación como leída y redirigir
        async function handleNotificationClick(notificationKey, url) {
            if (!currentUserKey || !notificationKey) {
                if (url) window.location.href = url;
                return;
            }
            const notifRef = ref(db, `usuarios/${currentUserKey}/notificaciones/${notificationKey}/leido`);
            await set(notifRef, true);
            if (url) window.location.href = url;
        }

        function renderNotifications(notifications) {
            const panel = document.getElementById('notification-list');
            const badge = document.getElementById('notification-badge');
            if (!panel || !badge) return;

            if (!notifications) {
                panel.innerHTML = '<p class="p-4 text-sm text-gray-500 text-center">No tienes notificaciones.</p>';
                badge.classList.add('hidden');
                return;
            }

            const notificationKeys = Object.keys(notifications).sort((a, b) => notifications[b].fecha - notifications[a].fecha);
            let unreadCount = 0;
            let html = '';

            notificationKeys.forEach(key => {
                const notif = notifications[key];
                if (!notif.leido) unreadCount++;

                if (notif.tipo === 'INVITACION_SALA') {
                    html += `
                        <div onclick="handleNotificationClick('${key}', null)" class="p-3 border-b hover:bg-gray-50 ${notif.leido ? 'opacity-60' : ''}">
                            <p class="text-sm text-gray-800">
                                <strong>${notif.remitente_nombre}</strong> te ha invitado a la sala <strong class="font-mono">${notif.id_sala}</strong>.
                            </p>
                            <div class="mt-2 text-right">
                                <button onclick="event.stopPropagation(); acceptInvitation('${key}', '${notif.id_sala}')" class="text-xs bg-green-500 text-white font-semibold px-3 py-1 rounded-md hover:bg-green-600">
                                    Aceptar
                                </button>
                            </div>
                        </div>
                    `;
                }
                // NUEVO: Renderizar notificaciones de nuevos documentos
                else if (notif.tipo === 'NUEVO_DOCUMENTO') {
                    html += `
                        <a href="#" onclick="handleNotificationClick('${key}', 'visor_documento.html?id=${notif.id_documento}'); return false;" data-notif-key="${key}" class="notification-item block p-3 border-b hover:bg-gray-50 ${notif.leido ? 'opacity-60' : ''}">
                            <p class="text-sm text-gray-800"><strong class="text-cyan-600">Biblioteca:</strong> Se ha añadido el documento: <strong>${notif.titulo_documento}</strong>.</p>
                        </a>
                    `;
                }
                // NUEVO: Renderizar notificaciones de AduPost
                else if (notif.tipo === 'NUEVO_ADUPOST') {
                    // MODIFICADO: Ahora usa handleNotificationClick
                    html += `
                        <a href="#" onclick="handleNotificationClick('${key}', 'adupost.html?post=${notif.postKey}'); return false;" data-notif-key="${key}" class="notification-item block p-3 border-b hover:bg-gray-50 ${notif.leido ? 'opacity-60' : ''}"><p class="text-sm text-gray-800"><strong class="text-green-600">AduPost:</strong> <strong>${notif.remitente_nombre || 'Usuario'}</strong> publicó: <em>"${notif.post_content || 'nuevo contenido'}"</em></p></a>
                    `;
                } else if (notif.tipo === 'NUEVA_REACCION') {
                    // NUEVO: Renderizar notificaciones de reacción
                    // MODIFICADO: Ahora usa handleNotificationClick
                    html += `
                        <a href="#" onclick="handleNotificationClick('${key}', 'adupost.html?post=${notif.postKey}'); return false;" data-notif-key="${key}" class="notification-item block p-3 border-b hover:bg-gray-50 ${notif.leido ? 'opacity-60' : ''}"><p class="text-sm text-gray-800"><strong class="text-green-600">AduPost:</strong> <strong>${notif.remitente_nombre || 'Alguien'}</strong> reaccionó a tu publicación: <em>"${notif.post_content || ''}"</em></p></a>
                    `;
                }
                // NUEVO: Renderizar notificaciones de bonus de AduCoins
                else if (notif.tipo === 'BONUS_ADUCOINS') {
                    html += `
                        <div class="p-3 border-b hover:bg-gray-50 ${notif.leido ? 'opacity-60' : ''}"><p class="text-sm text-gray-800"><strong class="text-amber-600">¡Felicidades!</strong> El profesor <strong>${notif.remitente_nombre}</strong> te ha premiado con <strong class="font-mono">${notif.cantidad} AduCoins</strong> por tu publicación.</p></div>
                    `;
                }
            });

            panel.innerHTML = html || '<p class="p-4 text-sm text-gray-500 text-center">No tienes notificaciones.</p>';
            badge.classList.toggle('hidden', unreadCount === 0);
        }

        function toggleNotifications() {
            playSound('soundClick');
            document.getElementById('notification-panel').classList.toggle('hidden');
        }

        function toggleProfileMenu() {
            playSound('soundClick');
            document.getElementById('profile-menu').classList.toggle('hidden');
        }

        // --- NUEVO: Lógica de Perfil y Avatares ---
        function updateProfileView(userData) {
            // MODIFICADO: Usar iniciales en lugar de imagen
            document.getElementById('profile-avatar-initials').textContent = getInitials(userData.nombre);
            document.getElementById('profile-name').textContent = userData.nombre || 'Usuario';
            document.getElementById('profile-score').textContent = userData.puntaje || 0;
            document.getElementById('profile-missions').textContent = userData.misiones_completadas || 0;
            
            const progress = userData.progreso_entrenamiento || 0;
            const progressBar = document.getElementById('profile-training-bar');
            if (progressBar) {
                progressBar.style.width = `${progress}%`;
                progressBar.textContent = `${Math.round(progress)}%`;
            }
        }

        async function acceptInvitation(notificationKey, roomId) {
            // 1. Obtener la referencia a la notificación completa
            const notifRef = ref(db, `usuarios/${currentUserKey}/notificaciones/${notificationKey}`);
            
            // CORRECCIÓN: Obtener los datos de la notificación ANTES de usarla
            const notifSnapshot = await get(notifRef);
            if (!notifSnapshot.exists()) {
                Swal.fire('Error', 'No se pudo encontrar la invitación.', 'error');
                return;
            }
            const notification = notifSnapshot.val(); // Ahora la variable 'notification' está definida

            // Marcar la notificación como leída
            await update(notifRef, { leido: true });

            // 2. Cerrar el panel de notificaciones
            document.getElementById('notification-panel').classList.add('hidden');

            // 3. Redirigir al usuario a la sala de espera
            const groupId = notification.id_grupo || ''; // Ahora esto funciona
            Swal.fire({
                title: 'Uniéndote a la Sala...',
                text: `Redirigiendo a la sala ${roomId}.`,
                icon: 'info',
                timer: 1500,
                showConfirmButton: false,
                didClose: () => {
                    // MODIFICADO: Pasamos el ID de la sala y el ID del grupo
                    window.location.href = `sala_espera.html?joinRoomId=${roomId}&groupId=${groupId}`;
                }
            });
        }

        async function markNotificationAsRead(notificationKey) {
            if (!currentUserKey || !notificationKey) return;
            const notifRef = ref(db, `usuarios/${currentUserKey}/notificaciones/${notificationKey}/leido`);
            await set(notifRef, true);
            // Opcional: cerrar el panel después de hacer clic
            document.getElementById('notification-panel').classList.add('hidden');
        }

        window.toggleNotifications = toggleNotifications;
        window.toggleProfileMenu = toggleProfileMenu;
        window.acceptInvitation = acceptInvitation;
        // ----------------------------------------------------------------------
        // 🎯 OTRAS FUNCIONES (Ranking, Audio, Juegos)
        // ----------------------------------------------------------------------
        function openGame(gameFile) {
            if (!playerNameGlobal || !currentUserKey) {
                Swal.fire('Acceso Denegado', 'Debes iniciar sesión para acceder a las actividades.', 'warning');
                return;
            }
            
            if (gameFile === 'sala_espera.html') {
                window.location.href = `sala_espera.html`; 
            } else {
                // CORRECCIÓN: Pasamos el playerKey a todos los juegos individuales
                window.location.href = `${gameFile}?playerKey=${currentUserKey}&playerName=${encodeURIComponent(playerNameGlobal)}`;
            }
        }
        
        // ----------------------------------------------------------------------
        // 🚀 INICIALIZACIÓN Y EXPORTACIÓN DE FUNCIONES
        // ----------------------------------------------------------------------
        
        // LÓGICA CORREGIDA DEL SPLASH SCREEN (Mostrar solo una vez por sesión de navegador)
        document.addEventListener('DOMContentLoaded', () => {
            // --- NUEVO: Lógica de inicialización con onAuthStateChanged ---
            // 1. Mostrar pantalla de carga
            const loadingScreen = document.getElementById('loading-screen');
            loadingScreen.classList.remove('hidden');
            document.getElementById('loading-text').textContent = 'Conectando...';

            // 2. Esperar a que la conexión con la base de datos esté activa
            const connectedRef = ref(db, '.info/connected');
            onValue(connectedRef, (snap) => {
                if (snap.val() === true) {
                    console.log("Conectado a Firebase Realtime Database.");

                    // Una vez conectados, habilitamos el botón de login
                    const loginBtn = document.getElementById('login-btn');
                    if (loginBtn) {
                        loginBtn.disabled = false;
                        loginBtn.textContent = 'Entrar';
                        loginBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                        loginBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                    }

                    // Y ahora sí, procedemos a verificar la sesión
                    checkSession();

                } else {
                    console.log("Desconectado de Firebase Realtime Database.");
                    // Opcional: podrías mostrar un mensaje de error si la desconexión persiste.
                }
            }, (error) => {
                // Manejar errores de conexión a la base de datos
                console.error("Error al verificar conexión de DB:", error);
                Swal.fire('Error Crítico', 'No se pudo conectar a la base de datos. Por favor, recarga la página.', 'error');
                loadingScreen.classList.add('hidden');
                navigate('login');
            });

            // --- NUEVO: Centralización de Event Listeners ---
            const loginBtn = document.getElementById('login-btn');
            if (loginBtn) {
                loginBtn.addEventListener('click', login);
            }

            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', logout);
            }

            document.querySelectorAll('[data-view]').forEach(button => {
                button.addEventListener('click', () => {
                    const viewId = button.dataset.view;
                    if (viewId === 'ranking') viewRanking();
                    else navigate(viewId);
                });
            });

            document.querySelectorAll('[data-game]').forEach(button => {
                button.addEventListener('click', () => openGame(button.dataset.game));
            });
            
            // 🛠️ PWA / SERVICE WORKER REGISTRATION (Mantengo el bloque original)
             if ('serviceWorker' in navigator) {
                 window.addEventListener('load', () => {
                     navigator.serviceWorker.register('/beta/sw.js', { scope: '/beta/' }) 
                         .then(registration => {
                             console.log('Service Worker registrado con éxito. Scope:', registration.scope);
                         })
                         .catch(registrationError => {
                             console.log('Fallo el registro del Service Worker:', registrationError);
                         });
                 });
             }
        });

        // Exportación de funciones globales para que funcionen con los atributos 'onclick' del HTML
        window.login = login;
        window.logout = logout;
        window.viewRanking = viewRanking;
        window.openGame = openGame;
        // MODIFICADO: Añadimos las funciones que estaban en onclicks al scope global
        // para asegurar compatibilidad con otras partes del código que puedan usarlas.
        window.handleNotificationClick = handleNotificationClick;
        window.playSound = playSound;
        window.navigate = navigate;
        window.showMainDashboard = showMainDashboard;
    </script>
</body>
</html>
