<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADUCHAT - Asesor Aduanero</title>
    
    <link rel="manifest" href="./manifest.json">
    <meta name="mobile-web-app-capable" content="yes"> 
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#10b981">
    <link rel="apple-touch-icon" href="./logo.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        /* Animaci√≥n de entrada de pantalla */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        
        /* --- NUEVO SPLASH SCREEN --- */
        @keyframes wave {
            0% { transform: scaleX(0); } /* Inicia cerrado */
            50% { transform: scaleX(1); } /* Se expande para cubrir la pantalla */
            100% { transform: scaleX(1); } /* Permanece cubriendo la pantalla */
        }
        @keyframes textFadeIn {
            0%, 50% { opacity: 0; transform: translateY(20px); } /* El texto espera a que la onda pase */
            100% { opacity: 1; transform: translateY(0); }
        }
        #splashScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: white; /* Inicia en blanco */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: background-color 1s ease-in-out, opacity 0.5s ease-out;
        }
        
        #splashLogo {
            position: absolute;
            width: 100%;
            height: 100%;
            background-color: #20c781; /* Verde */
            transform-origin: left;
            animation: wave 1.8s cubic-bezier(0.77, 0, 0.175, 1) forwards; /* Animaci√≥n m√°s r√°pida */
        }

        #splashText {
            font-size: 3rem;
            color: white;
            font-weight: bold;
            letter-spacing: 2px;
            opacity: 0; /* Inicialmente oculto */
            animation: textFadeIn 1.8s forwards;
            z-index: 1001;
        }

        /* --- NUEVO: Microinteracci√≥n de Clic --- */
        .clickable-card {
            @apply transition-transform duration-150;
        }
        .clickable-card:active {
            @apply transform scale-[0.97];
        }

        /* --- NUEVO: Transici√≥n para el panel de notificaciones --- */
        #notification-panel {
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        #notification-panel.hidden {
            opacity: 0;
            transform: translateY(-10px);
        }
    </style>
</head>
<body class="bg-green-50 font-sans text-gray-800">

    <audio id="logoSound" src="/beta/start.mp3" preload="auto"></audio>
    <audio id="soundClick" src="/beta/click.mp3" preload="auto"></audio>
    <audio id="soundLogin" src="/beta/login.mp3" preload="auto"></audio>

    <div id="splashScreen">
        <div id="splashLogo"></div>
        <div id="splashText" class="text-4xl font-extrabold">
            ADUWEB
        </div>
    </div>


    <div id="loginScreen" class="min-h-screen flex items-center justify-center bg-green-50 hidden">
        <div class="bg-white p-10 rounded-xl shadow-2xl w-full max-w-md space-y-6">
            <div class="text-center">
                <h1 class="text-4xl font-extrabold text-green-700">ADUWEB</h1>
                <p class="mt-2 text-gray-600">Simulador de Agente Aduanero Colaborativo</p>
            </div>
            
            <div class="space-y-4">
                <input type="text" id="userName" placeholder="Ingresa tu primer nombre (Ej: Andr√©s)" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-lg">
                <button onclick="login()" class="w-full p-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition">
                    Entrar
                </button>
            </div>

            <div class="text-center text-sm text-gray-500">
                <p>Usa el nombre que te fue asignado para cargar tu perfil y progreso.</p>
            </div>
        </div>
    </div>
    
    <!-- MODIFICADO: Pantalla de Bienvenida e Informaci√≥n (antes era careerSelectionScreen) -->
    <div id="welcomeScreen" class="min-h-screen p-8 bg-green-50 hidden">
        <div class="max-w-5xl mx-auto text-center">
            <h1 class="text-4xl font-extrabold text-gray-900 mb-3">
                ¬°Bienvenido a <span class="text-green-700">ADUWEB</span>!
            </h1>
            <p class="text-xl text-gray-600 mb-10">Tu plataforma de entrenamiento en Comercio Exterior.</p>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 text-left">
                <!-- Columna 1: Gu√≠as y Planes -->
                <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-blue-500">
                    <h3 class="text-xl font-bold text-blue-800 mb-3">üöÄ Gu√≠as y Planes</h3>
                    <ul class="space-y-2 text-sm text-gray-700 list-disc list-inside">
                        <li>Completa las misiones individuales para ganar experiencia.</li>
                        <li>√önete al simulador "La Merca" para una experiencia colaborativa.</li>
                        <li>Elige un rol en tu perfil para personalizar las misiones.</li>
                        <li>Invita a tus compa√±eros y compite en el ranking.</li>
                    </ul>
                </div>

                <!-- Columna 2: Futuras Versiones -->
                <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-purple-500">
                    <h3 class="text-xl font-bold text-purple-800 mb-3">üîÆ Futuras Versiones</h3>
                    <ul class="space-y-2 text-sm text-gray-700 list-disc list-inside">
                        <li>Nuevos casos de estudio para "La Merca".</li>
                        <li>Sistema de progresi√≥n con rangos e insignias.</li>
                        <li>Modo de juego "Auditor√≠a" para revisar partidas pasadas.</li>
                        <li>Integraci√≥n de m√°s roles y tareas complejas.</li>
                    </ul>
                </div>

                <!-- Columna 3: √öltimos Lanzamientos -->
                <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-yellow-500">
                    <h3 class="text-xl font-bold text-yellow-800 mb-3">‚ú® √öltimos Lanzamientos</h3>
                    <ul class="space-y-2 text-sm text-gray-700 list-disc list-inside">
                        <li><strong>v1.2:</strong> Sistema de invitaciones y notificaciones.</li>
                        <li><strong>v1.1:</strong> Panel de control para profesores.</li>
                        <li><strong>v1.0:</strong> Lanzamiento del simulador "La Merca".</li>
                    </ul>
                </div>
            </div>

            <button onclick="playSound('soundClick'); showMainDashboard();" class="mt-12 bg-green-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-green-700 transition shadow-lg text-lg">
                Continuar al Dashboard
            </button>
        </div>
    </div>

    <!-- NUEVO: Pantalla para Cambiar de Rol -->
    <div id="roleChangeScreen" class="min-h-screen p-8 bg-green-50 hidden">
        <div class="max-w-6xl mx-auto">
            <h1 class="text-3xl font-extrabold text-gray-900 mb-2 flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-green-600"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path></svg>
                Elige tu Nuevo Cargo
            </h1>
            <p class="text-xl text-gray-600 mb-8">Selecciona el rol que quieres desempe√±ar en las pr√≥ximas simulaciones.</p>

            <div id="careerListContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Las tarjetas de roles se insertar√°n aqu√≠ din√°micamente -->
            </div>
        </div>
    </div>

    <div id="mainScreen" class="min-h-screen bg-green-50 hidden">
        
        <!-- NUEVO HEADER ESTANDARIZADO -->
        <header class="bg-white py-4 px-6 shadow-md sticky top-0 z-20 border-b">
            <div class="max-w-7xl mx-auto flex justify-between items-center">
                <div class="flex items-center gap-4">
                    <span class="text-2xl font-extrabold text-green-700">ADUWEB</span>
                    <span class="text-sm font-light text-gray-500 hidden sm:block">| Portal Educativo</span>
                </div>
                <div class="flex items-center space-x-4 relative">
                    <span id="headerPlayerName" class="text-gray-700 font-semibold text-sm hidden md:block"></span>
                    
                    <!-- NUEVO: Icono de Notificaciones -->
                    <div id="notification-bell" class="relative cursor-pointer" onclick="toggleNotifications()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-600 hover:text-blue-600"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>
                        <span id="notification-badge" class="absolute -top-1 -right-1 h-3 w-3 rounded-full bg-red-500 border-2 border-white hidden"></span>
                    </div>

                    <button onclick="logout()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-semibold transition">
                        Salir
                    </button>

                    <!-- NUEVO: Panel de Notificaciones (Oculto) -->
                    <div id="notification-panel" class="hidden absolute top-full right-0 mt-2 w-80 bg-white rounded-lg shadow-xl border z-30 origin-top-right">
                        <div class="p-3 font-bold text-gray-800 border-b">Notificaciones</div>
                        <div id="notification-list" class="max-h-96 overflow-y-auto">
                            <!-- Las notificaciones se insertar√°n aqu√≠ -->
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <main class="max-w-7xl mx-auto p-6 md:p-10">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                
                <div class="lg:col-span-1 space-y-6">
                    <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-blue-500">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-600"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                            Perfil de Asesor
                        </h2>
                        <p class="text-3xl font-extrabold text-blue-600 mb-1" id="playerName">Nombre de Jugador</p>
                        <p class="text-lg text-gray-600" id="currentRoleDisplay">Analista de Comercio Exterior</p>
                        
                        <!-- <div class="mt-4 pt-4 border-t">
                            <button onclick="playSound('soundClick'); showWelcomeScreen();" class="w-full p-2 bg-yellow-500 text-white font-semibold rounded-lg hover:bg-yellow-600 transition text-sm">
                                Info Version 
                            </button>
                        </div> -->
                    </div>
                    
                    <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-purple-500">
                        <h3 class="text-xl font-bold text-gray-800 mb-3 flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-purple-600"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline></svg>
                            Progreso Global
                        </h3>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">Puntaje Total (EXP):</span>
                                <span class="text-2xl font-extrabold text-purple-600" id="playerScore">0</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">Puntaje Promedio / Misi√≥n:</span>
                                <span class="text-xl font-bold text-blue-600" id="playerAvgScore">0</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">Simulaciones Completadas:</span>
                                <span class="text-xl font-bold text-green-600" id="playerProgress">0</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">Progreso Entrenamiento:</span>
                                <div class="w-1/2 bg-gray-200 rounded-full h-4">
                                    <div id="training-progress-bar" class="bg-purple-600 h-4 rounded-full" style="width: 0%;"></div>
                                </div>
                            </div>
                            <div class="text-right -mt-2">
                                <span id="training-progress-percentage" class="text-xs font-bold text-purple-700">0%</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">Posici√≥n en Ranking:</span>
                                <button onclick="playSound('soundClick'); viewRanking();" class="text-blue-500 font-semibold hover:underline flex items-center gap-1">
                                    Ver Ranking
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-yellow-500"><circle cx="12" cy="8" r="7"></circle><polyline points="8.21 13.89 7 22 17 22 15.79 13.89"></polyline></svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-2 space-y-6">
                    
                    <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-green-500">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4 flex justify-between items-center gap-2">
                            <span class="flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-green-600"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
                                Plan de Formaci√≥n
                            </span>
                        </h2>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- Tarjeta 1: Partidas en L√≠nea -->
                            <div id="online-match-container" class="relative md:col-span-2">
                                <div id="online-match-card" onclick="openGame('sala_espera.html')" class="p-6 bg-green-600 text-white rounded-xl transition duration-300 shadow-lg clickable-card flex items-center gap-4">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                                    <div>
                                        <h3 class="text-xl font-bold">Partidas en L√≠nea</h3>
                                        <p class="text-sm opacity-90 mt-1">Compite en simulaciones multijugador.</p>
                                    </div>
                                </div>
                                <div id="online-match-lock-overlay" class="hidden absolute inset-0 bg-gray-800 bg-opacity-80 rounded-xl flex flex-col items-center justify-center text-center p-4 cursor-not-allowed">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
                                    <p class="text-white font-bold mt-2">Modo Multijugador Bloqueado</p>
                                    <p id="unlock-requirement-text" class="text-xs text-gray-300 mt-1">Completa y califica todos los juegos de pr√°ctica para desbloquear.</p>
                                </div>
                            </div>
                            
                            <!-- Tarjeta 2: Centro de Juegos -->
                            <div id="practice-games-container" class="relative">
                                <div id="practice-games-card" onclick="window.location.href='adugame_templates.html'" class="p-6 bg-white rounded-xl border border-gray-200 hover:bg-gray-50 hover:border-gray-400 transition duration-300 cursor-pointer shadow-md clickable-card flex items-center gap-4">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-purple-600"><path d="M6 9l6 6 6-6"></path></svg>
                                    <div>
                                        <h3 class="text-xl font-bold text-gray-800">Centro de Juegos</h3>
                                        <p class="text-sm text-gray-600 mt-1">Practica con juegos individuales.</p>
                                    </div>
                                </div>
                                <div id="practice-games-lock-overlay" class="hidden absolute inset-0 bg-gray-800 bg-opacity-80 rounded-xl flex flex-col items-center justify-center text-center p-4 cursor-not-allowed">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
                                    <p class="text-white font-bold mt-2">Centro de Juegos Bloqueado</p>
                                    <p class="text-xs text-gray-300 mt-1">Completa el 50% de la Ruta de Aprendizaje para desbloquear.</p>
                                </div>
                            </div>

                            <!-- Tarjeta 3: Ruta de Aprendizaje -->
                            <div onclick="openGame('icogame.html')" class="p-6 bg-white rounded-xl border border-gray-200 hover:bg-gray-50 hover:border-gray-400 transition duration-300 cursor-pointer shadow-md clickable-card flex items-center gap-4 md:col-span-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-600"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                                <div>
                                    <h3 class="text-xl font-bold text-gray-800">Ruta de Aprendizaje</h3>
                                    <p class="text-sm text-gray-600 mt-1">Completa m√≥dulos te√≥ricos y evaluaciones.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-yellow-500">
                        <h3 class="text-xl font-bold text-gray-800 mb-3 flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-yellow-600"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                            √öltima Actividad
                        </h3>
                        <div id="lastActivityContainer">
                            <p class="text-gray-500">A√∫n no has completado ninguna simulaci√≥n.</p>
                        </div>
                        <button onclick="playSound('soundClick'); viewHistory();" class="text-sm text-blue-600 font-semibold hover:underline mt-3">
                            Ver historial completo
                        </button>
                    </div>

                    <div onclick="window.location.href='panel_estadistico.html'" class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-indigo-500 cursor-pointer hover:shadow-xl transition">
                        <h3 class="text-xl font-bold text-gray-800 mb-3 flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-indigo-600"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"></path><path d="M22 12A10 10 0 0 0 12 2v10z"></path></svg>
                            An√°lisis de Partidas
                        </h3>
                        <p class="text-sm text-gray-600">Revisa los resultados, puntajes y gr√°ficos de rendimiento de las simulaciones completadas.</p>
                    </div>

                    <!-- NUEVO: Biblioteca de Documentos -->
                    <div onclick="window.location.href='biblioteca.html'" class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-cyan-500 cursor-pointer hover:shadow-xl transition">
                        <h3 class="text-xl font-bold text-gray-800 mb-3 flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-cyan-600"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path></svg>
                            Biblioteca de Documentos
                        </h3>
                        <p class="text-sm text-gray-600">Accede a gu√≠as, manuales y casos de estudio en formato Word compartidos por tu instructor.</p>
                    </div>

                </div>
            </div>
        </main>
    </div>

    <div id="rankingScreen" class="min-h-screen p-8 bg-green-50 hidden">
        <div class="max-w-4xl mx-auto bg-white p-8 rounded-xl shadow-2xl border">
            <button onclick="playSound('soundClick'); backToMain();" class="text-blue-500 hover:text-blue-700 mb-4 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-1"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
                Volver al Dashboard
            </button>
            <h1 class="text-3xl font-extrabold text-gray-900 mb-6 flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-yellow-500"><circle cx="12" cy="8" r="7"></circle><polyline points="8.21 13.89 7 22 17 22 15.79 13.89"></polyline></svg>
                Ranking de Asesores</h1>

            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200 border border-gray-200 rounded-lg">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pos.</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estudiante</th>
                            <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Misiones</th>
                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Puntaje (EXP)</th>
                        </tr>
                    </thead>
                    <tbody id="rankingTable" class="bg-white divide-y divide-gray-200">
                        </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <div id="tutorialModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-xl max-w-2xl w-full p-8 shadow-2xl animate-fade-in">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Gu√≠a de Inicio R√°pido: ADUWEB</h2>
            <p class="text-gray-600 mb-6">Esta secci√≥n te guiar√° en los objetivos de cada tipo de simulaci√≥n.</p>
            
            <ul class="list-disc pl-5 space-y-3 text-gray-700">
                <li><strong class="text-green-600">Simulador "La Merca" (Colaborativo):</strong> Objetivo: Resolver un caso de Importaci√≥n o Exportaci√≥n en equipo. Cada uno, seg√∫n su cargo, debe completar una tarea para desbloquear el paso del siguiente compa√±ero. ¬°El tiempo cuenta!</li>
                <li><strong class="text-yellow-600">IcoGame:</strong> Objetivo: Responder preguntas de selecci√≥n m√∫ltiple sobre Incoterms y aranceles. Ganas puntos de experiencia si respondes r√°pido y correctamente.</li>
            </ul>

            <button onclick="playSound('soundClick'); hideTutorialGuide();" class="mt-6 w-full p-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition">
                Entendido, ¬°A Empezar!
            </button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-app.js"; // Firebase App (core)
        import { getDatabase, ref, get, update, onValue, off, set } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-database.js"; // Firebase Realtime Database
        import { playSound } from "./utils.js";
        import { firebaseConfig, CAREER_ROLES } from "./config.js"; // Importar configuraci√≥n y roles

        // üîë CONSTANTES DE SESI√ìN
        const SESSION_KEY = 'aduweb_player_name';
        const SESSION_KEY_ID = 'aduweb_player_key';
        const SESSION_KEY_CAREER = 'aduweb_career'; ¬† ¬† ¬† // Clave para el ID del cargo
        const SESSION_KEY_CAREER_NAME = 'aduweb_career_name'; // Clave para el nombre del cargo
        const TOTAL_MODULES_REQUIRED = 5; // N√∫mero total de m√≥dulos en icogame.html
        // NOTE: SESSION_KEY_SPLASH is defined but not currently used in the splash screen logic.
        const SESSION_KEY_SPLASH = 'aduweb_splash_shown'; 

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let currentUserKey = null;
        let playerNameGlobal = "";
        let currentCareerId = null; ¬† ¬† // Estado en memoria del ID del cargo
        let currentCareerName = null; ¬† // Estado en memoria del Nombre del cargo
        
        let notificationsListener = null; // Listener para notificaciones
        let processedNotifications = new Set(); // NUEVO: Para rastrear notificaciones ya mostradas


        // ----------------------------------------------------------------------
        // üîÑ FUNCIONES DE VISTAS (SCREEN SWITCHING)
        // ----------------------------------------------------------------------
        
        // Funci√≥n general para cambiar de pantalla
        function showScreen(screenId) {
            // Oculta todas las pantallas principales
            const screens = ["loginScreen", "mainScreen", "rankingScreen", "welcomeScreen", "tutorialModal", "roleChangeScreen"];
            screens.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                     element.classList.add("hidden");
                }
            });
            // Muestra la pantalla solicitada
            const screen = document.getElementById(screenId);
            if (screen) {
                screen.classList.remove("hidden");
                screen.classList.add("animate-fade-in");
            }
        }

        // MODIFICADO: Esta funci√≥n ahora muestra la pantalla para cambiar de rol
        function showWelcomeScreen() {
            showScreen("welcomeScreen");
        }

        // Muestra el Dashboard principal de la carrera
        function showMainDashboard() {
            // Updates the UI with the selected role information
            document.getElementById("playerName").textContent = playerNameGlobal.split(' ')[0]; // Solo el primer nombre
            document.getElementById("currentRoleDisplay").textContent = "Estudiante en Formaci√≥n"; // Rol fijo
            document.getElementById("headerPlayerName").textContent = `Estudiante: ${playerNameGlobal}`;
            // document.getElementById("playerRoleTitle").textContent = currentCareerName || 'Asesor'; // Ya no es necesario

            showScreen("mainScreen");
        }

        // --- NUEVO: L√≥gica para el modal de tutorial ---
        function showTutorialGuide() {
            const modal = document.getElementById('tutorialModal');
            if (modal) {
                modal.classList.remove('hidden');
            }
        }

        function hideTutorialGuide() {
            const modal = document.getElementById('tutorialModal');
            if (modal) {
                modal.classList.add('hidden');
            }
        }

        // --- NUEVO: L√≥gica para seleccionar y renderizar roles ---

        // Funci√≥n llamada al hacer click en una carrera
        function selectCareer(careerId, careerName) {
            localStorage.setItem(SESSION_KEY_CAREER, careerId);
            localStorage.setItem(SESSION_KEY_CAREER_NAME, careerName);
            currentCareerId = careerId;
            currentCareerName = careerName;
            
            // Va al dashboard despu√©s de seleccionar
            showMainDashboard();
        }

        // Renderiza las 11 tarjetas de carrera
        function renderCareerList() {
            const listContainer = document.getElementById('careerListContainer');
            if (!listContainer) return;
            
            listContainer.innerHTML = CAREER_ROLES.map(role => `
                <button onclick="playSound('soundClick'); selectCareer('${role.id}', '${role.name}');" class="bg-white p-5 rounded-xl shadow-lg border-b-4 border-green-500 hover:shadow-xl hover:bg-green-50 transition duration-300 text-left flex flex-col justify-between h-full w-full">
                    <h4 class="text-xl font-extrabold text-gray-800 mb-1 flex items-center gap-2">
                        üíº ${role.name}
                    </h4>
                    <p class="text-sm text-gray-600">${role.desc}</p>
                </button>
            `).join('');
        }

        // ----------------------------------------------------------------------
        // üíæ FUNCIONES DE PROGRESO Y GUARDADO DE SESI√ìN
        // ----------------------------------------------------------------------

        /**
         * Recopila el estado actual del usuario y lo guarda en Firebase
         * como parte del historial de sesi√≥n y el √∫ltimo estado conocido.
         */
        async function saveUserProgress() {
            if (!currentUserKey) {
                return true; 
            }
            
            // 1. Recopilar Datos de la Sesi√≥n Actual
            const userProgressData = {
                careerId: localStorage.getItem(SESSION_KEY_CAREER) || 'N/A',
                careerName: localStorage.getItem(SESSION_KEY_CAREER_NAME) || 'Sin Rol',
                lastMissionCompleted: "Misi√≥n 3: Verificaci√≥n de Regulaciones (Simulado)", // Ejemplo de dato
                simulatorTaskPending: "An√°lisis de Ajustes al Valor (Pendiente)", // Ejemplo de dato
                sessionEndTime: new Date().toISOString(),
                scoreSnapshot: parseInt(document.getElementById("playerScore").textContent) || 0,
                misionsCompletedSnapshot: document.getElementById("playerProgress").textContent || "0/6",
            };

            // 2. Definir la nueva estructura de datos a enviar a Firebase
            const updates = {};
            const historyRef = `usuarios/${currentUserKey}/sessionHistory`;
            const lastStateRef = `usuarios/${currentUserKey}/lastKnownState`;
            
            // Generar una clave √∫nica para el historial (timestamp)
            const newHistoryKey = Date.now();
            
            // Guardar el registro en el historial
            updates[`${historyRef}/${newHistoryKey}`] = userProgressData;
            // Guardar el estado actual como la √∫ltima sesi√≥n conocida para la carga r√°pida
            updates[lastStateRef] = userProgressData;

            try {
                await update(ref(db), updates);
                return true; // Guardado exitoso
            } catch (error) {
                console.error("Error al guardar el progreso en Firebase:", error);
                return false; // Error en el guardado
            }
        }


        /**
         * üì§ LOGOUT - Modificada para preguntar si desea guardar el progreso con animaciones.
         */
        async function logout() {
            playSound("soundClick");

            const result = await Swal.fire({
                title: '¬øQuieres guardar tu progreso?',
                text: "Guardaremos tu rol, puntaje y tareas pendientes para continuar despu√©s.",
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#10b981', // Verde
                cancelButtonColor: '#ef4444', ¬†// Rojo
                confirmButtonText: 'S√≠, Guardar y Salir',
                cancelButtonText: 'No Guardar y Salir'
            });

            // Proceso de Cierre de Sesi√≥n
            if (result.isConfirmed) {
                // --- INICIA ANIMACI√ìN DE CARGA ---
                const loadingSwal = Swal.fire({
                    title: 'Guardando Progreso...',
                    html: 'Por favor, espera mientras actualizamos tu historial.',
                    timerProgressBar: true,
                    didOpen: () => {
                        Swal.showLoading();
                    },
                    allowOutsideClick: false,
                    allowEscapeKey: false
                });

                // Llama a la funci√≥n de guardado
                const success = await saveUserProgress();

                loadingSwal.close();
                
                if (success) {
                    // --- ANIMACI√ìN DE LISTO ---
                    await Swal.fire({
                        title: '¬°Guardado Completo!',
                        text: 'Tu progreso ha sido salvado en la nube.',
                        icon: 'success',
                        showConfirmButton: false,
                        timer: 1500
                    });
                } else {
                    await Swal.fire({
                        title: 'Error de Guardado',
                        text: 'Hubo un error al guardar. Revisa tu conexi√≥n. Saliendo sin guardar.',
                        icon: 'error',
                        confirmButtonText: 'Entendido'
                    });
                }
            }

            // NUEVO: Limpiar cualquier sesi√≥n de juego activa al cerrar sesi√≥n.
            const activeGames = await findActiveGamesForPlayer(currentUserKey);
            if (activeGames.length > 0) await removePlayerFromAllRooms(currentUserKey, activeGames);

            // NUEVO: Detener el listener de notificaciones
            // CORRECCI√ìN: onValue devuelve una funci√≥n de desuscripci√≥n que debe ser llamada directamente.
            if (notificationsListener) {
                notificationsListener(); // Llamar a la funci√≥n para desuscribirse.
                notificationsListener = null; // Limpiar la variable.
                processedNotifications.clear(); // Limpiar el set de notificaciones procesadas
            }
            
            // 3. Limpieza de Sesi√≥n Local
            localStorage.removeItem(SESSION_KEY);
            localStorage.removeItem(SESSION_KEY_ID);
            localStorage.removeItem(SESSION_KEY_CAREER); ¬† ¬† ¬† 
            localStorage.removeItem(SESSION_KEY_CAREER_NAME); ¬†
            // üõë Limpiar la bandera del splash screen para que se muestre al pr√≥ximo ingreso
            localStorage.removeItem(SESSION_KEY_SPLASH); 

            currentUserKey = null;
            playerNameGlobal = "";
            currentCareerId = null;
            currentCareerName = null;

            showScreen("loginScreen");
            document.getElementById("userName").value = "";

            // Muestra una alerta simple de cierre si el usuario NO eligi√≥ guardar.
            if (!result.isConfirmed) {
                 Swal.fire({
                    title: 'Sesi√≥n Cerrada',
                    text: 'Tu progreso actual no fue guardado.',
                    icon: 'info',
                    timer: 2000,
                    showConfirmButton: false
                });
            }
        }
        
        // ----------------------------------------------------------------------
        // üöÄ INICIO DE SESI√ìN Y RUTAS
        // ----------------------------------------------------------------------

        // Funci√≥n central para cargar datos y decidir la ruta (Login/Selecci√≥n/Dashboard)
        function loadUserDataAndRoute(data) {
            playerNameGlobal = data.nombre;
            currentUserKey = data.key;
            
            // NUEVO: Priorizar la carga de la carrera desde el √∫ltimo estado conocido en Firebase
            const lastState = data.lastKnownState;
            
            if (lastState && lastState.careerId) {
                currentCareerId = lastState.careerId;
                currentCareerName = lastState.careerName;
                
                // Actualizar localStorage para reflejar el estado de Firebase
                localStorage.setItem(SESSION_KEY_CAREER, currentCareerId);
                localStorage.setItem(SESSION_KEY_CAREER_NAME, currentCareerName);
                
                // --- L√ìGICA DE C√ÅLCULO DE PROGRESO ---
                const totalScore = data.puntaje || 0;
                const missionsCompleted = data.misiones_completadas || 0;
                const gameHistory = data.gameHistory ? Object.values(data.gameHistory) : [];

                document.getElementById("playerScore").textContent = totalScore;
                document.getElementById("playerProgress").textContent = `${missionsCompleted}`;

                // Calcular y mostrar puntaje promedio
                const avgScore = missionsCompleted > 0 ? Math.round(totalScore / missionsCompleted) : 0;
                document.getElementById("playerAvgScore").textContent = avgScore;

                // --- ¬°NUEVO! Cargar y mostrar el progreso de entrenamiento ---
                const trainingProgress = data.progreso_entrenamiento || 0;
                const trainingProgressBar = document.getElementById("training-progress-bar");
                const trainingProgressPercentage = document.getElementById("training-progress-percentage");
                trainingProgressBar.style.width = `${trainingProgress}%`;
                trainingProgressPercentage.textContent = `${Math.round(trainingProgress)}%`;

                // --- ¬°NUEVO! L√≥gica de desbloqueo de Partidas en L√≠nea ---
                const modulesCompleted = data.progreso_modulos_count || 0;
                checkPracticeGamesUnlock(modulesCompleted);
                checkOnlineMatchUnlock(modulesCompleted, data.lastKnownState?.careerId);

                // Mostrar √∫ltima actividad
                const lastActivityContainer = document.getElementById("lastActivityContainer");
                if (gameHistory.length > 0) {
                    const lastGame = gameHistory.sort((a, b) => b.date - a.date)[0];
                    const gameDate = new Date(lastGame.date).toLocaleDateString();
                    const resultClass = lastGame.result === 'success' ? 'text-green-600' : 'text-red-600';
                    lastActivityContainer.innerHTML = `
                        <p class="text-lg text-gray-700">Simulaci√≥n en sala <strong class="font-mono">${lastGame.roomId}</strong>.</p>
                        <p class="text-sm mt-1">Finalizada el ${gameDate} con un puntaje de <strong class="text-blue-700">${lastGame.score}</strong> pts.</p>
                        <p class="text-sm font-semibold ${resultClass} mt-2">Resultado: ${lastGame.result.toUpperCase()}</p>
                    `;
                } else {
                    lastActivityContainer.innerHTML = `<p class="text-gray-500">Completa una simulaci√≥n de "La Merca" para ver tu historial.</p>`;
                }

            } else {
                // Comportamiento anterior: Cargar desde localStorage o valores por defecto
                currentCareerId = localStorage.getItem(SESSION_KEY_CAREER);
                currentCareerName = localStorage.getItem(SESSION_KEY_CAREER_NAME) || 'Estudiante';
            }

            // Decide la ruta
            // if (!currentCareerId && !lastState) { // Ya no se necesita selecci√≥n de carrera
            //     showCareerSelection();
            // } else {
                document.getElementById("currentRoleDisplay").textContent = currentCareerName;
                showMainDashboard();
            // }

            // NUEVO: Iniciar la escucha de notificaciones
            startListeningForNotifications(currentUserKey);

            document.getElementById("loginScreen").classList.add("hidden");
        }


        // üì• LOGIN (Actualizado con SweetAlert2)
        async function login() {
            const userName = document.getElementById("userName").value.trim().toLowerCase();
            if (!userName) {
                Swal.fire({
                    title: '¬°Espera!',
                    text: 'Ingresa tu primer nombre para continuar.',
                    icon: 'warning',
                    confirmButtonColor: '#f59e0b'
                });
                return;
            }

            // ¬°CORRECCI√ìN! Reproducir un sonido aqu√≠, despu√©s de la interacci√≥n del usuario.
            playSound("soundLogin");

            const loginBtn = document.querySelector('#loginScreen button');
            loginBtn.disabled = true;
            loginBtn.textContent = 'Buscando...';

            // 1. Verificar si es un usuario especial (profesor)
            const specialUserRef = ref(db, "userEspecial");
            const specialSnapshot = await get(specialUserRef);
            if (specialSnapshot.exists()) {
                let specialUserFound = null;
                specialSnapshot.forEach(child => {
                    const data = child.val();
                    if ((data.nombre || "").toLowerCase() === userName) {
                        specialUserFound = data;
                    }
                });
                if (specialUserFound) {
                    localStorage.setItem('aduweb_special_user_name', specialUserFound.nombre);
                    window.location.href = 'panel_control.html'; // Redirecci√≥n limpia
                    return;
                }
            }

            try {
                const snapshot = await get(ref(db, "usuarios"));
                if (snapshot.exists()) {
                    let encontrado = null;
                    snapshot.forEach((child) => {
                        const data = child.val();
                        const nombreBD = (data.nombre || "").toLowerCase();
                        if (nombreBD.includes(userName)) {
                            encontrado = { key: child.key, ...data };
                        }
                    });

                    if (encontrado) {
                        localStorage.setItem(SESSION_KEY, encontrado.nombre);
                        localStorage.setItem(SESSION_KEY_ID, encontrado.key);

                        loadUserDataAndRoute(encontrado);
                        playSound("soundLogin");
                        
                        // Nueva Alerta Animada (¬°√âxito!)
                        Swal.fire({
                            title: `¬°Bienvenido, ${encontrado.nombre.split(' ')[0].toUpperCase()}!`,
                            text: `Tu rol de simulaci√≥n actual es: ${localStorage.getItem(SESSION_KEY_CAREER_NAME) || 'Sin asignar (Elige tu rol)'}.`,
                            icon: 'success', 
                            confirmButtonText: 'Continuar',
                            confirmButtonColor: '#10b981', // green-600
                        });


                    } else {
                        // Nueva Alerta Animada (¬°Error!)
                        Swal.fire({
                            title: 'Error de Acceso',
                            text: 'Usuario no encontrado en la base de datos.',
                            icon: 'error',
                            confirmButtonText: 'Entendido',
                            confirmButtonColor: '#ef4444' // red-500
                        });
                    }
                } else {
                    Swal.fire({
                        title: 'Error de BD',
                        text: 'No se encontraron usuarios en la base de datos.',
                        icon: 'error',
                        confirmButtonColor: '#ef4444'
                    });
                }
            } catch(e) {
                console.error(e);
                Swal.fire({
                    title: 'Error de Conexi√≥n',
                    text: 'Hubo un problema al conectar con Firebase.',
                    icon: 'error',
                    confirmButtonColor: '#ef4444'
                });
            } finally {
                loginBtn.disabled = false;
                loginBtn.textContent = 'Entrar';
            }
        }
        
        // Funci√≥n para obtener datos de Firebase por una clave espec√≠fica
        async function getPlayerByKey(key) {
             try {
                const snapshot = await get(ref(db, `usuarios/${key}`));
                if (snapshot.exists()) {
                    return { key: snapshot.key, ...snapshot.val() };
                }
                return null;
            } catch (error) {
                console.error("Error al obtener jugador por clave:", error);
                return null;
            }
        }

       /**
         * MODIFICADO: Busca TODAS las partidas activas de un jugador.
         * Devuelve un array con los IDs de las salas.
         */
        async function findActiveGamesForPlayer(playerKey) {
            if (!playerKey) return [];
            const activeRooms = [];
            try {
                const gamesRef = ref(db, 'partidas_activas');
                const snapshot = await get(gamesRef);

                if (snapshot.exists()) {
                    const allGames = snapshot.val();
                    Object.keys(allGames).forEach(roomId => {
                        if (allGames[roomId]?.jugadores?.[playerKey] && allGames[roomId]?.proceso_global !== 'COMPLETED') {
                            activeRooms.push(roomId);
                        }
                    });
                }
            } catch (error) {
                console.error("Error al buscar partidas activas:", error);
            }
            return activeRooms;
        }

        /**
         * NUEVA FUNCI√ìN: Elimina a un jugador de M√öLTIPLES salas a la vez.
         */
        async function removePlayerFromAllRooms(playerKey, roomIds) {
            if (!playerKey || !roomIds || roomIds.length === 0) return;

            const updates = {};
            roomIds.forEach(roomId => {
                updates[`partidas_activas/${roomId}/jugadores/${playerKey}`] = null;
            });

            try {
                await update(ref(db), updates);
                console.log(`Jugador ${playerKey} eliminado de las salas: ${roomIds.join(', ')}.`);
            } catch (error) {
                console.error("Error al eliminar al jugador de las salas:", error);
            }
        }

        // üîç CHECK SESSION (FUNCI√ìN CORREGIDA)
        async function checkSession() {
            const savedName = localStorage.getItem(SESSION_KEY);
            const savedKey = localStorage.getItem(SESSION_KEY_ID);
            
            if (!savedKey) {
                showScreen("loginScreen");
                return; 
            }
            
            // 1. Mostrar pantalla de carga mientras se busca el estado en Firebase
            const loadingSwal = Swal.fire({
                title: 'Recuperando Sesi√≥n...',
                text: 'Cargando tu progreso desde la nube.',
                timerProgressBar: true,
                showConfirmButton: false,
                didOpen: () => {
                    Swal.showLoading();
                },
                allowOutsideClick: false,
                allowEscapeKey: false
            });
            
            // 2. Intentar obtener los datos completos del jugador desde Firebase
            const playerStatus = await getPlayerByKey(savedKey);

            loadingSwal.close();
            
            if (playerStatus) {
                // ¬°√âxito!
                currentUserKey = savedKey; // Establecer la clave global del usuario
                
                // --- L√ìGICA DE RECONEXI√ìN MEJORADA ---
                const activeRooms = await findActiveGamesForPlayer(savedKey);

                if (activeRooms.length > 0) {
                    loadingSwal.close(); // Cerrar el loader antes de preguntar
                    const firstRoomId = activeRooms[0]; // Ofrecer reconectar a la primera encontrada

                    const reconectResult = await Swal.fire({
                        title: '¬°Partida en Curso Detectada!',
                        text: `Hemos detectado que tienes sesiones activas (ej: en la sala "${firstRoomId}"). ¬øDeseas reconectarte?`,
                        icon: 'info',
                        showCancelButton: true,
                        confirmButtonColor: '#10b981',
                        cancelButtonColor: '#ef4444',
                        confirmButtonText: 'S√≠, ¬°Reconectar!',
                        cancelButtonText: 'No, abandonar todas las salas'
                    });

                    if (reconectResult.isConfirmed) {
                        window.location.href = `sala_espera.html?key=${savedKey}`;
                        return;
                    } else {
                        // El usuario no quiere reconectar, lo eliminamos de TODAS las salas.
                        await removePlayerFromAllRooms(savedKey, activeRooms);
                    }
                }

                // --- FLUJO NORMAL (SI NO HAY PARTIDA ACTIVA O SE ABANDON√ì) ---
                loadUserDataAndRoute({ key: savedKey, ...playerStatus });

                Swal.fire({
                    title: `¬°Bienvenido de vuelta, ${savedName.split(' ')[0].toUpperCase()}!`,
                    icon: 'success', position: 'top-end', toast: true,
                    timer: 2000, showConfirmButton: false
                });

            } else {
                // El usuario exist√≠a antes, pero su clave ya no es v√°lida o hay un error de conexi√≥n
                localStorage.removeItem(SESSION_KEY);
                localStorage.removeItem(SESSION_KEY_ID);
                showScreen("loginScreen");
                
                Swal.fire('Error de Conexi√≥n', 'No se pudo cargar tu perfil. Por favor, inicia sesi√≥n de nuevo.', 'error');
            }
        }

        /**
         * NUEVO: Verifica si el usuario ha completado suficientes m√≥dulos para desbloquear los juegos de pr√°ctica.
         */
        function checkPracticeGamesUnlock(modulesCompleted) {
            const isUnlocked = (modulesCompleted / TOTAL_MODULES_REQUIRED) >= 0.5;
            const practiceGamesCard = document.getElementById('practice-games-card');
            const lockOverlay = document.getElementById('practice-games-lock-overlay');

            if (isUnlocked) {
                lockOverlay.classList.add('hidden');
                practiceGamesCard.classList.remove('opacity-50', 'cursor-not-allowed');
            } else {
                lockOverlay.classList.remove('hidden');
                practiceGamesCard.classList.add('opacity-50', 'cursor-not-allowed');
            }
        }

        /**
         * NUEVO: Verifica si el usuario ha completado el 100% del plan y ha elegido un rol para desbloquear las partidas en l√≠nea.
         */
        function checkOnlineMatchUnlock(modulesCompleted, chosenCareerId) {
            const hasFinishedTraining = modulesCompleted >= TOTAL_MODULES_REQUIRED;
            const hasChosenCareer = !!chosenCareerId;
            const isUnlocked = hasFinishedTraining && hasChosenCareer;

            const onlineMatchCard = document.getElementById('online-match-card');
            const lockOverlay = document.getElementById('online-match-lock-overlay');
            const requirementText = document.getElementById('unlock-requirement-text');

            if (isUnlocked) {
                lockOverlay.classList.add('hidden');
            } else {
                lockOverlay.classList.remove('hidden');
                if (!hasFinishedTraining) requirementText.textContent = `Completa el 100% de la Ruta de Aprendizaje para desbloquear.`;
                else if (!hasChosenCareer) requirementText.textContent = `¬°Graduado! Ahora elige un cargo de especializaci√≥n para jugar en l√≠nea.`;
            }
        }
        
        // ----------------------------------------------------------------------
        // üîî NUEVO: L√ìGICA DE NOTIFICACIONES
        // ----------------------------------------------------------------------

        function startListeningForNotifications(playerKey) {
            if (notificationsListener) off(notificationsListener); // Detener listener anterior

            processedNotifications.clear(); // Limpiar al iniciar
            let isFirstLoad = true;

            const notificationsRef = ref(db, `usuarios/${playerKey}/notificaciones`);
            notificationsListener = onValue(notificationsRef, (snapshot) => {
                const notifications = snapshot.val();
                renderNotifications(notifications);

                if (notifications) {
                    Object.keys(notifications).forEach(key => {
                        if (!processedNotifications.has(key)) {
                            // Es una notificaci√≥n nueva
                            processedNotifications.add(key);
                            if (!isFirstLoad) {
                                // Mostrar alerta solo si no es la carga inicial
                                const notif = notifications[key];
                                if (notif.tipo === 'INVITACION_SALA' && !notif.leido) {
                                    Swal.fire({
                                        toast: true,
                                        position: 'top-end',
                                        icon: 'info',
                                        title: `¬°Nueva invitaci√≥n de ${notif.remitente_nombre}!`,
                                        html: `Te ha invitado a la sala <strong>${notif.id_sala}</strong>.`,
                                        showConfirmButton: true,
                                        confirmButtonText: 'Unirse',
                                        timer: 4000, // 4 segundos
                                        timerProgressBar: true,
                                    }).then((result) => { if (result.isConfirmed) { acceptInvitation(key, notif.id_sala); } });
                                }
                            }
                        }
                    });
                }
                isFirstLoad = false; // Despu√©s de la primera ejecuci√≥n, ya no es la carga inicial
            });
        }

        function renderNotifications(notifications) {
            const panel = document.getElementById('notification-list');
            const badge = document.getElementById('notification-badge');
            if (!panel || !badge) return;

            if (!notifications) {
                panel.innerHTML = '<p class="p-4 text-sm text-gray-500 text-center">No tienes notificaciones.</p>';
                badge.classList.add('hidden');
                return;
            }

            const notificationKeys = Object.keys(notifications).sort((a, b) => notifications[b].fecha - notifications[a].fecha);
            let unreadCount = 0;
            let html = '';

            notificationKeys.forEach(key => {
                const notif = notifications[key];
                if (!notif.leido) unreadCount++;

                if (notif.tipo === 'INVITACION_SALA') {
                    html += `
                        <div class="p-3 border-b hover:bg-gray-50 ${notif.leido ? 'opacity-60' : ''}">
                            <p class="text-sm text-gray-800">
                                <strong>${notif.remitente_nombre}</strong> te ha invitado a la sala <strong class="font-mono">${notif.id_sala}</strong>.
                            </p>
                            <div class="mt-2 text-right">
                                <button onclick="acceptInvitation('${key}', '${notif.id_sala}')" class="text-xs bg-green-500 text-white font-semibold px-3 py-1 rounded-md hover:bg-green-600">
                                    Aceptar
                                </button>
                            </div>
                        </div>
                    `;
                }
                // NUEVO: Renderizar notificaciones de nuevos documentos
                else if (notif.tipo === 'NUEVO_DOCUMENTO') {
                    html += `
                        <a href="visor_documento.html?id=${notif.id_documento}" data-notif-key="${key}" class="notification-item block p-3 border-b hover:bg-gray-50 ${notif.leido ? 'opacity-60' : ''}">
                            <p class="text-sm text-gray-800"><strong class="text-cyan-600">Biblioteca:</strong> Se ha a√±adido el documento: <strong>${notif.titulo_documento}</strong>.</p>
                        </a>
                    `;
                }
            });

            panel.innerHTML = html || '<p class="p-4 text-sm text-gray-500 text-center">No tienes notificaciones.</p>';
            badge.classList.toggle('hidden', unreadCount === 0);
        }

        function toggleNotifications() {
            playSound('soundClick');
            document.getElementById('notification-panel').classList.toggle('hidden');
        }

        async function acceptInvitation(notificationKey, roomId) {
            // 1. Obtener la referencia a la notificaci√≥n completa
            const notifRef = ref(db, `usuarios/${currentUserKey}/notificaciones/${notificationKey}`);
            
            // CORRECCI√ìN: Obtener los datos de la notificaci√≥n ANTES de usarla
            const notifSnapshot = await get(notifRef);
            if (!notifSnapshot.exists()) {
                Swal.fire('Error', 'No se pudo encontrar la invitaci√≥n.', 'error');
                return;
            }
            const notification = notifSnapshot.val(); // Ahora la variable 'notification' est√° definida

            // Marcar la notificaci√≥n como le√≠da
            await update(notifRef, { leido: true });

            // 2. Cerrar el panel de notificaciones
            document.getElementById('notification-panel').classList.add('hidden');

            // 3. Redirigir al usuario a la sala de espera
            const groupId = notification.id_grupo || ''; // Ahora esto funciona
            Swal.fire({
                title: 'Uni√©ndote a la Sala...',
                text: `Redirigiendo a la sala ${roomId}.`,
                icon: 'info',
                timer: 1500,
                showConfirmButton: false,
                didClose: () => {
                    // MODIFICADO: Pasamos el ID de la sala y el ID del grupo
                    window.location.href = `sala_espera.html?joinRoomId=${roomId}&groupId=${groupId}`;
                }
            });
        }

        async function markNotificationAsRead(notificationKey) {
            if (!currentUserKey || !notificationKey) return;
            const notifRef = ref(db, `usuarios/${currentUserKey}/notificaciones/${notificationKey}/leido`);
            await set(notifRef, true);
            // Opcional: cerrar el panel despu√©s de hacer clic
            document.getElementById('notification-panel').classList.add('hidden');
        }

        window.toggleNotifications = toggleNotifications;
        window.acceptInvitation = acceptInvitation;
        // ----------------------------------------------------------------------
        // üéØ OTRAS FUNCIONES (Ranking, Audio, Juegos)
        // ----------------------------------------------------------------------

        // üèÜ Ranking (Mantenida)
        // MODIFICADO: Ahora muestra m√°s detalles del progreso del usuario.
        async function viewRanking() {
            const snapshot = await get(ref(db, "usuarios"));
            if (snapshot.exists()) {
                let ranking = [];
                snapshot.forEach((child) => {
                    const data = child.val();
                    // Solo incluir usuarios con nombre
                    if (data.nombre) {
                        ranking.push({
                            nombre: data.nombre,
                            puntaje: data.puntaje || 0,
                            misiones: data.misiones_completadas || 0,
                            progreso: data.progreso_entrenamiento || 0
                        });
                    }
                });

                ranking.sort((a, b) => b.puntaje - a.puntaje);

                const table = document.getElementById("rankingTable");
                table.innerHTML = "";
                ranking.slice(0, 20).forEach((player, i) => { // Mostrar solo los primeros 20
                    const row = document.createElement("tr");
                    row.className = `hover:bg-gray-50 transition-colors ${player.nombre === playerNameGlobal ? 'bg-green-100 font-bold' : ''}`;
                    row.innerHTML = `
                        <td class="px-4 py-3 font-bold text-lg">${i + 1}</td>
                        <td class="px-4 py-3 text-left">${player.nombre}</td>
                        <td class="px-4 py-3 text-center">${player.misiones}</td>
                        <td class="px-4 py-3 text-right font-semibold text-lg">${player.puntaje}</td>
                    `;
                    table.appendChild(row);
                });

                showScreen("rankingScreen");
            }
        }

        // Placeholder para futura funci√≥n de historial
        function viewHistory() {
            Swal.fire('Pr√≥ximamente', 'Aqu√≠ podr√°s ver el historial detallado de todas tus simulaciones.', 'info');
        }

        // üîô Volver (Mantenida)
        function backToMain() {
            showMainDashboard(); // Vuelve al dashboard de la carrera
        }

        // Funci√≥n Gen√©rica para Abrir Juegos (CORREGIDA PARA SALA MULTIJUGADOR)
        function openGame(gameFile) {
            if (!playerNameGlobal || !currentUserKey) {
                Swal.fire('Acceso Denegado', 'Debes iniciar sesi√≥n para acceder a las actividades.', 'warning');
                return;
            }
            
            // 2. Redirecci√≥n a la sala de espera (Partidas en L√≠nea)
            if (gameFile === 'sala_espera.html') {
                const lockOverlay = document.getElementById('online-match-lock-overlay');
                if (!lockOverlay.classList.contains('hidden')) {
                    Swal.fire('¬°Modo Bloqueado!', 'Debes completar tu formaci√≥n y elegir un cargo de especializaci√≥n para acceder a las partidas en l√≠nea.', 'warning');
                    return;
                }
                window.location.href = `sala_espera.html`; 
            } else {
                // CORRECCI√ìN: Pasamos el playerKey a todos los juegos individuales
                window.location.href = `${gameFile}?playerKey=${currentUserKey}&playerName=${encodeURIComponent(playerNameGlobal)}`;
            }
        }
        
        // ----------------------------------------------------------------------
        // üöÄ INICIALIZACI√ìN Y EXPORTACI√ìN DE FUNCIONES
        // ----------------------------------------------------------------------
        
        // L√ìGICA CORREGIDA DEL SPLASH SCREEN (Mostrar solo una vez por sesi√≥n de navegador)
        document.addEventListener('DOMContentLoaded', () => {
            const splash = document.getElementById('splashScreen');
            const logoSound = document.getElementById('logoSound');
            
            // --- L√ìGICA CORREGIDA ---
            // Si el usuario ya tiene una sesi√≥n activa, no mostramos la animaci√≥n.
            if (localStorage.getItem(SESSION_KEY_ID)) {
                splash.style.display = 'none';
                checkSession();
                return;
            }

            // Si no hay sesi√≥n, mostramos la animaci√≥n completa.
            setTimeout(() => {
                splash.style.backgroundColor = '#10b981'; // Cambia a verde
            }, 900);

            setTimeout(() => {
                splash.style.opacity = '0';
                setTimeout(() => {
                    splash.style.display = 'none';
                    checkSession(); 
                }, 500);
            }, 2200); // Duraci√≥n total de la animaci√≥n + fade out
            
            // üõ†Ô∏è PWA / SERVICE WORKER REGISTRATION (Mantengo el bloque original)
             if ('serviceWorker' in navigator) {
                 window.addEventListener('load', () => {
                     // Aseg√∫rate que la ruta al sw.js sea correcta
                     navigator.serviceWorker.register('/beta/sw.js', { scope: '/beta/' }) 
                         .then(registration => {
                             console.log('Service Worker registrado con √©xito. Scope:', registration.scope);
                         })
                         .catch(registrationError => {
                             console.log('Fallo el registro del Service Worker:', registrationError);
                         });
                 });
             }
        });

        // Exportaci√≥n de funciones globales para que funcionen con los atributos 'onclick' del HTML
        window.login = login;
        window.logout = logout;
        window.viewRanking = viewRanking;
        window.backToMain = backToMain;
        window.openGame = openGame;
        window.viewHistory = viewHistory;
        window.saveUserProgress = saveUserProgress; 
        window.showMainDashboard = showMainDashboard; // CORREGIDO: Exportar con el nombre correcto
        window.playSound = playSound;
        window.selectCareer = selectCareer;
        window.showWelcomeScreen = showWelcomeScreen;
        window.showTutorialGuide = showTutorialGuide; // Exportar nueva funci√≥n
        window.hideTutorialGuide = hideTutorialGuide; // Exportar nueva funci√≥n
    </script>
</body>
</html>
