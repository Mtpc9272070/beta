<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADUCHAT - Asesor Aduanero</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Animaci√≥n de entrada de pantalla */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.5s ease-out;
        }

        /* Animaci√≥n del icono del logo */
        @keyframes bounceY {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
        .animate-bounce-y {
            animation: bounceY 1s infinite alternate;
        }

        /* Estilos compartidos para botones */
        .menu-btn {
            @apply text-white font-semibold px-6 py-3 rounded-xl w-full md:w-auto transition transform hover:scale-105 focus:outline-none focus:ring-2;
        }
        /* Nueva tarjeta de misi√≥n */
        .mission-card {
            @apply bg-white p-6 rounded-2xl shadow-xl border-t-4 border-green-500 hover:shadow-2xl transition duration-300 flex flex-col justify-between;
        }
        .mission-icon {
            @apply w-12 h-12 bg-green-100 text-green-700 rounded-full flex items-center justify-center mb-3 text-2xl font-bold;
        }
        /* Colores espec√≠ficos para misiones */
        .mission-1 { @apply border-yellow-500 hover:bg-yellow-100; }
        .mission-2 { @apply border-blue-500 hover:bg-blue-100; }
        .mission-3 { @apply border-red-500 hover:bg-red-100; }
        .mission-4 { @apply border-purple-500 hover:bg-purple-100; }
        .mission-5 { @apply border-indigo-500 hover:bg-indigo-100; }
        .mission-6 { @apply border-green-500 hover:bg-green-100; }
    </style>
</head>
<body class="bg-gray-50 font-sans text-gray-800">

    <div id="loginScreen" class="flex items-center justify-center min-h-screen px-4 animate-fade-in">
        <div class="bg-white shadow-xl p-8 rounded-3xl w-full max-w-sm text-center transform transition duration-500 hover:scale-105 relative">
            <div class="bg-green-700 text-white py-4 px-6 rounded-t-3xl -mx-8 -mt-8 mb-6 flex items-center justify-center gap-2 relative">
                <span class="text-3xl animate-bounce-y">üí¨</span>
                <h1 class="text-3xl font-extrabold">ADU<span class="text-white">CHAT</span></h1>
                <span class="absolute top-0 right-0 -mt-2 -mr-2 bg-yellow-400 text-gray-800 font-bold px-3 py-1 rounded-full text-xs rotate-12 shadow-md z-20">
                    BETA
                </span>
            </div>
            <p class="mb-6 text-gray-600">Inicia sesi√≥n para comenzar tu entrenamiento.</p>
            <input id="userName" type="text" placeholder="Ingresa tu primer nombre"
                class="border border-gray-300 p-3 w-full rounded-xl mb-4 text-center focus:ring-2 focus:ring-green-400 focus:border-green-400 outline-none transition duration-300">
            <button onclick="login()"
                class="bg-green-600 text-white font-semibold px-6 py-3 rounded-xl w-full hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-400 transition transform hover:scale-105">
                Entrar
            </button>
        </div>
    </div>

    <div id="mainScreen" class="hidden bg-gray-100 min-h-screen animate-fade-in">
        <div class="bg-green-700 text-white pt-10 pb-20 px-6 mb-8 shadow-lg">
            <div class="max-w-4xl mx-auto flex justify-between items-center">
                 <div class="flex items-center gap-2">
                    <span class="text-3xl">üí¨</span>
                    <h1 class="text-3xl font-extrabold">ADU<span class="text-white">CHAT</span></h1>
                </div>
                <button onclick="logout()" class="text-sm bg-green-600 hover:bg-green-800 px-4 py-2 rounded-lg font-bold transition">
                    üö™ Salir
                </button>
            </div>
        </div>
        
        <div class="max-w-4xl mx-auto -mt-16 relative z-10 p-4">
            
            <div class="bg-white shadow-2xl rounded-3xl p-6 md:p-8 mb-8">
                <h2 class="text-3xl font-extrabold mb-2 text-gray-800">Asesor <span id="playerName" class="text-green-700 capitalize"></span></h2>
                <p class="text-gray-600 text-sm md:text-base mb-6">Completa las misiones para alcanzar el rango de Experto Aduanero.</p>

                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <div class="bg-green-50 p-4 rounded-xl text-center shadow-inner border border-green-200">
                        <h3 class="text-base font-bold text-green-700">Puntaje Total</h3>
                        <p id="playerScore" class="text-2xl font-extrabold text-green-900 mt-1">0</p>
                    </div>
                    <div class="bg-gray-100 p-4 rounded-xl text-center shadow-inner border border-gray-200">
                        <h3 class="text-base font-bold text-gray-700">Progreso</h3>
                        <p id="playerProgress" class="text-xl font-bold text-gray-900 mt-1">0/6 misiones</p>
                    </div>
                    <div class="p-4 rounded-xl text-center">
                         <button onclick="viewRanking()" class="menu-btn bg-green-600 hover:bg-green-700 focus:ring-green-400 h-full flex items-center justify-center gap-2">
                            üèÜ Ver Ranking
                        </button>
                    </div>
                </div>
            </div>

            <h3 class="text-2xl font-bold mt-10 mb-5 text-gray-800 border-b pb-2">üéØ Misiones Disponibles (6 Juegos)</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                
                <a href="#" onclick="openGame('icogame.html'); return false;" class="mission-card mission-1">
                    <div class="mission-icon bg-yellow-100 text-yellow-700">ü•á</div>
                    <h4 class="text-lg font-extrabold text-gray-800 mb-2">Misi√≥n 1: Juego de Incoterms</h4>
                    <p class="text-sm text-gray-600">Dominio de T√©rminos Internacionales de Comercio.</p>
                </a>
                
                <a href="rompecabezas.html" class="mission-card mission-2">
                    <div class="mission-icon bg-blue-100 text-blue-700">üß©</div>
                    <h4 class="text-lg font-extrabold text-gray-800 mb-2">Misi√≥n 2: Rompecabezas de Piezas ICO</h4>
                    <p class="text-sm text-gray-600">Identifica las responsabilidades del comprador y vendedor.</p>
                </a>
                
                <a href="regulador.html" class="mission-card mission-3">
                    <div class="mission-icon bg-red-100 text-red-700">‚öñÔ∏è</div>
                    <h4 class="text-lg font-extrabold text-gray-800 mb-2">Misi√≥n 3: Verificaci√≥n de Conformidad</h4>
                    <p class="text-sm text-gray-600">Eval√∫a la mercanc√≠a seg√∫n las normativas aduaneras.</p>
                </a>

                <a href="rompearance.html" class="mission-card mission-4">
                    <div class="mission-icon bg-purple-100 text-purple-700">üìö</div>
                    <h4 class="text-lg font-extrabold text-gray-800 mb-2">Misi√≥n 4: Rompecabezas Arancelario</h4>
                    <p class="text-sm text-gray-600">Usa el Sistema Armonizado para clasificar mercanc√≠as.</p>
                </a>

                <a href="simuinco.html" class="mission-card mission-5">
                    <div class="mission-icon bg-indigo-100 text-indigo-700">üí°</div>
                    <h4 class="text-lg font-extrabold text-gray-800 mb-2">Misi√≥n 5: Simulador de Reglas Incoterms</h4>
                    <p class="text-sm text-gray-600">Simulaci√≥n interactiva para la aplicaci√≥n de reglas.</p>
                </a>

                <a href="costimpo.html" class="mission-card mission-6">
                    <div class="mission-icon bg-green-100 text-green-700">üí∞</div>
                    <h4 class="text-lg font-extrabold text-gray-800 mb-2">Misi√≥n 6: Simulador Landed Cost</h4>
                    <p class="text-sm text-gray-600">Calcula el costo final de importaci√≥n (Valoraci√≥n).</p>
                </a>

            </div>

        </div>
    </div>

    <div id="rankingScreen" class="hidden bg-gray-50 min-h-screen animate-fade-in">
        <div class="bg-green-700 text-white py-4 px-6 mb-8 flex items-center justify-center gap-2 shadow-lg relative">
            <span class="text-3xl">üí¨</span>
            <h1 class="text-3xl font-extrabold">ADU<span class="text-white">CHAT</span></h1>
        </div>
        <div class="max-w-3xl mx-auto bg-white shadow-2xl rounded-3xl p-6 md:p-10 -mt-20 relative z-10">
            <h2 class="text-2xl md:text-3xl font-extrabold mb-6 text-center text-gray-800">Ranking Global</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full border border-gray-200 rounded-2xl overflow-hidden text-sm md:text-base">
                    <thead>
                        <tr class="bg-gray-100 text-left text-gray-600">
                            <th class="px-4 py-3 border-r border-gray-200 font-semibold">Posici√≥n</th>
                            <th class="px-4 py-3 border-r border-gray-200 font-semibold">Jugador</th>
                            <th class="px-4 py-3 font-semibold">Puntaje</th>
                        </tr>
                    </thead>
                    <tbody id="rankingTable" class="text-center"></tbody>
                </table>
            </div>
            <div class="text-center mt-8">
                <button onclick="backToMain()" class="menu-btn bg-green-600 hover:bg-green-700 focus:ring-green-400 flex items-center justify-center gap-2">
                    üîô Volver
                </button>
            </div>
        </div>
    </div>
    
    <audio id="soundLogin" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_4b2f6a041c.mp3?filename=success-1-6297.mp3"></audio>
    <audio id="soundBot" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_7e2d77e6f0.mp3?filename=pop-94319.mp3"></audio>
    <audio id="soundClick" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_c65a2c57b0.mp3?filename=click-124467.mp3"></audio>
    <audio id="soundWin" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_197b9d88a4.mp3?filename=success-fanfare-trumpets-6185.mp3"></audio>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-app.js";
        import { getDatabase, ref, get, update } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-database.js";

        // ‚öôÔ∏è Configuraci√≥n Firebase (Mantenida)
        const firebaseConfig = {
            apiKey: "AIzaSyB_eUoNQ7L4hd42SVPqbA7vNYHxpEii9To",
            authDomain: "dino-4fbde.firebaseapp.com",
            databaseURL: "https://dino-4fbde-default-rtdb.firebaseio.com",
            projectId: "dino-4fbde",
            storageBucket: "dino-4fbde.firebasestorage.app",
            messagingSenderId: "307345167689",
            appId: "1:307345167689:web:f75e11b0c68a3def253698",
            measurementId: "G-LFDL5N5VW3"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let currentUserKey = null;
        let playerNameGlobal = "";

        // üéµ Reproducir sonido
        function playSound(id) {
            document.getElementById(id).play();
        }

        // üîë Login
        async function login() {
            const userName = document.getElementById("userName").value.trim().toLowerCase();
            if (!userName) {
                alert("‚ö†Ô∏è Ingresa un nombre v√°lido.");
                return;
            }

            const snapshot = await get(ref(db, "usuarios"));
            if (snapshot.exists()) {
                let encontrado = null;
                snapshot.forEach((child) => {
                    const data = child.val();
                    const nombreBD = (data.nombre || "").toLowerCase();
                    if (nombreBD.includes(userName)) {
                        encontrado = { key: child.key, ...data };
                    }
                });

                if (encontrado) {
                    currentUserKey = encontrado.key;
                    // Asegura que el nombre guardado para pasarlo a los juegos sea el de la BD
                    playerNameGlobal = encontrado.nombre;
                    document.getElementById("playerName").textContent = encontrado.nombre;
                    document.getElementById("playerScore").textContent = encontrado.puntaje || 0;
                    document.getElementById("playerProgress").textContent = (encontrado.misiones_completadas || 0) + "/6 misiones"; // Cambiado a misiones

                    document.getElementById("loginScreen").classList.add("hidden");
                    document.getElementById("mainScreen").classList.remove("hidden");
                    document.getElementById("mainScreen").classList.add("animate-fade-in");

                    playSound("soundLogin");
                } else {
                    alert("‚ùå Usuario no encontrado en la base de datos.");
                }
            }
        }

        // üö™ Logout
        function logout() {
            document.getElementById("loginScreen").classList.remove("hidden");
            document.getElementById("mainScreen").classList.add("hidden");
            document.getElementById("userName").value = "";
            currentUserKey = null;
            playerNameGlobal = "";
        }

        // üèÜ Ranking
        async function viewRanking() {
            const snapshot = await get(ref(db, "usuarios"));
            if (snapshot.exists()) {
                let ranking = [];
                snapshot.forEach((child) => {
                    const data = child.val();
                    ranking.push({
                        nombre: data.nombre,
                        puntaje: data.puntaje || 0
                    });
                });

                ranking.sort((a, b) => b.puntaje - a.puntaje);

                const table = document.getElementById("rankingTable");
                table.innerHTML = "";
                ranking.forEach((player, i) => {
                    const row = document.createElement("tr");
                    row.className = "hover:bg-gray-50 transition-colors";
                    row.innerHTML = `
                        <td class="px-4 py-3 border-r border-gray-200">${i + 1}</td>
                        <td class="px-4 py-3 border-r border-gray-200">${player.nombre}</td>
                        <td class="px-4 py-3">${player.puntaje}</td>
                    `;
                    table.appendChild(row);
                });

                document.getElementById("mainScreen").classList.add("hidden");
                document.getElementById("rankingScreen").classList.remove("hidden");
                document.getElementById("rankingScreen").classList.add("animate-fade-in");
            }
        }

        // üîô Volver
        function backToMain() {
            document.getElementById("rankingScreen").classList.add("hidden");
            // document.getElementById("scenarioScreen").classList.add("hidden"); // Ya no se usa
            document.getElementById("mainScreen").classList.remove("hidden");
            document.getElementById("mainScreen").classList.add("animate-fade-in");
            // Opcional: Recargar progreso al volver al dashboard
            // if (currentUserKey) login(); 
        }

        // üÜï Funci√≥n Gen√©rica para Abrir Juegos y Pasar el Nombre si es icogame
        function openGame(gameFile) {
            if (gameFile === 'icogame.html') {
                if (!playerNameGlobal) {
                    alert("No se ha cargado el nombre del jugador. Intenta cerrar y volver a iniciar sesi√≥n.");
                    return;
                }
                // icogame.html requiere el nombre para Firebase (seg√∫n tu c√≥digo previo)
                window.location.href = `${gameFile}?name=${encodeURIComponent(playerNameGlobal)}`;
            } else {
                // El resto de juegos no requieren un par√°metro de nombre, solo redirecci√≥n
                window.location.href = gameFile;
            }
        }

        window.login = login;
        window.logout = logout;
        window.viewRanking = viewRanking;
        window.backToMain = backToMain;
        window.openGame = openGame;
    </script>
</body>
</html>
