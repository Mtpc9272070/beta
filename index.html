<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADUCHAT - Asesor Aduanero</title>
    
    <link rel="manifest" href="/beta/manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#10b981">
    <link rel="apple-touch-icon" href="/beta/logo.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        /* Animaci√≥n de entrada de pantalla */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        
        /* --- SPLASH SCREEN --- */

        /* Animaci√≥n del Arco Aduanero 3D (Estilo Netflix) */
        @keyframes netflixArc {
            0% { transform: scale(0.7) translateY(20px) perspective(500px) rotateX(90deg); opacity: 0; }
            20% { opacity: 1; }
            50% { transform: scale(1.1) translateY(-10px) perspective(500px) rotateX(0deg); }
            70% { transform: scale(1) translateY(0) perspective(500px) rotateX(0deg); }
            85% { transform: translateY(0) perspective(500px) rotateX(15deg); }
            100% { transform: scale(1) translateY(0) perspective(500px) rotateX(0deg); }
        }

        /* Animaci√≥n de texto: ADU aparece de abajo hacia arriba */
        @keyframes corpSlideUp {
            0%, 75% { opacity: 0; transform: translateY(20px); }
            100% { opacity: 1; transform: translateY(0); }
        }

        /* Animaci√≥n de entrada sutil para el copyright */
        @keyframes copyrightFade {
            0%, 90% { opacity: 0; }
            100% { opacity: 1; }
        }

        /* Estilo para el Contenedor/Trapezoide (NUEVO LOGO ADU) */
        .logo-shape {
            width: 100px;
            height: 100px;
            background-color: #10b981;
            clip-path: polygon(15% 0%, 85% 0%, 100% 100%, 0% 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 10px 0 0 #047857;
            transform-style: preserve-3d;
            position: relative;
            padding-top: 10px;
        }

        /* Estilo del texto ADU/UMAYOR */
        .main-text {
            font-family: ui-sans-serif, system-ui, sans-serif;
            font-weight: 900;
            letter-spacing: 0.2em;
            color: #047857;
        }

        /* Estilos compartidos para botones */
        .menu-btn {
            @apply text-white font-semibold px-6 py-3 rounded-xl w-full md:w-auto transition transform hover:scale-105 focus:outline-none focus:ring-2;
        }
        /* Tarjeta de misi√≥n (Solo texto, responsive, verde y animada) */
        .mission-card {
            /* Borde izquierdo verde y hover sutil */
            @apply bg-white p-5 rounded-xl shadow-lg border-l-4 border-green-500 hover:shadow-xl hover:bg-green-50 transition duration-300 flex flex-col justify-between;
        }
    </style>
</head>
<body class="bg-gray-50 font-sans text-gray-800">
    
    <div id="splashScreen" class="fixed inset-0 bg-white z-[60] flex flex-col items-center justify-center transition-opacity duration-500">
        <div id="logoContainer" class="logo-shape relative"
            style="animation: netflixArc 4.0s ease-out forwards;">
            <span id="letterA" class="text-white text-6xl font-extrabold tracking-wide" style="transform: rotateX(0deg);">A</span>
        </div>
        
        <h1 id="splashText" class="main-text mt-8 text-5xl opacity-0"
            style="animation: corpSlideUp 4.0s ease-out forwards;">
            ADU
        </h1>

        <p id="copyrightText" class="text-xs font-semibold mt-4 text-gray-500 opacity-0"
            style="animation: copyrightFade 4.0s ease-out forwards;">
            @UMAYOR 2025
        </p>
    </div>

    <div id="loginScreen" class="flex items-center justify-center min-h-screen px-4 animate-fade-in">
        <div class="bg-white shadow-xl p-8 rounded-3xl w-full max-w-sm text-center transform transition duration-500 hover:scale-105 relative">
            <div class="bg-green-700 text-white py-4 px-6 rounded-t-3xl -mx-8 -mt-8 mb-6 flex items-center justify-center gap-2 relative">
                <span class="text-3xl">üóÇÔ∏è</span>
                <h1 class="text-3xl font-extrabold">ADU<span class="text-white">WEB</span></h1>
                <span class="absolute top-0 right-0 -mt-2 -mr-2 bg-yellow-400 text-gray-800 font-bold px-3 py-1 rounded-full text-xs rotate-12 shadow-md z-20">
                    BETA
                </span>
            </div>
            <p class="mb-6 text-gray-600">Inicia sesi√≥n para comenzar tu entrenamiento.</p>
            <input id="userName" type="text" placeholder="Ingresa tu primer nombre"
                class="border border-gray-300 p-3 w-full rounded-xl mb-4 text-center focus:ring-2 focus:ring-green-400 focus:border-green-400 outline-none transition duration-300">
            <button onclick="login()"
                class="bg-green-600 text-white font-semibold px-6 py-3 rounded-xl w-full hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-400 transition transform hover:scale-105">
                Entrar
            </button>
        </div>
    </div>

    <div id="careerSelectionScreen" class="hidden flex items-center justify-center min-h-screen px-4 bg-gray-50 animate-fade-in">
        <div class="bg-white shadow-2xl p-8 rounded-3xl w-full max-w-4xl text-center">
            <h2 class="text-3xl font-extrabold text-green-700 mb-2">Selecciona tu Cargo de Simulaci√≥n</h2>
            <p class="mb-8 text-gray-600">Elige uno de los 11 roles para personalizar tu ruta de aprendizaje y enfocarte en las misiones m√°s relevantes para tu carrera.</p>
            
            <div id="careerList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                </div>

            <button onclick="logout()" class="menu-btn bg-gray-500 hover:bg-gray-600 focus:ring-gray-400 mt-10">
                üö™ Volver al Login
            </button>
        </div>
    </div>


    <div id="mainScreen" class="hidden bg-gray-100 min-h-screen animate-fade-in">
        <div class="bg-green-700 text-white pt-10 pb-20 px-6 mb-8 shadow-lg">
            <div class="max-w-4xl mx-auto flex justify-between items-center">
                <div class="flex items-center gap-2">
                    <span class="text-3xl">üóÇÔ∏è</span>
                    <h1 class="text-3xl font-extrabold">ADU<span class="text-white">WEB</span></h1>
                </div>
                <div class="flex gap-4">
                    <button onclick="showCareerSelection()" class="text-sm bg-green-600 hover:bg-green-800 px-4 py-2 rounded-lg font-bold transition">
                        üíº Cambiar Rol
                    </button>
                    <button onclick="logout()" class="text-sm bg-green-600 hover:bg-green-800 px-4 py-2 rounded-lg font-bold transition">
                        üö™ Salir
                    </button>
                </div>
            </div>
        </div>
        
        <div class="max-w-4xl mx-auto -mt-16 relative z-10 p-4">
            
            <div class="bg-white shadow-2xl rounded-xl p-6 md:p-8 mb-6 border-t-4 border-green-600">
                <h2 class="text-3xl font-extrabold mb-2 text-gray-800">
                    <span id="playerRoleTitle" class="text-green-700">Asesor</span> <span id="playerName" class="capitalize"></span>
                </h2>
                <p id="dashboardSubtitle" class="text-gray-600 text-sm md:text-base mb-6">Tu panel de control para el entrenamiento aduanero en el rol de <span id="currentRoleDisplay" class="font-bold text-green-600">[ROL SIN ASIGNAR]</span>.</p>

                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <div class="bg-green-50 p-4 rounded-lg text-center shadow-inner border border-green-200">
                        <h3 class="text-base font-bold text-green-700">Puntaje Total</h3>
                        <p id="playerScore" class="text-2xl font-extrabold text-green-900 mt-1">0</p>
                    </div>
                    <div class="bg-gray-100 p-4 rounded-lg text-center shadow-inner border border-gray-200">
                        <h3 class="text-base font-bold text-gray-700">Misiones</h3>
                        <p id="playerProgress" class="text-xl font-bold text-gray-900 mt-1">0/6</p>
                    </div>
                    <div class="p-4 rounded-lg text-center">
                         <button onclick="viewRanking()" class="menu-btn bg-green-600 hover:bg-green-700 focus:ring-green-400 h-full flex items-center justify-center gap-2">
                             üèÜ Ranking
                        </button>
                    </div>
                </div>
            </div>

            <div class="bg-blue-50 border-l-4 border-blue-500 p-5 rounded-xl mb-6 shadow-md flex justify-between items-center transition duration-300 hover:bg-blue-100">
                <div>
                    <h4 class="text-xl font-bold text-blue-800 mb-1">
                        üìö ¬øNuevo aqu√≠? ¬°Mira la Gu√≠a!
                    </h4>
                    <p class="text-sm text-blue-700">
                        Aprende a usar el Dashboard, a cambiar tu rol y el objetivo de cada secci√≥n.
                    </p>
                </div>
                <button onclick="showTutorialGuide()" class="bg-blue-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-blue-700 transition flex items-center gap-2 whitespace-nowrap">
                    ‚ñ∂Ô∏è Tutorial
                </button>
            </div>


            <a href="lamerca.html" class="block">
                <div class="bg-green-600 p-6 rounded-xl mb-4 shadow-xl border-t-4 border-white hover:bg-green-700 transition duration-300 cursor-pointer text-white flex items-center justify-between">
                    <div>
                        <p class="text-xl font-bold mb-1">
                            üöÄ Empezar Simulaci√≥n
                        </p>
                        <p class="text-sm opacity-90">
                            Accede al simulador completo de Comercio Exterior para aplicar tu rol.
                        </p>
                    </div>
                    <span class="text-4xl">
                        ‚û°Ô∏è
                    </span>
                </div>
            </a>
            
            <a href="lamerca.html" target="_blank" class="block">
                <div class="bg-white p-4 rounded-xl mb-8 shadow-md border-l-4 border-yellow-500 hover:bg-yellow-50 transition duration-300 cursor-pointer">
                    <p class="text-base font-bold mb-1 text-yellow-700">
                        [BETA] PROYECTO: LA MERCA (Feedback)
                    </p>
                    <p class="text-xs text-gray-600">
                        Si tienes una versi√≥n de desarrollo, puedes usar este enlace para pruebas y reportes.
                    </p>
                </div>
            </a>


            <h3 class="text-2xl font-bold mt-10 mb-5 text-gray-800 border-b pb-2">üéØ Misiones de Entrenamiento</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                
                <a href="#" onclick="openGame('icogame.html'); return false;" class="mission-card">
                    <h4 class="text-lg font-extrabold text-gray-800 mb-1">Misi√≥n 1: Prueba de Incoterms</h4>
                    <p class="text-sm text-gray-600">Eval√∫a tu dominio de los T√©rminos de Comercio Internacional (TCI).</p>
                </a>
                
                <a href="rompecabezas.html" class="mission-card">
                    <h4 class="text-lg font-extrabold text-gray-800 mb-1">Misi√≥n 2: Responsabilidad del TCI</h4>
                    <p class="text-sm text-gray-600">Identifica las obligaciones del comprador vs. vendedor en cada Incoterm.</p>
                </a>
                
                <a href="regulador.html" class="mission-card">
                    <h4 class="text-lg font-extrabold text-gray-800 mb-1">Misi√≥n 3: Verificaci√≥n de Regulaciones</h4>
                    <p class="text-sm text-gray-600">Eval√∫a el cumplimiento de las normativas aduaneras no arancelarias.</p>
                </a>

                <a href="rompearance.html" class="mission-card">
                    <h4 class="text-lg font-extrabold text-gray-800 mb-1">Misi√≥n 4: Clasificaci√≥n Arancelaria</h4>
                    <p class="text-sm text-gray-600">Asigna la subpartida arancelaria correcta seg√∫n la descripci√≥n de la mercanc√≠a.</p>
                </a>

                <a href="simuinco.html" class="mission-card">
                    <h4 class="text-lg font-extrabold text-gray-800 mb-1">Misi√≥n 5: Simulaci√≥n de Log√≠stica</h4>
                    <p class="text-sm text-gray-600">Simula el movimiento de la carga y el punto de transferencia de riesgo.</p>
                </a>

                <a href="costimpo.html" class="mission-card">
                    <h4 class="text-lg font-extrabold text-gray-800 mb-1">Misi√≥n 6: Landed Cost (Valoraci√≥n)</h4>
                    <p class="text-sm text-gray-600">Calcula el costo total de la importaci√≥n y la base gravable de aduanas.</p>
                </a>

            </div>

        </div>
    </div>

    <div id="rankingScreen" class="hidden bg-gray-50 min-h-screen animate-fade-in">
        <div class="bg-green-700 text-white py-4 px-6 mb-8 flex items-center justify-center gap-2 shadow-lg relative">
            <span class="text-3xl">üóÇÔ∏è</span>
            <h1 class="text-3xl font-extrabold">ADU<span class="text-white">CHAT</span></h1>
        </div>
        <div class="max-w-3xl mx-auto bg-white shadow-2xl rounded-xl p-6 md:p-10 -mt-20 relative z-10">
            <h2 class="text-2xl md:text-3xl font-extrabold mb-6 text-center text-gray-800">Ranking Global</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full border border-gray-200 rounded-xl overflow-hidden text-sm md:text-base">
                    <thead>
                        <tr class="bg-gray-100 text-left text-gray-600">
                            <th class="px-4 py-3 border-r border-gray-200 font-semibold">Posici√≥n</th>
                            <th class="px-4 py-3 border-r border-gray-200 font-semibold">Jugador</th>
                            <th class="px-4 py-3 font-semibold">Puntaje</th>
                        </tr>
                    </thead>
                    <tbody id="rankingTable" class="text-center"></tbody>
                </table>
            </div>
            <div class="text-center mt-8">
                <button onclick="backToMain()" class="menu-btn bg-green-600 hover:bg-green-700 focus:ring-green-400 flex items-center justify-center gap-2">
                    üîô Volver
                </button>
            </div>
        </div>
    </div>
    
    <div id="tutorialModal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl w-full max-w-2xl shadow-2xl overflow-y-auto max-h-[90vh]">
            <div class="p-6 md:p-8">
                <h2 class="text-3xl font-extrabold text-green-700 mb-4 border-b pb-2">Gu√≠a R√°pida del Dashboard AduWeb</h2>
                
                <p class="text-gray-700 mb-6">Este panel es tu centro de operaciones. Aqu√≠ tienes un desglose de las secciones clave:</p>
                
                <h4 class="text-xl font-bold text-gray-800 mt-4 mb-2 flex items-center gap-2">
                    1. üë§ Perfil y Rol (<span class="text-green-600">Arriba</span>)
                </h4>
                <ul class="list-disc list-inside ml-4 text-gray-600 mb-4 space-y-1 text-sm">
                    <li>Muestra tu **Nombre** y tu **Rol de Simulaci√≥n** actual.</li>
                    <li>**Objetivo:** Recordarte la perspectiva de tu entrenamiento.</li>
                    <li>**Acci√≥n:** El bot√≥n **"üíº Cambiar Rol"** te permite elegir uno de los 11 cargos para personalizar tu ruta.</li>
                </ul>

                <h4 class="text-xl font-bold text-gray-800 mt-4 mb-2 flex items-center gap-2">
                    2. üìä Estad√≠sticas Clave
                </h4>
                <ul class="list-disc list-inside ml-4 text-gray-600 mb-4 space-y-1 text-sm">
                    <li>**Puntaje Total:** Tu progreso acumulado en todas las misiones y simulaciones.</li>
                    <li>**Misiones:** Muestra las misiones completadas de 6 disponibles.</li>
                    <li>**Ranking:** Te lleva a la tabla de l√≠deres global.</li>
                </ul>

                <h4 class="text-xl font-bold text-gray-800 mt-4 mb-2 flex items-center gap-2">
                    3. üöÄ Empezar Simulaci√≥n
                </h4>
                <ul class="list-disc list-inside ml-4 text-gray-600 mb-4 space-y-1 text-sm">
                    <li>Es tu puerta de entrada al **Dashboard de Simulaci√≥n Avanzada (`lamerca.html`)**.</li>
                    <li>El contenido dentro de este dashboard est√° **personalizado** seg√∫n el rol que elegiste.</li>
                </ul>

                <h4 class="text-xl font-bold text-gray-800 mt-4 mb-2 flex items-center gap-2">
                    4. üéØ Misiones de Entrenamiento
                </h4>
                <ul class="list-disc list-inside ml-4 text-gray-600 mb-4 space-y-1 text-sm">
                    <li>**Misiones Fijas:** 6 actividades fundamentales (Incoterms, Clasificaci√≥n, Valoraci√≥n) obligatorias para todos los roles.</li>
                    <li>**Objetivo:** Dominar los pilares del comercio exterior antes de entrar a la simulaci√≥n compleja.</li>
                </ul>
            </div>
            
            <div class="p-6 md:p-8 bg-gray-100 border-t flex justify-end">
                <button onclick="hideTutorialGuide()" class="bg-red-500 text-white font-semibold px-6 py-3 rounded-xl hover:bg-red-600 transition">
                    Cerrar Gu√≠a
                </button>
            </div>
        </div>
    </div>


    <audio id="logoSound" src="swoosh.mp3" preload="auto"></audio>
    <audio id="soundLogin" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_4b2f6a041c.mp3?filename=success-1-6297.mp3"></audio>
    <audio id="soundBot" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_7e2d77e6f0.mp3?filename=pop-94319.mp3"></audio>
    <audio id="soundClick" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_c65a2c57b0.mp3?filename=click-124467.mp3"></audio>
    <audio id="soundWin" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_197b9d88a4.mp3?filename=success-fanfare-trumpets-6185.mp3"></audio>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-app.js";
        import { getDatabase, ref, get, update } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-database.js";

        // üîë CONSTANTES DE SESI√ìN
        const SESSION_KEY = 'aduweb_player_name';
        const SESSION_KEY_ID = 'aduweb_player_key';
        const SESSION_KEY_CAREER = 'aduweb_career';       // Clave para el ID del cargo
        const SESSION_KEY_CAREER_NAME = 'aduweb_career_name'; // Clave para el nombre del cargo

        // ‚öôÔ∏è Configuraci√≥n Firebase (Reemplazar con tu configuraci√≥n real si es necesario)
        const firebaseConfig = {
            apiKey: "AIzaSyB_eUoNQ7L4hd42SVPqbA7vNYHxpEii9To",
            authDomain: "dino-4fbde.firebaseapp.com",
            databaseURL: "https://dino-4fbde-default-rtdb.firebaseio.com",
            projectId: "dino-4fbde",
            storageBucket: "dino-4fbde.firebasestorage.app",
            messagingSenderId: "307345167689",
            appId: "1:307345167689:web:f75e11b0c68a3def253698",
            measurementId: "G-LFDL5N5VW3"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let currentUserKey = null;
        let playerNameGlobal = "";
        let currentCareerId = null;     // Estado en memoria del ID del cargo
        let currentCareerName = null;   // Estado en memoria del Nombre del cargo
        
        // üíº DATOS DE CARRERAS (Los 11 roles solicitados)
        const CAREER_ROLES = [
            { id: 'comex_analyst', name: 'Analista de Comercio Exterior', desc: 'Enfocado en procesos, documentaci√≥n y operativa aduanera.' },
            { id: 'customs_agent', name: 'Agente Aduanal/Despachante', desc: 'Especialista en legislaci√≥n, tr√°mites y representaci√≥n legal.' },
            { id: 'import_manager', name: 'Gerente de Importaciones', desc: 'Se centra en costos, valoraci√≥n y gesti√≥n de proveedores internacionales.' },
            { id: 'export_specialist', name: 'Especialista en Exportaciones', desc: 'Maneja Incoterms, log√≠stica de salida y regulaciones de destino.' },
            { id: 'logistics_coordinator', name: 'Coordinador de Log√≠stica', desc: 'Optimiza rutas, transporte, almacenamiento y transferencia de riesgo.' },
            { id: 'valuation_expert', name: 'Experto en Valoraci√≥n', desc: 'Profundiza en el c√°lculo del Landed Cost y la base gravable de tributos.' },
            { id: 'tariffs_specialist', name: 'Especialista en Aranceles', desc: 'Dominio de la Nomenclatura, clasificaci√≥n y reglas generales interpretativas.' },
            { id: 'compliance_officer', name: 'Oficial de Cumplimiento Aduanero', desc: 'Verifica el cumplimiento de regulaciones no arancelarias y restricciones.' },
            { id: 'supply_chain_planner', name: 'Planificador de Cadena de Suministro', desc: 'Integra procesos desde el origen hasta el destino final (end-to-end).' },
            { id: 'trade_consultant', name: 'Consultor de Negocios Internacionales', desc: 'Visi√≥n estrat√©gica de negociaci√≥n, Incoterms y acuerdos comerciales.' },
            { id: 'incoterms_auditor', name: 'Auditor de Incoterms', desc: 'Revisa contratos y documentos para validar el uso correcto de los T√©rminos.' },
        ];


        // ----------------------------------------------------------------------
        // üîÑ FUNCIONES DE VISTAS (SCREEN SWITCHING)
        // ----------------------------------------------------------------------
        
        // Funci√≥n general para cambiar de pantalla
        function showScreen(screenId) {
            // Oculta todas las pantallas principales
            const screens = ["loginScreen", "mainScreen", "rankingScreen", "careerSelectionScreen", "tutorialModal"];
            screens.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                     element.classList.add("hidden");
                }
            });
            // Muestra la pantalla solicitada
            const screen = document.getElementById(screenId);
            if (screen) {
                screen.classList.remove("hidden");
                screen.classList.add("animate-fade-in");
            }
        }

        // Muestra la pantalla de selecci√≥n de carrera
        function showCareerSelection() {
            renderCareerList(); 
            showScreen("careerSelectionScreen");
        }

        // Muestra el Dashboard principal de la carrera
        function showCareerDashboard() {
            // Actualiza la UI con la informaci√≥n del rol seleccionado
            document.getElementById("playerName").textContent = playerNameGlobal;
            document.getElementById("currentRoleDisplay").textContent = currentCareerName || '[ROL SIN ASIGNAR]';
            document.getElementById("playerRoleTitle").textContent = currentCareerName || 'Asesor';

            showScreen("mainScreen");
        }
        
        // Funci√≥n llamada al hacer click en una carrera
        function selectCareer(careerId, careerName) {
            localStorage.setItem(SESSION_KEY_CAREER, careerId);
            localStorage.setItem(SESSION_KEY_CAREER_NAME, careerName);
            currentCareerId = careerId;
            currentCareerName = careerName;
            
            // Va al dashboard despu√©s de seleccionar
            showCareerDashboard();
        }

        // Renderiza las 11 tarjetas de carrera
        function renderCareerList() {
            const listContainer = document.getElementById('careerList');
            if (!listContainer) return;
            
            listContainer.innerHTML = CAREER_ROLES.map(role => `
                <button onclick="selectCareer('${role.id}', '${role.name}')" class="bg-white p-5 rounded-xl shadow-lg border-b-4 border-green-500 hover:shadow-xl hover:bg-green-50 transition duration-300 text-left flex flex-col justify-between h-full">
                    <h4 class="text-xl font-extrabold text-gray-800 mb-1 flex items-center gap-2">
                        üíº ${role.name}
                    </h4>
                    <p class="text-sm text-gray-600">${role.desc}</p>
                </button>
            `).join('');
        }

        // üìö Muestra el modal de la gu√≠a
        function showTutorialGuide() {
            const modal = document.getElementById('tutorialModal');
            if (modal) {
                modal.classList.remove('hidden');
            }
        }

        // ‚ùå Oculta el modal de la gu√≠a
        function hideTutorialGuide() {
            const modal = document.getElementById('tutorialModal');
            if (modal) {
                modal.classList.add('hidden');
            }
        }
        
        // ----------------------------------------------------------------------
        // üíæ FUNCIONES DE PROGRESO Y GUARDADO DE SESI√ìN
        // ----------------------------------------------------------------------

        /**
         * Recopila el estado actual del usuario y lo guarda en Firebase
         * como parte del historial de sesi√≥n y el √∫ltimo estado conocido.
         */
        async function saveUserProgress() {
            if (!currentUserKey) {
                return true; 
            }
            
            // 1. Recopilar Datos de la Sesi√≥n Actual
            const userProgressData = {
                careerId: localStorage.getItem(SESSION_KEY_CAREER) || 'N/A',
                careerName: localStorage.getItem(SESSION_KEY_CAREER_NAME) || 'Sin Rol',
                lastMissionCompleted: "Misi√≥n 3: Verificaci√≥n de Regulaciones (Simulado)", // Ejemplo de dato
                simulatorTaskPending: "An√°lisis de Ajustes al Valor (Pendiente)", // Ejemplo de dato
                sessionEndTime: new Date().toISOString(),
                scoreSnapshot: parseInt(document.getElementById("playerScore").textContent) || 0,
                misionsCompletedSnapshot: document.getElementById("playerProgress").textContent || "0/6",
            };

            // 2. Definir la nueva estructura de datos a enviar a Firebase
            const updates = {};
            const historyRef = `usuarios/${currentUserKey}/sessionHistory`;
            const lastStateRef = `usuarios/${currentUserKey}/lastKnownState`;
            
            // Generar una clave √∫nica para el historial (timestamp)
            const newHistoryKey = Date.now();
            
            // Guardar el registro en el historial
            updates[`${historyRef}/${newHistoryKey}`] = userProgressData;
            // Guardar el estado actual como la √∫ltima sesi√≥n conocida para la carga r√°pida
            updates[lastStateRef] = userProgressData;

            try {
                await update(ref(db), updates);
                return true; // Guardado exitoso
            } catch (error) {
                console.error("Error al guardar el progreso en Firebase:", error);
                return false; // Error en el guardado
            }
        }


        /**
         * üì§ LOGOUT - Modificada para preguntar si desea guardar el progreso con animaciones.
         */
        async function logout() {
            playSound("soundClick");

            const result = await Swal.fire({
                title: '¬øQuieres guardar tu progreso?',
                text: "Guardaremos tu rol, puntaje y tareas pendientes para continuar despu√©s.",
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#10b981', // Verde
                cancelButtonColor: '#ef4444',  // Rojo
                confirmButtonText: 'S√≠, Guardar y Salir',
                cancelButtonText: 'No Guardar y Salir'
            });

            // Proceso de Cierre de Sesi√≥n
            if (result.isConfirmed) {
                // --- INICIA ANIMACI√ìN DE CARGA ---
                const loadingSwal = Swal.fire({
                    title: 'Guardando Progreso...',
                    html: 'Por favor, espera mientras actualizamos tu historial.',
                    timerProgressBar: true,
                    didOpen: () => {
                        Swal.showLoading();
                    },
                    allowOutsideClick: false,
                    allowEscapeKey: false
                });

                // Llama a la funci√≥n de guardado
                const success = await saveUserProgress();

                loadingSwal.close();
                
                if (success) {
                    // --- ANIMACI√ìN DE LISTO ---
                    await Swal.fire({
                        title: '¬°Guardado Completo!',
                        text: 'Tu progreso ha sido salvado en la nube.',
                        icon: 'success',
                        showConfirmButton: false,
                        timer: 1500
                    });
                } else {
                    await Swal.fire({
                        title: 'Error de Guardado',
                        text: 'Hubo un error al guardar. Revisa tu conexi√≥n. Saliendo sin guardar.',
                        icon: 'error',
                        confirmButtonText: 'Entendido'
                    });
                }
            }
            
            // 3. Limpieza de Sesi√≥n Local
            localStorage.removeItem(SESSION_KEY);
            localStorage.removeItem(SESSION_KEY_ID);
            localStorage.removeItem(SESSION_KEY_CAREER);       
            localStorage.removeItem(SESSION_KEY_CAREER_NAME);  
            
            currentUserKey = null;
            playerNameGlobal = "";
            currentCareerId = null;
            currentCareerName = null;

            showScreen("loginScreen");
            document.getElementById("userName").value = "";

            // Muestra una alerta simple de cierre si el usuario NO eligi√≥ guardar.
            if (!result.isConfirmed) {
                 Swal.fire({
                    title: 'Sesi√≥n Cerrada',
                    text: 'Tu progreso actual no fue guardado.',
                    icon: 'info',
                    timer: 2000,
                    showConfirmButton: false
                });
            }
        }
        
        // ----------------------------------------------------------------------
        // üöÄ INICIO DE SESI√ìN Y RUTAS (Actualizado para cargar lastKnownState)
        // ----------------------------------------------------------------------

        // Funci√≥n central para cargar datos y decidir la ruta (Login/Selecci√≥n/Dashboard)
        function loadUserDataAndRoute(data) {
            playerNameGlobal = data.nombre;
            currentUserKey = data.key;
            
            // üÜï NUEVO: Priorizar la carga de la carrera desde el √∫ltimo estado conocido en Firebase
            const lastState = data.lastKnownState;
            
            if (lastState && lastState.careerId) {
                currentCareerId = lastState.careerId;
                currentCareerName = lastState.careerName;
                
                // Actualizar localStorage para reflejar el estado de Firebase
                localStorage.setItem(SESSION_KEY_CAREER, currentCareerId);
                localStorage.setItem(SESSION_KEY_CAREER_NAME, currentCareerName);
                
                // Cargar datos de progreso si existen
                document.getElementById("playerScore").textContent = lastState.scoreSnapshot || data.puntaje || 0;
                document.getElementById("playerProgress").textContent = lastState.misionsCompletedSnapshot || data.misiones_completadas + "/6" || "0/6";

            } else {
                // Comportamiento anterior: Cargar desde localStorage o valores por defecto
                currentCareerId = localStorage.getItem(SESSION_KEY_CAREER);
                currentCareerName = localStorage.getItem(SESSION_KEY_CAREER_NAME);
                
                document.getElementById("playerScore").textContent = data.puntaje || 0;
                const progress = data.misiones_completadas || 0;
                document.getElementById("playerProgress").textContent = progress + "/6";
            }

            // Decide la ruta
            if (!currentCareerId) {
                showCareerSelection();
            } else {
                document.getElementById("currentRoleDisplay").textContent = currentCareerName;
                showCareerDashboard();
            }

            document.getElementById("loginScreen").classList.add("hidden");
        }


        // üì• LOGIN (Actualizado con SweetAlert2)
        async function login() {
            const userName = document.getElementById("userName").value.trim().toLowerCase();
            if (!userName) {
                Swal.fire({
                    title: '¬°Espera!',
                    text: 'Ingresa tu primer nombre para continuar.',
                    icon: 'warning',
                    confirmButtonColor: '#f59e0b'
                });
                return;
            }

            const loginBtn = document.querySelector('#loginScreen button');
            loginBtn.disabled = true;
            loginBtn.textContent = 'Buscando...';

            try {
                const snapshot = await get(ref(db, "usuarios"));
                if (snapshot.exists()) {
                    let encontrado = null;
                    snapshot.forEach((child) => {
                        const data = child.val();
                        const nombreBD = (data.nombre || "").toLowerCase();
                        if (nombreBD.includes(userName)) {
                            encontrado = { key: child.key, ...data };
                        }
                    });

                    if (encontrado) {
                        localStorage.setItem(SESSION_KEY, encontrado.nombre);
                        localStorage.setItem(SESSION_KEY_ID, encontrado.key);

                        loadUserDataAndRoute(encontrado);
                        playSound("soundLogin");
                        
                        // üåü Nueva Alerta Animada (¬°√âxito!)
                        Swal.fire({
                            title: `¬°Bienvenido, ${encontrado.nombre.toUpperCase()}!`,
                            text: `Tu rol de simulaci√≥n actual es: ${localStorage.getItem(SESSION_KEY_CAREER_NAME) || 'Sin asignar (Elige tu rol)'}.`,
                            icon: 'success', 
                            confirmButtonText: 'Continuar',
                            confirmButtonColor: '#10b981', // green-600
                        });


                    } else {
                        // ‚ùå Nueva Alerta Animada (¬°Error!)
                        Swal.fire({
                            title: 'Error de Acceso',
                            text: 'Usuario no encontrado en la base de datos.',
                            icon: 'error',
                            confirmButtonText: 'Entendido',
                            confirmButtonColor: '#ef4444' // red-500
                        });
                    }
                } else {
                    Swal.fire({
                        title: 'Error de BD',
                        text: 'No se encontraron usuarios en la base de datos.',
                        icon: 'error',
                        confirmButtonColor: '#ef4444'
                    });
                }
            } catch(e) {
                console.error(e);
                Swal.fire({
                    title: 'Error de Conexi√≥n',
                    text: 'Hubo un problema al conectar con Firebase.',
                    icon: 'error',
                    confirmButtonColor: '#ef4444'
                });
            } finally {
                loginBtn.disabled = false;
                loginBtn.textContent = 'Entrar';
            }
        }
        
        // Funci√≥n para obtener datos de Firebase por una clave espec√≠fica
        async function getPlayerByKey(key) {
             try {
                const snapshot = await get(ref(db, `usuarios/${key}`));
                if (snapshot.exists()) {
                    return { key: snapshot.key, ...snapshot.val() };
                }
                return null;
            } catch (error) {
                console.error("Error al obtener jugador por clave:", error);
                return null;
            }
        }

        // üîç CHECK SESSION
        async function checkSession() {
            const savedName = localStorage.getItem(SESSION_KEY);
            const savedKey = localStorage.getItem(SESSION_KEY_ID);
            
            if (savedName && savedKey) {
                const playerStatus = await getPlayerByKey(savedKey);
                
                if (playerStatus) {
                    playerStatus.key = savedKey;
                    loadUserDataAndRoute(playerStatus);
                } else {
                    localStorage.removeItem(SESSION_KEY);
                    localStorage.removeItem(SESSION_KEY_ID);
                }
            }
        }
        
        // ----------------------------------------------------------------------
        // üéØ OTRAS FUNCIONES (Ranking, Audio, Juegos)
        // ----------------------------------------------------------------------

        // üéµ Reproducir sonido
        function playSound(id) {
            const audio = document.getElementById(id);
            if (audio) {
                 audio.play().catch(e => console.log("Error al reproducir sonido:", e));
            }
        }

        // üèÜ Ranking (Mantenida)
        async function viewRanking() {
            const snapshot = await get(ref(db, "usuarios"));
            if (snapshot.exists()) {
                let ranking = [];
                snapshot.forEach((child) => {
                    const data = child.val();
                    ranking.push({
                        nombre: data.nombre,
                        // Usa puntaje del lastKnownState si existe, sino usa puntaje base.
                        puntaje: data.lastKnownState?.scoreSnapshot || data.puntaje || 0
                    });
                });

                ranking.sort((a, b) => b.puntaje - a.puntaje);

                const table = document.getElementById("rankingTable");
                table.innerHTML = "";
                ranking.forEach((player, i) => {
                    const row = document.createElement("tr");
                    row.className = "hover:bg-gray-50 transition-colors";
                    row.innerHTML = `
                        <td class="px-4 py-3 border-r border-gray-200">${i + 1}</td>
                        <td class="px-4 py-3 border-r border-gray-200">${player.nombre}</td>
                        <td class="px-4 py-3">${player.puntaje}</td>
                    `;
                    table.appendChild(row);
                });

                showScreen("rankingScreen");
            }
        }

        // üîô Volver (Mantenida)
        function backToMain() {
            showCareerDashboard(); // Vuelve al dashboard de la carrera
        }

        // Funci√≥n Gen√©rica para Abrir Juegos (Actualizada con SweetAlert2)
        function openGame(gameFile) {
            if (!playerNameGlobal) {
                Swal.fire({
                    title: 'Acceso Denegado',
                    text: 'Debes iniciar sesi√≥n para acceder a las actividades.',
                    icon: 'warning',
                    confirmButtonColor: '#f59e0b'
                });
                return;
            }
            
            if (gameFile === 'icogame.html') {
                 window.location.href = `${gameFile}?name=${encodeURIComponent(playerNameGlobal)}`;
            } else {
                window.location.href = gameFile;
            }
        }
        
        // ----------------------------------------------------------------------
        // üöÄ INICIALIZACI√ìN Y EXPORTACI√ìN DE FUNCIONES
        // ----------------------------------------------------------------------
        
        // L√≥gica de Splash Screen
        document.addEventListener('DOMContentLoaded', () => {
            const splash = document.getElementById('splashScreen');
            const logoSound = document.getElementById('logoSound');

            const soundTriggerTime = 2000;
            const totalDisplayTime = 7000;
            
            setTimeout(() => {
                if (logoSound) {
                    logoSound.play().catch(e => console.log('Error al reproducir el sonido:', e));
                }
            }, soundTriggerTime);

            setTimeout(() => {
                splash.style.opacity = '0';
                
                setTimeout(() => {
                    splash.style.display = 'none';
                    // üöÄ Llamada a la verificaci√≥n de sesi√≥n
                    checkSession(); 
                }, 500);
            }, totalDisplayTime);
            
            // üõ†Ô∏è PWA / SERVICE WORKER REGISTRATION (Mantengo el bloque original)
             if ('serviceWorker' in navigator) {
                 window.addEventListener('load', () => {
                     navigator.serviceWorker.register('/beta/sw.js', { scope: '/beta/' })
                         .then(registration => {
                             console.log('Service Worker registrado con √©xito. Scope:', registration.scope);
                         })
                         .catch(registrationError => {
                             console.log('Fallo el registro del Service Worker:', registrationError);
                         });
                 });
             }
        });

        // Exportaci√≥n de funciones globales para que funcionen con los atributos 'onclick' del HTML
        window.login = login;
        window.logout = logout;
        window.viewRanking = viewRanking;
        window.backToMain = backToMain;
        window.openGame = openGame;
        window.showCareerSelection = showCareerSelection;
        window.selectCareer = selectCareer; 
        window.showTutorialGuide = showTutorialGuide; 
        window.hideTutorialGuide = hideTutorialGuide;
        window.saveUserProgress = saveUserProgress; 
    </script>
</body>
</html>
