<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sala Multijugador - ADUWEB Simulaci√≥n</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        /* Animaci√≥n de entrada */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.5s ease-out; }

        .role-card {
            /* Estilo base */
            @apply bg-white p-4 rounded-xl shadow-md border-2 border-gray-200 hover:border-green-500 hover:bg-green-50 transition duration-200 cursor-pointer text-center flex flex-col items-center justify-center min-h-[120px];
        }
        .role-card.selected {
            /* Estilo cuando el jugador actual lo selecciona */
            @apply ring-4 ring-green-300 border-green-500 bg-green-100;
        }
        .role-card.disabled {
            /* Estilo cuando otro jugador lo selecciona */
            @apply bg-gray-200 border-gray-300 opacity-70 cursor-not-allowed pointer-events-none;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <!-- NUEVO HEADER ESTANDARIZADO -->
    <header class="bg-white py-4 px-6 shadow-md sticky top-0 z-20 border-b">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-4">
                <span class="text-2xl font-extrabold text-green-700">ADUWEB</span>
                <span class="text-sm font-light text-gray-500 hidden sm:block">| Sala de Espera</span>
            </div>
        </div>
    </header>

    <main class="max-w-4xl w-full p-6 md:p-10 mx-auto animate-fade-in">
        <h1 class="text-3xl font-extrabold text-gray-900 border-b pb-4 mb-8 flex items-center gap-3">
            <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-600"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
            Sala de Espera Multijugador
        </h1>
        
        <div id="roomControls" class="space-y-4">
            <h2 class="text-xl font-bold text-gray-700">Opciones de Sala</h2>
            <div class="flex space-x-4">
                <input type="text" id="roomIdInput" placeholder="ID de Sala (Ej: SALA-001)" class="flex-grow p-3 border-2 border-gray-300 rounded-lg">
                <button onclick="joinRoomFromInput()" class="p-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition shadow-md">
                    Unirse a Sala
                </button>
            </div>
            <button onclick="createRoom()" class="w-full p-3 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 transition shadow-md">
                Crear Nueva Sala
            </button>
        </div>

        <div id="roomDashboard" class="hidden space-y-6 bg-gray-50 p-6 rounded-xl border border-gray-200">
            <h2 class="text-2xl font-bold text-gray-800 flex justify-between items-center">
                Sala Activa: <span id="currentRoomDisplay" class="text-blue-600"></span>
                <span id="playerCount" class="text-sm font-semibold bg-yellow-400 px-3 py-1 rounded-full">0/5 Jugadores</span>
            </h2>

            <div class="flex justify-between items-center">
                 <button onclick="leaveGame()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-semibold transition shadow-md flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-log-out"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                    Salir de Sala
                </button>
                <button id="startGameButton" onclick="startGame()" class="p-3 bg-indigo-600 text-white font-bold rounded-lg transition opacity-50 cursor-not-allowed shadow-md" disabled>
                    Iniciar Simulaci√≥n
                </button>
            </div>
            
            <div id="caseSelection" class="hidden pt-4 border-t">
                <label for="caseSelector" class="block text-lg font-bold text-gray-700 mb-2">Seleccionar Caso de Estudio:</label>
                <select id="caseSelector" class="w-full p-3 border-2 border-gray-300 rounded-lg bg-white">
                    <!-- Las opciones se cargar√°n din√°micamente -->
                </select>
            </div>

            <h3 class="text-xl font-bold text-gray-700 pt-4 border-t">Selecciona tu Cargo (Rol)</h3>
            
            <div id="roleSelectionContainer" class="grid grid-cols-1 md:grid-cols-5 gap-4">
                </div>
            
            <h3 class="text-xl font-bold text-gray-700 pt-4 border-t">Jugadores en Sala</h3>
            <ul id="playerList" class="space-y-2 text-gray-600">
                </ul>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-app.js";
        import { getDatabase, ref, set, get, update, remove, runTransaction, onValue, off } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-database.js";

        // ‚öôÔ∏è Configuraci√≥n Firebase (Reemplaza con tu configuraci√≥n)
        const firebaseConfig = {
            apiKey: "AIzaSyB_eUoNQ7L4hd42SVPqbA7vNYHxpEii9To",
            authDomain: "dino-4fbde.firebaseapp.com",
            databaseURL: "https://dino-4fbde-default-rtdb.firebaseio.com",
            projectId: "dino-4fbde",
            storageBucket: "dino-4fbde.firebasestorage.app",
            messagingSenderId: "307345167689",
            appId: "1:307345167689:web:f75e11b0c68a3def253698",
            measurementId: "G-LFDL5N5VW3"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // üîë VARIABLES CLAVE
        let currentRoomId = null;
        let currentPlayerKey = null;
        let playerName = null;
        let isRoomLeader = false;
        let roomListener = null; 

        // üéØ ROLES DEFINITIVOS PARA ESTA SIMULACI√ìN (5 Jugadores)
        const GAME_ROLES_IDS = [
            'tariffs_specialist', ¬† // Posici√≥n 1: Clasificaci√≥n (INICIA)
            'compliance_officer', ¬† // Posici√≥n 2: Regulaciones
            'valuation_expert', ¬† ¬† // Posici√≥n 3: Valoraci√≥n
            'logistics_coordinator',// Posici√≥n 4: Log√≠stica
            'import_manager' ¬† ¬† ¬† ¬†// Posici√≥n 5: Decisi√≥n Final
        ];

        // Mapeo de IDs de rol a nombres legibles (Para la UI)
        const ROLE_NAMES = {
            'tariffs_specialist': 'Especialista en Aranceles',
            'compliance_officer': 'Oficial de Cumplimiento',
            'valuation_expert': 'Experto en Valoraci√≥n',
            'logistics_coordinator': 'Coordinador de Log√≠stica',
            'import_manager': 'Gerente de Importaciones'
        };

        // ----------------------------------------------------------------------
        // üîÑ FUNCIONES DE FIREBASE Y TIEMPO REAL
        // ----------------------------------------------------------------------

        /**
         * üü¢ Inicia la escucha en tiempo real de la sala actual.
         */
        function startListening(roomId) {
            if (roomListener) {
                off(roomListener);
            }
            
            const roomRef = ref(db, `partidas_activas/${roomId}`);
            
            roomListener = onValue(roomRef, (snapshot) => {
                const roomData = snapshot.val();
                if (!roomData) {
                    if (currentRoomId === roomId) {
                         Swal.fire('Atenci√≥n', 'La sala ha sido cerrada.', 'info');
                         leaveGame(false); 
                    }
                    return;
                }

                renderRoomState(roomData);
                
                // üöÄ L√≥gica de inicio de juego
                if (roomData.estado === 'EN_CURSO') {
                    const assignedRole = roomData.jugadores[currentPlayerKey]?.rol_id;
                    
                    if (!assignedRole) {
                         Swal.fire('Error', 'No se encontr√≥ tu rol asignado.', 'error');
                         return;
                    }

                    Swal.fire({
                        title: '¬°Juego Iniciado!',
                        text: `Redirigiendo a tu dashboard de rol (${assignedRole})...`,
                        icon: 'success',
                        timer: 1500,
                        showConfirmButton: false,
                        didClose: () => {
                            window.location.href = `lamerca.html?room=${currentRoomId}&role=${assignedRole}`;
                        }
                    });
                    off(roomListener); 
                }
            });
        }

        async function populateCaseSelector() {
            const selector = document.getElementById('caseSelector');
            selector.innerHTML = '';
            const casesRef = ref(db, 'casos_estudio');
            const snapshot = await get(casesRef);
            if (snapshot.exists()) {
                const cases = snapshot.val();
                Object.keys(cases).forEach(caseId => {
                    selector.innerHTML += `<option value="${caseId}">${caseId}: ${cases[caseId].nombre}</option>`;
                });
            }
        }

        /**
         * üé® Renderiza el estado de la sala, jugadores y roles.
         */
        function renderRoomState(roomData) {
            const players = roomData.jugadores || {};
            const playerKeys = Object.keys(players);
            
            // 1. Renderizar Jugadores en la lista
            const playerList = document.getElementById('playerList');
            playerList.innerHTML = '';
            playerKeys.forEach(key => {
                const player = players[key];
                const isLeader = key === roomData.leader_key;
                const isMe = key === currentPlayerKey;
                const roleName = player.rol_name || 'Esperando rol...';
                
                playerList.innerHTML += `
                    <li class="p-2 border-b flex justify-between items-center ${isMe ? 'bg-blue-100 rounded' : ''}">
                        <span>${player.nombre} ${isMe ? '(T√∫)' : ''}</span>
                        <span class="text-sm font-semibold">${roleName} ${isLeader ? 'üëë' : ''}</span>
                    </li>
                `;
            });
            
            // 2. Determinar roles ocupados
            const occupiedRoles = new Set(playerKeys.map(key => players[key].rol_id).filter(id => id));

            // 3. Renderizar Tarjetas de Rol
            const roleContainer = document.getElementById('roleSelectionContainer');
            roleContainer.innerHTML = '';
            
            GAME_ROLES_IDS.forEach(roleId => {
                const isOccupied = occupiedRoles.has(roleId);
                const playerInRole = isOccupied ? Object.values(players).find(p => p.rol_id === roleId) : null;
                const isMyRole = players[currentPlayerKey]?.rol_id === roleId;
                const className = `role-card ${isOccupied ? 'disabled' : ''} ${isMyRole ? 'selected' : ''}`;

                const iconSVG = {
                    selected: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="text-green-600"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>',
                    occupied: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="text-red-500"><circle cx="12" cy="12" r="10"></circle><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"></line></svg>',
                    available: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-400"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path></svg>'
                };
                const icon = isMyRole ? iconSVG.selected : (isOccupied ? iconSVG.occupied : iconSVG.available);
                const occupiedByHTML = isOccupied && !isMyRole ? `<span class="text-xs text-gray-500 mt-1">Tomado por: <strong>${playerInRole.nombre}</strong></span>` : '';

                roleContainer.innerHTML += `
                    <div id="role-${roleId}" class="${className}" onclick="${isOccupied ? '' : `handleRoleSelection('${roleId}', '${ROLE_NAMES[roleId]}')`}">
                        <div class="flex-grow flex flex-col items-center justify-center">
                            <span class="block mb-2">${icon}</span>
                            <p class="text-sm font-bold">${ROLE_NAMES[roleId]}</p>
                        </div>
                        <div class="h-6 mt-1">
                            ${occupiedByHTML}
                        </div>
                    </div>
                `;
            });

            // 4. Estado de la Sala y Bot√≥n de Inicio
            const playerCount = playerKeys.length;
            document.getElementById('currentRoomDisplay').textContent = currentRoomId;
            document.getElementById('playerCount').textContent = `${playerCount}/${GAME_ROLES_IDS.length} Jugadores`;
            
            const startGameButton = document.getElementById('startGameButton');
            
            const isReady = playerCount === GAME_ROLES_IDS.length && occupiedRoles.size === GAME_ROLES_IDS.length;

            // Mostrar selector de caso solo al l√≠der
            const caseSelectionDiv = document.getElementById('caseSelection');
            if (isRoomLeader) {
                caseSelectionDiv.classList.remove('hidden');
            }
            
            if (isRoomLeader && isReady) {
                startGameButton.disabled = false;
                startGameButton.classList.remove('opacity-50', 'cursor-not-allowed');
                startGameButton.textContent = 'Iniciar Simulaci√≥n';
            } else if (isRoomLeader) {
                startGameButton.disabled = true;
                startGameButton.classList.add('opacity-50', 'cursor-not-allowed');
                startGameButton.textContent = `Esperando ${GAME_ROLES_IDS.length - playerCount} jugadores...`;
            } else {
                startGameButton.disabled = true;
                startGameButton.classList.add('opacity-50', 'cursor-not-allowed');
                startGameButton.textContent = 'Esperando al L√≠der...';
            }
        }


        /**
         * üõ†Ô∏è FUNCI√ìN CORREGIDA: Transacci√≥n para seleccionar un rol.
         */
        async function handleRoleSelection(roleId, roleName) {
            const playersRef = ref(db, `partidas_activas/${currentRoomId}/jugadores`);

            try {
                const result = await runTransaction(playersRef, (currentPlayers) => {
                    if (currentPlayers) {
                        let roleIsFree = true;
                        
                        // 1. Verificar: ¬øEl rol ya est√° tomado por otro jugador?
                        for (const key in currentPlayers) {
                            if (key !== currentPlayerKey && currentPlayers[key].rol_id === roleId) {
                                roleIsFree = false;
                                return; // Abortar la transacci√≥n si el rol est√° ocupado
                            }
                        }

                        if (roleIsFree) {
                            // 2. Asignar: Si el rol est√° libre, se lo asignamos al jugador.
                            currentPlayers[currentPlayerKey].rol_id = roleId;
                            currentPlayers[currentPlayerKey].rol_name = roleName;
                            
                            // 3. Devolver el objeto modificado para COMITTEAR la transacci√≥n
                            return currentPlayers; 
                        }
                    }
                    return; 
                });

                if (result.committed) {
                    Swal.fire({
                        title: 'Rol Asignado',
                        text: `Has elegido: ${roleName}`,
                        icon: 'success',
                        toast: true,
                        position: 'top-end',
                        timer: 2000,
                        showConfirmButton: false
                    });
                } else if (result.snapshot.val()) {
                     Swal.fire('Atenci√≥n', 'Ese cargo ya fue tomado por otro jugador. Por favor, selecciona otro.', 'warning');
                }
                
            } catch(e) {
                console.error("Error en la transacci√≥n del rol:", e);
                Swal.fire('Error', 'No se pudo seleccionar el rol debido a un error de conexi√≥n.', 'error');
            }
        }

        /**
         * üö™ Elimina al jugador de la sala en Firebase y redirige.
         */
        async function leaveGame(notifyFirebase = true) {
            // Detener el listener antes de hacer cualquier otra cosa
            if (roomListener) {
                const unsubscribe = roomListener;
                unsubscribe();
                roomListener = null;
            }
            
            if (currentRoomId && currentPlayerKey && notifyFirebase) {
                const roomRef = ref(db, `partidas_activas/${currentRoomId}`);
                const playerRef = ref(db, `partidas_activas/${currentRoomId}/jugadores/${currentPlayerKey}`);
                
                // Primero, elimina al jugador
                await remove(playerRef);

                // Si el jugador que sale era el l√≠der, se necesita un nuevo l√≠der.
                if (isRoomLeader) {
                    const roomSnapshot = await get(roomRef);
                    if (roomSnapshot.exists()) {
                        const roomData = roomSnapshot.val();
                        const remainingPlayers = roomData.jugadores ? Object.keys(roomData.jugadores).sort() : []; // .sort() para consistencia
                        
                        if (remainingPlayers.length > 0) {
                            // Asigna el liderazgo al primer jugador que queda en la lista
                            await update(roomRef, { leader_key: remainingPlayers[0] });
                        } else {
                            // Si no quedan jugadores, la sala se elimina autom√°ticamente
                            await remove(roomRef);
                        }
                    }
                }
            }
            
            // Redirigir siempre al dashboard principal
            window.location.href = 'index.html'; 
        }

        /**
         * üöÄ Inicia el juego actualizando el estado de la sala a 'EN_CURSO'.
         */
        function startGame() {
            if (!isRoomLeader) return;

            const updates = {};
            const firstRole = GAME_ROLES_IDS[0]; // El primer rol: 'tariffs_specialist'

            // ¬°NUEVO! Guardar el caso seleccionado en la sala
            const selectedCaseId = document.getElementById('caseSelector').value;
            updates[`partidas_activas/${currentRoomId}/caseId`] = selectedCaseId;
            updates[`partidas_activas/${currentRoomId}/estado`] = 'EN_CURSO';
            updates[`partidas_activas/${currentRoomId}/proceso_global`] = firstRole; 
            // ¬°NUEVO! Establecer el tiempo de inicio para el cron√≥metro global
            updates[`partidas_activas/${currentRoomId}/startTime`] = Date.now();
            
            update(ref(db), updates)
                .then(() => {
                    console.log("Partida iniciada. Turno de:", firstRole);
                })
                .catch(error => {
                    Swal.fire('Error', 'No se pudo iniciar el juego.', 'error');
                });
        }
        
        // ----------------------------------------------------------------------
        // üõ†Ô∏è FUNCIONES DE UNI√ìN Y CREACI√ìN DE SALA (Implementaci√≥n Completa)
        // ----------------------------------------------------------------------

        /**
         * ‚úÖ Agrega los datos del jugador a la sala en Firebase.
         */
        async function addPlayerToRoom(roomId) {
            const playerRef = ref(db, `partidas_activas/${roomId}/jugadores/${currentPlayerKey}`);
            
            await set(playerRef, {
                nombre: playerName,
                rol_id: null,
                rol_name: null,
                is_leader: isRoomLeader 
            });
        }

        /**
         * üîë Finaliza la uni√≥n a la sala.
         */
        async function joinGameRoom(roomId, leaderKey = null) {
            currentRoomId = roomId;
            isRoomLeader = leaderKey === currentPlayerKey;

            await addPlayerToRoom(roomId); 

            document.getElementById('roomControls').classList.add('hidden');
            document.getElementById('roomDashboard').classList.remove('hidden');
            
            const startGameButton = document.getElementById('startGameButton');
            startGameButton.style.display = isRoomLeader ? 'block' : 'none';
            if (isRoomLeader) populateCaseSelector();

            startListening(roomId);
        }
        
        /**
         * ‚ûï Crea una sala y une al l√≠der.
         */
        async function createRoom() {
            const newRoomId = 'SALA-' + Math.random().toString(36).substring(2, 6).toUpperCase();
            
            await set(ref(db, `partidas_activas/${newRoomId}`), {
                id_sala: newRoomId,
                estado: 'ESPERA_JUGADORES',
                proceso_global: 'LOBBY',
                leader_key: currentPlayerKey, 
            });
            
            await joinGameRoom(newRoomId, currentPlayerKey);
        }

        /**
         * üîé Intenta unirse a una sala existente.
         */
        async function joinRoomFromInput() {
            const inputId = document.getElementById('roomIdInput').value.trim().toUpperCase();
            if (!inputId) {
                 Swal.fire('Error', 'Ingresa el ID de la sala.', 'error');
                 return;
            }
            
            const snapshot = await get(ref(db, `partidas_activas/${inputId}`));
            if (snapshot.exists()) {
                 const roomData = snapshot.val();
                 if (roomData.estado === 'EN_CURSO') {
                      Swal.fire('Error', 'La partida ya est√° en curso.', 'error');
                      return;
                 }
                 if (roomData.estado === 'COMPLETED') {
                      Swal.fire('Partida Finalizada', 'Esta simulaci√≥n ya ha terminado. No puedes unirte.', 'info');
                      return;
                 }
                 await joinGameRoom(inputId, roomData.leader_key);
            } else {
                 Swal.fire('Error', 'ID de sala no encontrado.', 'error');
            }
        }

        /**
         * NUEVA FUNCI√ìN: Al cargar la p√°gina, busca si el jugador ya est√° en una sala.
         */
        async function checkForExistingRoomAndJoin() {
            const loadingSwal = Swal.fire({
                title: 'Buscando tu sala...',
                text: 'Verificando si ya perteneces a una partida activa.',
                allowOutsideClick: false,
                didOpen: () => Swal.showLoading()
            });

            try {
                const gamesRef = ref(db, 'partidas_activas');
                const snapshot = await get(gamesRef);

                if (snapshot.exists()) {
                    const allGames = snapshot.val();
                    for (const roomId in allGames) {
                        const room = allGames[roomId];
                        if (room.jugadores && room.jugadores[currentPlayerKey] && room.proceso_global !== 'COMPLETED') {
                            // ¬°Encontrado! Unir al jugador a esta sala.
                            loadingSwal.close();
                            await joinGameRoom(roomId, room.leader_key);
                            return; // Detener la b√∫squeda
                        }
                    }
                }
                // Si el bucle termina, no se encontr√≥ ninguna sala.
                loadingSwal.close();
                // Se mostrar√°n los controles normales de "Crear/Unirse".
            } catch (error) {
                loadingSwal.close();
                Swal.fire('Error', 'No se pudo verificar tu estado en las salas. Por favor, intenta unirte manualmente.', 'error');
            }
        }

        // ----------------------------------------------------------------------
        // üöÄ INICIALIZACI√ìN
        // ----------------------------------------------------------------------
        
        document.addEventListener('DOMContentLoaded', () => {
            // Obtener PlayerKey (se asume que viene de index.html y est√° en localStorage)
            currentPlayerKey = localStorage.getItem('aduweb_player_key'); 
            playerName = localStorage.getItem('aduweb_player_name'); 
            
            if (!currentPlayerKey || !playerName) {
                Swal.fire({
                    title: 'Error de Sesi√≥n',
                    text: 'Debes iniciar sesi√≥n en la p√°gina principal para acceder a la sala.',
                    icon: 'error',
                    allowOutsideClick: false
                }).then(() => {
                    window.location.href = 'index.html'; 
                });
                return;
            }

            // ¬°NUEVO! Ejecutar la comprobaci√≥n de reconexi√≥n autom√°tica.
            checkForExistingRoomAndJoin();

            // Exportar funciones al scope global para que funcionen con onclick
            window.createRoom = createRoom;
            window.joinRoomFromInput = joinRoomFromInput;
            window.handleRoleSelection = handleRoleSelection;
            window.startGame = startGame;
            window.leaveGame = leaveGame;
        });
    </script>
</body>
</html>
