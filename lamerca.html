<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">Dashboard de Simulaci√≥n - ADUWEB</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        /* Estilo para la tarjeta de Tarea Activa */
        .mission-card {
            @apply bg-white p-6 rounded-xl shadow-2xl border-l-4 border-gray-400 transition duration-300;
        }
        .mission-card.active {
            /* Estilo cuando es el turno del jugador */
            @apply border-green-600 ring-4 ring-green-200;
        }

        /* Estilos para el mini-juego de "Raspar" */
        .scratch-card {
            @apply w-32 h-32 bg-gray-300 rounded-lg flex items-center justify-center cursor-pointer transition-all duration-300 shadow-md;
            background-image: linear-gradient(45deg, #bdc3c7, #2c3e50);
        }
        .scratch-card:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        .scratch-card.revealed {
            @apply cursor-default;
            background-image: none;
        }
        .scratch-card.correct {
            @apply bg-green-400 text-green-900 font-extrabold text-xl;
            animation: pulse-green 1s;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans text-gray-800">

    <header class="bg-gray-800 text-white py-4 px-6 shadow-lg sticky top-0 z-10">
        <div class="max-w-6xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-2">
                <span class="text-2xl">üåê</span>
                <h1 class="text-xl font-bold">Simulaci√≥n: La Merca</h1>
            </div>
            <div id="statusDisplay" class="bg-blue-600 px-3 py-1 rounded-full text-sm font-semibold">
                Sala: N/A | Turno: N/A
            </div>
            <button onclick="leaveGame()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm font-semibold transition">
                üö™ Salir de Sala
            </button>
        </div>
    </header>

    <main class="max-w-6xl mx-auto p-4 md:p-8">
        
        <div class="bg-white shadow-2xl rounded-xl p-6 md:p-8 mb-8 border-t-8 border-green-600">
            <h2 id="roleTitle" class="text-3xl font-extrabold text-gray-800 mb-1">
                [Rol Din√°mico]
            </h2>
            <p id="roleFocus" class="text-lg text-green-700 font-semibold mb-4">
                [Enfoque Din√°mico]
            </p>
            <div class="flex items-center text-gray-600 text-sm">
                <span id="playerInfo" class="mr-4">üë§ Jugador: [Nombre]</span>
            </div>
        </div>
        
        <div class="bg-indigo-50 p-4 rounded-xl border border-indigo-200 mb-8">
            <h3 class="text-xl font-bold text-indigo-800 mb-2">Flujo de la Simulaci√≥n</h3>
            <p id="globalStatus" class="text-lg font-semibold text-indigo-700">Esperando el inicio de la cadena de procesos...</p>
            <p class="text-sm text-indigo-600 mt-2">Tarea en Curso: <strong id="currentTurnRoleName">Nadie</strong></p>
        </div>


        <h3 class="text-2xl font-bold mb-5 text-gray-800 border-b pb-2">
            ‚úÖ Mi Tarea Activa: <span id="missionName" class="text-green-700"></span>
        </h3>
        
        <div id="roleTasksContainer" class="mission-card">
            <div class="text-center p-10">
                 <p class="text-gray-500 font-semibold">Cargando tu misi√≥n...</p>
            </div>
        </div>

    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-app.js";
        import { getDatabase, ref, onValue, update, off } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-database.js";
        
        // üîë CONSTANTES DE SESI√ìN Y ENTORNO
        const SESSION_KEY = 'aduweb_player_name';
        const SESSION_KEY_CAREER = 'aduweb_career';
        const SESSION_KEY_CAREER_NAME = 'aduweb_career_name';
        
        // ‚öôÔ∏è Configuraci√≥n Firebase (Debe coincidir con index.html)
        const firebaseConfig = {
            apiKey: "AIzaSyB_eUoNQ7L4hd42SVPqbA7vNYHxpEii9To",
            authDomain: "dino-4fbde.firebaseapp.com",
            databaseURL: "https://dino-4fbde-default-rtdb.firebaseio.com",
            projectId: "dino-4fbde",
            storageBucket: "dino-4fbde.firebasestorage.app",
            messagingSenderId: "307345167689",
            appId: "1:307345167689:web:f75e11b0c68a3def253698",
            measurementId: "G-LFDL5N5VW3"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // üéØ VARIABLES CLAVE DEL JUGADOR Y SALA
        let currentRoomId = null;
        let currentPlayerRole = null;
        let playerName = null;
        let roomListener = null;

        // ----------------------------------------------------------------------
        // üåê JERARQU√çA Y MISIONES DE SIMULACI√ìN (El motor del juego)
        // ----------------------------------------------------------------------

        // 1. Definici√≥n de la cadena de procesos (el cargo m√°s bajo comienza)
        const PROCESS_CHAIN = [
            'tariffs_specialist', ¬† // Tarea 1: Clasificaci√≥n
            'compliance_officer', ¬† // Tarea 2: Regulaciones
            'valuation_expert', ¬† ¬† // Tarea 3: Valoraci√≥n
            'logistics_coordinator',// Tarea 4: Log√≠stica y Flete
            'import_manager' ¬† ¬† ¬† ¬†// Tarea 5: Decisi√≥n Final
        ];
        
        // 2. Mapeo de misiones, entradas requeridas y la siguiente tarea en la cadena
        const ROLE_MISSION_DATA = {
            // TAREA 1: CLASIFICACI√ìN ARANCELARIA (Comienza el juego)
            'tariffs_specialist': { 
                missionName: 'Clasificaci√≥n de Mercanc√≠a',
                next: 'compliance_officer',
                input_key: 'tariffs_code', 
                required: [],
                // NUEVO: Mini-juego de "Raspa y Gana"
                game: {
                    html: `
                        <p class="text-gray-700 mb-4"><strong>Instrucci√≥n:</strong> El producto son "Laptops de alto rendimiento". Haz clic en las tarjetas para "rasparlas" y encontrar el c√≥digo arancelario correcto (Subpartida).</p>
                        <div id="scratch-game-container" class="grid grid-cols-3 gap-4 justify-items-center">
                            <!-- Las tarjetas se generar√°n aqu√≠ -->
                        </div>
                        <input type="hidden" id="missionInput" value="">
                    `,
                    init: (container) => {
                        const gameContainer = container.querySelector('#scratch-game-container');
                        const missionInput = container.querySelector('#missionInput');
                        const options = ['8528.71.00', '9001.30.00', '8471.30.00']; // Opci√≥n correcta es la √∫ltima
                        const correctCode = '8471.30.00';

                        // Barajar opciones
                        options.sort(() => Math.random() - 0.5);

                        options.forEach(code => {
                            const card = document.createElement('div');
                            card.className = 'scratch-card';
                            card.onclick = () => {
                                card.classList.add('revealed');
                                card.textContent = code;
                                if (code === correctCode) {
                                    card.classList.add('correct');
                                    missionInput.value = correctCode; // Guardar resultado en el input oculto
                                    gameContainer.querySelectorAll('.scratch-card').forEach(c => c.onclick = null); // Desactivar otras tarjetas
                                }
                            };
                            gameContainer.appendChild(card);
                        });
                    }
                }
            },
            // TAREA 2: VERIFICACI√ìN DE REGULACIONES
            'compliance_officer': { 
                missionName: 'Verificaci√≥n de Regulaciones (RNA)',
                next: 'valuation_expert',
                input_key: 'rna_check',
                required: ['tariffs_code'], // Requiere la clasificaci√≥n del anterior
                game: {
                    html: (inputData) => `
                        <p class="text-gray-700 mb-4"><strong>Clasificaci√≥n recibida del Especialista:</strong> <span class="font-bold text-lg text-blue-600">${inputData.tariffs_code || 'Esperando dato...'}</span></p>
                        <p class="text-gray-700 mb-4"><strong>Instrucci√≥n:</strong> Revisa las Regulaciones No Arancelarias (RNA) para esta subpartida. Si cumple, selecciona OK. Este resultado lo usar√° el Experto en Valoraci√≥n.</p>
                        <select id="missionInput" class="w-full p-3 border-2 border-gray-300 rounded-lg">
                            <option value="">-- Seleccionar Cumplimiento --</option>
                            <option value="RNA_OK">Cumple con RNA / Permisos OK</option>
                            <option value="RNA_PENDIENTE">Pendiente por Certificado</option>
                        </select>
                    `,
                    init: () => {} // No necesita inicializaci√≥n especial
                }
            },
            // TAREA 3: DETERMINACI√ìN DE VALOR
            'valuation_expert': { 
                missionName: 'C√°lculo del Valor en Aduana',
                next: 'logistics_coordinator',
                input_key: 'customs_value', 
                required: ['rna_check'],
                game: {
                    html: (inputData) => `
                        <p class="text-gray-700 mb-4"><strong>Estado de Regulaci√≥n recibido:</strong> <span class="font-bold text-lg ${inputData.rna_check === 'RNA_OK' ? 'text-green-600' : 'text-red-600'}">${inputData.rna_check || 'Esperando dato...'}</span></p>
                        <p class="text-gray-700 mb-4"><strong>Instrucci√≥n:</strong> Con base en el resultado anterior, ingresa el Valor en Aduana final (CIF) en USD.</p>
                        <input type="number" id="missionInput" placeholder="Ej: 15500.00" class="w-full p-3 border-2 border-gray-300 rounded-lg">
                    `,
                    init: () => {}
                }
            },
            // TAREA 4: GESTI√ìN DE LOG√çSTICA
            'logistics_coordinator': { 
                missionName: 'Confirmaci√≥n de Flete y Seguros',
                next: 'import_manager',
                input_key: 'final_freight', 
                required: ['customs_value'],
                game: {
                    html: (inputData) => `
                        <p class="text-gray-700 mb-4"><strong>Valor en Aduana recibido:</strong> <span class="font-bold text-lg text-blue-600">USD ${inputData.customs_value || 'Esperando dato...'}</span></p>
                        <p class="text-gray-700 mb-4"><strong>Instrucci√≥n:</strong> Ingresa el costo final de Flete y Seguros (separado del valor de mercanc√≠a) en USD.</p>
                        <input type="number" id="missionInput" placeholder="Ej: 2500.00" class="w-full p-3 border-2 border-gray-300 rounded-lg">
                    `,
                    init: () => {}
                }
            },
            // TAREA 5: GERENTE DE IMPORTACI√ìN (Finaliza el juego)
            'import_manager': { 
                missionName: 'Decisi√≥n Final y Visto Bueno',
                next: 'COMPLETED',
                input_key: 'final_decision',
                required: ['final_freight'],
                game: {
                    html: (inputData) => `
                        <p class="text-gray-700 mb-4"><strong>Costo de Flete y Seguros recibido:</strong> <span class="font-bold text-lg text-purple-600">USD ${inputData.final_freight || 'Esperando dato...'}</span></p>
                        <p class="text-gray-700 mb-4"><strong>Instrucci√≥n:</strong> Con todos los datos previos, aprueba la operaci√≥n o env√≠ala a correcci√≥n. Esta es la √∫ltima etapa.</p>
                        <select id="missionInput" class="w-full p-3 border-2 border-gray-300 rounded-lg">
                            <option value="">-- Seleccionar Decisi√≥n --</option>
                            <option value="APROBADO">APROBAR Operaci√≥n</option>
                            <option value="RECHAZADO">RECHAZAR / Enviar a Correcci√≥n</option>
                        </select>
                    `,
                    init: () => {}
                }
            },
            
            // Fallback para roles no incluidos en el juego
            'default': { 
                game: { html: () => `<p class="text-xl font-bold text-red-800">Tu rol no participa en esta simulaci√≥n multijugador.</p>`, init: () => {} }
            }
        };
        
        // ----------------------------------------------------------------------
        // üîÑ FUNCIONES DE TIEMPO REAL (CORE RTDB)
        // ----------------------------------------------------------------------
        
        /**
         * üü¢ Inicia la escucha en tiempo real de la sala para el flujo de turnos.
         */
        function startListening(roomId) {
            // Asegurarse de detener cualquier escucha anterior
            if (roomListener) {
                off(roomListener);
            }
            const roomRef = ref(db, `partidas_activas/${roomId}`);
            
            roomListener = onValue(roomRef, (snapshot) => {
                const roomData = snapshot.val();
                if (!roomData) {
                    Swal.fire('Atenci√≥n', 'El l√≠der cerr√≥ la sala o la partida finaliz√≥.', 'info');
                    window.location.href = 'index.html'; 
                    return;
                }

                const currentGlobalProcess = roomData.proceso_global;
                const lastResults = roomData.resultados || {};
                
                renderRoomState(roomData, currentGlobalProcess);
                renderMyTask(currentGlobalProcess, lastResults);
            });
        }
        
        /**
         * üé® Actualiza la UI con el estado global de la simulaci√≥n.
         */
        function renderRoomState(roomData, currentGlobalProcess) {
            const players = roomData.jugadores || {};
            const playerInTurn = Object.values(players).find(p => p.rol_id === currentGlobalProcess);
            
            let turnText = 'Esperando inicio de la partida...';
            if (currentGlobalProcess === 'INICIANDO_SIMULACION') {
                turnText = 'Iniciando el primer turno...';
            } else if (currentGlobalProcess === 'COMPLETED') {
                turnText = '¬°SIMULACI√ìN FINALIZADA! Revisa los resultados.';
            } else if (playerInTurn) {
                turnText = `Esperando la acci√≥n de: ${playerInTurn.nombre} (${currentGlobalProcess.toUpperCase()})`;
            }

            document.getElementById('globalStatus').textContent = turnText;
            document.getElementById('currentTurnRoleName').textContent = currentGlobalProcess === 'COMPLETED' ? 'FINALIZADO' : (playerInTurn ? playerInTurn.nombre : 'Calculando...');
        }

        /**
         * üéØ Renderiza la misi√≥n espec√≠fica del jugador y gestiona el turno.
         */
        function renderMyTask(currentGlobalProcess, lastResults) {
            const taskCard = document.getElementById('roleTasksContainer');
            const myTaskData = ROLE_MISSION_DATA[currentPlayerRole] || ROLE_MISSION_DATA['default'];
            
            // 1. Renderizar la misi√≥n espec√≠fica para este rol.
            document.getElementById('missionName').textContent = myTaskData.missionName || 'Tarea no definida';
            
            // Renderizar el HTML de la tarea, pasando los resultados previos si aplica.
            const gameHtml = myTaskData.game.html;
            taskCard.innerHTML = (typeof gameHtml === 'function') ? gameHtml(lastResults) : gameHtml;

            // Inicializar el script del mini-juego si existe
            if (myTaskData.game.init) myTaskData.game.init(taskCard);
            
            // 2. Comprobar el turno
            const isMyTurn = currentGlobalProcess === currentPlayerRole;
            
            // 3. Activar/Desactivar controles
            if (isMyTurn) {
                taskCard.classList.remove('inactive');
                taskCard.classList.add('active');
                
                const submitBtn = document.createElement('button');
                submitBtn.id = 'submitTaskBtn';
                submitBtn.onclick = submitTaskResult;
                submitBtn.className = 'w-full p-3 mt-6 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 transition';
                submitBtn.textContent = 'Enviar Resultado y Pasar Turno';
                taskCard.appendChild(submitBtn);
                
                // Mostrar alerta si el turno es nuestro
                Swal.fire({
                    title: '¬°Es tu Turno!',
                    text: `La tarea de ${myTaskData.missionName} te est√° esperando.`,
                    icon: 'info',
                    toast: true,
                    position: 'top-end',
                    timer: 3000,
                    showConfirmButton: false
                });

            } else {
                // Desactivar y mostrar mensaje de espera
                taskCard.classList.remove('active');
                taskCard.classList.add('inactive');
                taskCard.innerHTML += `<p class="mt-4 text-center text-red-600 font-semibold">Esperando la acci√≥n del cargo anterior...</p>`;
            }
        }

        /**
         * üíæ Env√≠a el resultado de mi tarea y pasa el turno al siguiente rol.
         */
        function submitTaskResult() {
            const missionInput = document.getElementById('missionInput');
            const result = missionInput ? missionInput.value.trim() : null;
            
            if (!result) {
                Swal.fire('Atenci√≥n', 'Debes completar el campo antes de enviar.', 'warning');
                return;
            }

            const myTaskData = ROLE_MISSION_DATA[currentPlayerRole];
            const nextRole = myTaskData.next;
            
            // 1. Preparar las actualizaciones
            const updates = {};
            // Guardar el resultado de mi tarea en la base de datos de la sala
            updates[`partidas_activas/${currentRoomId}/resultados/${myTaskData.input_key}`] = result;
            
            // 2. Pasar el turno al siguiente rol en la cadena
            updates[`partidas_activas/${currentRoomId}/proceso_global`] = nextRole;
            
            // 3. Ejecutar la actualizaci√≥n
            update(ref(db), updates)
                .then(() => {
                    if (nextRole === 'COMPLETED') {
                        Swal.fire('¬°Misi√≥n Finalizada!', 'Has completado la cadena de procesos de la simulaci√≥n.', 'success');
                        // Redireccionar al dashboard de resultados si es el final
                    } else {
                        Swal.fire('¬°Tarea Completada!', `Pasando el turno a: ${nextRole.toUpperCase()}`, 'success');
                    }
                })
                .catch(error => {
                    Swal.fire('Error', 'No se pudo enviar el resultado. Revisa tu conexi√≥n.', 'error');
                    console.error("Error al actualizar la DB:", error);
                });
        }
        
        /**
         * üö™ Sale de la sala y regresa al men√∫ principal.
         */
        function leaveGame() {
            if (roomListener) {
                off(roomListener);
            }
            window.location.href = 'index.html'; 
        }

        // ----------------------------------------------------------------------
        // üöÄ INICIALIZACI√ìN
        // ----------------------------------------------------------------------
        
        document.addEventListener('DOMContentLoaded', () => {
            // 1. Obtener par√°metros del URL (room y role)
            const urlParams = new URLSearchParams(window.location.search);
            currentRoomId = urlParams.get('room');
            currentPlayerRole = urlParams.get('role');
            playerName = localStorage.getItem(SESSION_KEY);
            const careerName = localStorage.getItem(SESSION_KEY_CAREER_NAME);

            // Si falta alguno, redirigir
            if (!currentRoomId || !currentPlayerRole) {
                Swal.fire('Error', 'Datos de sala o rol faltantes.', 'error').then(() => {
                    window.location.href = 'index.html'; 
                });
                return;
            }
            
            const dashboardData = ROLE_DASHBOARDS[currentPlayerRole] || ROLE_DASHBOARDS['default'];
            
            // 2. Cargar UI est√°tica
            document.getElementById('pageTitle').textContent = `Misi√≥n: ${careerName} - ADUWEB`;
            document.getElementById('statusDisplay').textContent = `Sala: ${currentRoomId} | Rol: ${currentPlayerRole.toUpperCase()}`;
            document.getElementById('playerInfo').textContent = `üë§ Jugador: ${playerName}`;
            document.getElementById('roleTitle').innerHTML = `${dashboardData.icon || 'üíº'} ${careerName || dashboardData.title}`;
            document.getElementById('roleFocus').textContent = dashboardData.focus;
            
            // 3. Exportar funciones al scope global
            window.submitTaskResult = submitTaskResult;
            window.leaveGame = leaveGame;

            // 4. Iniciar la escucha de turnos
            startListening(currentRoomId);
        });

        // Este objeto ya estaba en tu c√≥digo, lo mantengo para cargar la info est√°tica.
        const ROLE_DASHBOARDS = { /* ... (Mantener la definici√≥n completa de tus 11 roles aqu√≠) ... */ 
            'import_manager': { title: 'Gerente de Importaciones', icon: 'üí≤', focus: 'Se centra en costos, valoraci√≥n y gesti√≥n de proveedores internacionales.', tasks: ['Calcular Landed Cost (M√©todo 1)', 'Validar Costo de Mercanc√≠a', 'Negociar Flete Inicial'] },
            'valuation_expert': { title: 'Experto en Valoraci√≥n', icon: 'üí∞', focus: 'Profundiza en el c√°lculo del Landed Cost y la base gravable de tributos.', tasks: ['Analizar Ajustes al Valor', 'Aplicar M√©todo de Valoraci√≥n 3', 'Revisar Factura Comercial'] },
            'tariffs_specialist': { title: 'Especialista en Aranceles', icon: 'üîç', focus: 'Dominio de la Nomenclatura, clasificaci√≥n y reglas generales interpretativas.', tasks: ['Clasificar Subpartida Textil', 'Revisar Reglas Interpretativas 1 y 6', 'Evaluar Preferencia Arancelaria'] },
            'compliance_officer': { title: 'Oficial de Cumplimiento Aduanero', icon: 'üõ°Ô∏è', focus: 'Verifica el cumplimiento de regulaciones no arancelarias y restricciones.', tasks: ['Auditar Regulaciones de Sanidad', 'Revisar Licencia de Importaci√≥n', 'Monitorear Restricciones'] },
            'logistics_coordinator': { title: 'Coordinador de Log√≠stica', icon: 'üöö', focus: 'Optimiza rutas, transporte, almacenamiento y transferencia de riesgo.', tasks: ['Optimizar Flete Mar√≠timo', 'Gestionar Entrega DAP', 'Seguimiento GPS Carga'] },
            'default': { title: 'Simulaci√≥n General - Sin Rol Asignado', icon: '‚ùå', focus: 'Por favor, regrese al men√∫ principal y seleccione un rol de carrera para empezar.', tasks: ['Ir a Selecci√≥n de Rol'] }
        };

    </script>
</body>
</html>
