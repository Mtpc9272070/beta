<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">Dashboard de Simulaci√≥n - ADUWEB</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        /* Estilo para la tarjeta de Tarea Activa */
        .mission-card {
            @apply bg-white p-6 rounded-xl shadow-2xl border-l-4 border-gray-400 transition duration-300;
        }
        .mission-card.active {
            /* Estilo cuando es el turno del jugador */
            @apply border-green-600 ring-4 ring-green-200;
        }

        /* --- Estilos para el mini-juego de voltear cartas --- */
        @keyframes slot-machine-text {
            0% { transform: translateY(-100%); opacity: 0; }
            20%, 80% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(100%); opacity: 0; }
        }
        .slot-text { animation: slot-machine-text 0.2s ease-in-out; }

        .flip-card-container {
            background-color: transparent;
            width: 128px;
            height: 176px;
            perspective: 1000px;
        }
        .flip-card-inner {
            position: relative; width: 100%; height: 100%;
            transition: transform 0.6s; transform-style: preserve-3d;
        }
        .flip-card-container.is-flipped .flip-card-inner { transform: rotateY(180deg); }
        .flip-card-front, .flip-card-back {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            -webkit-backface-visibility: hidden; backface-visibility: hidden;
            display: flex; align-items: center; justify-content: center;
            border-radius: 12px; box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        .flip-card-front {
            background-color: #1f2937;
            background-image: url("data:image/svg+xml,%3Csvg width='20' height='20' viewBox='0 0 20 20' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23374151' fill-opacity='0.4' fill-rule='evenodd'%3E%3Cpath d='M0 0h20v1H0zM0 4h20v1H0zM0 8h20v1H0zM0 12h20v1H0zM0 16h20v1H0z'/%3E%3Cpath d='M0 0h1v20H0zM4 0h1v20H4zM8 0h1v20H8zM12 0h1v20H12zM16 0h1v20H16z'/%3E%3C/g%3E%3C/svg%3E");
            color: white; cursor: pointer;
        }
        .flip-card-back {
            transform: rotateY(180deg);
            @apply bg-white text-gray-800 p-2 relative;
        }
        .card-code { @apply font-mono font-bold absolute; }
        .top-left { @apply top-2 left-3; }
        .bottom-right { @apply bottom-2 right-3 transform rotate-180; }
        .card-icon { @apply text-4xl text-gray-300; }
        .flip-card-container.selected { filter: drop-shadow(0 0 8px rgba(59, 130, 246, 0.7)); }

        /* --- Animaci√≥n de Barajado --- */
        @keyframes dealCard {
            from { transform: translate(0, 0) scale(0.5) rotate(0deg); opacity: 0; }
            to { transform: translate(var(--tx, 0), var(--ty, 0)) scale(1) rotate(var(--r, 0deg)); opacity: 1; }
        }
        .deck-container { position: relative; height: 192px; }
        .flip-card-container.in-deck {
            position: absolute; left: 50%; top: 0;
            transform-origin: center center;
            margin-left: -64px;
            opacity: 0;
        }
        .flip-card-container.dealt {
            animation: dealCard 0.7s cubic-bezier(0.25, 1, 0.5, 1) forwards;
        }

        /* --- Estilos para el mini-juego de "Drag & Drop" (Oficial de Cumplimiento) --- */
        .draggable-doc {
            @apply bg-white p-3 rounded-lg shadow-md border border-gray-200 flex items-center gap-3 transition-all duration-200;
            cursor: grab;
        }
        .draggable-doc:hover {
            @apply shadow-lg transform -translate-y-1;
        }
        .draggable-doc.dragging {
            @apply opacity-50 shadow-xl scale-105;
        }
        .drop-zone {
            @apply p-4 rounded-xl border-2 border-dashed transition-all duration-200 min-h-[200px];
        }
        .drop-zone.drag-over {
            @apply ring-4;
        }

        /* --- Estilos para el mini-juego de "Calculadora" (Experto en Valoraci√≥n) --- */
        .data-box {
            @apply bg-gray-100 p-3 rounded-lg border border-gray-200 text-center;
        }
        .data-label {
            @apply text-sm font-medium text-gray-600 block;
        }
        .data-value {
            @apply text-xl font-extrabold text-gray-800;
        }
        .input-valor {
            @apply w-full p-3 text-xl font-bold text-center border-2 border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500 transition;
        }
        .step-container { @apply p-4 rounded-xl border-2 border-gray-200; }
        .feedback-box { @apply mt-2 p-2 text-sm font-semibold rounded-lg text-center; }
        .feedback-correct { @apply bg-green-100 text-green-800; }
        .feedback-incorrect { @apply bg-red-100 text-red-800; }

        /* --- Estilos para el Dashboard de Log√≠stica --- */
        .transport-option {
            @apply p-4 rounded-xl border-2 border-gray-300 cursor-pointer transition-all duration-200;
        }
        .transport-option:hover {
            @apply shadow-lg transform -translate-y-1;
        }
        .transport-option.selected {
            @apply ring-4 ring-cyan-400 border-cyan-500 bg-cyan-50;
        }
        #map-svg .route-path {
            stroke-dasharray: 1000;
            stroke-dashoffset: 1000;
            animation: draw-path 1.5s ease-out forwards;
        }
        @keyframes draw-path { to { stroke-dashoffset: 0; } }

        /* --- Estilos para el Dashboard Gerencial y Resultados --- */
        .summary-card {
            @apply bg-gray-100 p-4 rounded-lg border border-gray-200;
        }
        .summary-label {
            @apply text-sm font-medium text-gray-600 block;
        }
        .summary-value {
            @apply text-lg font-extrabold text-gray-800;
        }
        .decision-btn {
            @apply w-full p-4 rounded-xl text-white font-extrabold text-xl transition-all duration-200 transform hover:scale-105;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans text-gray-800">

    <header class="bg-gray-800 text-white py-4 px-6 shadow-lg sticky top-0 z-10">
        <div class="max-w-6xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-2">
                <span class="text-2xl">üåê</span>
                <h1 class="text-xl font-bold">Simulaci√≥n: La Merca</h1>
            </div>
            <div class="flex items-center gap-4">
                <div id="globalTimerDisplay" class="bg-purple-600 px-3 py-1 rounded-full text-sm font-semibold">‚è≥ 00:00</div>
                <div id="statusDisplay" class="bg-blue-600 px-3 py-1 rounded-full text-sm font-semibold">
                    Sala: N/A | Turno: N/A
                </div>
            </div>
            <button onclick="leaveGame()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm font-semibold transition">
                üö™ Salir de Sala
            </button>
        </div>
    </header>

    <!-- Contenedores de Audio para los Efectos de Sonido -->
    <audio id="soundStart" src="./start.mp3" preload="auto"></audio>
    <audio id="soundFlip" src="./flipcard.mp3" preload="auto"></audio>
    <audio id="soundSend" src="./enviar.mp3" preload="auto"></audio>
    <audio id="soundTick" src="./time.mp3" preload="auto" loop></audio>
    <audio id="soundTimeUp" src="./tic.mp3" preload="auto"></audio>
    <audio id="soundMiedo" src="./miedo.mp3" preload="auto" loop></audio>
    <audio id="soundDrag" src="./click.mp3" preload="auto"></audio>
    <audio id="soundDrop" src="./poner.mp3" preload="auto"></audio>
    <audio id="soundHelp" src="./ayuda.mp3" preload="auto"></audio>
    <!-- NUEVOS SONIDOS -->
    <audio id="soundCorrect" src="./correct.mp3" preload="auto"></audio>
    <audio id="soundWrong" src="./wrong.mp3" preload="auto"></audio>
    <audio id="soundApprove" src="./stamp.mp3" preload="auto"></audio>
    <audio id="soundReject" src="./reject.mp3" preload="auto"></audio>



    <main class="max-w-6xl mx-auto p-4 md:p-8">
        
        <div class="bg-white shadow-2xl rounded-xl p-6 md:p-8 mb-8 border-t-8 border-green-600">
            <h2 id="roleTitle" class="text-3xl font-extrabold text-gray-800 mb-1">
                [Rol Din√°mico]
            </h2>
            <p id="roleFocus" class="text-lg text-green-700 font-semibold mb-4">
                [Enfoque Din√°mico]
            </p>
            <div class="flex items-center text-gray-600 text-sm">
                <span id="playerInfo" class="mr-4">üë§ Jugador: [Nombre]</span>
            </div>
        </div>
        
        <div class="bg-indigo-50 p-4 rounded-xl border border-indigo-200 mb-8">
            <h3 class="text-xl font-bold text-indigo-800 mb-2">Flujo de la Simulaci√≥n</h3>
            <p id="globalStatus" class="text-lg font-semibold text-indigo-700">Esperando el inicio de la cadena de procesos...</p>
            <p class="text-sm text-indigo-600 mt-2">Tarea en Curso: <strong id="currentTurnRoleName">Nadie</strong></p>
        </div>


        <h3 class="text-2xl font-bold mb-5 text-gray-800 border-b pb-2">
            ‚úÖ Mi Tarea Activa: <span id="missionName" class="text-green-700"></span>
        </h3>
        
        <div id="roleTasksContainer" class="mission-card">
            <div class="text-center p-10">
                 <p class="text-gray-500 font-semibold">Cargando tu misi√≥n...</p>
            </div>
        </div>

    </main>

    <!-- NUEVA PANTALLA DE RESULTADOS FINALES -->
    <div id="resultsScreen" class="hidden max-w-4xl mx-auto p-4 md:p-8 animate-fade-in">
        <div class="bg-white p-8 rounded-2xl shadow-2xl border-t-8 border-indigo-600">
            <h1 class="text-3xl font-extrabold text-gray-900 mb-2">üìä Resultados Finales de la Simulaci√≥n</h1>
            <p class="text-lg text-gray-600 mb-6">Resumen completo de la operaci√≥n de importaci√≥n.</p>

            <div id="final-decision-display" class="p-4 text-center rounded-lg mb-6 text-2xl font-extrabold">
                <!-- Se llenar√° din√°micamente -->
            </div>

            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <div class="summary-card">
                    <span class="summary-label">C√≥digo Arancelario</span>
                    <span id="result-tariff" class="summary-value font-mono"></span>
                </div>
                <div class="summary-card">
                    <span class="summary-label">Cumplimiento RNA</span>
                    <span id="result-compliance" class="summary-value"></span>
                </div>
                <div class="summary-card">
                    <span class="summary-label">Valor en Aduana</span>
                    <span id="result-customs-value" class="summary-value"></span>
                </div>
                <div class="summary-card">
                    <span class="summary-label">Costo de Flete</span>
                    <span id="result-freight" class="summary-value"></span>
                </div>
            </div>

            <div class="p-4 rounded-xl border-2 border-gray-200 mb-6">
                <h4 class="font-bold text-lg text-gray-800 mb-3">An√°lisis de Costos Final (Landed Cost)</h4>
                <table class="w-full text-sm">
                    <tbody>
                        <tr class="border-b"><td class="py-2">Valor en Aduana (CIF)</td><td id="result-cost-cif" class="py-2 text-right font-semibold"></td></tr>
                        <tr class="border-b"><td class="py-2">Arancel (Gravamen 10%)</td><td id="result-cost-tariff" class="py-2 text-right font-semibold"></td></tr>
                        <tr class="border-b"><td class="py-2">IVA (19%)</td><td id="result-cost-vat" class="py-2 text-right font-semibold"></td></tr>
                        <tr class="bg-gray-100"><td class="py-2 font-bold">Landed Cost Total</td><td id="result-cost-total" class="py-2 text-right font-bold text-lg"></td></tr>
                    </tbody>
                </table>
            </div>

            <button onclick="leaveGame(false)" class="w-full p-4 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition">
                Finalizar y Volver al Men√∫
            </button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-app.js";
        import { getDatabase, ref, onValue, update, off, remove } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-database.js";
        
        // üîë CONSTANTES DE SESI√ìN Y ENTORNO
        const SESSION_KEY = 'aduweb_player_name';
        const SESSION_KEY_CAREER = 'aduweb_career';
        const SESSION_KEY_CAREER_NAME = 'aduweb_career_name';
        
        // ‚öôÔ∏è Configuraci√≥n Firebase (Debe coincidir con index.html)
        const firebaseConfig = {
            apiKey: "AIzaSyB_eUoNQ7L4hd42SVPqbA7vNYHxpEii9To",
            authDomain: "dino-4fbde.firebaseapp.com",
            databaseURL: "https://dino-4fbde-default-rtdb.firebaseio.com",
            projectId: "dino-4fbde",
            storageBucket: "dino-4fbde.firebasestorage.app",
            messagingSenderId: "307345167689",
            appId: "1:307345167689:web:f75e11b0c68a3def253698",
            measurementId: "G-LFDL5N5VW3"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // üéØ VARIABLES CLAVE DEL JUGADOR Y SALA
        let currentRoomId = null;
        let currentPlayerRole = null;
        let playerName = null;
        let roomListener = null;

        // ----------------------------------------------------------------------
        // üéµ FUNCIONES DE SONIDO
        // ----------------------------------------------------------------------
        function playSound(id) {
            const audio = document.getElementById(id);
            if (audio) {
                audio.currentTime = 0;
                audio.play().catch(e => console.log("Error al reproducir sonido:", e));
            }
        }

        function stopSound(id) {
            const audio = document.getElementById(id);
            if (audio) audio.pause();
        }

        // Formatear dinero (funci√≥n global para ser usada por varios juegos)
        const formatCurrency = (value) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(value);


        // ----------------------------------------------------------------------
        // üåê JERARQU√çA Y MISIONES DE SIMULACI√ìN (El motor del juego)
        // ----------------------------------------------------------------------

        // 1. Definici√≥n de la cadena de procesos (el cargo m√°s bajo comienza)
        const PROCESS_CHAIN = [
            'tariffs_specialist', ¬† // Tarea 1: Clasificaci√≥n
            'compliance_officer', ¬† // Tarea 2: Regulaciones
            'valuation_expert', ¬† ¬† // Tarea 3: Valoraci√≥n
            'logistics_coordinator',// Tarea 4: Log√≠stica y Flete
            'import_manager' ¬† ¬† ¬† ¬†// Tarea 5: Decisi√≥n Final
        ];
        
        // 2. Mapeo de misiones, entradas requeridas y la siguiente tarea en la cadena
        const ROLE_MISSION_DATA = {
            // TAREA 1: CLASIFICACI√ìN ARANCELARIA (Comienza el juego)
            'tariffs_specialist': { 
                instruction: "Tu misi√≥n es clasificar la mercanc√≠a. Voltea las cartas para encontrar el c√≥digo arancelario correcto. ¬°Tienes 30 segundos para esta tarea espec√≠fica!",
                missionName: 'Clasificaci√≥n de Mercanc√≠a',
                next: 'compliance_officer',
                input_key: 'tariffs_code', 
                required: [],
                // INTEGRACI√ìN DEL NUEVO DASHBOARD INTERACTIVO
                game: {
                    html: `
                        <div id="tariffGameContainer" class="hidden mt-6 space-y-6">
                            <div class="bg-blue-50 p-4 rounded-lg text-center border border-blue-200">
                                <p class="text-sm font-medium text-blue-700">Mercanc√≠a Asignada:</p>
                                <p id="merchandiseDisplay" class="text-xl font-bold text-blue-900 h-8"></p>
                            </div>
                            <div id="timerContainer" class="hidden text-center">
                                <p class="text-sm text-gray-500">Tiempo Restante</p>
                                <p id="gameTimer" class="text-5xl font-extrabold text-gray-800 transition-colors duration-300">30</p>
                            </div>
                            <p class="text-center text-gray-600"><strong>Instrucci√≥n:</strong> Voltea las cartas para encontrar el c√≥digo arancelario correcto.</p>
                            <div id="cardContainer" class="deck-container"></div>
                        </div>
                        <input type="hidden" id="missionInput" value="">
                    `,
                    init: (container, isMyTurn) => {
                        if (!isMyTurn) return; // No inicializar si no es mi turno

                        const gameContainer = container.querySelector('#tariffGameContainer');
                        const merchandiseDisplay = container.querySelector('#merchandiseDisplay');
                        const cardContainer = container.querySelector('#cardContainer');
                        const timerContainer = container.querySelector('#timerContainer');
                        const gameTimerDisplay = container.querySelector('#gameTimer');
                        const missionInput = container.querySelector('#missionInput');
                        const submitBtn = document.getElementById('submitTaskBtn');

                        const merchandiseData = [
                            { name: "Laptops de alto rendimiento", correctCode: "8471.30.00", decoys: ["8528.71.00", "9001.30.00", "8471.50.00"] },
                            { name: "Smartphones de √∫ltima generaci√≥n", correctCode: "8517.12.00", decoys: ["8517.70.00", "8525.80.00", "9006.59.00"] },
                            { name: "Granos de Caf√© sin tostar", correctCode: "0901.11.00", decoys: ["0901.21.00", "0801.32.00", "2101.11.00"] },
                        ];

                        let countdownInterval = null;

                        function startGameDirectly() {
                            playSound('soundStart');
                            gameContainer.classList.remove('hidden');

                            const selectedMerchandise = merchandiseData[Math.floor(Math.random() * merchandiseData.length)];
                            merchandiseDisplay.textContent = selectedMerchandise.name;
                            
                            startTimer();
                            setupCardGame(selectedMerchandise);
                        }

                        function startTimer() {
                            let timeLeft = 30;
                            timerContainer.classList.remove('hidden');
                            gameTimerDisplay.textContent = timeLeft;
                            gameTimerDisplay.classList.remove('text-red-500', 'animate-pulse');
                            playSound('soundTick');
                            countdownInterval = setInterval(() => {
                                timeLeft--;
                                gameTimerDisplay.textContent = timeLeft;
                                if (timeLeft === 10) { stopSound('soundTick'); playSound('soundMiedo'); }
                                if (timeLeft <= 10) { gameTimerDisplay.classList.add('text-red-500', 'animate-pulse'); }
                                if (timeLeft <= 0) {
                                    clearInterval(countdownInterval);
                                    stopSound('soundMiedo');
                                    playSound('soundTimeUp');
                                    Swal.fire('¬°Tiempo Agotado!', 'No lograste clasificar a tiempo. El turno pasar√° autom√°ticamente.', 'error');
                                    missionInput.value = "TIEMPO_AGOTADO";
                                    submitBtn.click();
                                }
                            }, 1000);
                        }

                        function setupCardGame(merchandise) {
                            cardContainer.innerHTML = '';
                            let options = [merchandise.correctCode, ...merchandise.decoys.slice(0, 3)];
                            options.sort(() => Math.random() - 0.5);
                            const positions = [{ tx: '-150%', r: '-10deg' }, { tx: '-50%', r: '5deg' }, { tx: '50%', r: '-5deg' }, { tx: '150%', r: '10deg' }];

                            options.forEach((code, index) => {
                                const cardElement = document.createElement('div');
                                cardElement.className = 'flip-card-container in-deck';
                                cardElement.innerHTML = `<div class="flip-card-inner"><div class="flip-card-front"></div><div class="flip-card-back"><span class="card-code top-left">${code.substring(0, 4)}</span><span class="card-icon">üóÉÔ∏è</span><span class="card-code bottom-right">${code.substring(0, 4)}</span></div></div>`;
                                cardElement.style.setProperty('--tx', positions[index].tx);
                                cardElement.style.setProperty('--r', positions[index].r);
                                setTimeout(() => cardElement.classList.add('dealt'), 100 + index * 150);

                                cardElement.onclick = () => {
                                    playSound('soundFlip');
                                    if (cardElement.classList.contains('selected')) return;
                                    cardElement.classList.add('is-flipped');
                                    cardContainer.querySelectorAll('.flip-card-container').forEach(c => c.classList.remove('selected'));
                                    cardElement.classList.add('selected');
                                    missionInput.value = code;
                                    submitBtn.disabled = false;
                                };
                                cardContainer.appendChild(cardElement);
                            });
                        }

                        // Iniciar el juego
                        startGameDirectly();
                    }
                }
            },
            // TAREA 2: VERIFICACI√ìN DE REGULACIONES
            'compliance_officer': { 
                instruction: "Has recibido un c√≥digo arancelario. Arrastra los documentos que consideres OBLIGATORIOS a la zona verde y los NO APLICABLES a la zona roja. Usa el Vadem√©cum si necesitas ayuda.",
                missionName: 'Verificaci√≥n de Regulaciones (RNA)',
                next: 'valuation_expert',
                input_key: 'rna_check',
                required: ['tariffs_code'], // Requiere la clasificaci√≥n del anterior
                // INTEGRACI√ìN DEL DASHBOARD DE OFICIAL DE CUMPLIMIENTO
                game: {
                    html: (inputData) => `
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                            <div class="lg:col-span-1 space-y-6">
                                <div class="bg-blue-50 p-4 rounded-xl border border-blue-200">
                                    <h4 class="font-bold text-lg text-blue-800 mb-2">Ficha de Importaci√≥n</h4>
                                    <p class="text-sm text-blue-700"><strong>C√≥digo Arancelario Recibido:</strong></p>
                                    <p class="font-semibold text-blue-900 font-mono">${inputData.tariffs_code || 'Esperando dato...'}</p>
                                </div>
                                <div class="text-center">
                                    <button id="showHelpBtn" class="bg-yellow-500 text-white font-semibold py-2 px-5 rounded-lg hover:bg-yellow-600 transition shadow-sm flex items-center gap-2 mx-auto">
                                        <span class="text-xl">üìñ</span> Pedir Ayuda (Vadem√©cum)
                                    </button>
                                </div>
                            </div>
                            <div class="lg:col-span-2 space-y-6">
                                <div>
                                    <h4 class="font-bold text-lg text-gray-800 mb-2">Bandeja de Documentos</h4>
                                    <div id="source-documents" class="p-4 bg-gray-100 rounded-xl grid grid-cols-1 sm:grid-cols-2 gap-3"></div>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div id="required-zone" class="drop-zone bg-green-50 border-green-400 ring-green-200">
                                        <h4 class="font-bold text-lg text-green-800 mb-2 text-center">üìÇ Documentos Requeridos</h4>
                                    </div>
                                    <div id="not-required-zone" class="drop-zone bg-red-50 border-red-400 ring-red-200">
                                        <h4 class="font-bold text-lg text-red-800 mb-2 text-center">üóëÔ∏è Documentos No Aplicables</h4>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <input type="hidden" id="missionInput" value="">
                    `,
                    init: (container, isMyTurn) => {
                        if (!isMyTurn) return;

                        const sourceContainer = container.querySelector('#source-documents');
                        const dropZones = container.querySelectorAll('.drop-zone');
                        const submitBtn = document.getElementById('submitTaskBtn');
                        const showHelpBtn = container.querySelector('#showHelpBtn');
                        const missionInput = container.querySelector('#missionInput');

                        const documents = [
                            { id: 'doc-rtm', name: 'Reglamento T√©cnico (RTM)', icon: 'üîå' },
                            { id: 'doc-sanitary', name: 'Registro Sanitario', icon: 'üíä' },
                            { id: 'doc-phyto', name: 'Permiso Fitosanitario', icon: 'üåø' },
                            { id: 'doc-dumping', name: 'Derechos Anti-Dumping', icon: 'üí∞' }
                        ];

                        documents.forEach(doc => {
                            const docElement = document.createElement('div');
                            docElement.id = doc.id;
                            docElement.className = 'draggable-doc';
                            docElement.draggable = true;
                            docElement.innerHTML = `<span class="text-2xl">${doc.icon}</span> <span class="font-semibold">${doc.name}</span>`;
                            sourceContainer.appendChild(docElement);
                            docElement.addEventListener('dragstart', (e) => { playSound('soundDrag'); e.dataTransfer.setData('text/plain', doc.id); setTimeout(() => docElement.classList.add('dragging'), 0); });
                            docElement.addEventListener('dragend', () => { docElement.classList.remove('dragging'); });
                        });

                        dropZones.forEach(zone => {
                            zone.addEventListener('dragover', (e) => { e.preventDefault(); zone.classList.add('drag-over'); });
                            zone.addEventListener('dragleave', () => { zone.classList.remove('drag-over'); });
                            zone.addEventListener('drop', (e) => {
                                e.preventDefault(); zone.classList.remove('drag-over');
                                const docId = e.dataTransfer.getData('text/plain');
                                const draggable = document.getElementById(docId);
                                if (draggable) { playSound('soundDrop'); zone.appendChild(draggable); checkCompletion(); }
                            });
                        });

                        function checkCompletion() {
                            if (sourceContainer.children.length === 0) {
                                const requiredDocs = Array.from(document.querySelectorAll('#required-zone .draggable-doc')).map(el => el.id);
                                missionInput.value = JSON.stringify(requiredDocs); // Guardar resultado en el input
                                submitBtn.disabled = false;
                            }
                        }

                        showHelpBtn.addEventListener('click', () => {
                            playSound('soundHelp');
                            Swal.fire({ title: 'üìñ Vadem√©cum Aduanero', html: `<ul class="text-sm text-left text-gray-600 space-y-2 list-disc list-inside p-4"><li><strong>Alimentos/Cosm√©ticos:</strong> Requieren Registro Sanitario.</li><li><strong>Electr√≥nicos/Juguetes:</strong> Requieren Reglamento T√©cnico.</li><li><strong>Plantas/Animales:</strong> Requieren Permiso Fitosanitario.</li><li><strong>Textiles/Acero:</strong> Pueden tener Derechos Anti-Dumping.</li></ul>`, icon: 'info', confirmButtonText: 'Entendido' });
                        });
                    }
                }
            },
            // TAREA 3: DETERMINACI√ìN DE VALOR
            'valuation_expert': { 
                instruction: "Tu tarea es calcular el Valor en Aduana definitivo. Completa cada paso de la calculadora. El valor FOB, Flete y Seguro son datos del caso. ¬°No hay l√≠mite de tiempo, pero el cron√≥metro global sigue corriendo!",
                missionName: 'C√°lculo del Valor en Aduana',
                next: 'logistics_coordinator',
                input_key: 'customs_value', 
                required: ['rna_check'],
                game: {
                    html: `
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div>
                                <h4 class="font-bold text-lg text-gray-800 mb-2">Datos del Caso</h4>
                                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                                    <div class="data-box"><span class="data-label">Valor FOB</span><span class="data-value">$50,000.00</span></div>
                                    <div class="data-box"><span class="data-label">Flete</span><span class="data-value">$3,000.00</span></div>
                                    <div class="data-box"><span class="data-label">Seguro</span><span class="data-value">$500.00</span></div>
                                </div>
                            </div>
                            <div class="data-box bg-purple-50 border-purple-200">
                                <span class="data-label">Tiempo de An√°lisis</span>
                                <span id="game-timer" class="data-value text-purple-700 text-4xl">00:00</span>
                            </div>
                        </div>
                        <div class="space-y-6">
                            <div id="step-cif" class="step-container"></div>
                            <div id="step-adjustment" class="step-container hidden"></div>
                            <div id="step-final" class="step-container hidden"></div>
                        </div>
                        <input type="hidden" id="missionInput" value="">
                    `,
                    init: (container, isMyTurn) => {
                        if (!isMyTurn) return;

                        const submitBtn = document.getElementById('submitTaskBtn');
                        const timerDisplay = container.querySelector('#game-timer');
                        const missionInput = container.querySelector('#missionInput');

                        const FOB_VALUE = 50000, FREIGHT_VALUE = 3000, INSURANCE_VALUE = 500;
                        const ADJUSTMENT_RATE = 0.02;

                        const steps = [
                            { id: 'cif', title: 'Paso 1: Calcular Valor CIF', help: `FOB (${formatCurrency(FOB_VALUE)}) + Flete (${formatCurrency(FREIGHT_VALUE)}) + Seguro (${formatCurrency(INSURANCE_VALUE)})`, correctValue: FOB_VALUE + FREIGHT_VALUE + INSURANCE_VALUE },
                            { id: 'adjustment', title: 'Paso 2: Calcular Ajuste (Comisi√≥n 2%)', help: `FOB (${formatCurrency(FOB_VALUE)}) x 2%`, correctValue: FOB_VALUE * ADJUSTMENT_RATE },
                            { id: 'final', title: 'Paso 3: Calcular Valor en Aduana Definitivo', help: `Valor CIF + Ajuste`, correctValue: (FOB_VALUE + FREIGHT_VALUE + INSURANCE_VALUE) + (FOB_VALUE * ADJUSTMENT_RATE) }
                        ];

                        let timerInterval = null, seconds = 0;

                        function startTimer() {
                            timerInterval = setInterval(() => {
                                seconds++;
                                const min = String(Math.floor(seconds / 60)).padStart(2, '0');
                                const sec = String(seconds % 60).padStart(2, '0');
                                timerDisplay.textContent = `${min}:${sec}`;
                            }, 1000);
                        }

                        function loadStep(stepIndex) {
                            if (stepIndex >= steps.length) {
                                submitBtn.disabled = false;
                                return;
                            }
                            const step = steps[stepIndex];
                            const stepContainer = container.querySelector(`#step-${step.id}`);
                            stepContainer.classList.remove('hidden');
                            stepContainer.innerHTML = `
                                <h4 class="font-bold text-lg text-gray-800 mb-2">${step.title}</h4>
                                <div class="flex items-center gap-4">
                                    <input type="number" id="input-${step.id}" placeholder="0.00" class="input-valor flex-grow">
                                    <button id="verify-${step.id}" class="bg-blue-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-blue-700">Verificar</button>
                                    <button id="help-${step.id}" class="bg-yellow-500 text-white font-semibold p-3 rounded-lg hover:bg-yellow-600">üßÆ</button>
                                </div>
                                <div id="feedback-${step.id}" class="feedback-box hidden"></div>
                            `;

                            document.getElementById(`verify-${step.id}`).onclick = () => verifyStep(stepIndex);
                            document.getElementById(`help-${step.id}`).onclick = () => showHelp(stepIndex);
                        }

                        function verifyStep(stepIndex) {
                            playSound('soundDrag'); // Reutilizamos el sonido de click
                            const step = steps[stepIndex];
                            const input = document.getElementById(`input-${step.id}`);
                            const feedback = document.getElementById(`feedback-${step.id}`);
                            const userValue = parseFloat(input.value) || 0;

                            feedback.classList.remove('hidden');
                            if (Math.abs(userValue - step.correctValue) < 0.01) {
                                playSound('soundCorrect');
                                feedback.textContent = `‚úÖ ¬°Correcto! El valor es ${formatCurrency(step.correctValue)}.`;
                                feedback.className = 'feedback-box feedback-correct';
                                input.disabled = true;
                                document.getElementById(`verify-${step.id}`).disabled = true;
                                document.getElementById(`help-${step.id}`).disabled = true;
                                if (step.id === 'final') missionInput.value = userValue; // Guardar valor final
                                loadStep(stepIndex + 1);
                            } else {
                                playSound('soundWrong');
                                feedback.textContent = `‚ùå Incorrecto. Revisa tus c√°lculos.`;
                                feedback.className = 'feedback-box feedback-incorrect';
                            }
                        }

                        function showHelp(stepIndex) {
                            playSound('soundHelp');
                            const step = steps[stepIndex];
                            Swal.fire({ title: `Ayuda para: ${step.title}`, html: `<p class="text-lg font-mono p-4 bg-gray-100 rounded-lg">${step.help} = <strong class="text-green-600">${formatCurrency(step.correctValue)}</strong></p>`, icon: 'info', confirmButtonText: 'Entendido' });
                        }

                        startTimer();
                        loadStep(0);
                    }
                }
            },
            // TAREA 4: GESTI√ìN DE LOG√çSTICA
            'logistics_coordinator': { 
                instruction: "Elige el modo de transporte para la mercanc√≠a. Cada opci√≥n tiene un costo y tiempo de tr√°nsito diferente. Tu elecci√≥n afectar√° el costo final de la operaci√≥n.",
                missionName: 'Confirmaci√≥n de Flete y Seguros',
                next: 'import_manager',
                input_key: 'final_freight', 
                required: ['customs_value'],
                game: {
                    html: `
                        <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
                            <div class="lg:col-span-2 space-y-4">
                                <h4 class="font-bold text-lg text-gray-800">1. Selecciona el Modo de Transporte</h4>
                                <div id="transport-options-container"></div>
                            </div>
                            <div class="lg:col-span-3">
                                <h4 class="font-bold text-lg text-gray-800 mb-2">2. Visualizaci√≥n de Ruta y Costos</h4>
                                <div class="bg-gray-200 rounded-xl border border-gray-300 relative overflow-hidden shadow-inner">
                                    <svg id="map-svg" class="w-full h-96" viewBox="0 0 800 400">
                                        <defs><pattern id="grid" width="20" height="20" patternUnits="userSpaceOnUse"><path d="M 20 0 L 0 0 0 20" fill="none" stroke="#d1d5db" stroke-width="0.5"/></pattern></defs>
                                        <rect width="100%" height="100%" fill="url(#grid)" />
                                        <path fill="#e5e7eb" d="M16,252L48,220L104,188L160,228L200,284L248,308L296,276L328,228L368,196L416,220L448,268L488,300L528,268L560,204L592,164L648,148L704,172L744,220L768,284L792,340H8V284Z" />
                                        <path fill="#e5e7eb" d="M208,52L248,20L320,20L368,52L400,108L456,140L488,108L544,84L592,108L608,148L568,172L504,164L448,180L408,148L360,124L320,148L272,132L240,92Z" />
                                        <path id="route-path" class="route-path" d="" fill="none" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" />
                                        <circle cx="200" cy="150" r="8" fill="#ef4444" stroke="white" stroke-width="2" /><text x="212" y="155" font-size="12" fill="#7f1d1d" font-weight="bold">Shanghai</text>
                                        <circle cx="680" cy="250" r="8" fill="#16a34a" stroke="white" stroke-width="2" /><text x="570" y="255" font-size="12" fill="#065f46" font-weight="bold">Buenaventura</text>
                                    </svg>
                                    <div class="absolute bottom-4 left-4 right-4 bg-white/80 backdrop-blur-sm p-4 rounded-lg shadow-lg grid grid-cols-2 gap-4">
                                        <div>
                                            <p class="text-sm font-semibold text-gray-600">Costo de Flete (USD)</p>
                                            <p id="cost-display" class="text-2xl font-extrabold text-gray-800">$0.00</p>
                                        </div>
                                        <div>
                                            <p class="text-sm font-semibold text-gray-600">Tiempo de Tr√°nsito</p>
                                            <p id="time-display" class="text-2xl font-extrabold text-gray-800">0 d√≠as</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <input type="hidden" id="missionInput" value="">
                    `,
                    init: (container, isMyTurn) => {
                        if (!isMyTurn) return;

                        const optionsContainer = container.querySelector('#transport-options-container');
                        const routePath = container.querySelector('#route-path');
                        const costDisplay = container.querySelector('#cost-display');
                        const timeDisplay = container.querySelector('#time-display');
                        const submitBtn = document.getElementById('submitTaskBtn');
                        const missionInput = container.querySelector('#missionInput');

                        const transportOptions = [
                            { id: 'sea', name: 'Transporte Mar√≠timo', icon: 'üö¢', cost: 3500, time: 30, description: 'Opci√≥n m√°s econ√≥mica, ideal para cargas no urgentes.', path: 'M 200 150 Q 440 300 680 250', color: '#0e7490' },
                            { id: 'air', name: 'Transporte A√©reo', icon: '‚úàÔ∏è', cost: 12000, time: 3, description: 'Opci√≥n m√°s r√°pida, ideal para cargas urgentes y de alto valor.', path: 'M 200 150 C 350 50, 550 50, 680 250', color: '#be123c' },
                            { id: 'multi', name: 'Multimodal (Mar + Tierra)', icon: 'üöö', cost: 4500, time: 25, description: 'Balance entre costo y tiempo, usando m√∫ltiples modos.', path: 'M 200 150 Q 400 280 500 280 T 680 250', color: '#86198f' }
                        ];

                        let selectedOption = null;

                        function selectTransport(optionId) {
                            playSound('soundDrop'); // Reutilizamos el sonido de "soltar"
                            selectedOption = transportOptions.find(opt => opt.id === optionId);
                            if (!selectedOption) return;

                            container.querySelectorAll('.transport-option').forEach(el => el.classList.remove('selected'));
                            container.querySelector(`#option-${optionId}`).classList.add('selected');

                            routePath.setAttribute('d', selectedOption.path);
                            routePath.setAttribute('stroke', selectedOption.color);
                            routePath.style.animation = 'none';
                            routePath.offsetHeight;
                            routePath.style.animation = null; 

                            costDisplay.textContent = formatCurrency(selectedOption.cost);
                            timeDisplay.textContent = `${selectedOption.time} d√≠as`;
                            
                            missionInput.value = selectedOption.cost; // Guardar el costo en el input oculto
                            submitBtn.disabled = false;
                        }

                        transportOptions.forEach(opt => {
                            const optionEl = document.createElement('div');
                            optionEl.id = `option-${opt.id}`;
                            optionEl.className = 'transport-option';
                            optionEl.innerHTML = `
                                <div class="flex items-center gap-4">
                                    <span class="text-3xl">${opt.icon}</span>
                                    <div>
                                        <p class="font-bold text-lg text-gray-800">${opt.name}</p>
                                        <p class="text-sm text-gray-600">${opt.description}</p>
                                    </div>
                                </div>
                            `;
                            optionEl.onclick = () => selectTransport(opt.id);
                            optionsContainer.appendChild(optionEl);
                        });

                        // Seleccionar una opci√≥n por defecto al iniciar
                        selectTransport(transportOptions[0].id);
                    }
                }
            },
            // TAREA 5: GERENTE DE IMPORTACI√ìN (Finaliza el juego)
            'import_manager': { 
                instruction: "Has recibido toda la informaci√≥n de los roles anteriores. Revisa el caso y toma la decisi√≥n final: APROBAR o RECHAZAR la importaci√≥n. Esta acci√≥n finalizar√° la simulaci√≥n para todos.",
                missionName: 'Decisi√≥n Final y Visto Bueno',
                next: 'COMPLETED',
                input_key: 'final_decision',
                required: ['final_freight'],
                game: {
                    html: `
                        <h4 class="font-bold text-lg text-gray-800 mb-3 text-center">Toma la Decisi√≥n Final</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <button id="approve-btn" class="decision-btn bg-green-600 hover:bg-green-700">APROBAR</button>
                            <button id="reject-btn" class="decision-btn bg-red-600 hover:bg-red-700">RECHAZAR</button>
                        </div>
                        <input type="hidden" id="missionInput" value="">
                    `,
                    init: (container, isMyTurn) => {
                        if (!isMyTurn) return;

                        const approveBtn = container.querySelector('#approve-btn');
                        const rejectBtn = container.querySelector('#reject-btn');
                        const missionInput = container.querySelector('#missionInput');
                        const submitBtn = document.getElementById('submitTaskBtn');

                        approveBtn.onclick = () => {
                            playSound('soundApprove');
                            missionInput.value = 'APROBADO';
                            approveBtn.classList.add('ring-4', 'ring-offset-2', 'ring-green-400');
                            rejectBtn.classList.remove('ring-4', 'ring-offset-2', 'ring-red-400');
                            submitBtn.disabled = false;
                        };

                        rejectBtn.onclick = () => {
                            playSound('soundReject');
                            missionInput.value = 'RECHAZADO';
                            rejectBtn.classList.add('ring-4', 'ring-offset-2', 'ring-red-400');
                            approveBtn.classList.remove('ring-4', 'ring-offset-2', 'ring-green-400');
                            submitBtn.disabled = false;
                        };

                        // El bot√≥n de env√≠o principal est√° deshabilitado hasta que se toma una decisi√≥n
                        submitBtn.disabled = true;
                        // Cambiamos el texto para que sea m√°s claro
                        submitBtn.textContent = 'Confirmar Decisi√≥n y Finalizar';
                    }
                }
            },
            
            // Fallback para roles no incluidos en el juego
            'default': { 
                game: { html: () => `<p class="text-xl font-bold text-red-800">Tu rol no participa en esta simulaci√≥n multijugador.</p>`, init: () => {} }
            }
        };
        
        // ----------------------------------------------------------------------
        // üîÑ FUNCIONES DE TIEMPO REAL (CORE RTDB)
        // ----------------------------------------------------------------------
        
        /**
         * üü¢ Inicia la escucha en tiempo real de la sala para el flujo de turnos.
         */
        function startListening(roomId) {
            // Asegurarse de detener cualquier escucha anterior
            if (roomListener) {
                off(roomListener);
            }
            const roomRef = ref(db, `partidas_activas/${roomId}`);
            
            roomListener = onValue(roomRef, (snapshot) => {
                const roomData = snapshot.val();
                if (!roomData) {
                    Swal.fire('Atenci√≥n', 'El l√≠der cerr√≥ la sala o la partida finaliz√≥.', 'info');
                    if (roomListener) roomListener(); // Detener el listener
                    window.location.href = 'index.html';
                    return;
                }

                // Iniciar o sincronizar el temporizador global
                if (roomData.startTime && roomData.proceso_global !== 'COMPLETED') {
                    startGlobalTimer(roomData.startTime);
                }

                if (roomData.proceso_global === 'COMPLETED') {
                    showFinalResults(roomData);
                    off(roomListener); // Detener la escucha una vez finalizado
                    return;
                }

                const currentGlobalProcess = roomData.proceso_global;
                const lastResults = roomData.resultados || {};
                
                // CORRECCI√ìN: Renderizar la tarea personal PRIMERO, y LUEGO el estado global.
                // Esto asegura que la tarea se active antes de que la UI intente mostrar qui√©n tiene el turno.
                renderMyTask(currentGlobalProcess, lastResults); 
                renderRoomState(roomData, currentGlobalProcess); 
            });
        }
        
        /**
         * üé® Actualiza la UI con el estado global de la simulaci√≥n.
         */
        function renderRoomState(roomData, currentGlobalProcess) {
            const players = roomData.jugadores || {};
            const playerInTurn = Object.values(players).find(p => p.rol_id === currentGlobalProcess);
            
            let turnText = 'Esperando inicio de la partida...';
            if (currentGlobalProcess === 'INICIANDO_SIMULACION') {
                turnText = 'Iniciando el primer turno...';
            } else if (currentGlobalProcess === 'COMPLETED') {
                turnText = '¬°SIMULACI√ìN FINALIZADA! Revisa los resultados.';
            } else if (playerInTurn) {
                turnText = `Esperando la acci√≥n de: ${playerInTurn.nombre} (${currentGlobalProcess.toUpperCase()})`;
            }

            document.getElementById('globalStatus').textContent = turnText;
            document.getElementById('currentTurnRoleName').textContent = currentGlobalProcess === 'COMPLETED' ? 'FINALIZADO' : (playerInTurn ? playerInTurn.nombre : 'Calculando...');
        }

        /**
         * üéØ Renderiza la misi√≥n espec√≠fica del jugador y gestiona el turno.
         */
        function renderMyTask(currentGlobalProcess, lastResults) {
            const taskCard = document.getElementById('roleTasksContainer');
            const myTaskData = ROLE_MISSION_DATA[currentPlayerRole] || ROLE_MISSION_DATA['default'];
            
            // 1. Renderizar la misi√≥n espec√≠fica para este rol.
            document.getElementById('missionName').textContent = myTaskData.missionName || 'Tarea no definida';
            
            // Renderizar el HTML de la tarea, pasando los resultados previos si aplica.
            const gameHtml = myTaskData.game.html;
            taskCard.innerHTML = (typeof gameHtml === 'function') ? gameHtml(lastResults) : gameHtml;

            // Inicializar el script del mini-juego si existe
            if (myTaskData.game.init) myTaskData.game.init(taskCard, isMyTurn);
            
            // 2. Comprobar el turno
            const isMyTurn = currentGlobalProcess === currentPlayerRole;
            
            // 3. Activar/Desactivar controles
            if (isMyTurn) {
                taskCard.classList.remove('inactive');
                taskCard.classList.add('active');
                
                // Mostrar alerta de instrucciones
                Swal.fire({
                    title: `¬°Es tu Turno! Misi√≥n: ${myTaskData.missionName}`,
                    html: `<p class="text-lg text-gray-700">${myTaskData.instruction || 'Completa tu tarea para que el proceso contin√∫e.'}</p>`,
                    icon: 'info',
                    timer: 10000, // 10 segundos para leer
                    timerProgressBar: true,
                    showConfirmButton: true,
                    confirmButtonText: 'Entendido, ¬°Empezar!',
                    allowOutsideClick: false
                }).then(() => {
                    // Iniciar el mini-juego despu√©s de que el jugador cierre la alerta o se acabe el tiempo
                    if (myTaskData.game.init) {
                        myTaskData.game.init(taskCard, isMyTurn);
                    }
                });

                // El HTML de la tarea se renderiza, pero el init() se llama despu√©s de la alerta.

                const submitBtn = document.createElement('button');
                submitBtn.id = 'submitTaskBtn';
                submitBtn.onclick = () => {
                    // Para el oficial de cumplimiento, el resultado ya se guard√≥ al hacer drop.
                    // Para los dem√°s, se lee el input en submitTaskResult.
                    submitTaskResult();
                };
                submitBtn.className = 'w-full p-3 mt-6 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 transition';
                // El bot√≥n de env√≠o para el especialista en aranceles debe estar deshabilitado al principio
                if (currentPlayerRole === 'tariffs_specialist') {
                    submitBtn.disabled = true;
                }
                submitBtn.textContent = 'Enviar Resultado y Pasar Turno';
                taskCard.appendChild(submitBtn);

            } else {
                // Desactivar y mostrar mensaje de espera
                taskCard.classList.remove('active');
                taskCard.classList.add('inactive');
                taskCard.innerHTML += `<p class="mt-4 text-center text-red-600 font-semibold">Esperando la acci√≥n del cargo anterior...</p>`;
            }
        }

        /**
         * üíæ Env√≠a el resultado de mi tarea y pasa el turno al siguiente rol.
         */
        function submitTaskResult() {
            const submitBtn = document.getElementById('submitTaskBtn');
            const missionInput = document.getElementById('missionInput');
            const result = missionInput ? missionInput.value.trim() : null;
            
            if (!result) {
                // Para el especialista, si el tiempo se agota, el resultado puede ser nulo pero debe continuar.
                if (currentPlayerRole === 'tariffs_specialist' && missionInput.value === "TIEMPO_AGOTADO") {
                    // No hacer nada, el turno pasar√°
                } else {
                    Swal.fire('Atenci√≥n', 'Debes completar la tarea antes de enviar.', 'warning');
                    return;
                }
            }

            const myTaskData = ROLE_MISSION_DATA[currentPlayerRole];
            const nextRole = myTaskData.next;
            
            // 1. Preparar las actualizaciones
            const updates = {};
            // Guardar el resultado de mi tarea en la base de datos de la sala
            updates[`partidas_activas/${currentRoomId}/resultados/${myTaskData.input_key}`] = result;
            
            // 2. Pasar el turno al siguiente rol en la cadena
            updates[`partidas_activas/${currentRoomId}/proceso_global`] = nextRole;

            // Actualizar el tiempo de la √∫ltima acci√≥n para el timer global
            updates[`partidas_activas/${currentRoomId}/lastActionTime`] = Date.now();
            
            // Deshabilitar bot√≥n para evitar doble env√≠o
            if (submitBtn) submitBtn.disabled = true;

            // 3. Ejecutar la actualizaci√≥n
            update(ref(db), updates)
                .then(() => {
                    playSound('soundSend');
                    // Detener sonidos del timer si estaban activos
                    stopSound('soundTick');
                    stopSound('soundMiedo');
                    // Detener el timer del experto en valoraci√≥n
                    // (La variable timerInterval es local a su 'init', as√≠ que no podemos pararla desde aqu√≠ directamente, pero el cambio de p√°gina lo har√°)

                    if (nextRole === 'COMPLETED') {
                        updates[`partidas_activas/${currentRoomId}/endTime`] = Date.now();
                    } else {
                        Swal.fire('¬°Tarea Completada!', `Pasando el turno a: ${nextRole.toUpperCase()}`, 'success');
                    }
                })
                .catch(error => {
                    Swal.fire('Error', 'No se pudo enviar el resultado. Revisa tu conexi√≥n.', 'error');
                    console.error("Error al actualizar la DB:", error);
                });
        }

        /**
         * ‚è±Ô∏è Inicia y sincroniza el temporizador global de la partida.
         */
        function startGlobalTimer(startTime) {
            if (globalTimerInterval) clearInterval(globalTimerInterval);

            const timerDisplay = document.getElementById('globalTimerDisplay');
            
            globalTimerInterval = setInterval(() => {
                const now = Date.now();
                const elapsedMs = now - startTime;
                
                const totalSeconds = Math.floor(elapsedMs / 1000);
                const minutes = String(Math.floor(totalSeconds / 60)).padStart(2, '0');
                const seconds = String(totalSeconds % 60).padStart(2, '0');
                
                timerDisplay.textContent = `‚è≥ ${minutes}:${seconds}`;
            }, 1000);
        }

        function stopGlobalTimer() {
            if (globalTimerInterval) clearInterval(globalTimerInterval);
        }

        /**
         * üìä Muestra la pantalla de resultados finales.
         */
        function showFinalResults(roomData) {
            document.querySelector('main').classList.add('hidden');
            document.getElementById('resultsScreen').classList.remove('hidden');

            const results = roomData.resultados || {};
            const decision = results.final_decision || 'NO DECIDIDO';

            const decisionDisplay = document.getElementById('final-decision-display');
            decisionDisplay.textContent = `Operaci√≥n ${decision}`;
            if (decision === 'APROBADO') {
                decisionDisplay.className += ' bg-green-100 text-green-800';
            } else {
                decisionDisplay.className += ' bg-red-100 text-red-800';
            }

            // Poblar resumen
            document.getElementById('result-tariff').textContent = results.tariffs_code || 'N/A';
            document.getElementById('result-compliance').textContent = results.rna_check ? `${JSON.parse(results.rna_check).length} Docs` : 'N/A';
            document.getElementById('result-customs-value').textContent = formatCurrency(results.customs_value || 0);
            document.getElementById('result-freight').textContent = formatCurrency(results.final_freight || 0);

            // Calcular y renderizar costos
            const valorAduana = results.customs_value || 0;
            const TARIFA_ARANCEL = 0.10;
            const TARIFA_IVA = 0.19;

            const arancel = valorAduana * TARIFA_ARANCEL;
            const baseIva = valorAduana + arancel;
            const iva = baseIva * TARIFA_IVA;
            const landedCost = valorAduana + arancel + iva;

            document.getElementById('result-cost-cif').textContent = formatCurrency(valorAduana);
            document.getElementById('result-cost-tariff').textContent = formatCurrency(arancel);
            document.getElementById('result-cost-vat').textContent = formatCurrency(iva);
            document.getElementById('result-cost-total').textContent = formatCurrency(landedCost);

            // Detener todos los sonidos de bucle por si acaso
            stopSound('soundTick');
            stopSound('soundMiedo');
            stopGlobalTimer();
        }
        
        /**
         * üö™ MODIFICADO: Sale de la sala, CERR√ÅNDOLA PARA TODOS.
         */
        async function leaveGame() {
            const result = await Swal.fire({
                title: '¬øEst√°s seguro de salir?',
                text: "¬°Atenci√≥n! Si sales, la simulaci√≥n se cerrar√° para TODOS los jugadores. Esta acci√≥n no se puede deshacer.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ef4444',
                cancelButtonColor: '#6b7280',
                confirmButtonText: 'S√≠, ¬°Cerrar para todos!',
                cancelButtonText: 'Cancelar'
            });

            if (result.isConfirmed) {
                Swal.fire({
                    title: 'Cerrando sala...',
                    text: 'Esta acci√≥n finalizar√° la partida para todos.',
                    allowOutsideClick: false,
                    didOpen: () => Swal.showLoading()
                });

                try {
                    const roomRef = ref(db, `partidas_activas/${currentRoomId}`);
                    await remove(roomRef);
                    // La redirecci√≥n ocurrir√° autom√°ticamente para todos los jugadores
                    // gracias al listener onValue que detectar√° que la sala ya no existe.
                } catch (error) {
                    Swal.fire('Error', 'No se pudo cerrar la sala. Revisa tu conexi√≥n.', 'error');
                }
            }
        }

        // ----------------------------------------------------------------------
        // üöÄ INICIALIZACI√ìN
        // ----------------------------------------------------------------------
        
        document.addEventListener('DOMContentLoaded', () => {
            // 1. Obtener par√°metros del URL (room y role)
            const urlParams = new URLSearchParams(window.location.search);
            currentRoomId = urlParams.get('room');
            currentPlayerRole = urlParams.get('role');
            playerName = localStorage.getItem(SESSION_KEY);
            const careerName = localStorage.getItem(SESSION_KEY_CAREER_NAME);

            // Si falta alguno, redirigir
            if (!currentRoomId || !currentPlayerRole) {
                Swal.fire('Error', 'Datos de sala o rol faltantes.', 'error').then(() => {
                    window.location.href = 'index.html'; 
                });
                return;
            }
            
            const dashboardData = ROLE_DASHBOARDS[currentPlayerRole] || ROLE_DASHBOARDS['default'];
            
            // 2. Cargar UI est√°tica
            document.getElementById('pageTitle').textContent = `Misi√≥n: ${careerName} - ADUWEB`;
            document.getElementById('statusDisplay').textContent = `Sala: ${currentRoomId} | Rol: ${currentPlayerRole.toUpperCase()}`;
            document.getElementById('playerInfo').textContent = `üë§ Jugador: ${playerName}`;
            document.getElementById('roleTitle').innerHTML = `${dashboardData.icon || 'üíº'} ${careerName || dashboardData.title}`;
            document.getElementById('roleFocus').textContent = dashboardData.focus;
            
            // 3. Exportar funciones al scope global
            window.submitTaskResult = submitTaskResult;
            window.leaveGame = leaveGame;

            // 4. Iniciar la escucha de turnos
            startListening(currentRoomId);
        });

        // Este objeto ya estaba en tu c√≥digo, lo mantengo para cargar la info est√°tica.
        const ROLE_DASHBOARDS = { /* ... (Mantener la definici√≥n completa de tus 11 roles aqu√≠) ... */ 
            'import_manager': { title: 'Gerente de Importaciones', icon: 'üí≤', focus: 'Se centra en costos, valoraci√≥n y gesti√≥n de proveedores internacionales.', tasks: ['Calcular Landed Cost (M√©todo 1)', 'Validar Costo de Mercanc√≠a', 'Negociar Flete Inicial'] },
            'valuation_expert': { title: 'Experto en Valoraci√≥n', icon: 'üí∞', focus: 'Profundiza en el c√°lculo del Landed Cost y la base gravable de tributos.', tasks: ['Analizar Ajustes al Valor', 'Aplicar M√©todo de Valoraci√≥n 3', 'Revisar Factura Comercial'] },
            'tariffs_specialist': { title: 'Especialista en Aranceles', icon: 'üîç', focus: 'Dominio de la Nomenclatura, clasificaci√≥n y reglas generales interpretativas.', tasks: ['Clasificar Subpartida Textil', 'Revisar Reglas Interpretativas 1 y 6', 'Evaluar Preferencia Arancelaria'] },
            'compliance_officer': { title: 'Oficial de Cumplimiento Aduanero', icon: 'üõ°Ô∏è', focus: 'Verifica el cumplimiento de regulaciones no arancelarias y restricciones.', tasks: ['Auditar Regulaciones de Sanidad', 'Revisar Licencia de Importaci√≥n', 'Monitorear Restricciones'] },
            'logistics_coordinator': { title: 'Coordinador de Log√≠stica', icon: 'üöö', focus: 'Optimiza rutas, transporte, almacenamiento y transferencia de riesgo.', tasks: ['Optimizar Flete Mar√≠timo', 'Gestionar Entrega DAP', 'Seguimiento GPS Carga'] },
            'default': { title: 'Simulaci√≥n General - Sin Rol Asignado', icon: '‚ùå', focus: 'Por favor, regrese al men√∫ principal y seleccione un rol de carrera para empezar.', tasks: ['Ir a Selecci√≥n de Rol'] }
        };

    </script>
</body>
</html>
