<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Creador de Juegos - ADUWEB</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.5s ease-out; }
        .template-card { @apply relative p-4 border-2 border-gray-300 rounded-xl cursor-pointer transition-all duration-200 text-center bg-white shadow-sm; }
        .template-card.selected { @apply border-indigo-500 bg-indigo-50 shadow-lg ring-4 ring-indigo-200; }
        fieldset { @apply mt-8 p-6 border border-gray-300 rounded-xl bg-white; }
        legend { @apply text-xl font-bold text-indigo-600 px-2; }
        label { @apply block text-sm font-medium text-gray-700 mb-1 mt-2; }
        input[type="text"], input[type="number"], textarea, select { @apply w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500; }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <header class="bg-white py-4 px-6 shadow-md sticky top-0 z-20 border-b">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-4">
                <span class="text-2xl font-extrabold text-indigo-600">ADUWEB</span>
                <span class="text-sm font-light text-gray-500 hidden sm:block">| Creador de Juegos</span>
            </div>
            <div class="flex items-center gap-4">
                <!-- NUEVO: Indicador de Estado de la API -->
                <div id="api-status" class="flex items-center gap-2 text-sm">
                    <span class="h-3 w-3 rounded-full bg-gray-400 animate-pulse"></span>
                    <span class="text-gray-500">Verificando API...</span>
                </div>
                <a href="panel_control.html" class="text-sm bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
                    Volver al Panel
                </a>
                <button onclick="logout()" class="text-sm bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition">Cerrar Sesi√≥n</button>
            </div>
        </div>
    </header>

    <main class="max-w-5xl mx-auto p-6 md:p-10 animate-fade-in">
        <h1 class="text-3xl font-extrabold text-gray-900 border-b pb-4 mb-8">Creador de Juegos ADUGAME</h1>

        <!-- Paso 1: Selecci√≥n de Plantilla -->
        <fieldset>
            <legend>Paso 1: Elige una Plantilla</legend>
            <p class="text-sm text-gray-600 -mt-4 mb-4">Creado por: <span id="profesorName" class="font-semibold text-indigo-600"></span></p>
            <!-- El contenedor de la API Key se ha eliminado. La clave ahora se carga desde config.js -->
            <div id="template-selection-container" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                <!-- Las plantillas se cargar√°n aqu√≠ -->
            </div>
        </fieldset>

        <!-- Paso 2: Editor de Contenido y Reglas (Din√°mico) -->
        <div id="editor-container" class="hidden">
            <fieldset>
                <legend>Paso 2: Configuraci√≥n General</legend>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="gameName">Nombre de tu Juego</label>
                        <input type="text" id="gameName" placeholder="Ej: Duelo de Incoterms - Nivel B√°sico">
                    </div>
                    <div>
                        <label for="gameDescription">Descripci√≥n Corta</label>
                        <input type="text" id="gameDescription" placeholder="Una breve descripci√≥n para los estudiantes">
                    </div>
                </div>
            </fieldset>

            <fieldset>
                <legend>Paso 3: Contenido Espec√≠fico del Juego</legend>
                <div id="template-specific-editor">
                    <!-- El formulario espec√≠fico de la plantilla se inyectar√° aqu√≠ -->
                </div>
            </fieldset>

            <fieldset>
                <legend>Paso 4: Reglas de Puntuaci√≥n</legend>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label for="maxScore">Puntaje M√°ximo</label>
                        <input type="number" id="maxScore" value="1000">
                    </div>
                    <div>
                        <label for="bonusPoints">Puntos de Bonificaci√≥n (por racha, etc.)</label>
                        <input type="number" id="bonusPoints" value="50">
                    </div>
                    <div>
                        <label for="topPrize">Premio para el 1er Puesto (EXP Extra)</label>
                        <input type="number" id="topPrize" value="500">
                    </div>
                </div>
                <!-- NUEVO: Opci√≥n para requerir herramienta -->
                <div class="mt-4 pt-4 border-t">
                    <label for="requiresTool" class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="requiresTool" class="h-5 w-5 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                        <span class="font-semibold text-gray-800">Requiere Herramienta de Adu-Experto</span>
                    </label>
                    <p class="text-xs text-gray-500 mt-1">Si se marca, solo los jugadores con nivel "Adu-Experto" podr√°n usar una herramienta especial para resolver este juego.</p>
                </div>
            </fieldset>

            <button id="save-game-btn" class="w-full mt-8 p-4 bg-green-600 text-white font-bold text-lg rounded-lg hover:bg-green-700 transition shadow-md">
                Guardar Juego Personalizado
            </button>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-app.js";
        import { getDatabase, ref, push, set, get, update } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-database.js";
        // NUEVO: Importar el manejador centralizado de la API
        import { callAduiaApi, ADUIA_BASE_URL } from "./keyhandler.js";        import { firebaseConfig } from "./config.js"; // MODIFICADO: Ya no necesitamos la clave de OpenAI aqu√≠
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const TEMPLATES = [
            { id: 'time_trial', name: 'Carrera Contra el Reloj', icon: '‚è±Ô∏è', editor: 'trueFalseEditor' },
            { id: 'merch_identifier', name: 'Identificador de Mercanc√≠a', icon: 'üè∑Ô∏è', editor: 'merchIdentifierEditor' },
            { id: 'customs_duel', name: 'Duelo Aduanero', icon: '‚öîÔ∏è', editor: 'trueFalseEditor' },
            { id: 'incoterm_riddle', name: 'Adivinanza Incoterms', icon: 'üí£', editor: 'trueFalseEditor' },
            { id: 'transport_race', name: 'Carrera de Transporte', icon: 'üèÅ', editor: 'trueFalseEditor' },
            { id: 'document_finder', name: 'Buscador de Documentos', icon: 'üìÇ', editor: 'trueFalseEditor' },
            { id: 'cargo_carousel', name: 'Carrusel de Carga', icon: 'üîÑ', editor: 'merchIdentifierEditor' },
            { id: 'role_puzzle', name: 'Rompecabezas de Cargos', icon: 'üßë‚Äçüíº', editor: 'merchIdentifierEditor' },
            { id: 'customs_impostor', name: 'Encuentra al Impostor', icon: 'üïµÔ∏è', editor: 'impostorEditor' },
            { id: 'supply_chain_crisis', name: 'Cadena de Suministro: Crisis', icon: 'üåç', editor: 'supplyChainEditor' },
            { id: 'merchandise_care', name: 'Cuidado de Mercanc√≠a', icon: 'üì¶', editor: 'merchandiseCareEditor' }
        ];

        const editorContainer = document.getElementById('editor-container');
        const templateSpecificEditor = document.getElementById('template-specific-editor');
        let selectedTemplateId = null;
        let currentGameKey = null; // NUEVO: Para saber si estamos editando

        // --- L√≥gica de Renderizado de Formularios ---

        const editorForms = {
            trueFalseEditor: () => `
                <div class="flex flex-wrap justify-between items-center mb-4 gap-2">
                    <p class="text-sm text-gray-600">A√±ade preguntas de Verdadero o Falso (Verdadero=0, Falso=1).</p>
                    <!-- NUEVO: Controles de IA -->
                    <div id="ai-controls-container" class="flex items-center gap-2">
                        <div id="ai-options" class="hidden flex items-center gap-2">
                            <input type="number" id="ai-num-questions" value="5" min="1" max="10" class="w-16 p-1 text-sm">
                            <select id="ai-difficulty" class="p-1 text-sm">
                                <option value="f√°cil">F√°cil</option>
                                <option value="intermedio" selected>Intermedio</option>
                                <option value="dif√≠cil">Dif√≠cil</option>
                            </select>
                            <button type="button" id="ai-generate-btn" class="text-sm bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600 transition">Generar</button>
                            <button type="button" id="ai-cancel-btn" class="text-sm text-gray-500 hover:text-red-600">√ó</button>
                        </div>
                        <button type="button" id="ai-main-btn" class="text-sm bg-purple-500 text-white px-3 py-1 rounded hover:bg-purple-600 transition flex items-center gap-1">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3c7.2 0 9 1.8 9 9s-1.8 9-9 9-9-1.8-9-9 1.8-9 9-9z"></path><path d="M20.62 5.23a.5.5 0 0 0-.84 0l-1.03 1.03a.5.5 0 0 0 0 .7.5.5 0 0 0 .7 0l1.04-1.03a.5.5 0 0 0 .13-.7z"></path><path d="M12 18a6 6 0 1 0 0-12 6 6 0 0 0 0 12z"></path></svg>
                            Relleno con IA
                        </button>
                    </div>
                </div>
                <div id="questions-list" class="space-y-3"></div>
                <button type="button" id="add-question" class="mt-4 text-sm bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600">+ A√±adir Pregunta Manualmente</button>
            `,
            merchIdentifierEditor: () => `
                <div class="flex flex-wrap justify-between items-center mb-4 gap-2">
                    <p class="text-sm text-gray-600">A√±ade pares de Imagen y Descripci√≥n. El juego se encargar√° de barajarlos.</p>
                    <!-- NUEVO: Controles de IA para pares -->
                    <div id="ai-controls-container" class="flex items-center gap-2">
                        <div id="ai-options" class="hidden flex items-center gap-2">
                            <input type="number" id="ai-num-items" value="4" min="1" max="8" class="w-16 p-1 text-sm">
                            <button type="button" id="ai-generate-btn" class="text-sm bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600 transition">Generar</button>
                            <button type="button" id="ai-cancel-btn" class="text-sm text-gray-500 hover:text-red-600">√ó</button>
                        </div>
                        <button type="button" id="ai-main-btn" class="text-sm bg-purple-500 text-white px-3 py-1 rounded hover:bg-purple-600 transition flex items-center gap-1">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3c7.2 0 9 1.8 9 9s-1.8 9-9 9-9-1.8-9-9 1.8-9 9-9z"></path><path d="M20.62 5.23a.5.5 0 0 0-.84 0l-1.03 1.03a.5.5 0 0 0 0 .7.5.5 0 0 0 .7 0l1.04-1.03a.5.5 0 0 0 .13-.7z"></path><path d="M12 18a6 6 0 1 0 0-12 6 6 0 0 0 0 12z"></path></svg>
                            Relleno con IA
                        </button>
                    </div>
                </div>
                <div id="item-pairs-list" class="space-y-3"></div>
                <button type="button" id="add-item-pair" class="mt-4 text-sm bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600">+ A√±adir Par Manualmente</button>
            `,
            impostorEditor: () => `
                <div class="flex flex-wrap justify-between items-center mb-4 gap-2">
                    <p class="text-sm text-gray-600">Genera escenarios de investigaci√≥n con IA. Solo necesitas un tema y luego seleccionar al culpable.</p>
                    <div id="ai-controls-container" class="flex items-center gap-2">
                        <input type="text" id="ai-topic-input" placeholder="Tema del caso (ej: Subvaloraci√≥n)" class="p-1 text-sm border rounded">
                        <button type="button" id="ai-generate-scenario-btn" class="text-sm bg-purple-500 text-white px-3 py-1 rounded hover:bg-purple-600 transition flex items-center gap-1">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3c7.2 0 9 1.8 9 9s-1.8 9-9 9-9-1.8-9-9 1.8-9 9-9z"></path><path d="M20.62 5.23a.5.5 0 0 0-.84 0l-1.03 1.03a.5.5 0 0 0 0 .7.5.5 0 0 0 .7 0l1.04-1.03a.5.5 0 0 0 .13-.7z"></path><path d="M12 18a6 6 0 1 0 0-12 6 6 0 0 0 0 12z"></path></svg>
                            Generar Escenario con IA
                        </button>
                    </div>
                </div>
                <div id="scenarios-list" class="space-y-6">
                    <!-- Los escenarios generados por IA se a√±adir√°n aqu√≠ -->
                </div>
            `,
            supplyChainEditor: () => `
                <div class="flex flex-wrap justify-between items-center mb-4 gap-2">
                    <p class="text-sm text-gray-600">Genera un escenario de crisis log√≠stica con IA. Solo necesitas un tema.</p>
                    <div id="ai-controls-container" class="flex items-center gap-2">
                        <input type="text" id="ai-topic-input" placeholder="Tema (ej: Exportar flores a Miami)" class="p-1 text-sm border rounded flex-grow">
                        <button type="button" id="ai-generate-supply-chain-btn" class="text-sm bg-purple-500 text-white px-3 py-1 rounded hover:bg-purple-600 transition flex items-center gap-1">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3c7.2 0 9 1.8 9 9s-1.8 9-9 9-9-1.8-9-9 1.8-9 9-9z"></path><path d="M20.62 5.23a.5.5 0 0 0-.84 0l-1.03 1.03a.5.5 0 0 0 0 .7.5.5 0 0 0 .7 0l1.04-1.03a.5.5 0 0 0 .13-.7z"></path><path d="M12 18a6 6 0 1 0 0-12 6 6 0 0 0 0 12z"></path></svg>
                            Generar Escenario con IA
                        </button>
                    </div>
                </div>
                <div id="supply-chain-scenario-container" class="hidden space-y-4 bg-gray-50 p-4 rounded-lg border">
                    <!-- El escenario generado por IA se mostrar√° aqu√≠ -->
                </div>
            `,
            merchandiseCareEditor: () => `
                <div class="flex flex-wrap justify-between items-center mb-4 gap-2">
                    <p class="text-sm text-gray-600">Genera un escenario sobre el cuidado de carga sensible. Solo necesitas un tema.</p>
                    <div id="ai-controls-container" class="flex items-center gap-2">
                        <input type="text" id="ai-topic-input" placeholder="Tema (ej: Transporte de vacunas)" class="p-1 text-sm border rounded flex-grow">
                        <button type="button" id="ai-generate-merchandise-care-btn" class="text-sm bg-purple-500 text-white px-3 py-1 rounded hover:bg-purple-600 transition flex items-center gap-1">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3c7.2 0 9 1.8 9 9s-1.8 9-9 9-9-1.8-9-9 1.8-9 9-9z"></path><path d="M20.62 5.23a.5.5 0 0 0-.84 0l-1.03 1.03a.5.5 0 0 0 0 .7.5.5 0 0 0 .7 0l1.04-1.03a.5.5 0 0 0 .13-.7z"></path><path d="M12 18a6 6 0 1 0 0-12 6 6 0 0 0 0 12z"></path></svg>
                            Generar Escenario con IA
                        </button>
                    </div>
                </div>
                <div id="merchandise-care-scenario-container" class="hidden space-y-4 bg-gray-50 p-4 rounded-lg border">
                    <!-- El escenario generado por IA se mostrar√° aqu√≠ -->
                </div>
            `
        };

        function addQuestionField(question = '', answer = 1) {
            const container = document.getElementById('questions-list');
            const field = document.createElement('div');
            field.className = 'flex gap-2 items-center bg-gray-50 p-3 rounded-lg border';
            field.innerHTML = `
                <input type="text" class="flex-grow data-q" placeholder="Texto de la pregunta" value="${question}">
                <select class="data-a w-32" value="${answer}">
                    <option value="0">Verdadero</option>
                    <option value="1" ${answer === 1 ? 'selected' : ''}>Falso</option>
                </select>
                <button type="button" class="text-red-500 hover:text-red-700" onclick="this.parentElement.remove()">√ó</button>
            `;
            // Asegurar que el select refleje el valor correcto
            const select = field.querySelector('.data-a');
            select.value = answer;
            container.appendChild(field);
        }

        function addItemPairField(imageUrl = '', description = '') {
            const container = document.getElementById('item-pairs-list');
            const field = document.createElement('div');
            field.className = 'grid grid-cols-1 md:grid-cols-2 gap-2 items-center bg-gray-50 p-3 rounded-lg border';
            field.innerHTML = `
                <input type="text" class="data-img-url" placeholder="URL de la imagen" value="${imageUrl}">
                <input type="text" class="data-desc" placeholder="Descripci√≥n y c√≥digo" value="${description}">
            `;
            container.appendChild(field);
        }

        function selectTemplate(templateId) {
            selectedTemplateId = templateId;
            document.querySelectorAll('.template-card').forEach(c => c.classList.remove('selected'));
            document.querySelector(`[data-template-id="${templateId}"]`).classList.add('selected');

            editorContainer.classList.remove('hidden');
            const editorType = TEMPLATES.find(t => t.id === templateId).editor;
            // CORREGIDO: Se llama a la funci√≥n con () para obtener el HTML.
            templateSpecificEditor.innerHTML = editorForms[editorType] ? editorForms[editorType]() : '<p>Editor no disponible.</p>';

            // A√±adir listeners a los botones de los formularios din√°micos
            if (document.getElementById('add-question')) {
                document.getElementById('add-question').onclick = () => addQuestionField('', 1);
                // No a√±adir por defecto si estamos editando, se llenar√° despu√©s
                if (!currentGameKey) addQuestionField('', 1);
            }
            if (document.getElementById('add-item-pair')) {
                document.getElementById('add-item-pair').onclick = () => addItemPairField();
                if (!currentGameKey) addItemPairField();
            }

            // NUEVO: Listeners para los controles de IA
            const aiMainBtn = document.getElementById('ai-main-btn');
            const aiOptions = document.getElementById('ai-options');
            const aiCancelBtn = document.getElementById('ai-cancel-btn');
            const aiGenerateBtn = document.getElementById('ai-generate-btn');

            if (aiMainBtn && aiOptions && aiCancelBtn && aiGenerateBtn) {
                aiMainBtn.onclick = () => { aiMainBtn.classList.add('hidden'); aiOptions.classList.remove('hidden'); };
                aiCancelBtn.onclick = () => { aiOptions.classList.add('hidden'); aiMainBtn.classList.remove('hidden'); };
                // MODIFICADO: Decidir qu√© funci√≥n de IA llamar
                if (selectedTemplateId === 'merch_identifier' || selectedTemplateId === 'cargo_carousel' || selectedTemplateId === 'role_puzzle') {
                    aiGenerateBtn.onclick = generateAIItemPairs;
                } else {
                    aiGenerateBtn.onclick = generateAIQuestions;
                }
            }
            if (document.getElementById('ai-generate-scenario-btn')) {
                document.getElementById('ai-generate-scenario-btn').onclick = generateAIImpostorScenario;
            }
            if (document.getElementById('ai-generate-supply-chain-btn')) {
                document.getElementById('ai-generate-supply-chain-btn').onclick = generateAISupplyChainScenario;
            }
            if (document.getElementById('ai-generate-merchandise-care-btn')) {
                document.getElementById('ai-generate-merchandise-care-btn').onclick = generateAIMerchandiseCareScenario;
            }
        }

        // --- NUEVO: L√≥gica de generaci√≥n con IA ---
        async function generateAIQuestions() {
            const topic = document.getElementById('gameName').value.trim();
            if (!topic) {
                Swal.fire('Tema Requerido', 'Por favor, escribe un nombre o tema para el juego antes de usar la IA.', 'warning');
                return;
            }

            const numQuestions = document.getElementById('ai-num-questions')?.value || 5;
            const difficulty = document.getElementById('ai-difficulty')?.value || 'intermedio';
            const generateBtn = document.getElementById('ai-generate-btn');

            generateBtn.disabled = true;
            generateBtn.innerHTML = `<svg class="animate-spin h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>`;

            const prompt = `
                Eres un experto en comercio exterior y aduanas. Genera ${numQuestions} preguntas de verdadero o falso sobre el tema "${topic}" con una dificultad ${difficulty}.
                Devuelve la respuesta en formato JSON, como un array de objetos. Cada objeto debe tener una clave "text" para la pregunta y una clave "answer" (0 para verdadero, 1 para falso).
                Ejemplo de formato: {"questions": [{"text": "El Incoterm EXW impone la m√°xima obligaci√≥n al vendedor.", "answer": 1}]}
            `;

            const payload = { model: "gpt-3.5-turbo-0125", messages: [{ role: "user", content: prompt }], temperature: 0.6, response_format: { type: "json_object" } };

            try {
                // MODIFICADO: Usar el manejador centralizado
                const data = await callAduiaApi(payload);
                let contentString = data.choices[0].message.content;

                // La IA ahora devuelve un objeto JSON directamente
                const aiContent = JSON.parse(contentString); // La respuesta de la funci√≥n es la misma que la de OpenAI
                const generatedQuestions = aiContent.questions; // Asumiendo que la IA respeta la estructura

                // Rellenar el formulario
                const questionsContainer = document.getElementById('questions-list');
                questionsContainer.innerHTML = ''; // Limpiar preguntas existentes
                generatedQuestions.forEach(q => {
                    if (q.text && (q.answer === 0 || q.answer === 1)) {
                        addQuestionField(q.text, q.answer);
                    }
                });

            } catch (error) {
                Swal.fire('Error de IA', `No se pudo generar el contenido: ${error.message}`, 'error');
            } finally {
                generateBtn.disabled = false;
                generateBtn.textContent = 'Generar';
            }
        }

        // --- NUEVO: L√≥gica de generaci√≥n con IA para pares de items ---
        async function generateAIItemPairs() {
            const topic = document.getElementById('gameName').value.trim();
            if (!topic) {
                Swal.fire('Tema Requerido', 'Por favor, escribe un nombre o tema para el juego antes de usar la IA.', 'warning');
                return;
            }

            const numItems = document.getElementById('ai-num-items')?.value || 4;
            const generateBtn = document.getElementById('ai-generate-btn');

            generateBtn.disabled = true;
            generateBtn.innerHTML = `<svg class="animate-spin h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>`;

            const prompt = `
                Eres un experto en comercio exterior y aduanas. Genera ${numItems} pares de contenido para un juego sobre "${topic}".
                Cada par debe tener una URL de imagen p√∫blica y una descripci√≥n corta que incluya un c√≥digo arancelario ficticio o real.
                Devuelve la respuesta en formato JSON, como un array de objetos. Cada objeto debe tener una clave "imageUrl" y una clave "description".
                Ejemplo de formato: {"items": [{"imageUrl": "https://example.com/image.png", "description": "Laptops (8471.30.00)"}]}
            `;

            const payload = { model: "gpt-3.5-turbo-0125", messages: [{ role: "user", content: prompt }], temperature: 0.7, response_format: { type: "json_object" } };

            try {
                // MODIFICADO: Usar el manejador centralizado
                const data = await callAduiaApi(payload);
                let contentString = data.choices[0].message.content;
                
                const aiContent = JSON.parse(contentString);
                const generatedItems = aiContent.items;

                // Rellenar el formulario
                const itemsContainer = document.getElementById('item-pairs-list');
                itemsContainer.innerHTML = ''; // Limpiar items existentes
                generatedItems.forEach(item => {
                    if (item.imageUrl && item.description) {
                        addItemPairField(item.imageUrl, item.description);
                    }
                });

            } catch (error) {
                Swal.fire('Error de IA', `No se pudo generar el contenido: ${error.message}`, 'error');
            } finally {
                generateBtn.disabled = false;
                generateBtn.textContent = 'Generar';
            }
        }

        // --- NUEVO: L√≥gica de IA para el juego del Impostor ---
        function addImpostorScenarioField(scenarioData, scenarioIndex) {
            const container = document.getElementById('scenarios-list');
            const scenarioDiv = document.createElement('div');
            scenarioDiv.className = 'scenario-card bg-gray-50 p-4 rounded-lg border-2 border-gray-200';
            scenarioDiv.dataset.index = scenarioIndex;

            let officersHtml = scenarioData.officers.map((officer, officerIndex) => `
                <div class="officer-entry mt-2 p-2 border-t border-gray-200">
                    <div class="flex items-center gap-2">
                        <input type="radio" name="impostor_scenario_${scenarioIndex}" value="${officerIndex}" class="impostor-radio h-5 w-5 text-red-600 focus:ring-red-500">
                        <span class="font-bold text-gray-700">${officer.name} (${officer.role})</span>
                    </div>
                    <p class="text-xs text-gray-600 italic pl-7">"${officer.statement}"</p>
                </div>
            `).join('');

            scenarioDiv.innerHTML = `
                <h4 class="font-bold text-lg text-gray-800">Escenario ${scenarioIndex + 1}</h4>
                <div class="mt-2">
                    <p class="font-semibold text-sm">Evidencias:</p>
                    <ul class="list-disc list-inside text-sm text-gray-600 pl-4">
                        ${scenarioData.evidence.map(e => `<li>${e}</li>`).join('')}
                    </ul>
                </div>
                <div class="mt-4">
                    <p class="font-semibold text-sm">Declaraciones (Selecciona al impostor):</p>
                    ${officersHtml}
                </div>
            `;
            container.appendChild(scenarioDiv);
        }

        async function generateAIImpostorScenario() {
            const topic = document.getElementById('ai-topic-input').value.trim();
            if (!topic) {
                Swal.fire('Tema Requerido', 'Por favor, escribe un tema para el caso antes de usar la IA (ej: "fraude documental", "contrabando de electr√≥nicos").', 'warning');
                return;
            }

            const generateBtn = document.getElementById('ai-generate-scenario-btn');
            generateBtn.disabled = true;
            generateBtn.innerHTML = `<svg class="animate-spin h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Generando...`;

            const prompt = `
                Eres un experto en aduanas. Crea un escenario para un juego de "encontrar al impostor" sobre el tema: "${topic}".
                Genera una respuesta JSON con dos claves: "evidence" (un array de 4 strings con pistas) y "officers" (un array de 4 objetos).
                Cada objeto de oficial debe tener: "name", "role", "emoji" y "statement".
                Una de las declaraciones ("statement") debe ser sutilmente contradictoria con las pistas en "evidence". Las otras 3 deben ser cre√≠bles.
                Ejemplo de formato: {"evidence": ["pista 1"], "officers": [{"name":"Juan", "role":"Inspector", "emoji":"üë®‚Äçüíº", "statement":"declaraci√≥n..."}]}
            `;
            const payload = { model: "gpt-3.5-turbo-0125", messages: [{ role: "user", content: prompt }], temperature: 0.8, response_format: { type: "json_object" } };

            try {
                const data = await callAduiaApi(payload);
                const contentString = data.choices[0].message.content;
                const jsonMatch = contentString.match(/\{[\s\S]*\}/);
                if (!jsonMatch) throw new Error("La respuesta de la IA no conten√≠a un JSON v√°lido.");
                const generatedScenario = JSON.parse(jsonMatch[0]);
                addImpostorScenarioField(generatedScenario, document.querySelectorAll('.scenario-card').length);
            } catch (error) {
                Swal.fire('Error de IA', `No se pudo generar el escenario: ${error.message}`, 'error');
            } finally {
                generateBtn.disabled = false;
                generateBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3c7.2 0 9 1.8 9 9s-1.8 9-9 9-9-1.8-9-9 1.8-9 9-9z"></path><path d="M20.62 5.23a.5.5 0 0 0-.84 0l-1.03 1.03a.5.5 0 0 0 0 .7.5.5 0 0 0 .7 0l1.04-1.03a.5.5 0 0 0 .13-.7z"></path><path d="M12 18a6 6 0 1 0 0-12 6 6 0 0 0 0 12z"></path></svg> Generar Escenario con IA`;
            }
        }

        // --- NUEVO: L√≥gica de IA para el juego de Cadena de Suministro ---
        async function generateAISupplyChainScenario() {
            const topic = document.getElementById('ai-topic-input').value.trim();
            if (!topic) {
                Swal.fire('Tema Requerido', 'Por favor, escribe un tema para el escenario (ej: "Exportar textiles a Jap√≥n").', 'warning');
                return;
            }

            const generateBtn = document.getElementById('ai-generate-supply-chain-btn');
            generateBtn.disabled = true;
            generateBtn.innerHTML = `<svg class="animate-spin h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Generando...`;

            const prompt = `
                Eres un experto en log√≠stica y cadena de suministro. Tu tarea es crear un escenario completo para un juego de simulaci√≥n llamado "Cadena de Suministro: Modo Crisis".
                El tema del escenario es: "${topic}".
                Genera una respuesta en formato JSON que contenga:
                1. Una clave "scenario" con un objeto que describa la misi√≥n: "product", "origin", "destination", "budget" (un n√∫mero en USD) y "deadline" (un n√∫mero en d√≠as).
                2. Una clave "events" que sea un array de 4 objetos. Cada objeto representa una crisis en una etapa de la cadena de suministro y debe tener: "stage", "crisis_text", y un array "options" de 2 o 3 objetos.
                3. Cada objeto de opci√≥n debe tener: "label" (ej: "Opci√≥n A"), "description" (el texto de la opci√≥n), "timeImpact" (un n√∫mero negativo de d√≠as), "costImpact" (un n√∫mero negativo en USD), y "feedback" (el texto que explica la consecuencia).
            `;
            const payload = { model: "gpt-3.5-turbo-0125", messages: [{ role: "user", content: prompt }], temperature: 0.8, response_format: { type: "json_object" } };

            try {
                const data = await callAduiaApi(payload);
                const contentString = data.choices[0].message.content;
                const jsonMatch = contentString.match(/\{[\s\S]*\}/);
                if (!jsonMatch) throw new Error("La respuesta de la IA no conten√≠a un JSON v√°lido.");
                
                const generatedData = JSON.parse(jsonMatch[0]);
                const container = document.getElementById('supply-chain-scenario-container');
                
                // Guardar los datos en el contenedor para usarlos al guardar el juego
                container.dataset.scenario = JSON.stringify(generatedData);

                // Mostrar los datos generados al profesor
                const { scenario, events } = generatedData;
                container.innerHTML = `
                    <h4 class="font-bold text-lg text-gray-800">Misi√≥n Generada</h4>
                    <p class="text-sm"><strong>Producto:</strong> ${scenario.product}</p>
                    <p class="text-sm"><strong>Ruta:</strong> ${scenario.origin} ‚Üí ${scenario.destination}</p>
                    <p class="text-sm"><strong>Presupuesto:</strong> $${scenario.budget} | <strong>L√≠mite:</strong> ${scenario.deadline} d√≠as</p>
                    <h5 class="font-semibold mt-4">Eventos de Crisis:</h5>
                    <ul class="list-disc list-inside text-xs text-gray-600 pl-4">
                        ${events.map(e => `<li><strong>${e.stage}:</strong> ${e.crisis_text}</li>`).join('')}
                    </ul>
                `;
                container.classList.remove('hidden');

            } catch (error) {
                Swal.fire('Error de IA', `No se pudo generar el escenario: ${error.message}`, 'error');
            } finally {
                generateBtn.disabled = false;
                generateBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3c7.2 0 9 1.8 9 9s-1.8 9-9 9-9-1.8-9-9 1.8-9 9-9z"></path><path d="M20.62 5.23a.5.5 0 0 0-.84 0l-1.03 1.03a.5.5 0 0 0 0 .7.5.5 0 0 0 .7 0l1.04-1.03a.5.5 0 0 0 .13-.7z"></path><path d="M12 18a6 6 0 1 0 0-12 6 6 0 0 0 0 12z"></path></svg> Generar Escenario con IA`;
            }
        }

        // --- NUEVO: L√≥gica de IA para el juego Cuidado de Mercanc√≠a ---
        async function generateAIMerchandiseCareScenario() {
            const topic = document.getElementById('ai-topic-input').value.trim();
            if (!topic) {
                Swal.fire('Tema Requerido', 'Por favor, escribe un tema para el escenario (ej: "Transportar obras de arte").', 'warning');
                return;
            }

            const generateBtn = document.getElementById('ai-generate-merchandise-care-btn');
            generateBtn.disabled = true;
            generateBtn.innerHTML = `<svg class="animate-spin h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Generando...`;

            const prompt = `
                Eres un experto en log√≠stica de carga sensible. Crea un escenario para un juego llamado "Cuidado de Mercanc√≠a" sobre: "${topic}".
                Genera una respuesta JSON con dos claves: "mission" (un objeto con "product", "origin", "destination", "quality_threshold" (ej: 80), "budget" en USD, y "deadline" en horas) y "events" (un array de 4 objetos de dilema).
                Cada evento debe tener: "stage", "dilemma_text", y un array "options" de 2 o 3 objetos.
                Cada opci√≥n debe tener: "letter" (A, B, C), "title", "description", "qualityImpact" (n√∫mero negativo), "costImpact" (USD negativo), "timeImpact" (horas negativo), y "feedback".
            `;
            const payload = { model: "gpt-3.5-turbo-0125", messages: [{ role: "user", content: prompt }], temperature: 0.8, response_format: { type: "json_object" } };

            try {
                const data = await callAduiaApi(payload);
                const contentString = data.choices[0].message.content;
                const jsonMatch = contentString.match(/\{[\s\S]*\}/);
                if (!jsonMatch) throw new Error("La respuesta de la IA no conten√≠a un JSON v√°lido.");
                
                const generatedData = JSON.parse(jsonMatch[0]);
                const container = document.getElementById('merchandise-care-scenario-container');
                
                container.dataset.scenario = JSON.stringify(generatedData);

                const { mission, events } = generatedData;
                container.innerHTML = `
                    <h4 class="font-bold text-lg text-gray-800">Misi√≥n Generada</h4>
                    <p class="text-sm"><strong>Producto:</strong> ${mission.product}</p>
                    <p class="text-sm"><strong>Ruta:</strong> ${mission.origin} ‚Üí ${mission.destination}</p>
                    <p class="text-sm"><strong>Presupuesto:</strong> $${mission.budget} | <strong>L√≠mite:</strong> ${mission.deadline} horas | <strong>Calidad M√≠nima:</strong> ${mission.quality_threshold}%</p>
                    <h5 class="font-semibold mt-4">Dilemas de Calidad:</h5>
                    <ul class="list-disc list-inside text-xs text-gray-600 pl-4">
                        ${events.map(e => `<li><strong>${e.stage}:</strong> ${e.dilemma_text}</li>`).join('')}
                    </ul>
                `;
                container.classList.remove('hidden');

            } catch (error) {
                Swal.fire('Error de IA', `No se pudo generar el escenario: ${error.message}`, 'error');
            } finally {
                generateBtn.disabled = false;
                generateBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3c7.2 0 9 1.8 9 9s-1.8 9-9 9-9-1.8-9-9 1.8-9 9-9z"></path><path d="M20.62 5.23a.5.5 0 0 0-.84 0l-1.03 1.03a.5.5 0 0 0 0 .7.5.5 0 0 0 .7 0l1.04-1.03a.5.5 0 0 0 .13-.7z"></path><path d="M12 18a6 6 0 1 0 0-12 6 6 0 0 0 0 12z"></path></svg> Generar Escenario con IA`;
            }
        }

        async function saveGame() {
            if (!selectedTemplateId) {
                Swal.fire('Error', 'Debes seleccionar una plantilla de juego.', 'error');
                return;
            }

            const gameData = {
                templateId: selectedTemplateId,
                name: document.getElementById('gameName').value.trim(),
                description: document.getElementById('gameDescription').value.trim(),
                rules: {
                    maxScore: parseInt(document.getElementById('maxScore').value),
                    bonusPoints: parseInt(document.getElementById('bonusPoints').value),
                    topPrize: parseInt(document.getElementById('topPrize').value)
                },
                requiresTool: document.getElementById('requiresTool').checked, // NUEVO
                content: {}, // Se llenar√° a continuaci√≥n
                createdBy: localStorage.getItem('aduweb_special_user_name') || 'Profesor',
                createdAt: Date.now()
            };

            if (!gameData.name) {
                Swal.fire('Error', 'El nombre del juego es obligatorio.', 'error');
                return;
            }

// Recolectar contenido espec√≠fico de la plantilla
if (['time_trial', 'customs_duel', 'incoterm_riddle', 'transport_race', 'document_finder'].includes(selectedTemplateId)) {
    gameData.content.questions = [];
    document.querySelectorAll('#questions-list > div').forEach(qDiv => {
        const text = qDiv.querySelector('.data-q').value.trim();
        const answer = parseInt(qDiv.querySelector('.data-a').value);
        if (text) gameData.content.questions.push({ text, answer });
    });
    if (gameData.content.questions.length === 0) {
        Swal.fire('Error', 'Debes a√±adir al menos una pregunta.', 'error');
        return;
    }
} else if (['merch_identifier', 'cargo_carousel', 'role_puzzle'].includes(selectedTemplateId)) {
    gameData.content.items = [];
    document.querySelectorAll('#item-pairs-list > div').forEach(pDiv => {
        const imageUrl = pDiv.querySelector('.data-img-url').value.trim();
        const description = pDiv.querySelector('.data-desc').value.trim();
        if (imageUrl && description) gameData.content.items.push({ imageUrl, description, id: `item_${Date.now()}_${Math.random()}` });
    });
    if (gameData.content.items.length === 0) {
        Swal.fire('Error', 'Debes a√±adir al menos un par de imagen/descripci√≥n.', 'error');
        return;
    }
} else if (selectedTemplateId === 'customs_impostor') {
    gameData.content.scenarios = [];
    document.querySelectorAll('.scenario-card').forEach(sDiv => {
        const scenarioIndex = sDiv.dataset.index;
        const evidences = Array.from(sDiv.querySelectorAll('ul li')).map(li => li.textContent);
        const officers = [];
        const impostorIndex = parseInt(sDiv.querySelector(`input[name="impostor_scenario_${scenarioIndex}"]:checked`)?.value);

        sDiv.querySelectorAll('.officer-entry').forEach((oDiv, officerIdx) => {
            const nameAndRole = oDiv.querySelector('span').textContent;
            const statement = oDiv.querySelector('p').textContent.replace(/"/g, '');
            officers.push({
                name: nameAndRole.split(' (')[0],
                role: nameAndRole.split(' (')[1]?.replace(')', ''),
                statement: statement,
                isImpostor: officerIdx === impostorIndex
            });
        });
        gameData.content.scenarios.push({ evidence: evidences, officers: officers });
    });
} else if (selectedTemplateId === 'supply_chain_crisis') {
    const container = document.getElementById('supply-chain-scenario-container');
    if (!container.dataset.scenario) {
        Swal.fire('Error', 'Debes generar un escenario con la IA antes de guardar.', 'error');
        return;
    }
    gameData.content = JSON.parse(container.dataset.scenario);
} else if (selectedTemplateId === 'merchandise_care') {
    const container = document.getElementById('merchandise-care-scenario-container');
    if (!container.dataset.scenario) {
        Swal.fire('Error', 'Debes generar un escenario con la IA antes de guardar.', 'error');
        return;
    }
    gameData.content = JSON.parse(container.dataset.scenario);
}
            // Guardar en Firebase
            const gameRef = currentGameKey ? ref(db, `custom_games/${currentGameKey}`) : push(ref(db, 'custom_games'));
            const isUpdating = !!currentGameKey;

            try {
                await set(gameRef, gameData);
                Swal.fire(
                    isUpdating ? '¬°Juego Actualizado!' : '¬°Juego Guardado!',
                    'Tus cambios han sido guardados correctamente.',
                    'success'
                ).then(() => {
                    window.location.href = 'mis_juegos.html'; // Redirigir a la lista de juegos
                });
            } catch (error) {
                Swal.fire('Error', 'No se pudo guardar el juego en la base de datos.', 'error');
                console.error(error);
            }
        }

        // --- NUEVO: L√≥gica para cargar un juego para editar ---
        // --- MODIFICADO: Funci√≥n para verificar el estado de la API de OpenAI (ahora usa la clave de config.js) ---
        async function checkApiStatus() {
    const statusContainer = document.getElementById('api-status');
    const statusDot = statusContainer.querySelector('span:first-child');
    const statusText = statusContainer.querySelector('span:last-child');
            statusDot.className = 'h-3 w-3 rounded-full bg-gray-400 animate-pulse';
            statusText.textContent = 'Verificando...';
            statusText.className = 'text-gray-500';

            try {
                // MODIFICADO: La clave ya no se verifica aqu√≠, sino en el backend.
                // Asumimos que si la funci√≥n existe, la clave est√° configurada.
                // Una prueba real ser√≠a llamar a la funci√≥n con un 'ping'.
                const functionUrl = ADUIA_BASE_URL; 
        // Nota: asumo que tu API tiene un endpoint /status adem√°s de /chat
        const response = await fetch(functionUrl + '/status');

                statusDot.classList.remove('animate-pulse', 'bg-gray-400');

                if (response.ok) {
                    statusDot.classList.add('bg-green-500');
                    statusText.textContent = 'API Operacional';
                    statusText.className = 'text-green-700 font-semibold';
                    return true;
                } else {
                    throw new Error(`Estado: ${response.status}`);
                }
            } catch (error) {
                statusDot.classList.remove('animate-pulse', 'bg-gray-400');
                statusDot.classList.add('bg-red-500');
                statusText.textContent = 'Error de Conexi√≥n';
                statusText.className = 'text-red-700 font-semibold';
                console.error("Error al verificar API:", error);
                return false;
            }
        }
        
        async function loadGameForEditing(gameKey) {
            // Cambiar el texto del bot√≥n de guardado
            document.getElementById('save-game-btn').textContent = 'Actualizar Juego'; // Esto parece estar en el lugar equivocado, lo muevo a la inicializaci√≥n
            document.querySelector('h1').textContent = 'Editando Juego';
        }

        // --- Inicializaci√≥n ---
        document.addEventListener('DOMContentLoaded', async () => {
            // Verificar sesi√≥n del profesor
            const profesorName = localStorage.getItem('aduweb_special_user_name');
            if (!profesorName) {
                window.location.href = 'index.html'; // Redirigir si no hay sesi√≥n de profesor
                return;
            }
            document.getElementById('profesorName').textContent = profesorName;

            // Verificar autom√°ticamente el estado de la API al cargar
            checkApiStatus();

            const container = document.getElementById('template-selection-container');
            TEMPLATES.forEach(template => {
                const card = document.createElement('div');
                card.className = 'template-card';
                card.dataset.templateId = template.id;
                card.innerHTML = `
                    <div class="text-4xl mx-auto mb-2">${template.icon}</div>
                    <h4 class="font-bold text-sm text-gray-700">${template.name}</h4>
                `;
                card.onclick = () => selectTemplate(template.id);
                container.appendChild(card);
            });

            document.getElementById('save-game-btn').addEventListener('click', saveGame);

            // --- NUEVO: Comprobar si estamos en modo edici√≥n ---
            const urlParams = new URLSearchParams(window.location.search);
            const gameKeyToEdit = urlParams.get('edit');
            if (gameKeyToEdit) {
                currentGameKey = gameKeyToEdit;
                document.getElementById('save-game-btn').textContent = 'Actualizar Juego';
                document.querySelector('h1').textContent = 'Editando Juego';
                await loadGameForEditing(gameKeyToEdit);
            }
        });

        // Funci√≥n de Logout
        function logout() {
            localStorage.removeItem('aduweb_special_user_name');
            window.location.href = 'index.html';
        }
        window.logout = logout;
    </script>
</body>
</html>
