<!DOCTYPE html>
<html lang="es">
<head>
    <audio id="soundClick" src="./click.mp3" preload="auto"></audio>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Control - ADUWEB</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        /* yarvis-styles.css - Estilos mejorados para el chat de Yarvis */

/* Animaciones de bienvenida */
#welcome-splash {
    transition: opacity 0.5s ease-out;
}

@keyframes shield-assemble-left {
    from { transform: translateX(-100%) rotateY(90deg); opacity: 0; }
    to { transform: translateX(0) rotateY(0); opacity: 1; }
}

@keyframes shield-assemble-right {
    from { transform: translateX(100%) rotateY(-90deg); opacity: 0; }
    to { transform: translateX(0) rotateY(0); opacity: 1; }
}

@keyframes shield-pulse {
    from { filter: drop-shadow(0 0 0px #a5b4fc); }
    to { filter: drop-shadow(0 0 20px #a5b4fc); }
}

@keyframes shield-open-left {
    to { transform: perspective(800px) translateX(-80%) rotateY(-45deg) scale(1.2); opacity: 0; }
}

@keyframes shield-open-right {
    to { transform: perspective(800px) translateX(80%) rotateY(45deg) scale(1.2); opacity: 0; }
}

@keyframes welcome-text-fade-in {
    0%, 60% { opacity: 0; transform: scale(0.9); }
    100% { opacity: 1; transform: scale(1); }
}

#shield-left {
    animation: shield-assemble-left 1s ease-out forwards, 
               shield-open-left 1.2s ease-in 1.5s forwards;
}

#shield-right {
    animation: shield-assemble-right 1s ease-out forwards, 
               shield-open-right 1.2s ease-in 1.5s forwards;
}

#welcome-text {
    animation: welcome-text-fade-in 1.5s ease-out 1.8s forwards;
}

#shield-icon {
    animation: shield-pulse 0.5s ease-in-out 1s alternate;
}

/* Chat window */
#yarvis-chat-window {
    scroll-behavior: smooth;
}

/* Burbujas de chat */
.yarvis-bubble {
    max-width: 80%;
    word-wrap: break-word;
    line-height: 1.5;
    font-size: 14px;
}

.yarvis-bubble.user {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 18px 18px 4px 18px;
}

.yarvis-bubble.ia {
    background-color: #f3f4f6;
    color: #1f2937;
    border-radius: 18px 18px 18px 4px;
}

.yarvis-bubble.alert {
    background-color: #fef3c7;
    color: #92400e;
    border-left: 4px solid #f59e0b;
    border-radius: 8px;
}

/* Tarjetas de acci√≥n */
.yarvis-action-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 12px;
    padding: 16px;
    color: white;
    margin: 8px 0;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

/* Botones de acci√≥n */
.yarvis-action-btn {
    background: white;
    color: #4f46e5;
    padding: 8px 16px;
    border-radius: 8px;
    font-weight: 600;
    margin: 4px;
    transition: all 0.2s;
    cursor: pointer;
    display: inline-block;
    border: none;
    font-size: 13px;
}

.yarvis-action-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
    background-color: #f9fafb;
}

.yarvis-action-btn:active {
    transform: translateY(0);
}

/* Indicador de escritura */
.typing-indicator {
    display: inline-flex;
    gap: 4px;
    padding: 12px 16px;
    background-color: #f3f4f6;
    border-radius: 18px;
}

.typing-indicator span {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #6366f1;
    animation: typing 1.4s infinite;
}

.typing-indicator span:nth-child(2) { 
    animation-delay: 0.2s; 
}

.typing-indicator span:nth-child(3) { 
    animation-delay: 0.4s; 
}

@keyframes typing {
    0%, 60%, 100% { 
        transform: translateY(0); 
        opacity: 0.4; 
    }
    30% { 
        transform: translateY(-10px); 
        opacity: 1; 
    }
}

/* Panel de contexto lateral */
.context-panel {
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    border-radius: 12px;
    padding: 16px;
    margin: 8px 0;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
}

/* Items de tareas */
.task-item {
    background: white;
    border-radius: 8px;
    padding: 12px;
    margin: 8px 0;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    transition: all 0.2s;
}

.task-item:hover {
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    transform: translateX(4px);
}

/* Comandos r√°pidos */
.quick-command {
    display: inline-block;
    background: #e0e7ff;
    color: #4338ca;
    padding: 6px 12px;
    border-radius: 16px;
    font-size: 12px;
    font-weight: 600;
    margin: 2px;
    cursor: pointer;
    transition: all 0.2s;
    border: 2px solid transparent;
}

.quick-command:hover {
    background: #4338ca;
    color: white;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(67, 56, 202, 0.3);
}

.quick-command:active {
    transform: translateY(0);
}

/* Tarjetas de vista previa */
.preview-card {
    background: white;
    border: 2px solid #e5e7eb;
    border-radius: 12px;
    padding: 16px;
    margin: 12px 0;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    transition: all 0.2s;
}

.preview-card:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
}

.preview-card h4 {
    color: #4f46e5;
    font-weight: bold;
    margin-bottom: 8px;
    font-size: 16px;
}

/* Badges de estad√≠sticas */
.stat-badge {
    display: inline-block;
    background: #dbeafe;
    color: #1e40af;
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 13px;
    font-weight: 600;
    margin: 4px;
}

/* Modal de Yarvis */
#yarvis-modal {
    backdrop-filter: blur(4px);
}

#yarvis-modal > div {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Bot√≥n flotante */
#open-yarvis-btn {
    box-shadow: 0 4px 20px rgba(79, 70, 229, 0.4);
    animation: pulse-float 2s ease-in-out infinite;
}

@keyframes pulse-float {
    0%, 100% {
        transform: translateY(0) scale(1);
        box-shadow: 0 4px 20px rgba(79, 70, 229, 0.4);
    }
    50% {
        transform: translateY(-4px) scale(1.05);
        box-shadow: 0 8px 25px rgba(79, 70, 229, 0.5);
    }
}

#open-yarvis-btn:hover {
    transform: scale(1.1);
    box-shadow: 0 8px 30px rgba(79, 70, 229, 0.6);
}

/* Scrollbar personalizado para el chat */
#yarvis-chat-window::-webkit-scrollbar {
    width: 6px;
}

#yarvis-chat-window::-webkit-scrollbar-track {
    background: #f3f4f6;
    border-radius: 10px;
}

#yarvis-chat-window::-webkit-scrollbar-thumb {
    background: #d1d5db;
    border-radius: 10px;
}

#yarvis-chat-window::-webkit-scrollbar-thumb:hover {
    background: #9ca3af;
}

/* Responsive */
@media (max-width: 640px) {
    .yarvis-bubble {
        max-width: 90%;
        font-size: 13px;
    }

    .preview-card {
        padding: 12px;
    }

    .quick-command {
        font-size: 11px;
        padding: 4px 10px;
    }

    #context-sidebar {
        display: none !important;
    }
}

/* Animaci√≥n de entrada para tarjetas */
@keyframes slideInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.preview-card,
.yarvis-action-card {
    animation: slideInUp 0.3s ease-out;
}

/* Header del modal */
#yarvis-modal .rounded-t-2xl {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

/* Efecto hover en cards del dashboard */
.hover\:shadow-xl:hover {
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 
                0 10px 10px -5px rgba(0, 0, 0, 0.04);
}

.hover\:-translate-y-1:hover {
    transform: translateY(-4px);
}

/* Mejora visual para inputs */
#yarvis-input:focus {
    outline: none;
    border-color: #6366f1;
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
}

/* Estado de carga */
.loading-state {
    opacity: 0.6;
    pointer-events: none;
}

/* Notificaci√≥n de badge */
.notification-badge {
    position: absolute;
    top: -4px;
    right: -4px;
    background: #ef4444;
    color: white;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 10px;
    font-weight: bold;
    animation: badge-pulse 2s infinite;
}

@keyframes badge-pulse {
    0%, 100% {
        transform: scale(1);
    }
    50% {
        transform: scale(1.1);
    }
}
    </style>
</head>
<body class="bg-gray-100 font-sans">
    <!-- Pantalla de Bienvenida -->
    <div id="welcome-splash" class="fixed inset-0 bg-gray-800 flex flex-col items-center justify-center z-50">
        <div class="relative w-32 h-32">
            <svg id="shield-icon" class="absolute inset-0 w-full h-full" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path id="shield-left" d="M12 22S3 17 3 10V5L12 2V22Z" fill="#4f46e5" stroke="#c7d2fe" stroke-width="0.5"/>
                <path id="shield-right" d="M12 22S21 17 21 10V5L12 2V22Z" fill="#4f46e5" stroke="#c7d2fe" stroke-width="0.5"/>
            </svg>
            <h1 id="welcome-text" class="absolute inset-0 flex items-center justify-center text-white text-3xl font-extrabold opacity-0">
                BIENVENIDO
            </h1>
        </div>
    </div>

    <header id="main-header" class="bg-white py-4 px-6 shadow-md sticky top-0 z-20 border-b opacity-0">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-4">
                <span class="text-2xl font-extrabold text-indigo-600">ADUWEB</span>
                <span class="text-sm font-light text-gray-500 hidden sm:block">| Panel de Control (Profesor)</span>
            </div>
            <button onclick="logout()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-semibold transition">
                Cerrar Sesi√≥n
            </button>
        </div>
    </header>

    <main id="main-content" class="max-w-7xl mx-auto p-6 md:p-10 opacity-0">
        <h1 class="text-3xl font-extrabold text-gray-900 mb-2">Bienvenido, <span id="profesorName" class="text-indigo-600"></span></h1>
        <p class="text-lg text-gray-600 mb-8">Tu asistente Yarvis est√° listo para ayudarte.</p>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            
            <!-- Crear Casos -->
            <div onclick="navigateTo('generador_casos.html')" class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-green-500 cursor-pointer hover:shadow-xl transition transform hover:-translate-y-1">
                <div class="flex items-center gap-4 mb-3">
                    <div class="bg-green-100 p-3 rounded-full">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-green-600"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="12" y1="8" x2="12" y2="16"></line><line x1="8" y1="12" x2="16" y2="12"></line></svg>
                    </div>
                    <h2 class="text-xl font-bold text-gray-800">Crear Casos</h2>
                </div>
                <p class="text-sm text-gray-600">Dise√±a nuevas simulaciones para "La Merca".</p>
            </div>

            <!-- Mis Juegos -->
            <div onclick="navigateTo('mis_juegos.html')" class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-blue-500 cursor-pointer hover:shadow-xl transition transform hover:-translate-y-1">
                <div class="flex items-center gap-4 mb-3">
                    <div class="bg-blue-100 p-3 rounded-full">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-600"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>
                    </div>
                    <h2 class="text-xl font-bold text-gray-800">Mis Juegos</h2>
                </div>
                <p class="text-sm text-gray-600">Gestiona tus juegos creados.</p>
            </div>

            <!-- Ver Ranking -->
            <div onclick="viewRanking()" class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-yellow-500 cursor-pointer hover:shadow-xl transition transform hover:-translate-y-1">
                <div class="flex items-center gap-4 mb-3">
                    <div class="bg-yellow-100 p-3 rounded-full">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-yellow-600"><circle cx="12" cy="8" r="7"></circle><polyline points="8.21 13.89 7 22 17 22 15.79 13.89"></polyline></svg>
                    </div>
                    <h2 class="text-xl font-bold text-gray-800">Ranking</h2>
                </div>
                <p class="text-sm text-gray-600">Consulta la tabla de posiciones.</p>
            </div>

            <!-- Editor de Planes -->
            <div onclick="navigateTo('editor_planes.html')" class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-purple-500 cursor-pointer hover:shadow-xl transition transform hover:-translate-y-1">
                <div class="flex items-center gap-4 mb-3">
                    <div class="bg-purple-100 p-3 rounded-full">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-purple-600"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                    </div>
                    <h2 class="text-xl font-bold text-gray-800">Planes de Estudio</h2>
                </div>
                <p class="text-sm text-gray-600">Personaliza contenido educativo.</p>
            </div>

            <!-- Gestor de Documentos -->
            <div onclick="navigateTo('editor_documentos.html')" class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-cyan-500 cursor-pointer hover:shadow-xl transition transform hover:-translate-y-1">
                <div class="flex items-center gap-4 mb-3">
                    <div class="bg-cyan-100 p-3 rounded-full">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-cyan-600"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>
                    </div>
                    <h2 class="text-xl font-bold text-gray-800">Documentos</h2>
                </div>
                <p class="text-sm text-gray-600">Sube y comparte archivos.</p>
            </div>

            <!-- Creador de Juegos -->
            <div onclick="navigateTo('creador_juegos.html')" class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-rose-500 cursor-pointer hover:shadow-xl transition transform hover:-translate-y-1">
                <div class="flex items-center gap-4 mb-3">
                    <div class="bg-rose-100 p-3 rounded-full">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-rose-600"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path></svg>
                    </div>
                    <h2 class="text-xl font-bold text-gray-800">Creador ADUGAME</h2>
                </div>
                <p class="text-sm text-gray-600">Crea actividades personalizadas.</p>
            </div>

            <!-- NUEVA TARJETA: Moderaci√≥n de AduPost -->
            <div onclick="navigateTo('adupost_moderation.html')" class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-indigo-500 cursor-pointer hover:shadow-xl transition transform hover:-translate-y-1">
                <div class="flex items-center gap-4 mb-3">
                    <div class="bg-indigo-100 p-3 rounded-full">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-indigo-600"><path d="M17 8h2a2 2 0 012 2v6a2 2 0 01-2 2h-2v4l-4-4H9a2 2 0 01-2-2V4a2 2 0 012-2h8a2 2 0 012 2v4z" /></svg>
                    </div>
                    <h2 class="text-xl font-bold text-gray-800">Moderar AduPost</h2>
                </div>
                <p class="text-sm text-gray-600">Revisa, premia y gestiona las publicaciones de la comunidad.</p>
            </div>
        </div>
    </main>

    <!-- Bot√≥n Flotante Yarvis -->
    <button id="open-yarvis-btn" onclick="toggleYarvis()" class="fixed bottom-6 right-6 bg-indigo-600 text-white w-16 h-16 rounded-full shadow-lg flex items-center justify-center transform hover:scale-110 transition-transform z-30">
        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3c7.2 0 9 1.8 9 9s-1.8 9-9 9-9-1.8-9-9 1.8-9 9-9z"></path><circle cx="12" cy="12" r="6"></circle></svg>
    </button>

    <!-- Modal Yarvis Mejorado -->
    <div id="yarvis-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-40 flex items-end justify-center sm:items-center">
        <div class="bg-white w-full max-w-4xl h-[85vh] rounded-t-2xl sm:rounded-2xl shadow-2xl flex transform transition-all duration-300 scale-95 opacity-0">
            
            <!-- Panel Lateral de Contexto -->
            <div id="context-sidebar" class="w-64 bg-gray-50 border-r p-4 overflow-y-auto hidden lg:block">
                <h3 class="font-bold text-gray-700 mb-3">Estado Actual</h3>
                
                <div class="context-panel mb-4">
                    <h4 class="text-sm font-semibold mb-2">üéØ Tareas Activas</h4>
                    <div id="active-tasks-list"></div>
                </div>
                
                <div class="context-panel mb-4">
                    <h4 class="text-sm font-semibold mb-2">üìä Resumen del D√≠a</h4>
                    <div id="daily-summary"></div>
                </div>
                
                <div class="context-panel">
                    <h4 class="text-sm font-semibold mb-2">üí° Sugerencias</h4>
                    <div id="proactive-suggestions"></div>
                </div>
            </div>
            
            <!-- √Årea Principal del Chat -->
            <div class="flex-grow flex flex-col">
                <!-- Header -->
                <div class="flex justify-between items-center p-4 border-b bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-t-2xl">
                    <div class="flex items-center gap-3">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 3c7.2 0 9 1.8 9 9s-1.8 9-9 9-9-1.8-9-9 1.8-9 9-9z"></path><circle cx="12" cy="12" r="6"></circle></svg>
                        <div>
                            <h3 class="text-lg font-bold">Yarvis - Tu Asistente Ejecutivo</h3>
                            <p class="text-xs opacity-90">Siempre listo para ayudarte</p>
                        </div>
                    </div>
                    <button onclick="toggleYarvis()" class="hover:bg-white hover:bg-opacity-20 rounded-full p-2 transition">&times;</button>
                </div>
                
                <!-- Comandos R√°pidos -->
                <div class="p-3 bg-indigo-50 border-b overflow-x-auto">
                    <div class="flex gap-2 flex-nowrap">
                        <span class="quick-command" onclick="sendQuickCommand('/crear')">‚ûï Crear</span>
                        <span class="quick-command" onclick="sendQuickCommand('/stats')">üìä Stats</span>
                        <span class="quick-command" onclick="sendQuickCommand('/revisar')">üëÄ Revisar</span>
                        <span class="quick-command" onclick="sendQuickCommand('/ranking')">üèÜ Ranking</span>
                        <span class="quick-command" onclick="sendQuickCommand('/ideas')">üí° Ideas</span>
                    </div>
                </div>
                
                <!-- Chat Window -->
                <div id="yarvis-chat-window" class="flex-grow p-4 space-y-4 overflow-y-auto bg-gray-50">
                    <!-- Mensajes aqu√≠ -->
                </div>
                
                <!-- Input -->
                <div class="p-4 border-t bg-white">
                    <div class="flex items-center gap-2">
                        <input type="text" id="yarvis-input" placeholder="Escribe un mensaje o usa /comando..." class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                        <button id="yarvis-send-btn" class="bg-indigo-600 text-white p-3 rounded-lg hover:bg-indigo-700 transition">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // --- IMPORTS ---
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-app.js";
        import { getDatabase, ref, get, set, update, push, query, orderByChild, limitToLast } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-database.js";
import { firebaseConfig } from "./config.js";
import { callAduiaApi } from "./keyhandler.js";
        // import { YarvisAssistant } from "./yarvis-improved.js"; // This is now inline
        import { initGuide, advanceGuide, endGuide, updateGuideMessage } from './yarvis_guide.js';

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// ============================================
// SISTEMA DE HERRAMIENTAS MEJORADO
// ============================================

class YarvisTools {
    constructor(database, professorName) {
        this.db = database;
        this.professorName = professorName;
    }

    // Obtener datos reales de Firebase
    async getStats() {
        try {
            const [gamesSnap, casesSnap, studentsSnap] = await Promise.all([
                get(ref(this.db, 'custom_games')),
                get(ref(this.db, 'casos_estudio')),
                get(ref(this.db, 'usuarios'))
            ]);

            const games = gamesSnap.exists() ? Object.values(gamesSnap.val()) : [];
            const cases = casesSnap.exists() ? Object.values(casesSnap.val()) : [];
            const students = studentsSnap.exists() ? Object.values(studentsSnap.val()) : [];

            const myGames = games.filter(g => g.createdBy === this.professorName).length;
            const totalGames = games.length;
            const totalCases = cases.length;
            
            const activeStudents = students.filter(s => {
                const lastActive = s.lastActive || 0;
                const weekAgo = Date.now() - (7 * 24 * 60 * 60 * 1000);
                return lastActive > weekAgo;
            }).length;

            const avgScore = students.length > 0
                ? Math.round(students.reduce((sum, s) => sum + (s.puntaje || 0), 0) / students.length)
                : 0;

            return {
                totalGames,
                myGames,
                totalCases,
                activeStudents,
                totalStudents: students.length,
                avgScore
            };
        } catch (error) {
            console.error('Error obteniendo stats:', error);
            return null;
        }
    }

    async getRanking(limit = 5) {
        try {
            const usersQuery = query(ref(this.db, 'usuarios'), orderByChild('puntaje'), limitToLast(limit));
            const snapshot = await get(usersQuery);
            
            if (!snapshot.exists()) return [];

            const ranking = [];
            snapshot.forEach(child => {
                ranking.push({
                    nombre: child.val().nombre || 'Usuario',
                    puntaje: child.val().puntaje || 0,
                    nivel: child.val().nivel || 1
                });
            });

            return ranking.reverse(); // Ordenar descendente
        } catch (error) {
            console.error('Error obteniendo ranking:', error);
            return [];
        }
    }

    async getMyGames() {
        try {
            const snapshot = await get(ref(this.db, 'custom_games'));
            if (!snapshot.exists()) return [];

            const allGames = Object.entries(snapshot.val());
            const myGames = allGames
                .filter(([_, game]) => game.createdBy === this.professorName)
                .map(([id, game]) => ({
                    id,
                    titulo: game.title || game.nombre || 'Sin t√≠tulo',
                    tipo: game.gameType || game.tipo || 'general',
                    fecha: game.createdAt || Date.now(),
                    jugadas: game.timesPlayed || 0
                }));

            return myGames;
        } catch (error) {
            console.error('Error obteniendo juegos:', error);
            return [];
        }
    }

    async getRecentActivity() {
        try {
            const studentsSnap = await get(ref(this.db, 'usuarios'));
            if (!studentsSnap.exists()) return [];

            const students = Object.values(studentsSnap.val());
            const inactive = students.filter(s => {
                const lastActive = s.lastActive || 0;
                const twoWeeksAgo = Date.now() - (14 * 24 * 60 * 60 * 1000);
                return lastActive < twoWeeksAgo;
            });

            return inactive.map(s => ({
                nombre: s.nombre || 'Usuario',
                ultimaActividad: s.lastActive ? new Date(s.lastActive).toLocaleDateString() : 'Nunca',
                puntaje: s.puntaje || 0
            }));
        } catch (error) {
            console.error('Error obteniendo actividad:', error);
            return [];
        }
    }

    async getPendingReviews() {
        try {
            const [gamesSnap, casesSnap] = await Promise.all([
                get(ref(this.db, 'custom_games')),
                get(ref(this.db, 'casos_estudio'))
            ]);

            const pending = [];

            if (gamesSnap.exists()) {
                const games = Object.entries(gamesSnap.val());
                games.forEach(([id, game]) => {
                    if (game.status === 'pending' || game.needsReview) {
                        pending.push({
                            tipo: 'juego',
                            titulo: game.title || 'Sin t√≠tulo',
                            creador: game.createdBy || 'Desconocido',
                            fecha: game.createdAt
                        });
                    }
                });
            }

            return pending;
        } catch (error) {
            console.error('Error obteniendo pendientes:', error);
            return [];
        }
    }
}

// ============================================
// ASISTENTE YARVIS CON IA MEJORADA
// ============================================

class YarvisAssistant {
    constructor(professorName) {
        this.professorName = professorName;
        this.tools = new YarvisTools(db, professorName);
        this.conversationHistory = [];
        this.isProcessing = false;
        
        this.initializeSystemPrompt();
    }

    initializeSystemPrompt() {
        this.conversationHistory = [{
            role: 'system',
            content: `Eres Yarvis, un asistente ejecutivo de IA para profesores de comercio exterior en la plataforma ADUWEB.

PERSONALIDAD Y ESTILO:
- Profesional pero amigable y cercano
- Respuestas concisas y directas (2-3 oraciones m√°ximo cuando sea posible)
- Proactivo: sugiere acciones cuando sea relevante
- IMPORTANTE: NUNCA uses asteriscos (*) para enfatizar. Usa may√∫sculas solo cuando sea necesario
- IMPORTANTE: NUNCA uses formato markdown. Escribe en texto plano conversacional
- Usa emojis ocasionalmente para dar personalidad (üéØ, üìä, üéÆ, ‚úÖ, etc.)

CAPACIDADES:
Puedes ayudar con:
1. Ver estad√≠sticas del panel
2. Consultar ranking de estudiantes
3. Revisar juegos creados
4. Ver estudiantes con baja actividad
5. Navegar a secciones espec√≠ficas
6. Generar ideas de contenido

FORMATO DE RESPUESTA:
- Responde siempre en espa√±ol
- S√© breve y al punto
- Si muestras datos, hazlo en formato legible pero NO uses markdown
- Ofrece acciones concretas cuando sea relevante

El profesor se llama: ${this.professorName}

Cuando el usuario pregunte por estad√≠sticas, ranking, juegos, etc., responde que vas a consultar la informaci√≥n y luego llama a la funci√≥n correspondiente.`
        }];
    }

    // Definir herramientas disponibles para la IA
    getToolDefinitions() {
        return [
            {
                type: 'function',
                function: {
                    name: 'obtener_estadisticas',
                    description: 'Obtiene estad√≠sticas completas del panel: juegos creados, casos, estudiantes activos, etc.',
                    parameters: { type: 'object', properties: {} }
                }
            },
            {
                type: 'function',
                function: {
                    name: 'obtener_ranking',
                    description: 'Obtiene el ranking de los mejores estudiantes por puntaje',
                    parameters: {
                        type: 'object',
                        properties: {
                            limite: {
                                type: 'number',
                                description: 'N√∫mero de estudiantes a mostrar (por defecto 5)'
                            }
                        }
                    }
                }
            },
            {
                type: 'function',
                function: {
                    name: 'obtener_mis_juegos',
                    description: 'Lista todos los juegos creados por el profesor',
                    parameters: { type: 'object', properties: {} }
                }
            },
            {
                type: 'function',
                function: {
                    name: 'obtener_estudiantes_inactivos',
                    description: 'Lista estudiantes que no han tenido actividad reciente',
                    parameters: { type: 'object', properties: {} }
                }
            },
            {
                type: 'function',
                function: {
                    name: 'obtener_pendientes',
                    description: 'Lista elementos pendientes de revisi√≥n o aprobaci√≥n',
                    parameters: { type: 'object', properties: {} }
                }
            },
            {
                type: 'function',
                function: {
                    name: 'navegar_a',
                    description: 'Navega a una secci√≥n espec√≠fica del panel',
                    parameters: {
                        type: 'object',
                        properties: {
                            pagina: {
                                type: 'string',
                                enum: ['generador_casos.html', 'mis_juegos.html', 'editor_planes.html', 'editor_documentos.html', 'creador_juegos.html', 'adupost_moderation.html'],
                                description: 'La p√°gina a la que navegar'
                            }
                        },
                        required: ['pagina']
                    }
                }
            },
            {
                type: 'function',
                function: {
                    name: 'generar_ideas',
                    description: 'Genera ideas creativas para contenido educativo basado en un tema',
                    parameters: {
                        type: 'object',
                        properties: {
                            tema: {
                                type: 'string',
                                description: 'El tema sobre el que generar ideas (ej: Incoterms, Valoraci√≥n Aduanera)'
                            }
                        }
                    }
                }
            }
        ];
    }

    // Ejecutar herramientas
    async executeTool(toolName, args = {}) {
        switch (toolName) {
            case 'obtener_estadisticas':
                return await this.tools.getStats();
            
            case 'obtener_ranking':
                return await this.tools.getRanking(args.limite || 5);
            
            case 'obtener_mis_juegos':
                return await this.tools.getMyGames();
            
            case 'obtener_estudiantes_inactivos':
                return await this.tools.getRecentActivity();
            
            case 'obtener_pendientes':
                return await this.tools.getPendingReviews();
            
            case 'navegar_a':
                return { action: 'navigate', page: args.pagina };
            
            case 'generar_ideas':
                return this.generateIdeas(args.tema);
            
            default:
                return { error: 'Herramienta no encontrada' };
        }
    }

    generateIdeas(tema = 'comercio exterior') {
        const ideas = {
            'incoterms': [
                'Quiz interactivo: Identifica el Incoterm correcto para cada situaci√≥n',
                'Caso pr√°ctico: Negociaci√≥n de t√©rminos entre exportador e importador',
                'Simulaci√≥n: Calcula costos seg√∫n diferentes Incoterms',
                'Juego de roles: Distribuir responsabilidades en una operaci√≥n FOB vs CIF'
            ],
            'valoracion': [
                'Ejercicio: C√°lculo de valor en aduana paso a paso',
                'Caso de estudio: Ajustes al valor de transacci√≥n',
                'Quiz: M√©todos de valoraci√≥n aduanera',
                'Simulaci√≥n: Determinar el m√©todo de valoraci√≥n correcto'
            ],
            'logistica': [
                'Planificaci√≥n de ruta: Optimizar una cadena log√≠stica internacional',
                'Caso: Selecci√≥n del modo de transporte adecuado',
                'Simulaci√≥n: Gesti√≥n de documentaci√≥n de exportaci√≥n',
                'Quiz: Documentos necesarios seg√∫n Incoterm'
            ],
            'default': [
                'Caso pr√°ctico: Exportaci√≥n de productos locales',
                'Quiz de conocimientos generales de comercio exterior',
                'Simulaci√≥n: Proceso completo de importaci√≥n',
                'Juego: Negociaci√≥n internacional de contratos'
            ]
        };

        const temaKey = tema.toLowerCase().includes('incoterm') ? 'incoterms'
            : tema.toLowerCase().includes('valor') ? 'valoracion'
            : tema.toLowerCase().includes('logist') ? 'logistica'
            : 'default';

        return ideas[temaKey];
    }

    // Procesar mensaje del usuario
    async processMessage(userMessage) {
        if (this.isProcessing) {
            return { error: 'Ya hay un mensaje proces√°ndose' };
        }

        this.isProcessing = true;

        try {
            // Agregar mensaje del usuario al historial
            this.conversationHistory.push({
                role: 'user',
                content: userMessage
            });

            // Preparar payload para la API
            const payload = {
                model: 'gpt-4-turbo-preview',
                messages: this.conversationHistory,
                tools: this.getToolDefinitions(),
                tool_choice: 'auto',
                temperature: 0.7,
                max_tokens: 500
            };

            // Llamar a la API
            const response = await callAduiaApi(payload);
            const assistantMessage = response.choices[0].message;

            // Verificar si la IA quiere usar herramientas
            if (assistantMessage.tool_calls && assistantMessage.tool_calls.length > 0) {
                // Agregar respuesta de la IA al historial
                this.conversationHistory.push({
                    role: 'assistant',
                    content: assistantMessage.content,
                    tool_calls: assistantMessage.tool_calls
                });

                // Ejecutar todas las herramientas solicitadas
                const toolResults = [];
                for (const toolCall of assistantMessage.tool_calls) {
                    const functionName = toolCall.function.name;
                    const functionArgs = JSON.parse(toolCall.function.arguments);
                    
                    const result = await this.executeTool(functionName, functionArgs);
                    
                    toolResults.push({
                        tool_call_id: toolCall.id,
                        role: 'tool',
                        name: functionName,
                        content: JSON.stringify(result)
                    });
                }

                // Agregar resultados al historial
                this.conversationHistory.push(...toolResults);

                // Obtener respuesta final de la IA con los datos
                const finalPayload = {
                    model: 'gpt-4-turbo-preview',
                    messages: this.conversationHistory,
                    temperature: 0.7,
                    max_tokens: 500
                };

                const finalResponse = await callAduiaApi(finalPayload);
                const finalMessage = finalResponse.choices[0].message;

                this.conversationHistory.push({
                    role: 'assistant',
                    content: finalMessage.content
                });

                // Verificar si hay una acci√≥n de navegaci√≥n
                const navigationResult = toolResults.find(r => {
                    const content = JSON.parse(r.content);
                    return content.action === 'navigate';
                });

                this.isProcessing = false;

                return {
                    message: finalMessage.content,
                    data: toolResults.map(r => JSON.parse(r.content)),
                    navigation: navigationResult ? JSON.parse(navigationResult.content) : null
                };
            } else {
                // Respuesta directa sin herramientas
                this.conversationHistory.push({
                    role: 'assistant',
                    content: assistantMessage.content
                });

                this.isProcessing = false;

                return {
                    message: assistantMessage.content,
                    data: null,
                    navigation: null
                };
            }
        } catch (error) {
            console.error('Error procesando mensaje:', error);
            this.isProcessing = false;
            
            return {
                message: 'Disculpa, tuve un problema al procesar tu solicitud. Por favor intenta de nuevo.',
                error: error.message
            };
        }
    }

    // Limpiar historial (mantener solo el system prompt)
    clearHistory() {
        this.initializeSystemPrompt();
    }

    // Obtener saludo inicial
    async getGreeting() {
        const stats = await this.tools.getStats();
        const pendientes = await this.tools.getPendingReviews();

        let greeting = `Hola ${this.professorName}! üëã `;

        if (stats) {
            greeting += `Tienes ${stats.myGames} juegos creados y ${stats.activeStudents} estudiantes activos. `;
        }

        if (pendientes && pendientes.length > 0) {
            greeting += `Hay ${pendientes.length} elementos pendientes de revisi√≥n. `;
        } else {
            greeting += `Todo est√° al d√≠a! `;
        }

        greeting += `¬øEn qu√© puedo ayudarte hoy?`;

        return greeting;
    }
}

// Exportar para uso global
export { YarvisAssistant };
 class YarvisChatUI {
        constructor(containerId) {
            this.container = document.getElementById(containerId);
            this.isOpen = false;
        }

        addMessage(text, type = 'ia') {
            const wrapper = document.createElement('div');
            wrapper.className = `flex mb-3 ${type === 'user' ? 'justify-end' : 'justify-start'}`;
            
            const bubble = document.createElement('div');
            bubble.className = `yarvis-bubble p-3 rounded-lg max-w-[80%] ${type}`;
            bubble.textContent = text;
            
            wrapper.appendChild(bubble);
            this.container.appendChild(wrapper);
            this.scrollToBottom();
        }

        addStatsCard(stats) {
            const wrapper = document.createElement('div');
            wrapper.className = 'flex justify-start mb-3 w-full';
            
            const card = document.createElement('div');
            card.className = 'preview-card w-full max-w-md';
            card.innerHTML = `
                <h4>üìä Estad√≠sticas del Panel</h4>
                <div class="grid grid-cols-2 gap-3 mt-3">
                    <div class="text-center p-3 bg-indigo-50 rounded-lg">
                        <p class="text-2xl font-bold text-indigo-600">${stats.myGames}</p>
                        <p class="text-xs text-gray-600">Mis Juegos</p>
                    </div>
                    <div class="text-center p-3 bg-green-50 rounded-lg">
                        <p class="text-2xl font-bold text-green-600">${stats.totalCases}</p>
                        <p class="text-xs text-gray-600">Casos Creados</p>
                    </div>
                    <div class="text-center p-3 bg-blue-50 rounded-lg">
                        <p class="text-2xl font-bold text-blue-600">${stats.activeStudents}</p>
                        <p class="text-xs text-gray-600">Activos</p>
                    </div>
                    <div class="text-center p-3 bg-yellow-50 rounded-lg">
                        <p class="text-2xl font-bold text-yellow-600">${stats.avgScore}</p>
                        <p class="text-xs text-gray-600">Promedio</p>
                    </div>
                </div>
            `;
            
            wrapper.appendChild(card);
            this.container.appendChild(wrapper);
            this.scrollToBottom();
        }

        addRankingCard(ranking) {
            const wrapper = document.createElement('div');
            wrapper.className = 'flex justify-start mb-3 w-full';
            
            const card = document.createElement('div');
            card.className = 'preview-card w-full max-w-md';
            
            const medals = ['ü•á', 'ü•à', 'ü•â'];
            
            card.innerHTML = `
                <h4>üèÜ Top ${ranking.length} Estudiantes</h4>
                <div class="mt-3 space-y-2">
                    ${ranking.map((student, idx) => `
                        <div class="flex justify-between items-center p-2 bg-gray-50 rounded hover:bg-gray-100 transition">
                            <div class="flex items-center gap-2">
                                <span class="text-lg">${medals[idx] || (idx + 1)}</span>
                                <span class="font-medium">${student.nombre}</span>
                            </div>
                            <span class="stat-badge">${student.puntaje} pts</span>
                        </div>
                    `).join('')}
                </div>
            `;
            
            wrapper.appendChild(card);
            this.container.appendChild(wrapper);
            this.scrollToBottom();
        }

        addGamesCard(games) {
            const wrapper = document.createElement('div');
            wrapper.className = 'flex justify-start mb-3 w-full';
            
            const card = document.createElement('div');
            card.className = 'preview-card w-full max-w-md';
            
            if (games.length === 0) {
                card.innerHTML = `
                    <h4>üéÆ Mis Juegos</h4>
                    <p class="text-gray-500 text-sm mt-2">A√∫n no has creado juegos.</p>
                    <button class="yarvis-action-btn mt-3 w-full" onclick="navigateTo('creador_juegos.html')">
                        Crear Mi Primer Juego
                    </button>
                `;
            } else {
                card.innerHTML = `
                    <h4>üéÆ Mis Juegos (${games.length})</h4>
                    <div class="mt-3 space-y-2">
                        ${games.slice(0, 5).map(game => `
                            <div class="p-2 bg-gray-50 rounded hover:bg-gray-100 transition">
                                <p class="font-medium text-sm">${game.titulo}</p>
                                <div class="flex gap-2 mt-1">
                                    <span class="text-xs text-gray-500">Tipo: ${game.tipo}</span>
                                    <span class="text-xs text-gray-500">‚Ä¢ ${game.jugadas} jugadas</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    ${games.length > 5 ? `<p class="text-xs text-gray-500 mt-2">Y ${games.length - 5} juegos m√°s...</p>` : ''}
                    <button class="yarvis-action-btn mt-3 w-full" onclick="navigateTo('mis_juegos.html')">
                        Ver Todos Mis Juegos
                    </button>
                `;
            }
            
            wrapper.appendChild(card);
            this.container.appendChild(wrapper);
            this.scrollToBottom();
        }

        addInactiveStudentsCard(students) {
            const wrapper = document.createElement('div');
            wrapper.className = 'flex justify-start mb-3 w-full';
            
            const card = document.createElement('div');
            card.className = 'preview-card w-full max-w-md';
            
            if (students.length === 0) {
                card.innerHTML = `
                    <h4>‚úÖ Estudiantes Activos</h4>
                    <p class="text-green-600 text-sm mt-2">Todos tus estudiantes est√°n activos. ¬°Excelente!</p>
                `;
            } else {
                card.innerHTML = `
                    <h4>‚ö†Ô∏è Estudiantes Inactivos (${students.length})</h4>
                    <p class="text-sm text-gray-600 mb-2">Considera enviarles un recordatorio:</p>
                    <div class="mt-3 space-y-2 max-h-48 overflow-y-auto">
                        ${students.slice(0, 10).map(student => `
                            <div class="p-2 bg-yellow-50 rounded border-l-2 border-yellow-400">
                                <p class="font-medium text-sm">${student.nombre}</p>
                                <p class="text-xs text-gray-500">√öltima actividad: ${student.ultimaActividad}</p>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            wrapper.appendChild(card);
            this.container.appendChild(wrapper);
            this.scrollToBottom();
        }

        addIdeasCard(ideas) {
            const wrapper = document.createElement('div');
            wrapper.className = 'flex justify-start mb-3 w-full';
            
            const card = document.createElement('div');
            card.className = 'preview-card w-full max-w-md';
            card.innerHTML = `
                <h4>üí° Ideas de Contenido</h4>
                <div class="mt-3 space-y-2">
                    ${ideas.map((idea, idx) => `
                        <div class="p-3 bg-indigo-50 rounded-lg hover:bg-indigo-100 transition cursor-pointer"
                             onclick="handleIdeaClick('${idea.replace(/'/g, "\\'")}')">
                            <p class="text-sm font-medium">${idx + 1}. ${idea}</p>
                        </div>
                    `).join('')}
                </div>
            `;
            
            wrapper.appendChild(card);
            this.container.appendChild(wrapper);
            this.scrollToBottom();
        }

        showTypingIndicator() {
            const wrapper = document.createElement('div');
            wrapper.className = 'typing-indicator-wrapper flex justify-start mb-3';
            wrapper.innerHTML = `
                <div class="typing-indicator bg-gray-200 rounded-lg">
                    <span></span><span></span><span></span>
                </div>
            `;
            this.container.appendChild(wrapper);
            this.scrollToBottom();
        }

        hideTypingIndicator() {
            const indicator = this.container.querySelector('.typing-indicator-wrapper');
            if (indicator) indicator.remove();
        }

        scrollToBottom() {
            this.container.scrollTop = this.container.scrollHeight;
        }

        clear() {
            this.container.innerHTML = '';
        }
    }

    async function sendMessage() {
        const input = document.getElementById('yarvis-input');
        const message = input.value.trim();
        
        if (!message || !yarvis) return;

        // Agregar mensaje del usuario
        chatUI.addMessage(message, 'user');
        input.value = '';

        // Mostrar indicador de escritura
        chatUI.showTypingIndicator();

        try {
            // Procesar mensaje
            const response = await yarvis.processMessage(message);

            // Ocultar indicador
            chatUI.hideTypingIndicator();

            // Verificar si hay error
            if (response.error) {
                chatUI.addMessage(response.message || 'Hubo un error al procesar tu solicitud.', 'ia');
                return;
            }

            // Mostrar respuesta de texto
            if (response.message) {
                chatUI.addMessage(response.message, 'ia');
            }

            // Mostrar datos visuales si existen
            if (response.data && Array.isArray(response.data)) {
                for (const dataItem of response.data) {
                    if (dataItem.totalGames !== undefined) {
                        // Es un objeto de estad√≠sticas
                        chatUI.addStatsCard(dataItem);
                    } else if (Array.isArray(dataItem) && dataItem[0]?.nombre) {
                        // Es un ranking
                        chatUI.addRankingCard(dataItem);
                    } else if (Array.isArray(dataItem) && dataItem[0]?.titulo) {
                        // Es una lista de juegos
                        chatUI.addGamesCard(dataItem);
                    } else if (Array.isArray(dataItem) && dataItem[0]?.ultimaActividad) {
                        // Es lista de estudiantes inactivos
                        chatUI.addInactiveStudentsCard(dataItem);
                    } else if (Array.isArray(dataItem) && typeof dataItem[0] === 'string') {
                        // Es una lista de ideas
                        chatUI.addIdeasCard(dataItem);
                    }
                }
            }

            // Manejar navegaci√≥n
            if (response.navigation) {
                setTimeout(() => {
                    navigateTo(response.navigation.page);
                }, 1500);
            }

        } catch (error) {
            chatUI.hideTypingIndicator();
            console.error('Error en sendMessage:', error);
            chatUI.addMessage('Disculpa, tuve un problema. Intenta de nuevo.', 'ia');
        }
    }

    function sendQuickCommand(command) {
        const input = document.getElementById('yarvis-input');
        input.value = command;
        sendMessage();
    }

    function toggleYarvis() {
        const modal = document.getElementById('yarvis-modal');
        const modalContent = modal.querySelector('div');
        
        if (modal.classList.contains('hidden')) {
            modal.classList.remove('hidden');
            setTimeout(() => {
                modalContent.classList.remove('scale-95', 'opacity-0');
            }, 10);
            playSound('soundClick');
        } else {
            modalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }
    }

    function viewRanking() {
        playSound('soundClick');
        if (yarvis) {
            toggleYarvis();
            setTimeout(() => {
                const input = document.getElementById('yarvis-input');
                input.value = 'mu√©strame el ranking completo';
                sendMessage();
            }, 500);
        }
    }

    // Manejador para clicks en ideas
    window.handleIdeaClick = function(idea) {
        chatUI.addMessage(`Me interesa: ${idea}`, 'user');
        chatUI.showTypingIndicator();
        
        setTimeout(async () => {
            chatUI.hideTypingIndicator();
            chatUI.addMessage('Perfecto! Te llevar√© al creador de contenido para que desarrolles esta idea.', 'ia');
            
            setTimeout(() => {
                navigateTo('creador_juegos.html');
            }, 1500);
        }, 1000);
    };

    // ============================================
    // COMANDOS R√ÅPIDOS MEJORADOS
    // ============================================

    const quickCommands = {
        '/crear': 'Quiero crear contenido nuevo',
        '/stats': 'Mu√©strame las estad√≠sticas del panel',
        '/ranking': 'Mu√©strame el ranking de estudiantes',
        '/juegos': 'Mu√©strame mis juegos creados',
        '/revisar': 'Qu√© tengo pendiente de revisar',
        '/inactivos': 'Mu√©strame estudiantes con baja actividad',
        '/ideas': 'Dame ideas de contenido educativo',
        '/help': 'Qu√© puedes hacer por m√≠'
    };

    function handleQuickCommand(cmd) {
        const command = quickCommands[cmd];
        if (command) {
            const input = document.getElementById('yarvis-input');
            input.value = command;
            sendMessage();
        }
    }

    document.addEventListener('DOMContentLoaded', async () => {
        // Animaci√≥n de bienvenida
        initWelcomeAnimation();

        // Inicializar Yarvis
        await initYarvis();

        // Event listeners
        const sendBtn = document.getElementById('yarvis-send-btn');
        const input = document.getElementById('yarvis-input');

        if (sendBtn) {
            sendBtn.addEventListener('click', sendMessage);
        }

        if (input) {
            input.addEventListener('keyup', (e) => {
                if (e.key === 'Enter') sendMessage();
            });

            // Autocompletado de comandos
            input.addEventListener('input', (e) => {
                const value = e.target.value;
                if (value.startsWith('/')) {
                    const matchingCommands = Object.keys(quickCommands)
                        .filter(cmd => cmd.startsWith(value));
                    
                    if (matchingCommands.length === 1) {
                        // Mostrar sugerencia (puedes mejorar esto con un dropdown)
                        input.setAttribute('placeholder', matchingCommands[0]);
                    }
                } else {
                    input.setAttribute('placeholder', 'Escribe un mensaje o usa /comando...');
                }
            });
        }

        // Comandos r√°pidos en la UI
        document.querySelectorAll('.quick-command').forEach(btn => {
            btn.addEventListener('click', function() {
                const command = this.textContent.trim();
                
                const commandMap = {
                    '‚ûï Crear': '/crear',
                    'üìä Stats': '/stats',
                    'üëÄ Revisar': '/revisar',
                    'üèÜ Ranking': '/ranking',
                    'üí° Ideas': '/ideas'
                };

                const cmd = commandMap[command];
                if (cmd) {
                    handleQuickCommand(cmd);
                }
            });
        });
    });

    // Exponer funciones globales
    window.toggleYarvis = toggleYarvis;
    window.sendQuickCommand = sendQuickCommand;
    window.navigateTo = navigateTo;
    window.logout = logout;
    window.viewRanking = viewRanking;
    </script>
</body>
</html>
