<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ADUCHAT - Juego Incoterms</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Animaciones */
    @keyframes fadeIn { from { opacity: 0; transform: translateY(18px);} to { opacity: 1; transform: translateY(0);} }
    .animate-fade-in { animation: fadeIn .45s ease-out; }

    @keyframes bounceY { 0%,100% { transform: translateY(0);} 50% { transform: translateY(-6px);} }
    .animate-bounce-y { animation: bounceY 1s infinite alternate; }

    /* Logo circle */
    .logo-circle { width:48px; height:48px; border-radius:12px; display:inline-flex; align-items:center; justify-content:center; background:linear-gradient(135deg,#10b981,#047857); box-shadow:0 8px 20px rgba(4, 120, 87, .12); }
  </style>
</head>
<body class="bg-green-50 min-h-screen flex items-center justify-center p-4 font-sans">

  <div class="w-full max-w-3xl">

    <header class="flex items-center justify-between bg-white rounded-2xl p-4 shadow-md mb-6">
      <div class="flex items-center gap-3">
        <div class="logo-circle animate-bounce-y text-white">
          <svg width="26" height="26" viewBox="0 0 24 24" fill="none" aria-hidden>
            <path d="M2 12a10 10 0 1118.365 6.27L22 22l-3.73-0.88A10 10 0 012 12z" fill="white" opacity="0.06"/>
            <path d="M7 10a1 1 0 100 2h6a1 1 0 100-2H7z" fill="white"/>
            <text x="6.6" y="19" font-size="9" fill="white" font-weight="700">A</text>
          </svg>
        </div>
        <div>
          <h1 class="text-lg font-extrabold text-green-800">ADU<span class="text-green-600">CHAT</span></h1>
          <p class="text-xs text-gray-500">Juego educativo ¬∑ Incoterms</p>
        </div>
      </div>

      <div class="text-right">
        <span class="inline-block bg-yellow-300 text-gray-800 px-3 py-1 rounded-full text-xs font-semibold shadow-sm">BETA</span>
      </div>
    </header>

    <div id="card" class="bg-white rounded-3xl shadow-2xl p-6 animate-fade-in">

      <div id="nameDisplay" class="mb-4 p-3 rounded-xl bg-green-50 border border-green-200 text-green-700">
        Cargando nombre...
      </div>

      <div id="gameContent" class="hidden">
        <h2 class="text-lg font-bold text-green-700 mb-2">Selecciona la modalidad</h2>
        <p class="text-sm text-gray-600 mb-4">Elige c√≥mo quieres practicar Incoterms</p>
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 mb-6">
          <button class="mode-btn p-3 rounded-xl bg-white border hover:shadow-md" onclick="openCustom()">
            üéØ <span class="block font-semibold mt-1">Un Incoterm</span>
          </button>
          <button class="mode-btn p-3 rounded-xl bg-white border hover:shadow-md" onclick="openRandom()">
            üé≤ <span class="block font-semibold mt-1">Aleatorio</span>
          </button>
          <button class="mode-btn p-3 rounded-xl bg-white border hover:shadow-md" onclick="openFull()">
            üèÜ <span class="block font-semibold mt-1">Quiz completo</span>
          </button>
        </div>

        <div id="randomOptions" class="hidden mb-4">
          <label class="block text-sm text-gray-700 mb-1">¬øCu√°ntos Incoterms jugar?</label>
          <input id="randomQty" type="number" min="1" max="11" value="4" class="w-28 p-2 border rounded-lg" />
          <button class="ml-3 bg-green-500 text-white px-3 rounded-xl" onclick="startRandomMode()">Iniciar</button>
        </div>
      </div>
      
      <div id="playArea" class="hidden mt-4">
        <div class="flex justify-between items-center mb-3">
          <h3 id="levelTitle" class="font-bold text-green-700">Incoterm</h3>
          <div class="text-right">
            <div id="timer" class="text-red-600 font-bold">90s</div>
            <div id="progress" class="text-sm text-gray-500">0/0 correctos</div>
          </div>
        </div>

        <div id="optionsGrid" class="grid grid-cols-2 gap-3 mb-4"></div>

        <div id="message" class="text-center text-gray-700 font-semibold mb-2"></div>

        <div class="flex gap-2 justify-center">
          <button id="nextBtn" class="hidden bg-green-600 text-white px-4 py-2 rounded-xl" onclick="nextLevel()">Siguiente nivel</button>
          <button id="quitBtn" class="bg-red-500 text-white px-4 py-2 rounded-xl" onclick="backToMainFromIcoterms()">Volver</button>
        </div>
      </div>

      <div id="resultsCard" class="hidden mt-6 p-4 bg-green-50 rounded-xl">
        <h3 class="font-bold text-green-800">Resultados finales</h3>
        <div id="resultsList" class="mt-3 text-sm text-gray-800"></div>
        <div class="mt-4 flex gap-2">
          <button class="flex-1 bg-white border rounded-xl py-2" onclick="restart()">üîÅ Nueva partida</button>
          <button class="flex-1 bg-green-600 text-white rounded-xl py-2" onclick="saveFinalResult()">üíæ Guardar resultado</button>
        </div>
        <div class="mt-3 text-xs text-gray-500">Puedes ver el ranking despu√©s de guardar.</div>
      </div>

      <div id="rankingMini" class="mt-6 hidden">
        <h4 class="font-semibold text-green-700">üèÜ Top 5</h4>
        <div id="rankingList" class="mt-2 text-sm text-gray-700"></div>
      </div>
      
      <div class="mt-6 text-center">
          <button class="bg-gray-300 text-gray-800 font-semibold px-4 py-2 rounded-lg hover:bg-gray-400 transition-colors" onclick="backToMainFromIcoterms()">
              üè† Volver al Dashboard Principal
          </button>
      </div>

    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import { getFirestore, collection, addDoc, query, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";
    // Eliminadas: getAuth, onAuthStateChanged, signOut

    // CONFIG - reemplaza si quieres con tu proyecto
    const firebaseConfig = {
      apiKey: "AIzaSyB_eUoNQ7L4hd42SVPqbA7vNYHxpEii9To",
      authDomain: "dino-4fbde.firebaseapp.com",
      projectId: "dino-4fbde",
      storageBucket: "dino-4fbde.firebasestorage.app",
      messagingSenderId: "307345167689",
      appId: "1:307345167689:web:f75e11b0c68a3def253698",
      measurementId: "G-LFDL5N5VW3"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    // Eliminada: const auth = getAuth(app);

    // Referencias DOM
    const nameDisplay = document.getElementById("nameDisplay");
    const gameContent = document.getElementById("gameContent");
    const rankingListEl = document.getElementById("rankingList");
    const rankingMini = document.getElementById("rankingMini");

    // Aseguramos que exista un objeto global player (el script del juego usar√° esto)
    window.player = window.player || { name: "" };

    // ------------------------------------------
    // üÜï L√ìGICA DE INICIALIZACI√ìN POR URL
    // ------------------------------------------

    // Funci√≥n para leer el nombre del par√°metro 'name' en la URL
    function getPlayerNameFromUrl() {
        const params = new URLSearchParams(window.location.search);
        return params.get('name');
    }
    
    // Funci√≥n para volver al dashboard
    function backToMainFromIcoterms() {
        window.location.href = "index.html";
    }
    window.backToMainFromIcoterms = backToMainFromIcoterms; 

    // Guardar resultado en Firestore
    async function saveScoreToFirestore(payload) {
      try {
        // El payload ya no depende del UID de Firebase Auth
        payload.savedAt = new Date().toISOString();
        await addDoc(collection(db, "rankingIncoterms"), payload);
        console.log("‚úÖ Guardado en Firestore");
        await loadTopRanking();
        alert("Resultado guardado correctamente.");
      } catch (e) {
        console.error("Error guardando resultado:", e);
        alert("Error guardando resultado. Revisa la consola.");
      }
    }
    window.saveScoreToFirestore = saveScoreToFirestore;

    // Cargar top 5 desde Firestore
    async function loadTopRanking() {
      try {
        const q = query(collection(db, "rankingIncoterms"), orderBy("average", "desc"), limit(5));
        const snap = await getDocs(q);
        let html = "<ol class='text-left inline-block'>";
        snap.forEach(doc => {
          const d = doc.data();
          html += `<li class="py-1">${d.username} ‚Äî <span class="font-bold">${d.average}</span> pts</li>`;
        });
        html += "</ol>";
        rankingListEl.innerHTML = html;
        rankingMini.classList.remove('hidden');
      } catch (e) {
        console.warn("No se pudo cargar ranking:", e);
      }
    }
    
    // Inicializaci√≥n al cargar el DOM
    document.addEventListener('DOMContentLoaded', () => {
        const urlPlayerName = getPlayerNameFromUrl();

        if (urlPlayerName) {
            // Caso de √âXITO: Nombre encontrado en la URL
            const playerName = decodeURIComponent(urlPlayerName);
            window.player.name = playerName;
            
            nameDisplay.textContent = `Nombre de jugador activo: ${playerName}`;
            nameDisplay.classList.remove('bg-red-100', 'border-red-400', 'text-red-700');
            nameDisplay.classList.add('bg-green-50', 'border-green-200', 'text-green-700');
            gameContent.classList.remove('hidden');
            
            loadTopRanking().catch(err => console.warn("Ranking no cargado:", err));
        } else {
            // Caso de ERROR: Nombre NO encontrado en la URL
            nameDisplay.textContent = `üö® Error: No se encontr√≥ un nombre de jugador. Regresa al Dashboard (index.html) y entra primero.`;
            nameDisplay.classList.add('bg-red-100', 'border-red-400', 'text-red-700');
            nameDisplay.classList.remove('bg-green-50', 'border-green-200', 'text-green-700');
            gameContent.classList.add('hidden'); // Ocultar el contenido del juego
            rankingMini.classList.add('hidden');
        }
    });

    window.saveScoreToFirestore = saveScoreToFirestore;
    // Eliminada: window.logout
  </script>

  <script>
    /* Datos incoterms: lista completa con correct answers */
    const INCOTERMS_ALL = {
      "EXW": ["Producci√≥n", "Empaque", "Entrega en f√°brica"],
      "FCA": ["Producci√≥n", "Empaque", "Transporte interno en origen", "Entrega al transportista"],
      "FAS": ["Producci√≥n", "Empaque", "Transporte interno en origen", "Entrega al costado del buque"],
      "FOB": ["Producci√≥n", "Empaque", "Transporte interno en origen", "Carga en puerto de salida", "Despacho de exportaci√≥n"],
      "CFR": ["Producci√≥n", "Empaque", "Transporte interno en origen", "Carga en puerto de salida", "Flete mar√≠timo"],
      "CIF": ["Producci√≥n", "Empaque", "Transporte interno en origen", "Carga en puerto de salida", "Flete mar√≠timo", "Seguro internacional"],
      "CPT": ["Producci√≥n", "Empaque", "Transporte interno en origen", "Flete internacional"],
      "CIP": ["Producci√≥n", "Empaque", "Transporte interno en origen", "Flete internacional", "Seguro internacional"],
      "DAP": ["Producci√≥n", "Empaque", "Transporte interno en origen", "Flete internacional", "Transporte interno en destino"],
      "DPU": ["Producci√≥n", "Empaque", "Transporte interno en origen", "Flete internacional", "Descarga en destino"],
      "DDP": ["Producci√≥n", "Empaque", "Transporte interno en origen", "Flete internacional", "Despacho de importaci√≥n", "Transporte interno en destino"]
    };

    const COSTS_MASTER = [
      "Producci√≥n","Empaque","Transporte interno en origen","Carga en puerto de salida","Despacho de exportaci√≥n",
      "Flete mar√≠timo","Seguro internacional","Flete internacional","Entrega en f√°brica","Entrega al transportista",
      "Entrega al costado del buque","Descarga en destino","Despacho de importaci√≥n","Transporte interno en destino",
      "Documentaci√≥n extra","Manipuleo","Aranceles","Vistos buenos","Almacenaje"
    ];

    // Estado del juego
    let player = window.player || { name: "" }; // receptor del nombre puesto por el m√≥dulo Firebase
    window.player = player; // aseguro global
    let mode = null;
    let incotermsToPlay = [];
    let perLevelScores = {};
    let currentLevelIndex = 0;
    let timer = 90, countdown = null;
    let selectedCorrect = [];

    // DOM refs
    const randomOptions = document.getElementById("randomOptions");
    const playArea = document.getElementById("playArea");
    const optionsGrid = document.getElementById("optionsGrid");
    const levelTitle = document.getElementById("levelTitle");
    const progressEl = document.getElementById("progress");
    const timerEl = document.getElementById("timer");
    const messageEl = document.getElementById("message");
    const resultsCard = document.getElementById("resultsCard");
    const resultsList = document.getElementById("resultsList");
    const gameContent = document.getElementById("gameContent");

    // UI helpers
    function checkPlayerName() {
      if (!player.name) {
        alert("Debes iniciar sesi√≥n en el dashboard principal para poder jugar.");
        // Redirigir si no hay nombre
        if (typeof window.backToMainFromIcoterms === 'function') {
            window.backToMainFromIcoterms();
        } else {
            location.href = "index.html";
        }
        return false;
      }
      return true;
    }

    // funciones de modos
    function openCustom() {
      if (!checkPlayerName()) return;
      const inc = prompt("Escribe el Incoterm a practicar (ej: FOB)").toUpperCase();
      if (!INCOTERMS_ALL[inc]) return alert("Incoterm inv√°lido.");
      mode = "custom";
      incotermsToPlay = [inc];
      startPlay();
    }

    function openRandom() {
      if (!checkPlayerName()) return;
      randomOptions.classList.remove("hidden");
    }

    function startRandomMode() {
      if (!checkPlayerName()) return;
      const qty = parseInt(document.getElementById("randomQty").value) || 3;
      const keys = Object.keys(INCOCOTERMS_ALL);
      incotermsToPlay = shuffle(keys).slice(0, Math.max(1, Math.min(keys.length, qty)));
      mode = "random";
      randomOptions.classList.add("hidden");
      startPlay();
    }

    function openFull() {
      if (!checkPlayerName()) return;
      incotermsToPlay = Object.keys(INCOTERMS_ALL);
      mode = "full";
      startPlay();
    }

    // gameplay
    function startPlay() {
      perLevelScores = {};
      currentLevelIndex = 0;
      document.getElementById("card").scrollIntoView({ behavior: "smooth" });
      resultsCard.classList.add("hidden");
      playArea.classList.remove("hidden");
      gameContent.classList.add("hidden"); // Ocultar selecci√≥n de modo
      nextLevel();
    }

    function nextLevel() {
      if (currentLevelIndex >= incotermsToPlay.length) {
        finishAll();
        return;
      }
      const inc = incotermsToPlay[currentLevelIndex];
      selectedCorrect = [];
      timer = 90;
      levelTitle.textContent = `${inc} ‚Äî Nivel ${currentLevelIndex+1}/${incotermsToPlay.length}`;
      messageEl.textContent = "";
      progressEl.textContent = `0/${INCOTERMS_ALL[inc].length} correctos`;
      timerEl.textContent = `${timer}s`;
      optionsGrid.innerHTML = "";

      let options = new Set(INCOTERMS_ALL[inc]);
      const shuffledMaster = shuffle([...COSTS_MASTER]);
      for (let i=0; options.size < Math.min(10, COSTS_MASTER.length) && i < shuffledMaster.length; i++) {
        options.add(shuffledMaster[i]);
      }
      const optionsArr = shuffle([...options]);

      optionsArr.forEach(opt => {
        const btn = document.createElement("button");
        btn.className = "p-3 rounded-xl border bg-white text-left hover:bg-green-50 transition";
        btn.textContent = opt;
        btn.onclick = () => handlePick(opt, btn, inc);
        optionsGrid.appendChild(btn);
      });

      clearInterval(countdown);
      countdown = setInterval(() => {
        timer--;
        timerEl.textContent = `${timer}s`;
        if (timer <= 0) {
          clearInterval(countdown);
          finalizeLevel(inc, false);
        }
      }, 1000);
    }

    function handlePick(opt, btn, inc) {
      const correctList = INCOTERMS_ALL[inc];
      if (btn.dataset.done) return;
      if (correctList.includes(opt)) {
        selectedCorrect.push(opt);
        btn.className = "p-3 rounded-xl bg-green-600 text-white";
        btn.dataset.done = "1";
        progressEl.textContent = `${selectedCorrect.length}/${correctList.length} correctos`;
        if (selectedCorrect.length === correctList.length) {
          clearInterval(countdown);
          finalizeLevel(inc, true);
        }
      } else {
        timer -= 7;
        if (timer < 0) timer = 0;
        timerEl.textContent = `${timer}s`;
        btn.className = "p-3 rounded-xl bg-red-500 text-white";
        btn.dataset.done = "1";
        messageEl.textContent = "‚ùå Esa no corresponde al Incoterm. -7s";
        setTimeout(()=> messageEl.textContent = "", 1200);
      }
    }

    function finalizeLevel(inc, won) {
      const correctCount = selectedCorrect.length;
      let score = 0;
      if (won) score = correctCount * 100;
      else score = correctCount * 50;
      perLevelScores[inc] = score;
      messageEl.textContent = `Nivel ${inc} terminado ‚Äî ${score} pts`;
      currentLevelIndex++;
      setTimeout(() => {
        nextLevel();
      }, 1100);
    }

    function finishAll() {
      clearInterval(countdown);
      playArea.classList.add("hidden");
      resultsCard.classList.remove("hidden");
      let html = "<ul>";
      let total = 0, count = 0;
      for (const inc of incotermsToPlay) {
        const sc = perLevelScores[inc] || 0;
        html += `<li class="py-1 border-b border-green-100"><b>${inc}</b> ‚Äî ${sc} pts</li>`;
        total += sc; count++;
      }
      const average = count ? (Math.round((total / count) * 100) / 100) : 0;
      html += `</ul><div class="mt-3 font-bold text-green-800">Promedio final: ${average} pts</div>`;
      resultsList.innerHTML = html;
    }

    function restart() {
      playArea.classList.add("hidden");
      resultsCard.classList.add("hidden");
      gameContent.classList.remove("hidden"); // Mostrar selecci√≥n de modo
      document.getElementById("card").scrollIntoView({behavior:"smooth"});
    }

    // Eliminada: quitGame() y reemplazado por la llamada a backToMainFromIcoterms() en el HTML

    function saveFinalResult() {
      if (!checkPlayerName()) return;
      let total = 0, count = 0;
      const details = [];
      for (const inc of incotermsToPlay) {
        const sc = perLevelScores[inc] || 0;
        total += sc; count++;
        details.push({incoterm: inc, score: sc});
      }
      const average = count ? Math.round((total/count)*100)/100 : 0;
      const payload = {
        username: player.name,
        average: average,
        details: details,
        timestamp: new Date().toISOString()
      };
      if (typeof saveScoreToFirestore === "function") {
        saveScoreToFirestore(payload);
      } else {
        alert("Firebase no est√° configurado correctamente para guardar puntajes.");
      }
    }

    // utils
    function shuffle(arr) { return arr.sort(()=> Math.random() - .5); }

    // Export globals
    window.openFull = openFull;
    window.openRandom = openRandom;
    window.openCustom = openCustom;
    window.startRandomMode = startRandomMode;
    window.saveFinalResult = saveFinalResult;
    window.restart = restart;
  </script>
</body>
</html>
