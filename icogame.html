<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plan de Entrenamiento - ADUWEB</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.5s ease-out; }
        .progress-bar-fill { transition: width 0.5s ease-in-out; }
    </style>
</head>
<body class="bg-gray-100 font-sans">

<header class="bg-white py-4 px-6 shadow-md sticky top-0 z-20 border-b">
    <div class="max-w-7xl mx-auto flex justify-between items-center">
        <div class="flex items-center gap-4">
            <span class="text-2xl font-extrabold text-green-700">ADUWEB</span>
            <span class="text-sm font-light text-gray-500 hidden sm:block">| Formación Técnica</span>
        </div>
        <a href="index.html" class="text-sm bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
            🔙 Dashboard Principal
        </a>
    </div>
</header>

<main class="max-w-7xl mx-auto p-6 md:p-10 animate-fade-in">
    <div class="flex justify-between items-center border-b pb-4 mb-8">
        <h1 class="text-3xl font-extrabold text-gray-900">Ruta de Aprendizaje: Primer Semestre</h1>
        <div class="text-right">
            <p class="text-sm font-medium text-gray-600">Progreso de Formación Técnica</p>
            <div class="w-48 bg-gray-200 rounded-full h-4 mt-1">
                <div id="global-progress-bar" class="bg-purple-600 h-4 rounded-full progress-bar-fill" style="width: 0%;"></div>
            </div>
            <p id="global-progress-percentage" class="text-xs font-bold text-purple-700 mt-1">0%</p>
        </div>
    </div>
    
    <!-- NUEVO: Contenedor de Módulos Lineales -->
    <div id="modules-container" class="space-y-6">
        <!-- Los módulos de entrenamiento se insertarán aquí dinámicamente -->
    </div>
</main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-app.js";
    import { getDatabase, ref, get, update, set, query, orderByChild, onValue } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-database.js";
    import { firebaseConfig } from "./config.js"; // Importar configuración centralizada

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // ------------------------------------------
    // 📚 Módulos Fijos
    const TRAINING_MODULES = [
        { id: 'module_1', name: 'Módulo 1: Fundamentos del Comercio Exterior', icon: '🌍' },
        { id: 'module_2', name: 'Módulo 2: Incoterms y Negociación', icon: '✍️' },
        { id: 'module_3', name: 'Módulo 3: Clasificación Arancelaria', icon: '🧬' },
        { id: 'module_4', name: 'Módulo 4: Valoración Aduanera', icon: '💰' },
        { id: 'module_5', name: 'Módulo 5: Logística y Documentos', icon: '🚚' }
    ];
    // ------------------------------------------
    // ⚙️ LÓGICA PRINCIPAL
    // ------------------------------------------
    let playerKey = null;
    let playerName = null;
    let userProgress = {};

    // --- NUEVO: Renderiza la vista principal de Módulos ---
    async function renderModulesView() {
        document.querySelector('h1').textContent = 'Ruta de Aprendizaje: Primer Semestre';
        document.querySelector('a').innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
            Dashboard Principal
        `;
        document.querySelector('a').href = 'index.html';

        const container = document.getElementById('modules-container');
        container.innerHTML = ''; // Limpiar contenedor

        for (const module of TRAINING_MODULES) {
            const levelsSnapshot = await get(ref(db, `learning_path/modules/${module.id}/levels`));
            const levelsData = levelsSnapshot.exists() ? levelsSnapshot.val() : {};
            const totalLevels = Object.keys(levelsData).length;
            const completedLevels = userProgress[module.id] ? Object.keys(userProgress[module.id]).length : 0;

            // --- NUEVO: Cálculo de progreso basado en porcentajes ---
            let moduleProgress = 0;
            if (userProgress[module.id]) {
                Object.keys(userProgress[module.id]).forEach(completedLevelId => {
                    if (levelsData[completedLevelId]) {
                        moduleProgress += levelsData[completedLevelId].percentage || 0;
                    }
                });
            }

            const moduleCard = document.createElement('div');
            moduleCard.className = 'p-6 rounded-xl shadow-lg border-l-4 border-blue-500 bg-white hover:bg-blue-50 cursor-pointer transition';
            moduleCard.onclick = () => renderLevelsView(module.id, module.name);
            moduleCard.innerHTML = `
                <div class="flex flex-col md:flex-row justify-between md:items-center gap-4">
                    <div class="flex items-start gap-4">
                        <span class="text-3xl mt-1">${module.icon}</span>
                        <div>
                            <h3 class="text-xl font-bold text-gray-800">${module.name}</h3>
                            <p class="text-sm text-gray-600 mt-1">Progreso: ${completedLevels} de ${totalLevels} niveles</p>
                        </div>
                    </div>
                    <div class="w-full md:w-1/3">
                        <div class="w-full bg-gray-200 rounded-full h-4">
                            <div class="bg-blue-600 h-4 rounded-full" style="width: ${moduleProgress}%;"></div>
                        </div>
                        <p class="text-xs text-right font-bold text-blue-700 mt-1">${Math.round(moduleProgress)}%</p>
                    </div>
                </div>
            `;
            container.appendChild(moduleCard);
        }
        updateGlobalProgress();
    }

    // --- NUEVO: Renderiza la vista de Niveles para un Módulo específico ---
    async function renderLevelsView(moduleId, moduleName) {
        document.querySelector('h1').textContent = moduleName;
        document.querySelector('a').innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
            Volver a Módulos
        `;
        document.querySelector('a').onclick = (e) => { e.preventDefault(); renderModulesView(); };
        document.querySelector('a').href = '#';

        const container = document.getElementById('modules-container');
        container.innerHTML = '<p class="text-center text-gray-500">Cargando niveles...</p>';

        // Cargar los niveles desde Firebase, ordenados por el campo 'order'
        const levelsRef = query(ref(db, `learning_path/modules/${moduleId}/levels`), orderByChild('order'));
        const snapshot = await get(levelsRef);

        if (!snapshot.exists()) {
            container.innerHTML = '<p class="text-center text-gray-500">El plan de estudios aún no ha sido configurado por el instructor.</p>';
            return;
        }
        container.innerHTML = ''; // Limpiar "cargando"

        const levels = Object.values(snapshot.val());
        let previousModuleCompleted = true; // El primer módulo siempre está disponible

        levels.forEach(level => {
            const moduleProgress = userProgress[moduleId] || {};
            // CORRECCIÓN: Verificar la propiedad 'completed' dentro del objeto guardado.
            const isCompleted = moduleProgress[level.id]?.completed === true;
            const isAvailable = previousModuleCompleted && !isCompleted;
            const hasStudied = sessionStorage.getItem(`studied_${moduleId}_${level.id}`) === 'true';
            const hasCustomActivity = level.custom_activity && level.custom_activity.type === 'context_quiz';
            const isLocked = !previousModuleCompleted;

            let cardClass = 'bg-white';
            let borderColor = 'border-gray-300';
            let statusIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-400"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>`;
            let buttonsHtml = `<button class="bg-gray-400 text-white font-semibold px-4 py-2 rounded-lg cursor-not-allowed" disabled>Bloqueado</button>`;

            if (isCompleted) {
                borderColor = 'border-green-500';
                statusIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="text-green-500"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>`;
                buttonsHtml = `<button onclick="showStudyMaterial('${moduleId}', '${level.id}')" class="bg-gray-500 text-white font-semibold px-4 py-2 rounded-lg hover:bg-gray-600 transition">Repasar</button>`;
            } else if (isAvailable) {
                borderColor = 'border-blue-500';
                statusIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-500 animate-pulse"><circle cx="12" cy="12" r="1"></circle><circle cx="12" cy="5" r="1"></circle><circle cx="12" cy="19" r="1"></circle><circle cx="5" cy="12" r="1"></circle><circle cx="19" cy="12" r="1"></circle></svg>`;
                
                // MODIFICADO: Decide a qué página de evaluación ir
                const evalTargetPage = hasCustomActivity ? 'actividad_player.html' : 'eval_rol.html';
                const evalOnClick = `window.location.href='${evalTargetPage}?moduleId=${moduleId}&levelId=${level.id}'`;
                const evalButtonState = hasStudied 
                    ? `onclick="${evalOnClick}" class="bg-blue-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-blue-700 transition"`
                    : `disabled class="bg-gray-400 text-white font-semibold px-4 py-2 rounded-lg cursor-not-allowed" title="Debes estudiar el material primero"`;

                buttonsHtml = `
                    <button onclick="showStudyMaterial('${moduleId}', '${level.id}')" class="bg-yellow-500 text-white font-semibold px-3 py-2 rounded-lg hover:bg-yellow-600 transition">Estudiar</button>
                    <button ${evalButtonState}>Iniciar Evaluación</button>
                `;
            }

            const moduleHtml = `
                <div class="p-6 rounded-xl shadow-lg border-l-4 ${borderColor} ${cardClass} ${isLocked ? 'opacity-60' : ''}">
                    <div class="flex flex-col md:flex-row justify-between md:items-center gap-4">
                        <div class="flex items-start gap-4">
                            <span class="text-3xl mt-1">${level.icon}</span>
                            <div>
                                <h3 class="text-xl font-bold text-gray-800">${level.name}</h3>
                                <p class="text-sm text-gray-600 mt-1">${level.desc}</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-4 md:gap-2 flex-shrink-0">
                            <div class="w-24 text-center">${statusIcon}</div>
                            <div class="flex items-center gap-2">${buttonsHtml}</div>
                        </div>
                    </div>
                </div>
            `;
            container.innerHTML += moduleHtml;

            // Si el módulo actual se completó, el siguiente estará disponible
            if (isCompleted) {
                previousModuleCompleted = true;
            } else {
                previousModuleCompleted = false;
            }
        });

        updateGlobalProgress();
    }

    // --- NUEVO: Lógica para mostrar material de estudio en un modal ---
    function getFileIdFromUrl(url) {
        const match = url ? url.match(/\/(?:document|file)\/d\/([a-zA-Z0-9_-]+)/) : null;
        return match ? match[1] : null;
    }

    async function showStudyMaterial(moduleId, levelId) {
        const planRef = ref(db, `learning_path/modules/${moduleId}/content/${levelId}`);
        const snapshot = await get(planRef);

        if (snapshot.exists()) {
            const levelData = snapshot.val();
            const fileId = getFileIdFromUrl(levelData.documentUrl || '');

            if (!fileId) {
                Swal.fire('Documento no encontrado', 'El profesor no ha enlazado un documento de estudio para este módulo.', 'warning');
                return;
            }

            const embedUrl = `https://docs.google.com/document/d/${fileId}/preview`;

            Swal.fire({
                title: `Material de Estudio: ${levelData.title}`,
                html: `
                    <div class="text-left p-2 space-y-4">
                        <div class="bg-gray-100 p-3 rounded-lg border">${levelData.content}</div>
                        <div class="w-full h-96 md:h-[60vh] bg-gray-200 rounded-lg shadow-inner overflow-hidden">
                            <iframe src="${embedUrl}" class="w-full h-full border-0"></iframe>
                        </div>
                        <div id="reading-progress-container" class="mt-4">
                            <p class="text-sm font-semibold text-gray-600 mb-2">Tiempo de lectura restante:</p>
                            <div class="w-full bg-gray-200 rounded-full h-4">
                                <div id="reading-progress-bar" class="bg-blue-600 h-4 rounded-full transition-all duration-1000" style="width: 100%;"></div>
                            </div>
                        </div>
                    </div>
                `,
                icon: 'info',
                width: '90%',
                confirmButtonText: 'He Terminado de Leer',
                allowOutsideClick: false,
                didOpen: () => {
                    const confirmButton = Swal.getConfirmButton();
                    confirmButton.disabled = true;
                    let timeLeft = 15; // 15 segundos de lectura obligatoria
                    const progressBar = document.getElementById('reading-progress-bar');

                    const timerInterval = setInterval(() => {
                        timeLeft--;
                        const progressPercentage = (timeLeft / 15) * 100;
                        progressBar.style.width = `${progressPercentage}%`;

                        if (timeLeft <= 0) {
                            clearInterval(timerInterval);
                            confirmButton.disabled = false;
                            progressBar.style.width = '0%';
                            document.getElementById('reading-progress-container').innerHTML = '<p class="text-center font-bold text-green-600">¡Puedes continuar!</p>';
                        }
                    }, 1000);
                }
            }).then(async (result) => {
                if (result.isConfirmed) {
                    sessionStorage.setItem(`studied_${moduleId}_${levelId}`, 'true');
                    await renderLevelsView(moduleId, TRAINING_MODULES.find(m => m.id === moduleId).name);
                }
            });

        } else {
            Swal.fire('Error', 'No se encontró el material de estudio para este nivel.', 'error');
        }
    }
    window.showStudyMaterial = showStudyMaterial;

    // ------------------------------------------
    // 💾 GESTIÓN DE PROGRESO (Firebase y localStorage)
    // ------------------------------------------
    async function loadUserProgress() {
        const progressRef = ref(db, `usuarios/${playerKey}/progreso_modulos`);
        const snapshot = await get(progressRef);
        userProgress = snapshot.exists() ? snapshot.val() : {};
    }

    async function updateGlobalProgress() {
        const totalModules = TRAINING_MODULES.length;
        let totalProgressPercentage = 0;

        for (const module of TRAINING_MODULES) {
            const levelsSnapshot = await get(ref(db, `learning_path/modules/${module.id}/levels`));
            const levelsData = levelsSnapshot.exists() ? levelsSnapshot.val() : {};
            
            let moduleProgress = 0;
            if (userProgress[module.id]) {
                Object.keys(userProgress[module.id]).forEach(completedLevelId => {
                    if (levelsData[completedLevelId]) {
                        moduleProgress += levelsData[completedLevelId].percentage || 0;
                    }
                });
            }
            // Cada módulo contribuye con su progreso (0-100) dividido por el número total de módulos.
            totalProgressPercentage += moduleProgress / totalModules;
        }

        document.getElementById('global-progress-bar').style.width = `${totalProgressPercentage}%`;
        document.getElementById('global-progress-percentage').textContent = `${Math.round(totalProgressPercentage)}%`;

        // Guardar el progreso global en el perfil del usuario en Firebase.
        if (playerKey) {
            const userRef = ref(db, `usuarios/${playerKey}`);
            await update(userRef, { progreso_entrenamiento: Math.round(totalProgressPercentage) });
        }
    }

    // Inicialización al cargar el DOM
    document.addEventListener('DOMContentLoaded', async () => {
        // --- CORRECCIÓN: Esperar a que Firebase esté online ---
        const connectedRef = ref(db, '.info/connected');
        onValue(connectedRef, async (snap) => {
            if (snap.val() === true) {
                console.log("Conectado a Firebase. Iniciando carga de datos...");

                playerKey = localStorage.getItem('aduweb_player_key');
                playerName = localStorage.getItem('aduweb_player_name');

                if (!playerKey || !playerName) {
                    Swal.fire({
                        title: 'Acceso Denegado',
                        text: 'Debes iniciar sesión en el dashboard principal para acceder al plan de entrenamiento.',
                        icon: 'error',
                        confirmButtonText: 'Volver al Inicio'
                    }).then(() => {
                        window.location.href = 'index.html';
                    });
                } else {
                    // Cargar el progreso del usuario y luego renderizar los módulos
                    await loadUserProgress();
                    await renderModulesView();
                }
            }
        }, (error) => {
            console.error("Error al verificar conexión de DB:", error);
            Swal.fire('Error Crítico', 'No se pudo conectar a la base de datos. Por favor, recarga la página.', 'error').then(() => {
                window.location.href = 'index.html';
            });
        });
    });
  </script>
</body>
</html>
