<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Casos - ADUWEB</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        /* Estilos mejorados para una UI más moderna */
        fieldset { @apply mb-8 p-6 bg-white border border-gray-200 rounded-2xl shadow-sm; }
        legend { @apply text-lg font-bold text-indigo-700 px-4 py-2 bg-indigo-50 border border-indigo-200 rounded-lg shadow-sm -mt-10 ml-4 flex items-center gap-2; }
        label { @apply block text-sm font-semibold text-gray-600 mb-1; }
        .input-group { @apply relative; }
        .input-icon { @apply absolute left-3 top-1/2 -translate-y-1/2 text-gray-400; }
        input[type="text"], input[type="number"], select, textarea {
            @apply w-full p-3 border-2 border-transparent bg-gray-100 rounded-full shadow-inner transition-all duration-300 ease-in-out;
            @apply hover:bg-gray-200;
            @apply focus:bg-white focus:shadow-lg focus:ring-4 focus:ring-indigo-200 focus:border-indigo-400;
        }
        .input-with-icon { @apply pl-10; }
        .dynamic-field-group { @apply bg-gray-50 p-4 rounded-xl mb-4 border border-gray-200 relative; }
        .remove-btn { @apply absolute top-3 right-3 text-gray-400 hover:text-red-600 hover:bg-red-100 rounded-full p-1 transition-all; }
        .hidden-role { display: none; }
    </style>    
</head>
<body class="bg-gray-100 font-sans">
    <script> function playSound(id) { console.log(`Playing sound: ${id}`); } </script>

    <header class="bg-white py-3 px-6 shadow-md sticky top-0 z-20 border-b border-gray-200">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-4">
                <span class="text-2xl font-extrabold text-indigo-700">ADUWEB</span>
                <span class="text-sm font-light text-gray-500 hidden sm:block">| Creador de Escenarios SIPU</span>
            </div>
            <button onclick="playSound('soundClick'); window.location.href='panel_control.html'" class="text-sm bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold px-4 py-2 rounded-lg transition flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
                Volver al Panel de Control
            </button>
        </div>
    </header>

    <main class="max-w-4xl mx-auto p-6 md:p-10">
        <h1 class="text-4xl font-extrabold text-gray-900 mb-2">
            Generador de Escenarios de Simulación
        </h1>
        <p class="text-lg text-gray-600 mb-12">Usa este formulario para crear o editar casos de estudio para el simulador SIPU.</p>

        <form id="case-generator-form" class="space-y-12 pb-24">

            <fieldset>
                <legend><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12.22 2h-4.44a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8.88z"></path><path d="M18 2v6h6"></path></svg>Configuración del Escenario</legend>
                
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <!-- Columna Principal -->
                    <div class="lg:col-span-2 space-y-6">
                        <div>
                            <label for="caseName">Nombre del Escenario</label>
                            <div class="input-group">
                                <div class="input-icon"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7.01" y2="7"></line></svg></div>
                                <input type="text" id="caseName" required class="input-with-icon">
                            </div>
                            <p class="text-xs text-gray-500 mt-1.5">Un título descriptivo. Ej: Importación de Drones con Alerta Roja.</p>
                        </div>

                        <div>
                            <label for="productName">Nombre del Producto Principal</label>
                            <div class="input-group">
                                <div class="input-icon"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path></svg></div>
                                <input type="text" id="productName" required class="input-with-icon">
                            </div>
                             <p class="text-xs text-gray-500 mt-1.5">El producto central de la simulación. Ej: Textiles de Algodón.</p>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="productImage">URL de Imagen del Producto</label>
                                <div class="input-group">
                                    <div class="input-icon"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg></div>
                                    <input type="text" id="productImage" placeholder="https://ejemplo.com/imagen.png" class="input-with-icon">
                                </div>
                            </div>
                             <div>
                                <label for="timeLimit">Límite de Tiempo (segundos)</label>
                                <div class="input-group">
                                    <div class="input-icon"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg></div>
                                    <input type="number" id="timeLimit" value="180" min="60" class="input-with-icon">
                                </div>
                            </div>
                        </div>

                        <div>
                            <label for="productDescription">Descripción Detallada del Producto</label>
                            <div class="input-group">
                                <div class="input-icon"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg></div>
                                <input type="text" id="productDescription" placeholder="Ej: Dron recreativo con 4 hélices, cámara 4K..." class="input-with-icon">
                            </div>
                        </div>

                        <div>
                            <label for="mysteryClue">Pista Misteriosa General</label>
                            <div class="input-group">
                                <div class="input-icon"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line><line x1="11" y1="8" x2="11" y2="14"></line><line x1="11" y1="17" x2="11.01" y2="17"></line></svg></div>
                                <input type="text" id="mysteryClue" placeholder="Ej: ¡Alerta! El origen real no coincide con el declarado." class="input-with-icon">
                            </div>
                            <p class="text-xs text-gray-500 mt-1.5">Esta pista será visible para todos los roles durante la simulación.</p>
                        </div>
                    </div>

                    <!-- Columna Secundaria -->
                    <div class="lg:col-span-1 space-y-6">
                        <div>
                            <label class="block text-sm font-semibold text-gray-600 mb-2">Índice del Escenario</label>
                            <div class="input-group">
                                <div class="input-icon"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="4" y1="9" x2="20" y2="9"></line><line x1="4" y1="15" x2="20" y2="15"></line><line x1="10" y1="3" x2="8" y2="21"></line><line x1="16" y1="3" x2="14" y2="21"></line></svg></div>
                                <input type="number" id="caseIndex" min="1" class="input-with-icon" required>
                            </div>
                        </div>
                        <div>
                            <label for="caseType">Tipo de Escenario</label>
                            <select id="caseType" onchange="window.toggleRoleSelection()" required>
                                <option value="">Seleccione el tipo</option>
                                <option value="multicargo">Proceso Completo (Multicargo)</option>
                                <option value="cargo">Tarea Específica (Un Cargo)</option>
                            </select>
                        </div>
                        <div id="single-role-selector" class="hidden-role">
                            <label for="singleRole">Seleccionar Cargo Específico</label>
                            <select id="singleRole" onchange="window.toggleRoleSelection()">
                                <option value="auxiliar">Auxiliar de Aduanas</option>
                                <option value="clasificador">Clasificador Arancelario</option>
                                <option value="liquidador">Liquidador de Impuestos</option>
                                <option value="coordinador">Coordinador de Transporte</option>
                                <option value="inspector">Inspector de Carga</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-600 mb-2">ID Final del Escenario</label>
                            <div class="bg-gray-800 border-2 border-gray-700 rounded-xl p-4 text-center">
                                <span id="caseIdDisplay" class="text-2xl font-extrabold text-white tracking-wider">---</span>
                                <!-- El span caseIdPrefix se usa en JS, lo reintroducimos aquí de forma invisible -->
                                <p id="caseIdStatus" class="text-sm font-semibold text-yellow-400 mt-1"><span id="caseIdPrefix" class="hidden"></span></p>
                            </div>
                        </div>
                    </div>
                </div>
            </fieldset>
            
            <fieldset id="ai-generation-fieldset" class="hidden-role border-t-4 border-indigo-600">
                <legend><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path></svg>Generación con IA</legend>
                <p class="text-sm text-gray-600 mb-4">La IA puede rellenar los campos vacíos con datos coherentes. Los campos que ya hayas llenado serán respetados.</p>
                <div class="space-y-4">
                    <label for="ai-prompt">Contexto Adicional (Ej: Baterías de litio con problemas de certificación)</label>
                    <textarea id="ai-prompt" rows="1" placeholder="Describe el problema que deseas que la IA genere, o déjalo vacío para un caso estándar."></textarea>
                    <button type="button" id="generate-ai-btn" class="w-full p-3 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700 transition">
                        ✨ Generar Datos de Caso con IA
                    </button>
                </div>
            </fieldset>

            <fieldset id="fieldset-auxiliar" class="role-fieldset hidden-role">
                <legend><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>Etapa 1: Auxiliar de Aduanas</legend>
                <div class="mb-4">
                    <label for="auxiliarHint">Pista Específica</label>
                    <div class="input-group">
                        <div class="input-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><path d="M15 3h6v6"></path><path d="M10 14L21 3"></path></svg>
                        </div>
                        <input type="text" id="auxiliarHint" placeholder="Ej: Revisa la lista de documentos obligatorios..." class="input-with-icon">
                    </div>
                </div>
                <label>Documentos Requeridos (Separados por coma)</label>
                <div class="input-group">
                    <div class="input-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect></svg>
                    </div>
                    <input type="text" id="requiredDocuments" value="" placeholder="Ej: factura, packing_list, bl" class="input-with-icon">
                </div>
            </fieldset>

            <fieldset id="fieldset-clasificador" class="role-fieldset hidden-role">
                <legend><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>Etapa 2: Clasificador Arancelario</legend>
                <div class="mb-4">
                    <label for="clasificadorHint">Pista Específica</label>
                    <div class="input-group">
                        <div class="input-icon"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><path d="M15 3h6v6"></path><path d="M10 14L21 3"></path></svg></div>
                        <input type="text" id="clasificadorHint" placeholder="Ej: El producto tiene funcionalidad de comunicación..." class="input-with-icon">
                    </div>
                </div>
                
                <h4 class="font-semibold text-gray-800 mb-2">Opciones de Clasificación:</h4>
                <div id="clasificador-options-container">
                    </div>
                <button type="button" id="addTariffOption" onclick="window.addTariffOptionField({})" class="w-full text-center bg-indigo-100 hover:bg-indigo-200 text-indigo-800 font-bold py-2 px-4 rounded-lg transition">
                    Añadir Código de Distracción
                </button>

                <h4 class="font-semibold text-gray-800 mt-6 mb-2">Notas Legales (Opcional):</h4>
                <div id="legal-notes-container"></div>
                <button type="button" onclick="window.addLegalNoteField()" class="w-full text-center bg-indigo-100 hover:bg-indigo-200 text-indigo-800 font-bold py-2 px-4 rounded-lg transition mt-2">
                    Añadir Nota Legal
                </button>
            </fieldset>

            <fieldset id="fieldset-liquidador" class="role-fieldset hidden-role">
                <legend><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1v22M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>Etapa 3: Liquidador de Impuestos</legend>
                <div class="mb-4">
                    <label for="liquidadorHint">Pista Específica</label>
                    <div class="input-group">
                        <div class="input-icon"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><path d="M15 3h6v6"></path><path d="M10 14L21 3"></path></svg></div>
                        <input type="text" id="liquidadorHint" placeholder="Ej: El cálculo del IVA debe incluir el Arancel pagado." class="input-with-icon">
                    </div>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
                    <div>
                        <label for="fobValue">Valor FOB (USD)</label>
                        <input type="number" id="fobValue" value="" min="1" required>
                    </div>
                    <div>
                        <label for="freightValue">Flete (USD)</label>
                        <input type="number" id="freightValue" value="0" min="0">
                    </div>
                    <div>
                        <label for="insuranceValue">Seguro (USD)</label>
                        <input type="number" id="insuranceValue" value="0" min="0">
                    </div>
                    <div>
                        <label for="ivaRate">Tasa IVA (Ej: 0.19 para 19%)</label>
                        <input type="number" id="ivaRate" value="" step="0.01" min="0" max="1" required>
                    </div>
                </div>
                <div class="mt-4">
                    <label for="incoterm">Incoterm Aplicable</label>
                    <div class="input-group">
                        <div class="input-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>
                        </div>
                        <input type="text" id="incoterm" value="FOB" placeholder="Ej: FOB, CIF, EXW" class="input-with-icon">
                    </div>
                </div>
            </fieldset>

            <fieldset id="fieldset-coordinador" class="role-fieldset hidden-role">
                <legend><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17.8 19.2 16 11l3.5-3.5C21 6 21.5 4 21 3c-1-.5-3 0-4.5 1.5L13 8 4.8 6.2c-.5-.1-.9.1-1.1.5l-.3.5c-.2.5-.1 1 .3 1.3L9 12l-2 3H4l-1 1 3 2 2 3 1-1v-3l3-2 3.5 5.3c.3.4.8.5 1.3.3l.5-.2c.4-.3.6-.7.5-1.2z"></path></svg>Etapa 4: Coordinador de Transporte</legend>
                <div class="mb-4">
                    <label for="coordinadorHint">Pista Específica</label>
                    <div class="input-group">
                        <div class="input-icon"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><path d="M15 3h6v6"></path><path d="M10 14L21 3"></path></svg></div>
                        <input type="text" id="coordinadorHint" placeholder="Ej: Revisa las penalidades por demora..." class="input-with-icon">
                    </div>
                </div>
                <label for="correctTransportOption">Opción de Transporte Óptima (ID)</label>
                <select id="correctTransportOption" class="mb-4">
                    <option value="air">Aéreo</option>
                    <option value="sea">Marítimo</option>
                </select>

                <h4 class="font-semibold text-gray-800 mb-2">Detalles de Opciones:</h4>
                <div id="transport-options-container">
                    </div>
                
                <h4 class="font-semibold text-gray-800 mt-6 mb-2">Coordenadas Geográficas:</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-gray-50 p-3 rounded-lg">
                        <label>Origen (Nombre y Coords)</label>
                        <div class="input-group mb-2">
                            <div class="input-icon"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg></div>
                            <input type="text" id="originName" placeholder="Ej: Puerto de Shanghai" class="input-with-icon">
                        </div>
                        <div class="input-group">
                            <div class="input-icon"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="4"></circle><line x1="12" y1="2" x2="12" y2="6"></line><line x1="12" y1="18" x2="12" y2="22"></line><line x1="2" y1="12" x2="6" y2="12"></line><line x1="18" y1="12" x2="22" y2="12"></line></svg></div>
                            <input type="text" id="originCoords" placeholder="Ej: 31.2304, 121.4737" class="input-with-icon">
                        </div>
                    </div>
                    <div class="bg-gray-50 p-3 rounded-lg">
                        <label>Destino (Nombre y Coords)</label>
                        <div class="input-group mb-2">
                            <div class="input-icon"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg></div>
                            <input type="text" id="destinationName" placeholder="Ej: Puerto de Cartagena" class="input-with-icon">
                        </div>
                        <div class="input-group">
                            <div class="input-icon"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="4"></circle><line x1="12" y1="2" x2="12" y2="6"></line><line x1="12" y1="18" x2="12" y2="22"></line><line x1="2" y1="12" x2="6" y2="12"></line><line x1="18" y1="12" x2="22" y2="12"></line></svg></div>
                            <input type="text" id="destinationCoords" placeholder="Ej: 10.4237, -75.5453" class="input-with-icon">
                        </div>
                    </div>
                </div>

            </fieldset>

            <fieldset id="fieldset-inspector" class="role-fieldset hidden-role">
                <legend><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>Etapa 5: Inspector de Carga</legend>
                <div class="mb-4">
                    <label for="inspectorHint">Pista Específica</label>
                    <div class="input-group">
                        <div class="input-icon"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><path d="M15 3h6v6"></path><path d="M10 14L21 3"></path></svg></div>
                        <input type="text" id="inspectorHint" placeholder="Ej: La diferencia de peso es sospechosa..." class="input-with-icon">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-6">
                    <div>
                        <label for="declaredUnits">Unidades Declaradas (Esperadas)</label>
                        <input type="number" id="declaredUnits" value="" min="1" required>
                    </div>
                    <div>
                        <label for="foundUnits">Unidades Encontradas (Hallazgo Físico)</label>
                        <input type="number" id="foundUnits" value="" required>
                        <p class="text-xs text-red-500 mt-1">Si son diferentes, el Inspector debe seleccionar "Discrepancia".</p>
                    </div>
                </div>
                <div class="mt-4">
                    <label for="discrepancyDetail">Detalle de la Discrepancia (si aplica)</label>
                    <div class="input-group">
                        <div class="input-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
                        </div>
                        <input type="text" id="discrepancyDetail" placeholder="Ej: Unidades faltantes, contrabando oculto..." class="input-with-icon">
                    </div>
                </div>
            </fieldset>

            <button type="button" id="save-case-btn" class="w-full p-4 bg-green-600 text-white font-bold text-lg rounded-lg hover:bg-green-700 transition shadow-md disabled:bg-gray-400 disabled:cursor-not-allowed">
                Guardar Caso de Estudio
            </button>

        </form>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-app.js";
        import { getDatabase, ref, set, get } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-database.js";
        import { callAduiaApi } from "./keyhandler.js"; 
        
        function playSound(id) { console.log(`Playing sound: ${id}`); }

        const firebaseConfig = {
            apiKey: "AIzaSyB_eUoNQ7L4hd42SVPqbA7vNYHxpEii9To",
            authDomain: "dino-4fbde.firebaseapp.com",
            databaseURL: "https://dino-4fbde-default-rtdb.firebaseio.com",
            projectId: "dino-4fbde",
            storageBucket: "dino-4fbde.firebasestorage.app",
            messagingSenderId: "307345167689",
            appId: "1:307345167689:web:f75e11b0c68a3def253698",
            measurementId: "G-LFDL5N5VW3"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const form = document.getElementById('case-generator-form');
        const caseIdInput = document.getElementById('caseIndex');
        const caseIdStatus = document.getElementById('caseIdStatus');
        const caseTypeSelect = document.getElementById('caseType');
        const singleRoleSelect = document.getElementById('singleRole');
        const singleRoleSelectorDiv = document.getElementById('single-role-selector');
        const caseIdPrefixSpan = document.getElementById('caseIdPrefix');
        const saveBtn = document.getElementById('save-case-btn');
        const clasificadorOptionsContainer = document.getElementById('clasificador-options-container');
        const transportOptionsContainer = document.getElementById('transport-options-container');
        const legalNotesContainer = document.getElementById('legal-notes-container');
        const roleFieldsets = document.querySelectorAll('.role-fieldset');
        const aiPromptInput = document.getElementById('ai-prompt');
        const aiGenerationFieldset = document.getElementById('ai-generation-fieldset');
        const generateAiBtn = document.getElementById('generate-ai-btn');

        const ROLES_MAP = {
            'auxiliar': 'Auxiliar', 'clasificador': 'Clasificador', 'liquidador': 'Liquidador', 
            'coordinador': 'Coordinador', 'inspector': 'Inspector'
        };
        const ALL_ROLES_IDS = Object.keys(ROLES_MAP);

        // --- DEFINICIÓN DE PROPIEDADES BASE DEL ESQUEMA (AJUSTADO A SIPU) ---
        const SCHEMA_PROPERTIES = {
            mysteryClue: { type: "string", description: "Pista general que aplica a todas las etapas." },
            auxiliarHint: { type: "string" },
            requiredDocuments: { type: "string", description: "Documentos requeridos separados por coma (ej: factura, packing_list, bl, fitosanitario). USAR SOLO CLAVES DEL SIMULADOR SIPU." },
            clasificadorHint: { type: "string" },
            tariffOptions: { 
                type: "array", 
                items: {
                    type: "object",
                    properties: { code: { type: "string" }, rate: { type: "number", description: "Tasa arancelaria en porcentaje (0-100)." }, desc: { type: "string" } }
                },
                description: "Lista de 3-4 códigos arancelarios. El PRIMERO debe ser el correcto y tener una tasa coherente con el FOB." 
            },
            liquidadorHint: { type: "string" },
            fobValue: { type: "number", description: "Valor FOB de la mercancía en USD, coherente con el producto." },
            ivaRate: { type: "number", description: "Tasa IVA como decimal (ej: 0.19) aplicable al producto." },
            coordinadorHint: { type: "string" },
            correctTransportOption: { type: "string", enum: ["air", "sea"], description: "ID de la opción de transporte óptima. La IA debe elegir 'air' o 'sea'." },
            transportOptions: {
                type: "object", // Definido como objeto para la IA con claves 'air' y 'sea'
                properties: {
                    air: {
                        type: "object",
                        properties: { id: { type: "string", enum: ["air"] }, cost: { type: "number" }, time: { type: "number" } },
                        description: "Detalles del transporte aéreo. Costo y tiempo deben ser NUMÉRICOS PUROS."
                    },
                    sea: {
                        type: "object",
                        properties: { id: { type: "string", enum: ["sea"] }, cost: { type: "number" }, time: { type: "number" } },
                        description: "Detalles del transporte marítimo. Costo y tiempo deben ser NUMÉRICOS PUROS."
                    }
                }
            },
            inspectorHint: { type: "string" },
            declaredUnits: { type: "number" },
            foundUnits: { type: "number", description: "Unidades encontradas. Debe diferir de declaredUnits en un ±5-15% para crear una discrepancia." }
        };
        
        // --- MAPEADOR DE CAMPOS DEL DOM A KEYS DEL ESQUEMA ---
        const DOM_FIELD_MAP = {
            'mysteryClue': { id: 'mysteryClue', schemaKey: 'mysteryClue' },
            'auxiliarHint': { id: 'auxiliarHint', schemaKey: 'auxiliarHint' },
            'requiredDocuments': { id: 'requiredDocuments', schemaKey: 'requiredDocuments' },
            'clasificadorHint': { id: 'clasificadorHint', schemaKey: 'clasificadorHint' },
            'liquidadorHint': { id: 'liquidadorHint', schemaKey: 'liquidadorHint' },
            'fobValue': { id: 'fobValue', schemaKey: 'fobValue' },
            'ivaRate': { id: 'ivaRate', schemaKey: 'ivaRate' },
            'coordinadorHint': { id: 'coordinadorHint', schemaKey: 'coordinadorHint' },
            'correctTransportOption': { id: 'correctTransportOption', schemaKey: 'correctTransportOption' },
            'inspectorHint': { id: 'inspectorHint', schemaKey: 'inspectorHint' },
            'declaredUnits': { id: 'declaredUnits', schemaKey: 'declaredUnits' },
            'foundUnits': { id: 'foundUnits', schemaKey: 'foundUnits' }
        };
        
        // --- FUNCIÓN DE UTILIDAD: SANITIZAR NÚMEROS DE LA RESPUESTA DE LA IA ---
        function sanitizeNumber(value) {
            if (typeof value === 'number') return value;
            if (typeof value !== 'string') return 0;
            
            // Elimina texto, símbolos, y luego toma el primer número (incluyendo decimales)
            const sanitized = value.replace(/[^0-9.,]+/g, '');
            
            // Reemplazar coma por punto para asegurar la conversión a float en JS
            return parseFloat(sanitized.replace(',', '.')) || 0;
        }


        // --- 1. FUNCIÓN PARA CONSTRUIR EL ESQUEMA JSON DINÁMICO (Basado en campos vacíos) ---
        function buildAISchemaAndInstructions(caseType, targetRole, productName) {
            const schema = {
                type: "object",
                properties: {},
                required: []
            };
            let instructionText = "Instrucciones detalladas de relleno (sólo para campos solicitados):\n";
            let fieldsFound = false;

            const rolesToInclude = caseType === 'multicargo' 
                ? ALL_ROLES_IDS 
                : (targetRole ? [targetRole] : []);

            // 1. Escanear campos estáticos y generales
            const generalFields = ['mysteryClue'];
            generalFields.forEach(key => {
                const element = document.getElementById(DOM_FIELD_MAP[key].id);
                if (element && element.value.trim() === '') {
                    schema.properties[key] = SCHEMA_PROPERTIES[key];
                    schema.required.push(key);
                    instructionText += `- Generar la Pista General ('mysteryClue').\n`;
                    fieldsFound = true;
                }
            });

            // 2. Escanear campos por rol
            rolesToInclude.forEach(roleId => {
                const fieldIds = getFieldIdsForRole(roleId);

                fieldIds.forEach(key => {
                    const element = document.getElementById(key);
                    const schemaKey = DOM_FIELD_MAP[key].schemaKey;
                    
                    if (element && element.value.trim() === '') {
                        schema.properties[schemaKey] = SCHEMA_PROPERTIES[schemaKey];
                        schema.required.push(schemaKey);
                        instructionText += `- Generar el campo '${key}' para el rol ${ROLES_MAP[roleId]}.\n`;
                        fieldsFound = true;
                    }
                });

                // b) Lógica para campos dinámicos (Aranceles y Transporte)
                if (roleId === 'clasificador') { 
                    const firstInput = clasificadorOptionsContainer.querySelector('.dynamic-field-group input[data-type="code"]');
                    const isDefaultEmpty = clasificadorOptionsContainer.children.length === 1 && (firstInput ? firstInput.value.trim() === '' : false);
                    
                    if (clasificadorOptionsContainer.children.length === 0 || isDefaultEmpty) {
                         if (!schema.properties.tariffOptions) {
                            schema.properties.tariffOptions = SCHEMA_PROPERTIES.tariffOptions;
                            schema.required.push('tariffOptions');
                            instructionText += `- Generar la lista 'tariffOptions'. Debe incluir 1 CORRECTO y 2-3 distracciones. El PRIMERO es la respuesta final para el clasificador.\n`;
                            fieldsFound = true;
                        }
                    }
                }
                
                if (roleId === 'coordinador') {
                     // Escaneamos si los campos de COSTO/TIEMPO están vacíos (indicando que la IA debe rellenar todo el bloque)
                     let transportEmpty = true;
                     transportOptionsContainer.querySelectorAll('input[type="number"]').forEach(input => {
                        if (input.value.trim() !== '') {
                            transportEmpty = false;
                        }
                     });
                     
                     // Si los campos de costo/tiempo están vacíos, la IA debe rellenar
                     if (transportEmpty) {
                        if (!schema.properties.transportOptions) {
                            // Cambiamos a usar el esquema de objeto que la IA realmente usa
                            schema.properties.transportOptions = SCHEMA_PROPERTIES.transportOptions;
                            schema.required.push('transportOptions', 'correctTransportOption');
                            instructionText += `- Generar el objeto 'transportOptions' (con claves 'air' y 'sea' y valores NUMÉRICOS PUROS) y seleccionar la 'correctTransportOption' (air/sea) óptima. Costos y tiempos realistas y NUMÉRICOS.\n`;
                            fieldsFound = true;
                        }
                     }
                }
            });
            
            // Si el clasificador fue incluido, añadimos el código correcto a propiedades
            if (rolesToInclude.includes('clasificador')) {
                 if (schema.properties.tariffOptions) {
                    schema.properties.correctTariffCode = { type: "string", description: "El código arancelario correcto (el primer elemento en tariffOptions)." };
                 }
            }


            console.log("Schema dinámico generado:", schema);
            return { schema, instructionText, fieldsFound };
        }
        
        // --- Mapeador de IDs de campos por Rol ---
        function getFieldIdsForRole(roleId) {
            switch (roleId) {
                case 'auxiliar':
                    return ['auxiliarHint', 'requiredDocuments'];
                case 'clasificador':
                    return ['clasificadorHint'];
                case 'liquidador':
                    return ['liquidadorHint', 'fobValue', 'ivaRate'];
                case 'coordinador':
                    return ['coordinadorHint', 'correctTransportOption'];
                case 'inspector':
                    return ['inspectorHint', 'declaredUnits', 'foundUnits'];
                default:
                    return [];
            }
        }
        // --- FUNCIÓN DE CONTROL DE VISTAS (Se mantiene) ---
        function toggleRoleSelection() {
            const type = caseTypeSelect.value;
            const selectedRole = singleRoleSelect.value;
            
            if (type === 'cargo') {
                singleRoleSelectorDiv.classList.remove('hidden-role');
            } else {
                singleRoleSelectorDiv.classList.add('hidden-role');
            }
            
            roleFieldsets.forEach(fieldset => fieldset.classList.add('hidden-role'));
            
            if (type === 'multicargo') {
                roleFieldsets.forEach(fieldset => fieldset.classList.remove('hidden-role'));
            } else if (type === 'cargo' && selectedRole) {
                const fieldset = document.getElementById(`fieldset-${selectedRole}`);
                if (fieldset) fieldset.classList.remove('hidden-role');
            }

            if (type) {
                aiGenerationFieldset.classList.remove('hidden-role');
            } else {
                aiGenerationFieldset.classList.add('hidden-role');
            }

            checkCaseId();
        }

        // --- 2. FUNCIÓN PRINCIPAL DE GENERACIÓN CON IA ---
        async function generateCaseWithAI() {
            const userPrompt = aiPromptInput.value.trim();
            const type = caseTypeSelect.value;
            const role = singleRoleSelect.value;
            
            const caseName = document.getElementById('caseName').value.trim();
            const productName = document.getElementById('productName').value.trim();
            const timeLimit = document.getElementById('timeLimit').value.trim();
            
            if (!productName || !type || (type === 'cargo' && !role)) {
                return Swal.fire('Error', 'Debes rellenar **Producto Principal** y seleccionar el **Tipo de Caso/Cargo** antes de usar la IA.', 'error');
            }

            // 1. Construir Schema y obtener instrucciones (basado en campos vacíos)
            const { schema, instructionText, fieldsFound } = buildAISchemaAndInstructions(type, role, productName);

            if (!fieldsFound && userPrompt === '') {
                 return Swal.fire('Información', 'No hay campos vacíos detectados para rellenar, y no proporcionaste un Contexto Adicional. Edita un campo manualmente para forzar la generación.', 'info');
            }

            Swal.fire({
                title: 'Generando Datos Faltantes...',
                text: 'Aplicando la Coherencia SIPU. Esto puede tomar unos segundos.',
                didOpen: () => { Swal.showLoading(); },
                allowOutsideClick: false,
                allowEscapeKey: false
            });

            const systemPrompt = `Eres un experto generador de escenarios de simulación de aduanas, especializado en la creación de casos coherentes con la plantilla SIPU (Simulador de Procesos Unificados).

            --- CONTEXTO DEL CASO ---
            - Producto Principal: "${productName}"
            - Tipo de Caso: ${type.toUpperCase()}
            - Cargo(s) Visibles: ${type === 'multicargo' ? 'TODOS' : ROLES_MAP[role]}
            - Contexto del Docente: ${userPrompt ? userPrompt : 'Generar un problema estándar de importación/exportación.'}
            
            --- REGLAS DE COHERENCIA SIPU (CRÍTICO) ---
            1. COHERENCIA TOTAL: Todos los valores (FOB, Arancel, Unidades) deben ser interdependientes y REALISTEAS para el producto.
            2. DOCUMENTOS: En 'requiredDocuments', usar **SOLO CLAVES CORTAS** separadas por coma (ej: factura, bl, certificado_origen).
            3. LIQUIDACIÓN: El valor 'fobValue' debe ser compatible con la tasa 'ivaRate' y la tasa arancelaria del código correcto para el cálculo final.
            4. TRANSPORTE: **CRÍTICO**: Los campos 'cost' y 'time' en 'transportOptions' deben ser **VALORES NUMÉRICOS PUROS** (sin texto como 'USD' o 'days'). Aéreo más rápido, Marítimo más económico.
            5. DISCREPANCIA: La diferencia entre 'declaredUnits' y 'foundUnits' debe ser clara (5-15% de diferencia).

            --- TAREA PRINCIPAL ---
            Tu tarea es rellenar **SOLO** los campos solicitados en el 'required' del esquema, siguiendo las instrucciones detalladas.
            
            ${instructionText}
            
            Genera **SOLO** JSON válido, sin texto adicional (como \`\`\`json).`;

            console.log("System Prompt enviado a IA:", systemPrompt);

            const payload = {
                model: "gpt-4o", 
                messages: [{ role: "system", content: systemPrompt }],
                response_format: { type: "json_object" },
                temperature: 0.7,
                schema: schema
            };

            try {
                const response = await callAduiaApi(payload);
                const aiData = response.choices[0].message.content;

                if (!aiData) {
                    throw new Error("La IA no devolvió contenido JSON.");
                }
                
                let jsonString = aiData.trim();
                if (jsonString.startsWith('```')) {
                    jsonString = jsonString.replace(/^```json\s*|\s*```$/g, '').trim();
                }

                const parsedData = JSON.parse(jsonString);
                console.log("Respuesta de IA parseada:", parsedData);
                
                fillFormFromAI(parsedData);

            } catch (error) {
                console.error("Error en la generación con IA:", error);
                Swal.close();
                
                let errorMsg = 'No se pudo generar el caso. ';
                if (error.message.includes('JSON')) {
                    errorMsg += 'La IA devolvió un formato inválido. Revisa el log de la consola.';
                } else if (error.message.includes('Error 500')) {
                    errorMsg += 'El servidor de la API devolvió un Error 500. Revisa el log del backend.';
                } else {
                    errorMsg += error.message;
                }

                Swal.fire({
                    icon: 'error',
                    title: 'Error de IA',
                    text: errorMsg,
                    footer: 'Revisa consola (F12) para detalles'
                });
            }
        }


        // --- 3. FUNCIÓN PARA RELLENAR EL FORMULARIO (Defensiva con Sanitización) ---
        function fillFormFromAI(data) {
            const caseType = caseTypeSelect.value;
            const targetRole = singleRoleSelect.value;
            
            // 1. Rellenar campos generales
            if (data.mysteryClue) {
                 document.getElementById('mysteryClue').value = data.mysteryClue;
            }
            
            // 2. Llenado por rol
            ALL_ROLES_IDS.forEach(roleId => {
                const shouldFill = caseType === 'multicargo' || roleId === targetRole;
                
                if (shouldFill) {
                    
                    if (roleId === 'auxiliar') {
                        if (data.auxiliarHint) document.getElementById('auxiliarHint').value = data.auxiliarHint;
                        if (data.requiredDocuments) document.getElementById('requiredDocuments').value = data.requiredDocuments;
                    }
                    
                    if (roleId === 'clasificador') {
                        if (data.clasificadorHint) document.getElementById('clasificadorHint').value = data.clasificadorHint;
                        
                        if (data.tariffOptions && data.tariffOptions.length > 0) {
                            // Limpiar y rellenar opciones de clasificación
                            clasificadorOptionsContainer.innerHTML = '';
                            data.tariffOptions.forEach((opt, index) => {
                                addTariffOptionField({ 
                                    code: opt.code, 
                                    rate: opt.rate, 
                                    desc: opt.desc, 
                                    correct: index === 0 
                                });
                            });
                        }
                    }

                    if (roleId === 'liquidador') {
                        if (data.liquidadorHint) document.getElementById('liquidadorHint').value = data.liquidadorHint;
                        if (data.fobValue !== undefined) document.getElementById('fobValue').value = data.fobValue;
                        if (data.ivaRate !== undefined) document.getElementById('ivaRate').value = data.ivaRate;
                    }

                    if (roleId === 'coordinador') {
                        if (data.coordinadorHint) document.getElementById('coordinadorHint').value = data.coordinadorHint;
                        if (data.correctTransportOption) document.getElementById('correctTransportOption').value = data.correctTransportOption;

                        if (data.transportOptions) {
                            // CORRECCIÓN CRÍTICA: Iterar sobre las claves del objeto transportOptions
                            Object.keys(data.transportOptions).forEach(id => {
                                const opt = data.transportOptions[id];
                                
                                // Asegurar que el ID es 'air' o 'sea' y que la opción tiene contenido
                                if ( (id === 'air' || id === 'sea') && typeof opt === 'object' ) {
                                    const container = document.querySelector(`#transport-options-container [data-id="${id}"]`);
                                    
                                    if (container) {
                                        // CRITICAL FIX: Sanitize both cost and time before injection
                                        // Aseguramos que opt.cost/opt.time tienen un valor antes de pasar a sanitize
                                        const costValue = opt.cost !== undefined ? opt.cost : 0;
                                        const timeValue = opt.time !== undefined ? opt.time : 0;
                                        
                                        const cleanedCost = sanitizeNumber(costValue);
                                        const cleanedTime = Math.round(sanitizeNumber(timeValue)); 

                                        // Inyectar valores sanitizados
                                        container.querySelector('input[data-type="cost"]').value = cleanedCost;
                                        container.querySelector('input[data-type="time"]').value = cleanedTime;
                                    }
                                }
                            });
                        }
                    }
                    
                    if (roleId === 'inspector') {
                        if (data.inspectorHint) document.getElementById('inspectorHint').value = data.inspectorHint;
                        if (data.declaredUnits !== undefined) document.getElementById('declaredUnits').value = data.declaredUnits;
                        if (data.foundUnits !== undefined) document.getElementById('foundUnits').value = data.foundUnits;
                    }
                }
            });
            
            // Fallback para asegurar campos dinámicos se inicializan si quedan vacíos
            if (clasificadorOptionsContainer.children.length === 0) renderInitialFields(true);
            if (transportOptionsContainer.children.length === 0) renderInitialFields(false, true);

            checkCaseId(); 
            Swal.close(); 
            Swal.fire('¡Datos Generados!', 'La IA ha rellenado los campos faltantes. Revisa y guarda el caso.', 'success');
        }


        // --- FUNCIONES DE APOYO (ADD, RENDER, CHECK, SAVE) ---

        function generateCaseId() {
            const type = caseTypeSelect.value;
            const index = document.getElementById('caseIndex').value.trim();
            
            if (!type || !index) return '';

            let prefix;
            let fullId;

            if (type === 'multicargo') {
                prefix = 'multi-';
                fullId = `multicargo${index}`;
            } else if (type === 'cargo') {
                const role = singleRoleSelect.value;
                if (!role) return '';
                prefix = `${role}-`;
                fullId = `cargo_${role}${index}`;
            }
            
            caseIdPrefixSpan.textContent = prefix;
            return fullId;
        }

        async function checkCaseId() {
            const caseId = generateCaseId();
            if (!caseId) {
                caseIdStatus.textContent = '';
                saveBtn.disabled = true;
                return;
            }

            const caseRef = ref(db, `casos_estudio/${caseId}`);
            const snapshot = await get(caseRef); 

            if (snapshot.exists()) {
                caseIdStatus.textContent = '❌ ¡ID Existente!';
                caseIdStatus.className = 'text-sm font-semibold text-red-600';
                saveBtn.disabled = true;
            } else {
                caseIdStatus.textContent = '✅ Disponible';
                caseIdStatus.className = 'text-sm font-semibold text-green-600';
                saveBtn.disabled = false;
            }
        }
        
        function addTariffOptionField(data = {}) {
            const merchDiv = document.createElement('div');
            merchDiv.classList.add('dynamic-field-group');
            merchDiv.setAttribute('data-group', 'tariff');
            
            merchDiv.innerHTML = `
                <button type="button" class="remove-btn" onclick="this.closest('.dynamic-field-group').remove();"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button>
                <label class="font-bold ${data.correct ? 'text-green-700' : 'text-gray-700'}">Código Arancelario ${data.correct ? '(Correcto)' : '(Distracción)'}</label>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-2">
                    <div>
                        <label>Código</label>
                        <input type="text" data-type="code" placeholder="Ej: 8517.62" required value="${data.code || ''}">
                    </div>
                    <div>
                        <label>Tasa Arancel (%)</label>
                        <input type="number" data-type="rate" value="${data.rate || 10}" min="0" max="100" required>
                    </div>
                    <div class="md:col-span-3">
                        <label>Descripción Corta</label>
                        <input type="text" data-type="desc" placeholder="Ej: Aparatos de comunicación genéricos" required value="${data.desc || ''}">
                    </div>
                </div>
            `;
            clasificadorOptionsContainer.appendChild(merchDiv);
        }

        function addLegalNoteField(data = {}) {
            const noteDiv = document.createElement('div');
            noteDiv.classList.add('dynamic-field-group');
            noteDiv.setAttribute('data-group', 'legal-note');
            noteDiv.innerHTML = `
                <button type="button" class="remove-btn" onclick="this.closest('.dynamic-field-group').remove();"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button>
                <label class="font-bold text-gray-700">Nota Legal para Subpartida</label>
                <input type="text" data-type="code" placeholder="Código Arancelario (Ej: 8517.62.90)" value="${data.code || ''}">
                <textarea data-type="note" class="mt-2" placeholder="Texto de la nota legal...">${data.note || ''}</textarea>
            `;
            legalNotesContainer.appendChild(noteDiv);
        }

        function setInitialCaseId() {
            const randomId = Math.floor(Math.random() * 900) + 100; 
            document.getElementById('caseIndex').value = randomId;
            checkCaseId();
        }
        
        function renderInitialFields(clasificadorOnly = false, transportOnly = false) {
            
            if (!transportOnly && clasificadorOptionsContainer.children.length === 0) {
                addTariffOptionField({ correct: true });
            }
            
            if (!clasificadorOnly && transportOptionsContainer.children.length === 0) {
                // Transporte
                const defaultTransport = [
                    { id: 'air', name: 'Aéreo' },
                    { id: 'sea', name: 'Marítimo' }
                ];
                transportOptionsContainer.innerHTML = ''; // Asegura que se limpie
                defaultTransport.forEach(opt => {
                    const group = document.createElement('div');
                    group.classList.add('dynamic-field-group');
                    group.setAttribute('data-group', 'transport');
                    group.setAttribute('data-id', opt.id);
                    group.innerHTML = `
                        <h5 class="font-bold text-gray-800">${opt.name} ${opt.id === 'air' ? '✈️' : '🚢'}</h5>
                        <label>Costo (USD)</label><input type="number" data-type="cost" value="" required>
                        <label class="mt-2">Tiempo (días)</label><input type="number" data-type="time" value="" required>
                    `;
                    transportOptionsContainer.appendChild(group);
                });
            }
        }

        // --- FUNCIÓN DE GUARDADO EN FIREBASE ---
        async function saveCaseToFirebase() {

            const caseId = generateCaseId();
            if (!caseId) {
                return Swal.fire('Error', 'Debe seleccionar el Tipo de Caso, el Cargo (si aplica) y el Índice.', 'error');
            }
            
            const caseType = caseTypeSelect.value;
            const singleRole = singleRoleSelect.value;
            
            const productName = document.getElementById('productName').value.trim();
            const productImage = document.getElementById('productImage').value.trim();
            const productDescription = document.getElementById('productDescription').value.trim();
            const timeLimit = parseInt(document.getElementById('timeLimit').value) || 180;
            const mysteryClue = document.getElementById('mysteryClue').value.trim();
            
            const tariffOptions = {};
            const tariffGroups = clasificadorOptionsContainer.querySelectorAll('[data-group="tariff"]');
            
            const tariffArray = [];
            let correctTariffCode = "";
            const legalNotes = {};
            
            tariffGroups.forEach((group, index) => {
                const code = group.querySelector('[data-type="code"]').value.trim();
                const rate = parseFloat(group.querySelector('[data-type="rate"]').value);
                const name = group.querySelector('[data-type="desc"]').value.trim();
                
                if (code) {
                    const option = {
                        code: code,
                        rate: rate / 100, // Convertir a decimal para Firebase
                        name: name
                    };
                    tariffArray.push(option);
                    if (index === 0) {
                        correctTariffCode = code;
                    }
                }
            });

            const legalNoteGroups = legalNotesContainer.querySelectorAll('[data-group="legal-note"]');
            legalNoteGroups.forEach(group => {
                const code = group.querySelector('[data-type="code"]').value.trim();
                const note = group.querySelector('[data-type="note"]').value.trim();
                if (code && note) {
                    legalNotes[code] = note;
                }
            });
            const transportOptions = {};
            const transportGroups = document.querySelectorAll('#transport-options-container [data-group="transport"]');
            transportGroups.forEach(group => {
                const id = group.getAttribute('data-id');
                const costInput = group.querySelector('input[data-type="cost"]').value;
                const timeInput = group.querySelector('input[data-type="time"]').value;

                // VALIDACIÓN EXTRA: Si el rol coordinador está activo, los campos no pueden estar vacíos
                if ((caseType === 'multicargo' || singleRole === 'coordinador')) {
                     if (costInput === '' || timeInput === '') {
                        throw new Error(`Los campos de Costo/Días para ${id} no pueden estar vacíos si el Coordinador está activo.`);
                     }
                }
                
                transportOptions[id] = {
                    cost: parseFloat(costInput),
                    time: parseInt(timeInput)
                };
            });

            const caseObject = {
                nombre: document.getElementById('caseName').value.trim(),
                caseId: caseId,
                caseType: caseType,
                game: {
                    productName: productName,
                    productImage: productImage,
                    productDescription: productDescription,
                    timeLimit: timeLimit,
                    mysteryClue: mysteryClue,
                    iconTime: "<svg xmlns='[http://www.w3.org/2000/svg](http://www.w3.org/2000/svg)' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><circle cx='12' cy='12' r='10'/><polyline points='12 6 12 12 16 14'/></svg>",
                    iconClue: "<svg xmlns='[http://www.w3.org/2000/svg](http://www.w3.org/2000/svg)' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><circle cx='12' cy='12' r='10'/><path d='M12 16v-4'/><path d='M12 8h.01'/></svg>"
                },
                auxiliar: (caseType === 'multicargo' || singleRole === 'auxiliar') ? {
                    required_documents: document.getElementById('requiredDocuments').value.split(',').map(s => s.trim()).filter(Boolean),
                    hint: document.getElementById('auxiliarHint').value.trim()
                } : null,
                clasificador: (caseType === 'multicargo' || singleRole === 'clasificador') ? {
                    correct_tariff_code: correctTariffCode,
                    tariff_options_array: tariffArray, 
                    legal_notes: legalNotes,
                    hint: document.getElementById('clasificadorHint').value.trim()
                } : null,
                liquidador: (caseType === 'multicargo' || singleRole === 'liquidador') ? {
                    fob_value: parseFloat(document.getElementById('fobValue').value),
                    freight_value: parseFloat(document.getElementById('freightValue').value),
                    insurance_value: parseFloat(document.getElementById('insuranceValue').value),
                    iva_rate: parseFloat(document.getElementById('ivaRate').value),
                    incoterm: document.getElementById('incoterm').value.trim(),
                    hint: document.getElementById('liquidadorHint').value.trim()
                } : null,
                coordinador: (caseType === 'multicargo' || singleRole === 'coordinador') ? {
                    correct_option: document.getElementById('correctTransportOption').value,
                    options: transportOptions,
                    origin_name: document.getElementById('originName').value.trim(),
                    origin_coords: document.getElementById('originCoords').value.split(',').map(Number),
                    destination_name: document.getElementById('destinationName').value.trim(),
                    destination_coords: document.getElementById('destinationCoords').value.split(',').map(Number),
                    hint: document.getElementById('coordinadorHint').value.trim()
                } : null,
                inspector: (caseType === 'multicargo' || singleRole === 'inspector') ? {
                    declared_units: parseInt(document.getElementById('declaredUnits').value),
                    found_units: parseInt(document.getElementById('foundUnits').value),
                    discrepancy_detail: document.getElementById('discrepancyDetail').value.trim(),
                    hint: document.getElementById('inspectorHint').value.trim()
                } : null
            };

            if (caseObject.clasificador && !caseObject.clasificador.correct_tariff_code) {
                 return Swal.fire('Error', 'Debe definir al menos un Código Arancelario Correcto para el Clasificador.', 'error');
            }

            try {
                await set(ref(db, `casos_estudio/${caseId}`), caseObject);
                
                Swal.fire('¡Éxito!', `El caso "${caseObject.nombre}" (${caseId}) ha sido guardado en Firebase.`, 'success');
                form.reset();
                setInitialCaseId();
                toggleRoleSelection();
                renderInitialFields();
            } catch (error) {
                Swal.fire('Error', `No se pudo guardar el caso en la base de datos. ${error.message}`, 'error');
                console.error("Error al guardar en Firebase:", error);
            }
        }
        
        // --- EVENT LISTENERS Y EXPOSICIÓN GLOBAL ---
        
        window.saveCaseToFirebase = saveCaseToFirebase;
        window.toggleRoleSelection = toggleRoleSelection;
        window.generateCaseWithAI = generateCaseWithAI; 
        window.addTariffOptionField = addTariffOptionField; 
        window.addLegalNoteField = addLegalNoteField;
        
        document.addEventListener('DOMContentLoaded', () => {
            
            document.getElementById('save-case-btn').addEventListener('click', saveCaseToFirebase);
            document.getElementById('addTariffOption').addEventListener('click', () => addTariffOptionField({}));
            document.getElementById('generate-ai-btn').addEventListener('click', generateCaseWithAI); 
            
            document.getElementById('caseName').addEventListener('input', toggleRoleSelection);
            document.getElementById('caseIndex').addEventListener('input', checkCaseId);
            document.getElementById('singleRole').addEventListener('change', toggleRoleSelection);
            
            setInitialCaseId();
            renderInitialFields();
            toggleRoleSelection(); 
        });

    </script>
</body>
</html>
