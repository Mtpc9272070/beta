<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Casos - ADUWEB</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        fieldset { @apply mb-8 p-6 border border-gray-300 rounded-xl; }
        legend { @apply text-xl font-bold text-indigo-600 px-2; }
        label { @apply block text-sm font-medium text-gray-700 mb-1; }
        input[type="text"], input[type="number"] { @apply w-full p-2 border border-gray-300 rounded-lg shadow-sm; }
    </style>    
</head>
<body class="bg-gray-100 font-sans">

    <header class="bg-white py-4 px-6 shadow-md sticky top-0 z-20 border-b">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-4">
                <span class="text-2xl font-extrabold text-green-700">ADUWEB</span>
                <span class="text-sm font-light text-gray-500 hidden sm:block">| Generador de Casos</span>
            </div>
            <button onclick="window.location.href='index.html'" class="text-sm bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
                Volver al Dashboard
            </button>
        </div>
    </header>

    <main class="max-w-4xl mx-auto p-6 md:p-10">
        <h1 class="text-3xl font-extrabold text-gray-900 border-b pb-4 mb-8 flex items-center gap-3">
            <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-indigo-600"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="12" y1="8" x2="12" y2="16"></line><line x1="8" y1="12" x2="16" y2="12"></line></svg>
            Generador de Casos "La Merca"
        </h1>

        <form id="case-generator-form" class="bg-white p-8 rounded-xl shadow-lg">

            <fieldset>
                <legend>Datos Generales del Caso</legend>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="caseId">Número del Caso (Ej: 2, 3, 10)</label>
                        <div class="flex items-center gap-2">
                            <span class="font-semibold text-gray-500">CASO_</span>
                            <input type="number" id="caseId" min="1" class="flex-grow" required>
                            <span id="caseIdStatus" class="text-sm font-semibold"></span>
                        </div>
                    </div>
                    <div>
                        <label for="caseName">Nombre del Caso</label>
                        <input type="text" id="caseName" placeholder="Ej: Importación de Textiles desde Vietnam" required>
                    </div>
                </div>
            </fieldset>

            <fieldset>
                <legend>Especialista en Aranceles</legend>
                <label>Mercancía Principal (para el juego de cartas)</label>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 bg-gray-50 p-4 rounded-lg">
                    <div>
                        <label for="merchName">Nombre Mercancía</label>
                        <input type="text" id="merchName" placeholder="Ej: Camisetas de Algodón">
                    </div>
                    <div>
                        <label for="correctCode">Código Correcto</label>
                        <input type="text" id="correctCode" placeholder="Ej: 6109.10.00">
                    </div>
                    <div>
                        <label for="decoys">Códigos de Distracción (separados por coma)</label>
                        <input type="text" id="decoys" placeholder="6105.10.00, 6205.20.00, ...">
                    </div>
                </div>
            </fieldset>

            <fieldset>
                <legend>Respuestas Correctas (para Auditoría)</legend>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h4 class="font-semibold text-gray-800 mb-2">Datos de Cumplimiento</h4>
                        <div class="space-y-3">
                            <div>
                                <label for="auditTariffCode">Código Arancelario Correcto</label>
                                <input type="text" id="auditTariffCode" placeholder="Debe coincidir con el de arriba">
                            </div>
                            <div>
                                <label for="auditRequiredDoc">ID del Documento Requerido</label>
                                <input type="text" id="auditRequiredDoc" placeholder="Ej: doc-rtm">
                                <p class="text-xs text-gray-500 mt-1">
                                    IDs disponibles: 
                                    <code class="font-mono bg-gray-200 px-1 rounded">doc-rtm</code>, 
                                    <code class="font-mono bg-gray-200 px-1 rounded">doc-sanitary</code>, 
                                    <code class="font-mono bg-gray-200 px-1 rounded">doc-phyto</code>, 
                                    <code class="font-mono bg-gray-200 px-1 rounded">doc-dumping</code>.</p>
                            </div>
                        </div>
                    </div>
                    <div>
                        <h4 class="font-semibold text-gray-800 mb-2">Datos de Costos</h4>
                        <div class="space-y-3">
                            <div>
                                <label for="auditCustomsValue">Valor en Aduana Correcto (USD)</label>
                                <input type="number" id="auditCustomsValue" placeholder="Ej: 54500">
                            </div>
                            <div>
                                <label for="auditOptimalFreight">Flete Óptimo (USD)</label>
                                <input type="number" id="auditOptimalFreight" placeholder="Ej: 3500">
                            </div>
                        </div>
                    </div>
                </div>
            </fieldset>

            <button type="button" id="save-case-btn" class="w-full p-4 bg-green-600 text-white font-bold text-lg rounded-lg hover:bg-green-700 transition shadow-md disabled:bg-gray-400 disabled:cursor-not-allowed">
                Guardar Caso en la Nube
            </button>

        </form>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-app.js";
        import { getDatabase, ref, set, get } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB_eUoNQ7L4hd42SVPqbA7vNYHxpEii9To",
            authDomain: "dino-4fbde.firebaseapp.com",
            databaseURL: "https://dino-4fbde-default-rtdb.firebaseio.com",
            projectId: "dino-4fbde",
            storageBucket: "dino-4fbde.firebasestorage.app",
            messagingSenderId: "307345167689",
            appId: "1:307345167689:web:f75e11b0c68a3def253698",
            measurementId: "G-LFDL5N5VW3"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const caseIdInput = document.getElementById('caseId');
        const caseIdStatus = document.getElementById('caseIdStatus');
        const saveBtn = document.getElementById('save-case-btn');

        async function checkCaseId() {
            const id = caseIdInput.value;
            if (!id || id < 1) {
                caseIdStatus.textContent = '';
                return;
            }
            const caseRef = ref(db, `casos_estudio/CASO_${id}`);
            const snapshot = await get(caseRef);
            if (snapshot.exists()) {
                caseIdStatus.textContent = '❌ ¡Este ID ya existe!';
                caseIdStatus.className = 'text-sm font-semibold text-red-600';
                saveBtn.disabled = true;
            } else {
                caseIdStatus.textContent = '✅ Disponible';
                caseIdStatus.className = 'text-sm font-semibold text-green-600';
                saveBtn.disabled = false;
            }
        }

        async function saveCaseToFirebase() {
            const form = document.getElementById('case-generator-form');
            const caseId = `CASO_${document.getElementById('caseId').value.trim()}`;
            const caseName = document.getElementById('caseName').value.trim();

            if (!caseId || !caseName) {
                Swal.fire('Error', 'El ID y el Nombre del caso son obligatorios.', 'error');
                return;
            }

            const merchName = document.getElementById('merchName').value;
            const correctCode = document.getElementById('correctCode').value;
            const decoys = document.getElementById('decoys').value.split(',').map(s => s.trim());

            const auditTariffCode = document.getElementById('auditTariffCode').value;
            const auditRequiredDoc = document.getElementById('auditRequiredDoc').value;
            const auditCustomsValue = parseFloat(document.getElementById('auditCustomsValue').value);
            const auditOptimalFreight = parseFloat(document.getElementById('auditOptimalFreight').value);

            const caseObject = {
                nombre: caseName,
                tariffs_specialist: {
                    merchandiseData: [ { name: merchName, correctCode: correctCode, decoys: decoys } ]
                },
                compliance_officer: { /* ... (datos estándar) ... */ },
                valuation_expert: { /* ... (datos estándar) ... */ },
                logistics_coordinator: { /* ... (datos estándar) ... */ },
                respuestas_correctas: {
                    tariffs_code: auditTariffCode,
                    required_doc: auditRequiredDoc,
                    customs_value: auditCustomsValue,
                    optimal_freight: auditOptimalFreight
                }
            };

            try {
                await set(ref(db, `casos_estudio/${caseId}`), caseObject);
                Swal.fire('¡Éxito!', `El caso "${caseName}" ha sido guardado en la nube.`, 'success');
                form.reset();
                setInitialCaseId();
            } catch (error) {
                Swal.fire('Error', 'No se pudo guardar el caso en la base de datos.', 'error');
                console.error("Error al guardar en Firebase:", error);
            }
        }

        function setInitialCaseId() {
            caseIdInput.value = Math.floor(Math.random() * 90) + 10; // Un número aleatorio entre 10 y 99
            checkCaseId();
        }

        window.saveCaseToFirebase = saveCaseToFirebase;
        document.getElementById('save-case-btn').addEventListener('click', saveCaseToFirebase);
        caseIdInput.addEventListener('input', checkCaseId);
        document.addEventListener('DOMContentLoaded', setInitialCaseId);
    </script>

</body>
</html>