<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ADUWEB | Port Logistics v7 Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- Three.js Import -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <style>
        body { margin: 0; overflow: hidden; background-color: #0f172a; font-family: 'Segoe UI', sans-serif; user-select: none; touch-action: none; }
        
        .glass-panel {
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        }

        .control-btn {
            background: linear-gradient(to bottom, #334155, #1e293b);
            border: 1px solid #475569;
            color: #94a3b8;
            box-shadow: 0 3px 0 #0f172a;
            transition: all 0.1s;
        }
        .control-btn:active {
            transform: translateY(3px);
            box-shadow: 0 0 0 #0f172a;
            color: white;
        }

        /* Botones de Acción */
        .action-btn {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-width: 0 0 4px 0;
            border-style: solid;
        }
        .btn-disabled { background: #334155; border-color: #1e293b; color: #64748b; cursor: not-allowed; opacity: 0.7; }
        .btn-grab { background: #16a34a; border-color: #14532d; color: white; animation: pulse-green 2s infinite; }
        .btn-drop { background: #2563eb; border-color: #1e3a8a; color: white; animation: pulse-blue 2s infinite; }
        .btn-stack { background: #f97316; border-color: #9a3412; color: white; } /* Naranja para acomodar */

        @keyframes pulse-green { 0% { box-shadow: 0 0 0 0 rgba(22, 163, 74, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(22, 163, 74, 0); } 100% { box-shadow: 0 0 0 0 rgba(22, 163, 74, 0); } }
        @keyframes pulse-blue { 0% { box-shadow: 0 0 0 0 rgba(37, 99, 235, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(37, 99, 235, 0); } 100% { box-shadow: 0 0 0 0 rgba(37, 99, 235, 0); } }

        .status-badge {
            background: rgba(0,0,0,0.8);
            padding: 4px 12px;
            border-radius: 99px;
            font-weight: bold;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            border: 1px solid rgba(255,255,255,0.2);
        }

        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 20px; width: 20px; border-radius: 50%; background: #ffffff; cursor: pointer; margin-top: -8px; box-shadow: 0 2px 5px rgba(0,0,0,0.5); }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #475569; border-radius: 2px; }

        /* UI Transition Classes */
        .ui-element { transition: opacity 0.5s ease, transform 0.5s ease; }
        .ui-hidden { opacity: 0; pointer-events: none; transform: translateY(20px); }

        /* Botón 360 */
        .btn-360 {
            position: absolute; bottom: 20px; right: 20px;
            width: 56px; height: 56px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(5px);
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            color: white;
            display: flex; align-items: center; justify-content: center;
            font-size: 24px;
            cursor: pointer;
            z-index: 50;
            transition: all 0.3s;
            box-shadow: 0 0 15px rgba(0,0,0,0.5);
        }
        .btn-360:hover { background: rgba(255,255,255,0.2); transform: scale(1.1); }
        .btn-360.active { background: #ef4444; border-color: #fca5a5; transform: rotate(180deg); }

        /* Pantalla Rotación */
        #rotate-warning { display: none; position: fixed; inset: 0; z-index: 100; background: #020617; flex-direction: column; align-items: center; justify-content: center; color: white; text-align: center; }
        .phone-icon { font-size: 4rem; animation: rotate-phone 2s infinite ease-in-out; margin-bottom: 2rem; color: #3b82f6; }
        @keyframes rotate-phone { 0% { transform: rotate(0deg); } 25% { transform: rotate(-90deg); } 75% { transform: rotate(-90deg); } 100% { transform: rotate(0deg); } }
        @media (max-width: 768px) and (orientation: portrait) {
            #rotate-warning { display: flex; }
            #game-ui, #game-canvas, #btn-360-toggle { display: none; }
        }
    </style>
</head>
<body class="h-screen w-screen bg-slate-900 text-slate-100 overflow-hidden">

    <!-- PANTALLA DE BLOQUEO POR ROTACIÓN -->
    <div id="rotate-warning">
        <i class="fas fa-mobile-alt phone-icon"></i>
        <h2 class="text-2xl font-bold mb-2">Gira tu dispositivo</h2>
        <p class="text-slate-400 max-w-xs px-4">Esta simulación requiere vista horizontal.</p>
    </div>

    <!-- Botón para Volver al Menú Principal -->
    <a href="../../../index.html" class="absolute top-4 left-4 z-[100] bg-white/80 backdrop-blur-sm text-slate-800 px-4 py-2 rounded-full font-bold shadow-lg hover:bg-white transition-all flex items-center gap-2">
        <i class="fas fa-arrow-left"></i>
        <span>Volver al Hub</span>
    </a>

    <!-- BOTÓN 360 FLOTANTE -->
    <button id="btn-360-toggle" class="btn-360 hidden" onclick="toggle360Mode()">
        <i class="fas fa-street-view"></i>
    </button>
    <div id="msg-360" class="hidden absolute bottom-24 right-4 text-right pointer-events-none transition-opacity duration-500 opacity-0 z-40">
        <div class="text-xs text-cyan-400 font-bold uppercase tracking-widest mb-1">Modo Inspección</div>
        <div class="text-sm text-white bg-black/50 px-2 py-1 rounded">Desliza para rotar <br> Pulsa X para operar aquí</div>
    </div>

    <!-- HUD SUPERIOR -->
    <div id="game-ui" class="absolute inset-0 pointer-events-none z-20 transition-all duration-500">
        <div class="absolute top-0 left-0 w-full p-2 md:p-4 flex justify-between ui-element">
            <!-- Objetivo -->
            <div class="glass-panel px-4 py-2 rounded-xl flex items-center gap-3 pointer-events-auto scale-90 origin-top-left md:scale-100">
                <div id="target-color-box" class="w-8 h-8 md:w-10 md:h-10 rounded bg-slate-700 shadow-inner border border-white/20"></div>
                <div>
                    <div class="text-[8px] text-slate-400 font-bold uppercase">ORDEN</div>
                    <div id="target-text" class="text-sm md:text-lg font-black italic">CARGANDO...</div>
                </div>
            </div>
            
            <!-- Score -->
            <div class="glass-panel px-4 py-2 rounded-xl flex flex-col items-end pointer-events-auto scale-90 origin-top-right md:scale-100">
                <div class="text-[8px] text-slate-400 font-bold uppercase">SALDO</div>
                <div class="text-lg md:text-2xl font-mono text-emerald-400 font-bold">$<span id="score">0</span></div>
            </div>
        </div>

        <!-- Instrucción Flotante -->
        <div class="absolute top-16 md:top-20 left-0 w-full text-center pointer-events-none z-10 ui-element">
            <div id="instruction-pill" class="inline-block status-badge text-yellow-400 animate-bounce shadow-lg">
                <i class="fas fa-info-circle mr-1"></i> <span id="instruction-text">INICIALIZANDO...</span>
            </div>
        </div>

        <!-- CONTROLES INFERIORES -->
        <div class="absolute bottom-0 left-0 w-full p-2 md:p-6 flex items-end justify-between gap-2 md:gap-8 pb-4 ui-element pr-20">
            
            <!-- D-PAD -->
            <div class="glass-panel p-3 rounded-2xl pointer-events-auto shadow-xl">
                <div class="text-[8px] text-slate-500 font-bold text-center mb-1 tracking-widest">MOVER</div>
                <div class="grid grid-cols-3 gap-1">
                    <div></div>
                    <button id="btn-fwd" class="control-btn w-12 h-12 rounded-lg text-lg flex items-center justify-center"><i class="fas fa-chevron-up"></i></button>
                    <div></div>
                    <button id="btn-left" class="control-btn w-12 h-12 rounded-lg text-lg flex items-center justify-center"><i class="fas fa-chevron-left"></i></button>
                    <div class="w-12 h-12 flex items-center justify-center text-slate-600"><i class="fas fa-arrows-alt text-xl"></i></div>
                    <button id="btn-right" class="control-btn w-12 h-12 rounded-lg text-lg flex items-center justify-center"><i class="fas fa-chevron-right"></i></button>
                    <div></div>
                    <button id="btn-back" class="control-btn w-12 h-12 rounded-lg text-lg flex items-center justify-center"><i class="fas fa-chevron-down"></i></button>
                    <div></div>
                </div>
            </div>

            <!-- PANEL CENTRAL DE ACCIONES -->
            <div class="flex-1 max-w-[280px] flex flex-col gap-2 pointer-events-auto self-end mb-1">
                
                <!-- BOTÓN PRINCIPAL (Acción del Juego) -->
                <button id="btn-action" class="w-full h-16 rounded-xl action-btn btn-disabled flex flex-col items-center justify-center shadow-xl group relative overflow-hidden transition-all">
                    <div class="flex items-center gap-2 relative z-10">
                        <i id="icon-action" class="fas fa-search text-2xl"></i>
                        <span id="text-action" class="text-base font-black tracking-wider leading-none">BUSCANDO</span>
                    </div>
                </button>

                <!-- BOTÓN SECUNDARIO (Acomodar/Stack) -->
                <button id="btn-stack" class="w-full h-12 rounded-lg border border-slate-600 bg-slate-800 text-slate-400 flex items-center justify-center gap-2 shadow-lg opacity-50 cursor-not-allowed transition-all" onclick="handleStack()" disabled>
                    <i class="fas fa-layer-group"></i>
                    <span class="text-xs font-bold uppercase tracking-wider">Acomodar</span>
                </button>
            </div>

            <!-- CONTROLES DESLIZANTES -->
            <div class="flex gap-2">
                <!-- SLIDER ALTURA -->
                <div class="glass-panel p-2 md:p-3 rounded-2xl pointer-events-auto h-48 md:h-56 flex flex-col items-center bg-slate-800/90">
                    <div class="text-[8px] text-slate-400 font-bold mb-1 uppercase">GANCHO</div>
                    <input type="range" id="hoist-slider" min="5" max="42" value="15" step="0.5" class="h-full w-6 -rotate-180 opacity-90 accent-yellow-400" style="writing-mode: bt-lr; -webkit-appearance: slider-vertical;">
                    <div class="mt-1 text-[8px] text-yellow-500 font-mono"><i class="fas fa-arrow-down"></i></div>
                </div>

                <!-- SLIDER ZOOM -->
                <div class="glass-panel p-2 md:p-3 rounded-2xl pointer-events-auto h-48 md:h-56 flex flex-col items-center bg-slate-800/90 border-cyan-900/50">
                    <div class="text-[8px] text-cyan-400 font-bold mb-1 uppercase">ZOOM</div>
                    <input type="range" id="zoom-slider" min="20" max="70" value="45" step="1" class="h-full w-6 -rotate-180 opacity-90 accent-cyan-400" style="writing-mode: bt-lr; -webkit-appearance: slider-vertical;">
                    <div class="mt-1 text-[8px] text-cyan-500 font-mono"><i class="fas fa-search-plus"></i></div>
                </div>
            </div>
        </div>
    </div>

    <!-- PANTALLA INICIO -->
    <div id="start-screen" class="absolute inset-0 z-50 bg-slate-900 flex flex-col items-center justify-center p-4 text-center">
        <div class="w-24 h-24 bg-blue-600 rounded-3xl flex items-center justify-center mb-4 shadow-[0_0_50px_rgba(37,99,235,0.3)] animate-pulse">
            <i class="fas fa-dolly text-5xl text-white"></i>
        </div>
        <h1 class="text-3xl md:text-5xl font-black text-white mb-2 tracking-tight">PORT <span class="text-blue-500">LOGISTICS</span></h1>
        <p class="text-slate-400 text-sm md:text-base mb-8">Operator Pro v7.0 (Multitarea)</p>
        <button onclick="startGame()" class="px-8 py-4 bg-white text-slate-900 text-lg font-bold rounded-xl hover:scale-105 transition shadow-xl w-full max-w-xs">
            EMPEZAR
        </button>
    </div>

    <!-- CANVAS 3D -->
    <div id="game-canvas" class="absolute inset-0 z-0 bg-slate-800 cursor-grab active:cursor-grabbing"></div>

    <script type="module">
        import * as THREE from 'three';
        import { RoundedBoxGeometry } from 'three/addons/geometries/RoundedBoxGeometry.js';

        // COLORES
        const COLORS = {
            red: { hex: 0xe11d48, name: "ROJO" },
            blue: { hex: 0x2563eb, name: "AZUL" },
            green: { hex: 0x16a34a, name: "VERDE" },
            yellow: { hex: 0xd97706, name: "AMBAR" }
        };

        // ESTADO GLOBAL
        const STATE = {
            active: false,
            score: 0,
            target: null, 
            crane: { x: 0, z: 0 },
            hoist: 15,
            zoom: 45,
            grabbedObj: null,
            hoverObj: null,
            onDropZone: false,
            actionState: 'IDLE',
            
            // Stacking Logic
            canStack: false,
            stackY: 0,

            // 360 Mode Vars
            is360Mode: false,
            cameraAngle: Math.PI / 4,
            isDragging: false,
            previousMouseX: 0
        };

        let scene, camera, renderer, clock;
        let craneTrolley, craneSpreader, laserGuide;
        let craneCables = [];
        let boxes = [];
        let audioCtx;

        // --- GAME LOOP ---
        window.startGame = function() {
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('btn-360-toggle').classList.remove('hidden');
            initAudio();
            init3D();
            newOrder();
            animate();
        };

        window.toggle360Mode = function() {
            STATE.is360Mode = !STATE.is360Mode;
            
            const btn = document.getElementById('btn-360-toggle');
            const icon = btn.querySelector('i');
            const uiElements = document.querySelectorAll('.ui-element');
            const msg = document.getElementById('msg-360');

            if(STATE.is360Mode) {
                btn.classList.add('active');
                icon.className = 'fas fa-times';
                uiElements.forEach(el => el.classList.add('ui-hidden'));
                msg.classList.remove('hidden');
                setTimeout(() => msg.classList.remove('opacity-0'), 100);
            } else {
                btn.classList.remove('active');
                icon.className = 'fas fa-street-view';
                uiElements.forEach(el => el.classList.remove('ui-hidden'));
                msg.classList.add('opacity-0');
                setTimeout(() => msg.classList.add('hidden'), 500);
                updateCameraPos();
            }
        };

        function newOrder() {
            const keys = Object.keys(COLORS);
            const key = keys[Math.floor(Math.random() * keys.length)];
            STATE.target = COLORS[key];
            
            document.getElementById('target-color-box').style.backgroundColor = '#' + STATE.target.hex.toString(16).padStart(6,'0');
            document.getElementById('target-text').innerText = STATE.target.name;
            document.getElementById('target-text').style.color = '#' + STATE.target.hex.toString(16).padStart(6,'0');
            
            updateInstruction("Ubica el contenedor " + STATE.target.name);
        }

        function updateInstruction(text) {
            document.getElementById('instruction-text').innerText = text;
        }

        // --- SCENE SETUP ---
        function init3D() {
            const container = document.getElementById('game-canvas');
            clock = new THREE.Clock();
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x0f172a);
            scene.fog = new THREE.Fog(0x0f172a, 40, 140);

            updateCameraZoom();

            renderer = new THREE.WebGLRenderer({ antialias: true, powerPreference: 'high-performance' });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            container.appendChild(renderer.domElement);

            const ambi = new THREE.AmbientLight(0xffffff, 0.7);
            scene.add(ambi);
            const sun = new THREE.DirectionalLight(0xffffff, 1.2);
            sun.position.set(-20, 80, -20);
            sun.castShadow = true;
            sun.shadow.mapSize.width = 1024; sun.shadow.mapSize.height = 1024;
            sun.shadow.camera.left = -60; sun.shadow.camera.right = 60;
            sun.shadow.camera.top = 60; sun.shadow.camera.bottom = -60;
            scene.add(sun);

            createLevel();
            createCrane();
            setupControls();
            setupDragControls();
            window.addEventListener('resize', onResize);
        }

        function updateCameraZoom() {
            const aspect = window.innerWidth / window.innerHeight;
            const D = 90 - STATE.zoom;

            if (!camera) {
                camera = new THREE.OrthographicCamera(-D*aspect, D*aspect, D, -D, 1, 1000);
            } else {
                camera.left = -D*aspect;
                camera.right = D*aspect;
                camera.top = D;
                camera.bottom = -D;
                camera.updateProjectionMatrix();
            }
            updateCameraPos();
        }

        function updateCameraPos() {
            const r = 70.7;
            camera.position.x = r * Math.sin(STATE.cameraAngle);
            camera.position.z = r * Math.cos(STATE.cameraAngle);
            camera.position.y = 50;
            camera.lookAt(0, 0, 0);
        }

        function createLevel() {
            // Muelle (Dock)
            const dock = new THREE.Mesh(new THREE.BoxGeometry(100, 10, 140), new THREE.MeshStandardMaterial({ color: 0x334155 }));
            dock.position.set(25, -5, 0); dock.receiveShadow = true; scene.add(dock);

            // Mar
            const water = new THREE.Mesh(new THREE.PlaneGeometry(300, 300), new THREE.MeshBasicMaterial({ color: 0x0ea5e9 }));
            water.rotation.x = -Math.PI/2; water.position.y = -6; scene.add(water);

            // Barco
            const ship = new THREE.Group();
            const hull = new THREE.Mesh(new THREE.BoxGeometry(30, 15, 120), new THREE.MeshStandardMaterial({ color: 0x7f1d1d }));
            hull.position.y = 1.5; hull.receiveShadow = true; ship.add(hull);
            const deck = new THREE.Mesh(new THREE.BoxGeometry(28, 1, 118), new THREE.MeshStandardMaterial({ color: 0x475569 }));
            deck.position.y = 9; deck.receiveShadow = true; ship.add(deck);
            ship.position.x = -35;
            scene.add(ship);

            // Cinta
            const beltGroup = new THREE.Group();
            beltGroup.position.set(35, 0, 0);
            const beltFrame = new THREE.Mesh(new THREE.BoxGeometry(12, 2, 60), new THREE.MeshStandardMaterial({ color: 0xf59e0b }));
            beltFrame.receiveShadow = true; beltGroup.add(beltFrame);
            const beltSurf = new THREE.Mesh(new THREE.BoxGeometry(10, 0.2, 60), new THREE.MeshStandardMaterial({ color: 0x111111 }));
            beltSurf.position.y = 1.1; beltFrame.receiveShadow = true; beltGroup.add(beltSurf);
            
            const dropZone = new THREE.Mesh(new THREE.PlaneGeometry(10, 10), new THREE.MeshBasicMaterial({ color: 0x3b82f6, transparent: true, opacity: 0.4 }));
            dropZone.rotation.x = -Math.PI/2; dropZone.position.y = 1.25; beltGroup.add(dropZone);
            scene.add(beltGroup);

            // Contenedores Iniciales
            const geo = new RoundedBoxGeometry(3.8, 3.8, 7.8, 4, 0.2);
            const colValues = Object.values(COLORS);
            
            for(let x=-1; x<=1; x++) {
                for(let z=-3; z<=3; z++) {
                    const stacks = Math.floor(Math.random() * 3) + 1;
                    for(let y=0; y<stacks; y++) {
                        const cData = colValues[Math.floor(Math.random() * colValues.length)];
                        const mat = new THREE.MeshStandardMaterial({ color: cData.hex });
                        const box = new THREE.Mesh(geo, mat);
                        // Ship Deck Y=9. Box H=3.8. First level center = 9 + 1.9 = 10.9
                        box.position.set(-35 + (x*4.2), 10.9 + (y*3.8), z*8.2);
                        box.castShadow = true; box.receiveShadow = true;
                        box.userData = { colorHex: cData.hex };
                        scene.add(box);
                        boxes.push(box);
                    }
                }
            }
        }

        function createCrane() {
            const gantry = new THREE.Group();
            const legMat = new THREE.MeshStandardMaterial({ color: 0xfacc15 });
            const legGeo = new THREE.BoxGeometry(3, 45, 3);
            [[-45,-30],[-45,30],[45,-30],[45,30]].forEach(p => {
                const l = new THREE.Mesh(legGeo, legMat); l.position.set(p[0], 22.5, p[1]); l.castShadow=true; gantry.add(l);
            });
            const beam = new THREE.Mesh(new THREE.BoxGeometry(100, 4, 4), legMat); beam.position.set(0, 45, 30); gantry.add(beam);
            const beam2 = beam.clone(); beam2.position.z = -30; gantry.add(beam2);
            scene.add(gantry);

            craneTrolley = new THREE.Group();
            craneTrolley.position.y = 47;
            const tBody = new THREE.Mesh(new THREE.BoxGeometry(8, 2, 24), new THREE.MeshStandardMaterial({ color: 0x334155 }));
            craneTrolley.add(tBody);
            scene.add(craneTrolley);

            craneSpreader = new THREE.Group();
            const sBody = new THREE.Mesh(new THREE.BoxGeometry(4.2, 1, 8.2), new THREE.MeshStandardMaterial({ color: 0x000000 }));
            craneSpreader.add(sBody);
            
            laserGuide = new THREE.Mesh(new THREE.PlaneGeometry(0.2, 0.2), new THREE.MeshBasicMaterial({ color: 0xff0000 }));
            laserGuide.rotation.x = -Math.PI/2;
            scene.add(laserGuide);

            const lineMat = new THREE.LineBasicMaterial({ color: 0x000000 });
            for(let i=0; i<4; i++) {
                const g = new THREE.BufferGeometry().setFromPoints([new THREE.Vector3(0,0,0), new THREE.Vector3(0,-10,0)]);
                const l = new THREE.Line(g, lineMat);
                l.userData = { ox: (i%2?1:-1)*3, oz: (i<2?1:-1)*10 };
                craneTrolley.add(l);
                craneCables.push(l);
            }
            scene.add(craneSpreader);
        }

        // --- LOGIC ---
        function updateLogic(dt) {
            if (STATE.is360Mode) {
                if (!STATE.isDragging) STATE.cameraAngle += dt * 0.2;
                updateCameraPos();
                return;
            }

            // Movimiento
            const spd = 30 * dt;
            if(inputs.fwd) STATE.crane.z -= spd;
            if(inputs.back) STATE.crane.z += spd;
            if(inputs.left) STATE.crane.x -= spd;
            if(inputs.right) STATE.crane.x += spd;

            STATE.crane.x = Math.max(-42, Math.min(42, STATE.crane.x));
            STATE.crane.z = Math.max(-28, Math.min(28, STATE.crane.z));

            craneTrolley.position.x = THREE.MathUtils.lerp(craneTrolley.position.x, STATE.crane.x, 0.15);
            craneTrolley.position.z = THREE.MathUtils.lerp(craneTrolley.position.z, STATE.crane.z, 0.15);

            const targetY = 47 - STATE.hoist;
            craneSpreader.position.x = craneTrolley.position.x;
            craneSpreader.position.z = craneTrolley.position.z;
            craneSpreader.position.y = THREE.MathUtils.lerp(craneSpreader.position.y, targetY, 0.1);

            // Cables
            craneCables.forEach(l => {
                const pos = l.geometry.attributes.position.array;
                const dy = craneSpreader.position.y - craneTrolley.position.y;
                pos[0] = l.userData.ox; pos[1]=0; pos[2]=l.userData.oz;
                pos[3] = l.userData.ox*0.5; pos[4]=dy; pos[5]=l.userData.oz*0.5;
                l.geometry.attributes.position.needsUpdate = true;
            });

            checkContext();
            updateUI();
            
            // Laser
            laserGuide.position.set(craneSpreader.position.x, 0.5, craneSpreader.position.z);
            if(STATE.hoverObj && !STATE.grabbedObj) {
                laserGuide.position.y = STATE.hoverObj.position.y + 2.1;
                laserGuide.scale.set(15, 30, 1);
            } else {
                laserGuide.position.y = STATE.crane.x < 0 ? 10 : 0.5;
                laserGuide.scale.set(4, 4, 1);
            }
        }

        function checkContext() {
            STATE.onDropZone = (Math.abs(STATE.crane.x - 35) < 6 && Math.abs(STATE.crane.z) < 10);
            
            // 1. Manejo del estado del Botón Principal
            if(STATE.grabbedObj) {
                STATE.hoverObj = null;
                if(STATE.onDropZone) {
                    STATE.actionState = 'CAN_DROP';
                    updateInstruction("¡Posición Correcta! SUELTA.");
                } else {
                    STATE.actionState = 'CARRYING';
                    updateInstruction("Lleva a la CINTA o ACOMODA");
                }
            } else {
                // Buscando caja para agarrar
                const spreaderP = new THREE.Vector3(STATE.crane.x, 0, STATE.crane.z);
                let best = null;
                let minD = 4;

                boxes.forEach(b => {
                    const dx = Math.abs(b.position.x - spreaderP.x);
                    const dz = Math.abs(b.position.z - spreaderP.z);
                    if(dx < minD && dz < minD) {
                        if(!best || b.position.y > best.position.y) best = b;
                    }
                });

                if(best) {
                    STATE.hoverObj = best;
                    const dy = Math.abs(craneSpreader.position.y - (best.position.y + 2));
                    if(dy < 4) {
                        STATE.actionState = 'CAN_GRAB';
                        updateInstruction("¡Alineado! AGARRA.");
                    } else {
                        STATE.actionState = 'IDLE'; 
                        updateInstruction("Baja el gancho");
                    }
                } else {
                    STATE.hoverObj = null;
                    STATE.actionState = 'IDLE';
                    updateInstruction("Busca el contenedor " + STATE.target.name);
                }
            }

            // 2. Manejo del estado del Botón "Acomodar" (Stack)
            STATE.canStack = false;
            STATE.stackY = 0;

            if (STATE.grabbedObj && !STATE.onDropZone) {
                const sPos = craneSpreader.position;
                
                // Determinar altura base (Suelo/Cubierta)
                // Barco: X entre -50 y -20. Cubierta Y=9. Caja base Y ~10.9
                // Muelle: X entre 10 y 45. Suelo Y=0. Caja base Y ~1.9 (Dock Top=0 + HalfHeight)
                
                let baseHeight = -999;
                const onShip = (sPos.x > -50 && sPos.x < -20 && Math.abs(sPos.z) < 55);
                const onDock = (sPos.x > 10 && sPos.x < 45 && Math.abs(sPos.z) < 65);

                if (onShip) baseHeight = 10.9;
                else if (onDock) baseHeight = 1.9;

                if (baseHeight > -900) {
                    // Estamos sobre zona segura. Buscar si hay cajas debajo.
                    let maxStackY = baseHeight;
                    
                    boxes.forEach(b => {
                        if(b === STATE.grabbedObj) return; // Ignorar la que tenemos
                        const dx = Math.abs(b.position.x - sPos.x);
                        const dz = Math.abs(b.position.z - sPos.z);
                        if(dx < 3 && dz < 6) { // Sobre esta caja
                            if(b.position.y + 3.8 > maxStackY) {
                                maxStackY = b.position.y + 3.8;
                            }
                        }
                    });

                    // Verificar si el gancho está cerca de la altura de apilado
                    // La caja agarrada cuelga a -2.5 del spreader.
                    // Su parte inferior está en (spreader.y - 2.5) - 1.9 = spreader.y - 4.4?
                    // No, position es centro. Centro caja = StackY.
                    // Spreader debe estar en StackY + 2.5.
                    
                    const targetSpreaderY = maxStackY + 2.5;
                    const diff = Math.abs(sPos.y - targetSpreaderY);

                    if (diff < 5) { // Tolerancia generosa
                        STATE.canStack = true;
                        STATE.stackY = maxStackY;
                    }
                }
            }
        }

        function updateUI() {
            // Botón Principal
            const btn = document.getElementById('btn-action');
            const icon = document.getElementById('icon-action');
            const text = document.getElementById('text-action');

            btn.className = "w-full h-16 rounded-xl action-btn flex flex-col items-center justify-center shadow-xl group relative overflow-hidden transition-all";

            switch(STATE.actionState) {
                case 'IDLE':
                    btn.classList.add('btn-disabled');
                    icon.className = "fas fa-search text-2xl text-slate-500 mb-0.5";
                    text.innerText = "BUSCANDO";
                    break;
                case 'CAN_GRAB':
                    btn.classList.add('btn-grab');
                    icon.className = "fas fa-hand-rock text-3xl mb-0.5";
                    text.innerText = "AGARRAR";
                    break;
                case 'CARRYING':
                    btn.classList.add('btn-transit');
                    icon.className = "fas fa-truck-loading text-3xl mb-0.5";
                    text.innerText = "MOVIENDO";
                    break;
                case 'CAN_DROP':
                    btn.classList.add('btn-drop');
                    icon.className = "fas fa-check-circle text-3xl mb-0.5";
                    text.innerText = "ENTREGAR";
                    break;
            }

            // Botón Acomodar
            const btnStack = document.getElementById('btn-stack');
            if(STATE.canStack) {
                btnStack.disabled = false;
                btnStack.classList.remove('opacity-50', 'cursor-not-allowed');
                btnStack.classList.add('btn-stack', 'animate-pulse');
            } else {
                btnStack.disabled = true;
                btnStack.classList.add('opacity-50', 'cursor-not-allowed');
                btnStack.classList.remove('btn-stack', 'animate-pulse');
            }
        }

        function handleAction() {
            if(STATE.actionState === 'CAN_GRAB' && STATE.hoverObj) {
                playSound('lock');
                STATE.grabbedObj = STATE.hoverObj;
                scene.remove(STATE.grabbedObj);
                craneSpreader.add(STATE.grabbedObj);
                STATE.grabbedObj.position.set(0, -2.5, 0);
                STATE.grabbedObj.rotation.set(0,0,0);
            } 
            else if(STATE.actionState === 'CAN_DROP' && STATE.grabbedObj) {
                // Lógica de Entrega Final
                const box = STATE.grabbedObj;
                craneSpreader.remove(box);
                scene.add(box);
                
                const wPos = new THREE.Vector3();
                craneSpreader.getWorldPosition(wPos);
                box.position.copy(wPos);
                box.position.y -= 2.5;

                STATE.grabbedObj = null;

                if(box.userData.colorHex === STATE.target.hex) {
                    playSound('success');
                    STATE.score += 200;
                    document.getElementById('score').innerText = STATE.score;
                    animateBelt(box);
                } else {
                    playSound('error');
                    STATE.score -= 50;
                    document.getElementById('score').innerText = STATE.score;
                    animateBelt(box, true);
                }
            }
        }

        window.handleStack = function() {
            if (STATE.canStack && STATE.grabbedObj) {
                playSound('thud'); // Sonido de golpe seco
                const box = STATE.grabbedObj;
                
                // Desvincular de la grúa
                craneSpreader.remove(box);
                scene.add(box);

                // Posicionar en el mundo en las coordenadas calculadas
                const wPos = new THREE.Vector3();
                craneSpreader.getWorldPosition(wPos);
                
                box.position.set(wPos.x, STATE.stackY, wPos.z);
                box.rotation.set(0,0,0);

                // Resetear estado
                STATE.grabbedObj = null;
                // Nota: La caja ya estaba en el array 'boxes', no necesitamos añadirla de nuevo,
                // solo actualizar su posición visual, lo cual acabamos de hacer.
            }
        }

        function animateBelt(box, reject=false) {
            const interval = setInterval(() => {
                box.position.z += 0.5;
                if(reject) box.position.x += 0.1; 
                
                if(box.position.z > 50) {
                    clearInterval(interval);
                    scene.remove(box);
                    // Eliminar del array lógico para que no se detecte más
                    boxes = boxes.filter(b => b !== box);
                    if(!reject) newOrder();
                }
            }, 30);
        }

        // --- INPUTS & EVENTS ---
        const inputs = { fwd:false, back:false, left:false, right:false };
        
        function setupControls() {
            const bind = (id, k) => {
                const el = document.getElementById(id);
                el.onmousedown = el.ontouchstart = (e) => { e.preventDefault(); inputs[k]=true; el.style.background='#475569'; };
                el.onmouseup = el.ontouchend = el.onmouseleave = (e) => { e.preventDefault(); inputs[k]=false; el.style.background=''; };
            };
            bind('btn-fwd', 'fwd'); bind('btn-back', 'back');
            bind('btn-left', 'left'); bind('btn-right', 'right');

            const slider = document.getElementById('hoist-slider');
            slider.oninput = (e) => STATE.hoist = parseFloat(e.target.value);
            
            const zoomSlider = document.getElementById('zoom-slider');
            zoomSlider.oninput = (e) => {
                STATE.zoom = parseFloat(e.target.value);
                updateCameraZoom();
            };

            document.getElementById('btn-action').onclick = handleAction;
        }

        function setupDragControls() {
            const canvas = document.getElementById('game-canvas');
            const onStart = (x) => { if(!STATE.is360Mode) return; STATE.isDragging = true; STATE.previousMouseX = x; };
            const onMove = (x) => { 
                if(!STATE.is360Mode || !STATE.isDragging) return;
                const delta = x - STATE.previousMouseX;
                STATE.cameraAngle -= delta * 0.01;
                STATE.previousMouseX = x;
                updateCameraPos();
            };
            const onEnd = () => { STATE.isDragging = false; };

            canvas.addEventListener('mousedown', e => onStart(e.clientX));
            window.addEventListener('mousemove', e => onMove(e.clientX));
            window.addEventListener('mouseup', onEnd);
            canvas.addEventListener('touchstart', e => onStart(e.touches[0].clientX));
            window.addEventListener('touchmove', e => onMove(e.touches[0].clientX));
            window.addEventListener('touchend', onEnd);
        }

        function onResize() {
            updateCameraZoom();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function initAudio() {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }
        function playSound(type) {
            if(!audioCtx) return;
            const o = audioCtx.createOscillator();
            const g = audioCtx.createGain();
            o.connect(g).connect(audioCtx.destination);
            if(type==='lock') { o.frequency.setValueAtTime(300, audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime+0.1); }
            else if(type==='success') { o.type='sine'; o.frequency.setValueAtTime(600, audioCtx.currentTime); o.frequency.linearRampToValueAtTime(900, audioCtx.currentTime+0.2); g.gain.linearRampToValueAtTime(0, audioCtx.currentTime+0.4); }
            else if(type==='thud') { o.type='square'; o.frequency.setValueAtTime(100, audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime+0.15); }
            else { o.type='sawtooth'; o.frequency.setValueAtTime(150, audioCtx.currentTime); g.gain.linearRampToValueAtTime(0, audioCtx.currentTime+0.2); }
            o.start(); o.stop(audioCtx.currentTime+0.5);
        }

        function animate() {
            requestAnimationFrame(animate);
            STATE.active = true;
            updateLogic(clock.getDelta());
            renderer.render(scene, camera);
        }
    </script>
</body>
</html>